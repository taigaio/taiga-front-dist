{"version":3,"sources":["coffee/app.coffee","coffee/classes.coffee","coffee/utils.coffee","coffee/modules/controllerMixins.coffee","coffee/modules/admin.coffee","coffee/modules/auth.coffee","coffee/modules/backlog.coffee","coffee/modules/base.coffee","coffee/modules/common.coffee","coffee/modules/events.coffee","coffee/modules/feedback.coffee","coffee/modules/integrations.coffee","coffee/modules/issues.coffee","coffee/modules/kanban.coffee","coffee/modules/projects.coffee","coffee/modules/related-tasks.coffee","coffee/modules/resources.coffee","coffee/modules/search.coffee","coffee/modules/taskboard.coffee","coffee/modules/tasks.coffee","coffee/modules/team.coffee","coffee/modules/user-settings.coffee","coffee/modules/userstories.coffee","coffee/modules/wiki.coffee","coffee/modules/common/analytics.coffee","coffee/modules/common/attachments.coffee","coffee/modules/common/bind-scope.coffee","coffee/modules/common/compile-html.directive.coffee","coffee/modules/common/components.coffee","coffee/modules/common/confirm.coffee","coffee/modules/common/custom-field-values.coffee","coffee/modules/common/estimation.coffee","coffee/modules/common/filters.coffee","coffee/modules/common/history.coffee","coffee/modules/common/importer.coffee","coffee/modules/common/lightboxes.coffee","coffee/modules/common/loader.coffee","coffee/modules/common/loading.coffee","coffee/modules/common/popovers.coffee","coffee/modules/common/raven-logger.coffee","coffee/modules/common/tags.coffee","coffee/modules/common/wisiwyg.coffee","coffee/modules/backlog/filters.coffee","coffee/modules/backlog/lightboxes.coffee","coffee/modules/backlog/main.coffee","coffee/modules/backlog/sortable.coffee","coffee/modules/backlog/sprints.coffee","coffee/modules/taskboard/charts.coffee","coffee/modules/taskboard/lightboxes.coffee","coffee/modules/taskboard/main.coffee","coffee/modules/taskboard/sortable.coffee","coffee/modules/kanban/main.coffee","coffee/modules/kanban/sortable.coffee","coffee/modules/issues/detail.coffee","coffee/modules/issues/lightboxes.coffee","coffee/modules/issues/list.coffee","coffee/modules/userstories/detail.coffee","coffee/modules/tasks/detail.coffee","coffee/modules/team/main.coffee","coffee/modules/wiki/main.coffee","coffee/modules/wiki/nav.coffee","coffee/modules/admin/lightboxes.coffee","coffee/modules/admin/memberships.coffee","coffee/modules/admin/nav.coffee","coffee/modules/admin/project-profile.coffee","coffee/modules/admin/project-values.coffee","coffee/modules/admin/roles.coffee","coffee/modules/admin/third-parties.coffee","coffee/modules/projects/lightboxes.coffee","coffee/modules/base/bind.coffee","coffee/modules/base/conf.coffee","coffee/modules/base/contrib.coffee","coffee/modules/base/filters.coffee","coffee/modules/base/http.coffee","coffee/modules/base/location.coffee","coffee/modules/base/model.coffee","coffee/modules/base/navurls.coffee","coffee/modules/base/repository.coffee","coffee/modules/base/storage.coffee","coffee/modules/base/urls.coffee","coffee/modules/resources/attachments.coffee","coffee/modules/resources/custom-attributes-values.coffee","coffee/modules/resources/custom-attributes.coffee","coffee/modules/resources/history.coffee","coffee/modules/resources/invitations.coffee","coffee/modules/resources/issues.coffee","coffee/modules/resources/kanban.coffee","coffee/modules/resources/locales.coffee","coffee/modules/resources/mdrender.coffee","coffee/modules/resources/memberships.coffee","coffee/modules/resources/modules.coffee","coffee/modules/resources/notify-policies.coffee","coffee/modules/resources/projects.coffee","coffee/modules/resources/roles.coffee","coffee/modules/resources/search.coffee","coffee/modules/resources/sprints.coffee","coffee/modules/resources/tasks.coffee","coffee/modules/resources/user-settings.coffee","coffee/modules/resources/users.coffee","coffee/modules/resources/userstories.coffee","coffee/modules/resources/webhooklogs.coffee","coffee/modules/resources/webhooks.coffee","coffee/modules/resources/wiki.coffee","coffee/modules/user-settings/change-password.coffee","coffee/modules/user-settings/lightboxes.coffee","coffee/modules/user-settings/main.coffee","coffee/modules/user-settings/nav.coffee","coffee/modules/user-settings/notifications.coffee","modules/components/components.module.coffee","modules/external-apps/external-apps.module.coffee","modules/home/home.module.coffee","modules/navigation-bar/navigation-bar.module.coffee","modules/profile/profile.module.coffee","modules/projects/projects.module.coffee","modules/resources/resources.module.coffee","modules/user-timeline/user-timeline.module.coffee","modules/components/joy-ride/joy-ride.directive.coffee","modules/components/joy-ride/joy-ride.service.coffee","modules/components/project-menu/project-menu.controller.coffee","modules/components/project-menu/project-menu.directive.coffee","modules/components/terms-of-service-and-privacy-policy-notice/terms-of-service-and-privacy-policy-notice.directive.coffee","modules/components/vote-button/vote-button.controller.coffee","modules/components/vote-button/vote-button.directive.coffee","modules/components/watch-button/watch-button.controller.coffee","modules/components/watch-button/watch-button.directive.coffee","modules/external-apps/external-app.controller.coffee","modules/external-apps/external-app.service.coffee","modules/feedback/feedback.service.coffee","modules/home/duties/duty.directive.coffee","modules/home/home.service.coffee","modules/home/projects/home-project-list.directive.coffee","modules/home/working-on/working-on.controller.coffee","modules/home/working-on/working-on.directive.coffee","modules/navigation-bar/dropdown-project-list/dropdown-project-list.directive.coffee","modules/navigation-bar/dropdown-user/dropdown-user.directive.coffee","modules/navigation-bar/navigation-bar.directive.coffee","modules/navigation-bar/navigation-bar.service.coffee","modules/profile/profile-bar/profile-bar.controller.coffee","modules/profile/profile-bar/profile-bar.directive.coffee","modules/profile/profile-contacts/profile-contacts.controller.coffee","modules/profile/profile-contacts/profile-contacts.directive.coffee","modules/profile/profile-favs/items/items.directive.coffee","modules/profile/profile-favs/profile-favs.controller.coffee","modules/profile/profile-favs/profile-favs.directive.coffee","modules/profile/profile-hints/profile-hints.controller.coffee","modules/profile/profile-hints/profile-hints.directive.coffee","modules/profile/profile-projects/profile-projects.controller.coffee","modules/profile/profile-projects/profile-projects.directive.coffee","modules/profile/profile-tab/profile-tab.directive.coffee","modules/profile/profile-tabs/profile-tabs.controller.coffee","modules/profile/profile-tabs/profile-tabs.directive.coffee","modules/profile/profile.controller.coffee","modules/projects/components/like-project-button/like-project-button.controller.coffee","modules/projects/components/like-project-button/like-project-button.directive.coffee","modules/projects/components/like-project-button/like-project-button.service.coffee","modules/projects/components/sort-projects.directive.coffee","modules/projects/components/watch-project-button/watch-project-button.controller.coffee","modules/projects/components/watch-project-button/watch-project-button.directive.coffee","modules/projects/components/watch-project-button/watch-project-button.service.coffee","modules/projects/listing/projects-listing.controller.coffee","modules/projects/project/project.controller.coffee","modules/projects/projects.service.coffee","modules/resources/external-apps-resource.service.coffee","modules/resources/issues-resource.service.coffee","modules/resources/projects-resource.service.coffee","modules/resources/resources.coffee","modules/resources/tasks-resource.service.coffee","modules/resources/user-resource.service.coffee","modules/resources/users-resource.service.coffee","modules/resources/userstories-resource.service.coffee","modules/services/app-meta.service.coffee","modules/services/check-permissions.service.coffee","modules/services/current-user.service.coffee","modules/services/lightbox-factory.service.coffee","modules/services/paginate-response.service.coffee","modules/services/project.service.coffee","modules/services/scope-event.service.coffee","modules/services/theme.service.coffee","modules/services/user.service.coffee","modules/services/xhrError.service.coffee","modules/user-timeline/user-timeline-attachment/user-timeline-attachment.directive.coffee","modules/user-timeline/user-timeline-item/user-timeline-item-title.service.coffee","modules/user-timeline/user-timeline-item/user-timeline-item-type.service.coffee","modules/user-timeline/user-timeline-item/user-timeline-item.directive.coffee","modules/user-timeline/user-timeline-pagination-sequence/user-timeline-pagination-sequence.service.coffee","modules/user-timeline/user-timeline/user-timeline.controller.coffee","modules/user-timeline/user-timeline/user-timeline.directive.coffee","modules/user-timeline/user-timeline/user-timeline.service.coffee","plugins/main.coffee"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7UA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/VA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5aA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/2BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACniBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACheA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACldA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACn2CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClqBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5qBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC58BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3lBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnuBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpDA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,sBAAA,GAAyB,SAAC,kBAAD,EAAqB,oBAArB,EAA2C,SAA3C;AACrB,QAAA;IAAA,IAAA,GAAO,SAAC,KAAD,EAAQ,EAAR,EAAY,KAAZ,EAAmB,IAAnB;MACH,KAAK,CAAC,EAAN,GAAW;MAEX,KAAK,CAAC,GAAN,CAAU,qBAAV,EAAiC,SAAA;QAC7B,IAAG,SAAS,CAAC,IAAV,CAAA,CAAA,KAAoB,GAAvB;iBACI,KAAK,CAAC,EAAE,CAAC,MAAT,GAAkB,KADtB;SAAA,MAAA;iBAGI,KAAK,CAAC,EAAE,CAAC,MAAT,GAAkB,MAHtB;;MAD6B,CAAjC;MAMA,KAAK,CAAC,uBAAN,CAA8B,KAAK,CAAC,EAApC,EAAwC,UAAxC,EAAoD,SAAA;eAAM,kBAAkB,CAAC,QAAQ,CAAC,GAA5B,CAAgC,SAAhC;MAAN,CAApD;MACA,KAAK,CAAC,uBAAN,CAA8B,KAAK,CAAC,EAApC,EAAwC,iBAAxC,EAA2D,SAAA;eAAM,kBAAkB,CAAC,eAAnB,CAAA;MAAN,CAA3D;aACA,KAAK,CAAC,uBAAN,CAA8B,KAAK,CAAC,EAApC,EAAwC,iBAAxC,EAA2D,SAAA;eAAM,oBAAoB,CAAC,eAArB,CAAA;MAAN,CAA3D;IAXG;IAcP,SAAA,GAAY;MACR,WAAA,EAAa,oCADL;MAER,KAAA,EAAO,EAFC;MAGR,IAAA,EAAM,IAHE;;AAMZ,WAAO;EArBc;;EAuBzB,sBAAsB,CAAC,OAAvB,GAAiC,CAC7B,sBAD6B,EAE7B,wBAF6B,EAG7B,WAH6B;;EAMjC,OAAO,CAAC,MAAR,CAAe,oBAAf,CAAoC,CAAC,SAArC,CAA+C,iBAA/C,EAAkE,sBAAlE;AAhDA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnDA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,wBAAA,GAA2B,SAAA;AACvB,QAAA;IAAA,IAAA,GAAO,SAAC,KAAD,EAAQ,GAAR,EAAa,KAAb,EAAoB,IAApB;aACH,IAAI,CAAC,YAAL,CAAA;IADG;AAGP,WAAO;MACH,WAAA,EAAa,gDADV;MAEH,KAAA,EAAO;QACH,IAAA,EAAM,GADH;OAFJ;MAKH,YAAA,EAAc,IALX;MAMH,UAAA,EAAY,iBANT;MAOH,IAAA,EAAM,IAPH;MAQH,gBAAA,EAAkB,IARf;;EAJgB;;EAe3B,OAAO,CAAC,MAAR,CAAe,cAAf,CAA8B,CAAC,SAA/B,CAAyC,mBAAzC,EAA8D,wBAA9D;AAlCA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjGA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,QAAA,GAAW,SAAC,WAAD,EAAc,IAAd;AACP,QAAA;IAAA,OAAA,GAAU;IAEV,OAAO,CAAC,mBAAR,GAA8B,SAAC,aAAD,EAAgB,KAAhB;AAC1B,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,cAApB;MACN,GAAA,GAAS,GAAD,GAAK,GAAL,GAAQ,aAAR,GAAsB,eAAtB,GAAqC;AAC7C,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,CAAa,CAAC,IAAd,CAAmB,SAAC,MAAD;eACtB,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MADsB,CAAnB;IAHmB;IAM9B,OAAO,CAAC,yBAAR,GAAoC,SAAC,aAAD,EAAgB,KAAhB;AAChC,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,oBAApB;MACN,GAAA,GAAS,GAAD,GAAK;MACb,IAAA,GAAO;QACH,OAAA,EAAS,KADN;QAEH,aAAA,EAAe,aAFZ;;AAKP,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,IAAf,CAAoB,CAAC,IAArB,CAA0B,SAAC,MAAD;eAC7B,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MAD6B,CAA1B;IARyB;AAWpC,WAAO,SAAA;AACH,aAAO;QAAC,cAAA,EAAgB,OAAjB;;IADJ;EApBA;;EAuBX,QAAQ,CAAC,OAAT,GAAmB,CAAC,SAAD,EAAY,SAAZ;;EAEnB,MAAA,GAAS,OAAO,CAAC,MAAR,CAAe,iBAAf;;EACT,MAAM,CAAC,OAAP,CAAe,wBAAf,EAAyC,QAAzC;AA7CA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,QAAA,GAAW,SAAC,WAAD,EAAc,IAAd;AACP,QAAA;IAAA,OAAA,GAAU;IAEV,OAAO,CAAC,iBAAR,GAA4B,SAAC,MAAD;AACxB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,QAApB;MAEN,WAAA,GAAc;QACV,OAAA,EAAS;UACL,sBAAA,EAAwB,GADnB;SADC;;AAMd,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,EAAc,MAAd,EAAsB,WAAtB,CACH,CAAC,IADE,CACG,SAAC,MAAD;AACF,eAAO,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MADL,CADH;IATiB;AAa5B,WAAO,SAAA;AACH,aAAO;QAAC,QAAA,EAAU,OAAX;;IADJ;EAhBA;;EAmBX,QAAQ,CAAC,OAAT,GAAmB,CAAC,SAAD,EAAY,SAAZ;;EAEnB,MAAA,GAAS,OAAO,CAAC,MAAR,CAAe,iBAAf;;EACT,MAAM,CAAC,OAAP,CAAe,kBAAf,EAAmC,QAAnC;AAzCA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,UAAA,GAAa,SAAA,GAAA;;EAEb,QAAA,GAAW,SAAC,WAAD,EAAc,IAAd,EAAoB,uBAApB;AACP,QAAA;IAAA,OAAA,GAAU;IAEV,OAAO,CAAC,gBAAR,GAA2B,SAAC,WAAD;AACvB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,UAApB;MAEN,GAAA,GAAS,GAAD,GAAK,gBAAL,GAAqB;AAE7B,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,CACH,CAAC,IADE,CACG,SAAC,MAAD;AACF,eAAO,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MADL,CADH;IALgB;IAS3B,OAAO,CAAC,mBAAR,GAA8B,SAAC,MAAD,EAAS,QAAT;AAC1B,UAAA;;QADmC,WAAS;;MAC5C,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,UAApB;MACN,WAAA,GAAc;MAEd,IAAG,CAAC,QAAJ;QACI,WAAW,CAAC,OAAZ,GAAsB;UAClB,sBAAA,EAAwB,GADN;UAD1B;;MAKA,MAAA,GAAS;QAAC,QAAA,EAAU,MAAX;QAAmB,UAAA,EAAY,yBAA/B;;AAET,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,EAAc,MAAd,EAAsB,WAAtB,CACH,CAAC,IADE,CACG,SAAC,MAAD;AACF,eAAO,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MADL,CADH;IAXmB;IAe9B,OAAO,CAAC,eAAR,GAA0B,SAAC,SAAD;AACtB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,UAApB;MACN,GAAA,GAAS,GAAD,GAAK,GAAL,GAAQ;AAEhB,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,CACH,CAAC,IADE,CACG,SAAC,MAAD;AACF,eAAO,SAAS,CAAC,MAAV,CAAiB,MAAM,CAAC,IAAxB;MADL,CADH;IAJe;IAQ1B,OAAO,CAAC,eAAR,GAA0B,SAAC,QAAD;AACtB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,4BAApB;AACN,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,QAAf;IAFe;IAI1B,OAAO,CAAC,WAAR,GAAsB,SAAC,SAAD,EAAY,IAAZ;AAClB,UAAA;MAAA,MAAA,GAAS;QACL,IAAA,EAAM,IADD;;MAIT,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,kBAApB;MACN,GAAA,GAAS,GAAD,GAAK,GAAL,GAAQ;AAEhB,aAAO,IAAI,CAAC,GAAL,CAAS,GAAT,EAAc,MAAd,CAAqB,CAAC,IAAtB,CAA2B,SAAC,MAAD;QAC9B,MAAA,GAAS,SAAS,CAAC,MAAV,CAAiB,MAAjB;AACT,eAAO,uBAAA,CAAwB,MAAxB;MAFuB,CAA3B;IARW;IAYtB,OAAO,CAAC,WAAR,GAAsB,SAAC,SAAD;AAClB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,cAApB,EAAoC,SAApC;AACN,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV;IAFW;IAItB,OAAO,CAAC,aAAR,GAAwB,SAAC,SAAD;AACpB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,gBAApB,EAAsC,SAAtC;AACN,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV;IAFa;IAIxB,OAAO,CAAC,YAAR,GAAuB,SAAC,SAAD,EAAY,YAAZ;AACnB,UAAA;MAAA,IAAA,GAAO;QACH,aAAA,EAAe,YADZ;;MAGP,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,eAApB,EAAqC,SAArC;AACN,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV,EAAe,IAAf;IALY;IAOvB,OAAO,CAAC,cAAR,GAAyB,SAAC,SAAD;AACrB,UAAA;MAAA,GAAA,GAAM,WAAW,CAAC,OAAZ,CAAoB,iBAApB,EAAuC,SAAvC;AACN,aAAO,IAAI,CAAC,IAAL,CAAU,GAAV;IAFc;AAIzB,WAAO,SAAA;AACH,aAAO;QAAC,UAAA,EAAY,OAAb;;IADJ;EAtEA;;EAyEX,QAAQ,CAAC,OAAT,GAAmB,CAAC,SAAD,EAAY,SAAZ,EAAuB,2BAAvB;;EAEnB,MAAA,GAAS,OAAO,CAAC,MAAR,CAAe,iBAAf;;EACT,MAAM,CAAC,OAAP,CAAe,qBAAf,EAAsC,QAAtC;AAjGA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpDA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EAEV,QAAA,GAAW,KAAK,CAAC;;EAGX;IACF,cAAC,CAAC,OAAF,GAAY,CACR,YADQ;;IAIC,wBAAC,SAAD;MAAC,IAAC,CAAA,YAAD;IAAD;;6BAEb,IAAA,GAAM,SAAC,GAAD,EAAM,KAAN;AACF,UAAA;MAAA,IAAU,CAAI,GAAd;AAAA,eAAA;;MAEA,IAAG,GAAA,KAAO,OAAV;QACI,IAAA,GAAO,CAAA,CAAE,OAAF;QAEP,IAAG,IAAI,CAAC,MAAL,KAAe,CAAlB;UACI,IAAA,GAAO,CAAA,CAAE,iBAAF;UACP,CAAA,CAAE,MAAF,CAAS,CAAC,MAAV,CAAiB,IAAjB,EAFJ;;eAIA,IAAI,CAAC,IAAL,CAAU,KAAA,IAAS,EAAnB,EAPJ;OAAA,MAQK,IAAG,GAAG,CAAC,OAAJ,CAAY,KAAZ,CAAA,KAAsB,CAAzB;QACD,IAAA,GAAO,CAAA,CAAE,iBAAA,GAAkB,GAAlB,GAAsB,IAAxB;QAEP,IAAG,IAAI,CAAC,MAAL,KAAe,CAAlB;UACI,IAAA,GAAO,CAAA,CAAE,kBAAA,GAAmB,GAAnB,GAAuB,KAAzB;UACP,CAAA,CAAE,MAAF,CAAS,CAAC,MAAV,CAAiB,IAAjB,EAFJ;;eAIA,IAAI,CAAC,IAAL,CAAU,SAAV,EAAqB,KAAA,IAAS,EAA9B,EAPC;OAAA,MAAA;QASD,IAAA,GAAO,CAAA,CAAE,aAAA,GAAc,GAAd,GAAkB,IAApB;QAEP,IAAG,IAAI,CAAC,MAAL,KAAe,CAAlB;UACI,IAAA,GAAO,CAAA,CAAE,cAAA,GAAe,GAAf,GAAmB,KAArB;UACP,CAAA,CAAE,MAAF,CAAS,CAAC,MAAV,CAAiB,IAAjB,EAFJ;;eAIA,IAAI,CAAC,IAAL,CAAU,SAAV,EAAqB,KAAA,IAAS,EAA9B,EAfC;;IAXH;;6BA4BN,QAAA,GAAU,SAAC,KAAD;aACN,IAAC,CAAC,IAAF,CAAO,OAAP,EAAgB,KAAhB;IADM;;6BAGV,cAAA,GAAgB,SAAC,WAAD;aACZ,IAAC,CAAC,IAAF,CAAO,aAAP,EAAsB,QAAA,CAAS,WAAT,EAAsB,GAAtB,CAAtB;IADY;;6BAGhB,eAAA,GAAiB,SAAC,KAAD,EAAQ,WAAR;MACb,IAAC,CAAC,IAAF,CAAO,cAAP,EAAuB,SAAvB;MACA,IAAC,CAAC,IAAF,CAAO,cAAP,EAAuB,UAAvB;MACA,IAAC,CAAC,IAAF,CAAO,eAAP,EAAwB,KAAxB;MACA,IAAC,CAAC,IAAF,CAAO,qBAAP,EAA8B,QAAA,CAAS,WAAT,EAAsB,GAAtB,CAA9B;aACA,IAAC,CAAC,IAAF,CAAO,eAAP,EAA2B,MAAM,CAAC,QAAQ,CAAC,MAAjB,GAAwB,wBAAlD;IALa;;6BAOjB,iBAAA,GAAmB,SAAC,KAAD,EAAQ,WAAR;MACf,IAAC,CAAC,IAAF,CAAO,SAAP,EAAkB,QAAlB;MACA,IAAC,CAAC,IAAF,CAAO,cAAP,EAAuB,4BAAvB;MACA,IAAC,CAAC,IAAF,CAAO,UAAP,EAAmB,KAAnB;MACA,IAAC,CAAC,IAAF,CAAO,gBAAP,EAAyB,QAAA,CAAS,WAAT,EAAsB,GAAtB,CAAzB;MACA,IAAC,CAAC,IAAF,CAAO,UAAP,EAAsB,MAAM,CAAC,QAAQ,CAAC,MAAjB,GAAwB,wBAA7C;aACA,IAAC,CAAC,IAAF,CAAO,QAAP,EAAiB,MAAM,CAAC,QAAQ,CAAC,IAAjC;IANe;;6BAQnB,MAAA,GAAQ,SAAC,KAAD,EAAQ,WAAR;MACJ,IAAC,CAAC,QAAF,CAAW,KAAX;MACA,IAAC,CAAC,cAAF,CAAiB,WAAjB;MACA,IAAC,CAAC,eAAF,CAAkB,KAAlB,EAAyB,WAAzB;aACA,IAAC,CAAC,iBAAF,CAAoB,KAApB,EAA2B,WAA3B;IAJI;;6BAMR,iBAAA,GAAmB,SAAA;aACf,CAAA,CAAE,MAAF,CAAS,CAAC,MAAV,CACI,gHADJ;IADe;;6BAMnB,oBAAA,GAAsB,SAAA;aAClB,CAAA,CAAE,yBAAF,CAA4B,CAAC,MAA7B,CAAA;IADkB;;6BAGtB,KAAA,GAAO,SAAC,EAAD;MACH,IAAiB,IAAC,CAAC,QAAnB;QAAA,IAAC,CAAC,SAAF,CAAA,EAAA;;aAEA,IAAC,CAAC,SAAF,GAAc,IAAC,CAAA,SAAS,CAAC,gBAAX,CAA4B,EAA5B,EAAgC,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD;iBAC1C,KAAC,CAAC,MAAF,CAAS,KAAK,CAAC,KAAf,EAAsB,KAAK,CAAC,WAA5B;QAD0C;MAAA,CAAA,CAAA,CAAA,IAAA,CAAhC;IAHX;;;;;;EAOX,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,kBAAtC,EAA0D,cAA1D;AAtGA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3CA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EAEV,OAAA,GAAU,IAAC,CAAC,KAAK,CAAC;;EAEZ;IACF,kBAAC,CAAC,OAAF,GAAY,CACR,mBADQ,EAER,YAFQ,EAGR,aAHQ;;IAMC,4BAAC,eAAD,EAAmB,cAAnB,EAAoC,EAApC;MAAC,IAAC,CAAA,kBAAD;MAAkB,IAAC,CAAA,iBAAD;MAAiB,IAAC,CAAA,KAAD;MAC7C,IAAC,CAAC,KAAF,GAAU;MACV,IAAC,CAAC,SAAF,GAAc,SAAS,CAAC,GAAV,CAAA;MACd,IAAC,CAAC,aAAF,GAAkB,SAAS,CAAC,GAAV,CAAA;MAClB,IAAC,CAAC,QAAF,GAAa;MAEb,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,UAAjC,EAA6C,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAA7C;MACA,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,cAAjC,EAAiD,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAAjD;IAPS;;iCASb,eAAA,GAAiB,SAAA;MACb,IAAG,IAAC,CAAC,OAAF,CAAA,CAAA,KAAe,IAAlB;AACI,eAAO,KADX;;AAEA,aAAO;IAHM;;iCAKjB,OAAA,GAAS,SAAA;AACL,UAAA;MAAA,IAAG,CAAC,IAAC,CAAC,KAAN;QACI,QAAA,GAAW,IAAC,CAAA,cAAc,CAAC,GAAhB,CAAoB,UAApB;QAEX,IAAG,QAAH;UACI,QAAA,GAAW,SAAS,CAAC,MAAV,CAAiB,QAAjB;UACX,IAAC,CAAC,OAAF,CAAU,QAAV,EAFJ;SAHJ;;AAOA,aAAO,IAAC,CAAC;IARJ;;iCAUT,UAAA,GAAY,SAAA;MACR,IAAC,CAAC,KAAF,GAAU;MACV,IAAC,CAAC,SAAF,GAAc,SAAS,CAAC,GAAV,CAAA;MACd,IAAC,CAAC,aAAF,GAAkB,SAAS,CAAC,GAAV,CAAA;aAClB,IAAC,CAAC,QAAF,GAAa;IAJL;;iCAMZ,OAAA,GAAS,SAAC,IAAD;MACL,IAAC,CAAC,KAAF,GAAU;AAEV,aAAO,IAAC,CAAC,aAAF,CAAA;IAHF;;iCAKT,uBAAA,GAAyB,SAAC,QAAD;aACrB,IAAC,CAAA,eAAe,CAAC,uBAAjB,CAAyC,QAAzC,CAAkD,CAAC,IAAnD,CAAwD,CAAA,SAAA,KAAA;eAAA,SAAA;iBACpD,KAAC,CAAC,YAAF,CAAA;QADoD;MAAA,CAAA,CAAA,CAAA,IAAA,CAAxD;IADqB;;iCAIzB,YAAA,GAAc,SAAA;AACV,aAAO,IAAC,CAAA,eAAe,CAAC,mBAAjB,CAAqC,IAAC,CAAC,KAAK,CAAC,GAAR,CAAY,IAAZ,CAArC,CACH,CAAC,IADE,CACG,CAAA,SAAA,KAAA;eAAA,SAAC,QAAD;iBAAc,KAAC,CAAC,WAAF,CAAc,QAAd;QAAd;MAAA,CAAA,CAAA,CAAA,IAAA,CADH;IADG;;iCAId,cAAA,GAAgB,SAAC,OAAD;MACZ,IAAG,OAAH;QACI,IAAC,CAAC,QAAS,CAAA,OAAA,CAAX,GAAsB,MAD1B;OAAA,MAAA;QAGI,IAAC,CAAC,QAAF,GAAa;UACT,OAAA,EAAS,KADA;UAET,MAAA,EAAQ,KAFC;UAGT,SAAA,EAAW,KAHF;UAHjB;;aASA,IAAC,CAAA,EAAE,CAAC,IAAI,CAAC,cAAT,CAAwB,SAAxB,EAAmC,IAAC,CAAC,QAArC;IAVY;;iCAYhB,iBAAA,GAAmB,SAAA;AACf,aAAW,IAAA,OAAA,CAAQ,CAAA,SAAA,KAAA;eAAA,SAAC,OAAD;UACf,IAAG,KAAC,CAAC,QAAF,KAAc,IAAjB;YACI,OAAA,CAAQ,KAAC,CAAC,QAAV;AACA,mBAFJ;;iBAIA,KAAC,CAAA,EAAE,CAAC,IAAI,CAAC,cAAT,CAAwB,SAAxB,CACI,CAAC,IADL,CACU,SAAC,MAAD;YACF,KAAC,CAAC,QAAF,GAAa;mBACb,OAAA,CAAQ,KAAC,CAAC,QAAV;UAFE,CADV,CAII,CAAC,OAAD,CAJJ,CAIW,SAAA;YAEH,KAAC,CAAC,QAAF,GAAa;cACT,OAAA,EAAS,IADA;cAET,MAAA,EAAQ,IAFC;cAGT,SAAA,EAAW,IAHF;;YAMb,KAAC,CAAA,EAAE,CAAC,IAAI,CAAC,iBAAT,CAA2B,SAA3B,EAAsC,KAAC,CAAC,QAAxC;mBAEA,OAAA,CAAQ,KAAC,CAAC,QAAV;UAVG,CAJX;QALe;MAAA,CAAA,CAAA,CAAA,IAAA,CAAR;IADI;;iCAsBnB,aAAA,GAAe,SAAA;AACX,aAAO,OAAO,CAAC,GAAR,CAAY,CACf,IAAC,CAAC,YAAF,CAAA,CADe,CAAZ;IADI;;iCAKf,WAAA,GAAa,SAAC,QAAD;MACT,IAAC,CAAC,SAAF,GAAc,IAAC,CAAC,SAAS,CAAC,GAAZ,CAAgB,KAAhB,EAAuB,QAAvB;MACd,IAAC,CAAC,SAAF,GAAc,IAAC,CAAC,SAAS,CAAC,GAAZ,CAAgB,SAAhB,EAA2B,QAAQ,CAAC,KAAT,CAAe,CAAf,EAAkB,EAAlB,CAA3B;MAEd,IAAC,CAAC,aAAF,GAAkB,SAAS,CAAC,MAAV,CAAiB,OAAA,CAAQ,QAAQ,CAAC,IAAT,CAAA,CAAR,EAAyB,SAAC,CAAD;eAAO,CAAC,CAAC;MAAT,CAAzB,CAAjB;AAElB,aAAO,IAAC,CAAC;IANA;;;;;;EAQjB,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,sBAAtC,EAA8D,kBAA9D;AAxHA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxCA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EAEJ;IACF,cAAC,CAAC,OAAF,GAAY,CACR,mBADQ,EAER,mBAFQ;;IAKC,wBAAC,eAAD,EAAmB,QAAnB;MAAC,IAAC,CAAA,kBAAD;MAAkB,IAAC,CAAA,WAAD;MAC5B,IAAC,CAAC,QAAF,GAAa;MACb,IAAC,CAAC,QAAF,GAAa;MACb,IAAC,CAAC,mBAAF,GAAwB,SAAS,CAAC,IAAV,CAAA;MACxB,IAAC,CAAC,cAAF,GAAmB,SAAS,CAAC,IAAV,CAAA;MAEnB,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,SAAjC,EAA4C,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAA5C;MACA,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,SAAjC,EAA4C,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAA5C;MACA,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,oBAAjC,EAAuD,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAAvD;MACA,KAAK,CAAC,uBAAN,CAA8B,IAA9B,EAAiC,eAAjC,EAAkD,CAAA,SAAA,KAAA;eAAA,SAAA;AAAM,iBAAO,KAAC,CAAC;QAAf;MAAA,CAAA,CAAA,CAAA,IAAA,CAAlD;IATS;;6BAWb,UAAA,GAAY,SAAC,OAAD;MACR,IAAC,CAAC,QAAF,GAAa;MAEb,IAAG,OAAH;eACI,IAAC,CAAC,mBAAF,GAAwB,IAAC,CAAC,mBAAmB,CAAC,IAAtB,CAA2B,IAAC,CAAC,QAA7B,EAD5B;OAAA,MAAA;eAGI,IAAC,CAAC,mBAAF,GAAwB,SAAS,CAAC,IAAV,CAAA,EAH5B;;IAHQ;;6BAQZ,gBAAA,GAAkB,SAAC,KAAD;AACd,aAAW,IAAA,OAAA,CAAQ,CAAA,SAAA,KAAA;eAAA,SAAC,OAAD,EAAU,MAAV;UACf,IAAG,CAAC,KAAC,CAAC,OAAH,IAAc,KAAC,CAAC,OAAO,CAAC,GAAV,CAAc,MAAd,CAAA,KAAyB,KAA1C;mBACI,KAAC,CAAA,eACG,CAAC,gBADL,CACsB,KADtB,CAEI,CAAC,IAFL,CAEU,SAAC,OAAD;cACF,KAAC,CAAC,UAAF,CAAa,OAAb;qBACA,OAAA,CAAA;YAFE,CAFV,CAKI,CAAC,OAAD,CALJ,CAKW,SAAC,GAAD;qBACH,KAAC,CAAA,QAAQ,CAAC,QAAV,CAAmB,GAAnB;YADG,CALX,EADJ;WAAA,MAAA;mBASK,OAAA,CAAA,EATL;;QADe;MAAA,CAAA,CAAA,CAAA,IAAA,CAAR;IADG;;6BAalB,UAAA,GAAY,SAAC,OAAD;MACR,IAAC,CAAC,QAAF,GAAa;aACb,IAAC,CAAC,cAAF,GAAmB,IAAC,CAAC,QAAQ,CAAC,GAAX,CAAe,SAAf,CAAyB,CAAC,MAA1B,CAAiC,SAAC,MAAD;eAAY,MAAM,CAAC,GAAP,CAAW,WAAX;MAAZ,CAAjC;IAFX;;6BAIZ,YAAA,GAAc,SAAA;MACV,IAAC,CAAC,QAAF,GAAa;MACb,IAAC,CAAC,cAAF,GAAmB,SAAS,CAAC,IAAV,CAAA;MACnB,IAAC,CAAC,QAAF,GAAa;aACb,IAAC,CAAC,mBAAF,GAAwB,SAAS,CAAC,IAAV,CAAA;IAJd;;6BAMd,YAAA,GAAc,SAAA;AACV,UAAA;MAAA,KAAA,GAAQ,IAAC,CAAC,OAAO,CAAC,GAAV,CAAc,MAAd;AAER,aAAO,IAAC,CAAA,eAAe,CAAC,gBAAjB,CAAkC,KAAlC,CAAwC,CAAC,IAAzC,CAA8C,CAAA,SAAA,KAAA;eAAA,SAAC,OAAD;iBAAa,KAAC,CAAC,UAAF,CAAa,OAAb;QAAb;MAAA,CAAA,CAAA,CAAA,IAAA,CAA9C;IAHG;;;;;;EAKlB,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,kBAAtC,EAA0D,cAA1D;AA1EA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1EA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA,mBAAA;IAAA;;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EAGJ;;;;;;;;;KAAqB,KAAK,CAAC,OAAN,GAAgB,SAAA;WACvC;MAAA,GAAA,EAAK,SAAC,SAAD;AACD,YAAA;QAAA,YAAA,GAAe,CAAA,CAAE,wBAAF;QAEf,IAAG,YAAY,CAAC,MAAb,KAAuB,CAA1B;UACI,YAAA,GAAe,CAAA,CAAE,iDAAF;UACf,CAAA,CAAE,MAAF,CAAS,CAAC,MAAV,CAAiB,YAAjB,EAFJ;;eAIA,YAAY,CAAC,IAAb,CAAkB,MAAlB,EAA0B,gBAAA,GAAiB,SAAjB,GAA2B,MAArD;MAPC,CAAL;;EADuC;;EAW3C,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,gBAAtC,EAAwD,YAAxD;AAjCA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA,+BAAA;IAAA;;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EACV,WAAA,GAAc,KAAK,CAAC;;EAGd;;;IACF,WAAC,CAAC,OAAF,GAAY,CAAC,aAAD;;IAEC,qBAAC,EAAD;MAAC,IAAC,CAAA,KAAD;MACV,WAAA,CAAY,IAAZ;IADS;;0BAGb,iBAAA,GAAmB,SAAC,QAAD;AACf,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,iBAAV,CAA4B,QAA5B;IADQ;;0BAGnB,WAAA,GAAa,SAAC,MAAD;AACT,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,WAAV,CAAsB,MAAtB;IADE;;0BAGb,QAAA,GAAU,SAAC,MAAD,EAAS,UAAT,EAAqB,UAArB,EAAiC,SAAjC;AACN,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,QAAV,CAAmB,MAAnB,EAA2B,UAA3B,EAAuC,UAAvC,EAAmD,SAAnD;IADD;;0BAGV,QAAA,GAAU,SAAC,MAAD,EAAS,UAAT,EAAqB,UAArB,EAAiC,SAAjC;AACN,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,QAAV,CAAmB,MAAnB,EAA2B,UAA3B,EAAuC,UAAvC,EAAmD,SAAnD;IADD;;0BAGV,UAAA,GAAY,SAAC,MAAD,EAAS,UAAT,EAAqB,UAArB,EAAiC,SAAjC;AACR,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,UAAV,CAAqB,MAArB,EAA6B,UAA7B,EAAyC,UAAzC,EAAqD,SAArD;IADC;;0BAGZ,QAAA,GAAU,SAAC,MAAD;AACN,aAAO,IAAC,CAAA,EAAE,CAAC,KAAK,CAAC,QAAV,CAAmB,MAAnB;IADD;;0BAGV,4BAAA,GAA8B,SAAC,MAAD,EAAS,QAAT;AAC1B,aAAO,IAAC,CAAC,WAAF,CAAc,MAAd,CACH,CAAC,IADE,CACG,SAAC,QAAD;QACF,QAAA,GAAW,QAAQ,CAAC,GAAT,CAAa,SAAC,OAAD;AACpB,cAAA;UAAA,gBAAA,GAAmB,QAAQ,CAAC,MAAT,CAAgB,SAAC,OAAD;AAC/B,gBAAA;YAAA,SAAA,GAAY,OAAO,CAAC,GAAR,CAAY,IAAZ;AACZ,mBAAO,OAAO,CAAC,GAAR,CAAY,SAAZ,CAAsB,CAAC,OAAvB,CAA+B,SAA/B,CAAA,KAA6C,CAAC;UAFtB,CAAhB;UAInB,OAAA,GAAU,OAAO,CAAC,GAAR,CAAY,UAAZ,EAAwB,gBAAxB;AAEV,iBAAO;QAPa,CAAb;AASX,eAAO;MAVL,CADH;IADmB;;;;KAxBR,KAAK,CAAC;;EAsChC,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,eAAtC,EAAuD,WAAvD;AA7DA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA,QAAA;IAAA;;;EAmBM;;;IACF,QAAC,CAAC,OAAF,GAAY,CACR,IADQ,EAER,WAFQ,EAGR,YAHQ;;IAMC,kBAAC,CAAD,EAAK,QAAL,EAAgB,OAAhB;MAAC,IAAC,CAAA,IAAD;MAAI,IAAC,CAAA,WAAD;MAAW,IAAC,CAAA,UAAD;IAAhB;;uBAEb,QAAA,GAAU,SAAA;MACN,IAAC,CAAA,QAAQ,CAAC,IAAV,CAAe,IAAC,CAAA,OAAO,CAAC,OAAT,CAAiB,WAAjB,CAAf;aACA,IAAC,CAAA,QAAQ,CAAC,OAAV,CAAA;IAFM;;uBAIV,gBAAA,GAAkB,SAAA;MACd,IAAC,CAAA,QAAQ,CAAC,IAAV,CAAe,IAAC,CAAA,OAAO,CAAC,OAAT,CAAiB,mBAAjB,CAAf;aACA,IAAC,CAAA,QAAQ,CAAC,OAAV,CAAA;IAFc;;uBAIlB,QAAA,GAAU,SAAC,GAAD;MACN,IAAG,GAAH;QACI,IAAG,GAAG,CAAC,MAAJ,KAAc,GAAjB;UACI,IAAC,CAAC,QAAF,CAAA,EADJ;SAAA,MAGK,IAAG,GAAG,CAAC,MAAJ,KAAc,GAAjB;UACD,IAAC,CAAC,gBAAF,CAAA,EADC;SAJT;;AAOA,aAAO,IAAC,CAAA,CAAC,CAAC,MAAH,CAAU,GAAV;IARD;;;;KAjBS,KAAK,CAAC;;EA2B7B,OAAO,CAAC,MAAR,CAAe,aAAf,CAA6B,CAAC,OAA9B,CAAsC,mBAAtC,EAA2D,QAA3D;AA9CA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,+BAAA,GAAkC,SAAC,QAAD,EAAW,QAAX;AAC9B,QAAA;IAAA,mBAAA,GAAsB,CAAC,MAAD,EAAS,OAAT,EAAkB,MAAlB,EAA0B,MAA1B,EAAkC,MAAlC;IAEtB,OAAA,GAAU,SAAC,GAAD;MACN,GAAA,GAAM,GAAG,CAAC,WAAJ,CAAA;AAEN,aAAO,CAAC,CAAC,IAAF,CAAO,mBAAP,EAA4B,SAAC,SAAD;AAC/B,eAAO,GAAG,CAAC,OAAJ,CAAY,SAAZ,EAAuB,GAAA,GAAM,SAAS,CAAC,MAAvC,CAAA,KAAkD,CAAC;MAD3B,CAA5B;IAHD;IAMV,IAAA,GAAO,SAAC,KAAD,EAAQ,EAAR;AACH,UAAA;MAAA,QAAA,GAAW,OAAA,CAAQ,KAAK,CAAC,UAAU,CAAC,GAAjB,CAAqB,KAArB,CAAR;MAEX,IAAG,QAAH;QACI,YAAA,GAAe,QAAQ,CAAC,GAAT,CAAa,4EAAb,EADnB;OAAA,MAAA;QAGI,YAAA,GAAe,QAAQ,CAAC,GAAT,CAAa,sEAAb,EAHnB;;MAKA,EAAE,CAAC,IAAH,CAAQ,YAAR;MACA,QAAA,CAAS,EAAE,CAAC,QAAH,CAAA,CAAT,CAAA,CAAwB,KAAxB;aAEA,EAAE,CAAC,IAAH,CAAQ,KAAR,CAAc,CAAC,KAAf,CAAqB,SAAA;eAAM,IAAC,CAAC,MAAF,CAAA;MAAN,CAArB;IAXG;AAaP,WAAO;MACH,IAAA,EAAM,IADH;MAEH,KAAA,EAAO;QACH,UAAA,EAAY,2BADT;OAFJ;;EAtBuB;;EA6BlC,+BAA+B,CAAC,OAAhC,GAA0C,CACtC,aADsC,EAEtC,UAFsC;;EAK1C,OAAO,CAAC,MAAR,CAAe,mBAAf,CACI,CAAC,SADL,CACe,0BADf,EAC2C,+BAD3C;AArDA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,SAAA,GAAY,IAAC,CAAC,KAAK,CAAC;;EAEd;IACF,qBAAC,CAAC,OAAF,GAAY,CACR,YADQ;;oCAIZ,oBAAA,GAAsB;MAClB,QAAA,EAAU,sBADQ;MAElB,SAAA,EAAW,uBAFO;MAGlB,kBAAA,EAAoB,2BAHF;MAIlB,QAAA,EAAU,sBAJQ;MAKlB,aAAA,EAAe,2BALG;MAMlB,UAAA,EAAY,wBANM;MAOlB,UAAA,EAAY,wBAPM;MAQlB,MAAA,EAAQ,oBARU;MASlB,YAAA,EAAc,wBATI;MAUlB,YAAA,EAAc,0BAVI;;;oCAatB,OAAA,GAAS;MACL,QAAA,EAAU,SAAC,QAAD,EAAW,KAAX;AACN,YAAA;QAAA,IAAA,GAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,CAAf;QAEP,IAAG,IAAI,CAAC,GAAL,CAAS,oBAAT,CAAH;UACI,UAAA,GAAa,IAAC,CAAA,SAAS,CAAC,OAAX,CAAmB,yBAAnB,EAA8C;YAAC,QAAA,EAAU,IAAI,CAAC,GAAL,CAAS,UAAT,CAAX;WAA9C;UACb,GAAA,GAAM;AAEN,iBAAO,IAAC,CAAC,QAAF,CAAW,GAAX,EAAgB,IAAI,CAAC,GAAL,CAAS,MAAT,CAAhB,EAAkC,UAAlC,EAJX;SAAA,MAAA;AAMI,iBAAO,IAAC,CAAC,gBAAF,CAAmB,IAAI,CAAC,GAAL,CAAS,MAAT,CAAnB,EANX;;MAHM,CADL;MAYL,UAAA,EAAY,SAAC,QAAD,EAAW,KAAX;AACR,YAAA;QAAA,UAAA,GAAa,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf;AAEb,eAAO,IAAC,CAAA,SAAS,CAAC,OAAX,CAAmB,IAAC,CAAC,oBAAqB,CAAA,UAAA,CAA1C;MAHC,CAZP;MAiBL,YAAA,EAAc,SAAC,QAAD,EAAW,KAAX;AACV,YAAA;QAAA,GAAA,GAAM;AAEN,eAAO,IAAC,CAAC,QAAF,CAAW,GAAX,EAAgB,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,SAAT,EAAoB,MAApB,CAAf,CAAhB;MAHG,CAjBT;MAsBL,SAAA,EAAW,SAAC,QAAD,EAAW,KAAX;AACP,YAAA;QAAA,IAAG,CAAC,CAAC,OAAF,CAAU,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,CAAf,CAA+C,CAAC,IAAhD,CAAA,CAAV,CAAH;UACI,KAAA,GAAQ,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,CAAf,CAA+C,CAAC,GAAhD,CAAoD,CAApD;UAGR,IAAG,KAAA,KAAS,IAAT,IAAiB,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,aAArE;YACI,KAAA,GAAQ,IAAC,CAAA,SAAS,CAAC,OAAX,CAAmB,4BAAnB,EADZ;;AAGA,iBAAO,MAPX;SAAA,MAAA;AASI,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,CAAf,CAA+C,CAAC,KAAhD,CAAA,CAAuD,CAAC,GAAxD,CAA4D,CAA5D,EATX;;MADO,CAtBN;MAkCL,WAAA,EAAa,SAAC,QAAD,EAAW,KAAX;AACT,YAAA;QAAA,GAAA,GAAM;AAEN,eAAO,IAAC,CAAC,QAAF,CAAW,GAAX,EAAgB,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,WAAT,EAAsB,MAAtB,CAAf,CAAhB;MAHE,CAlCR;MAuCL,OAAA,EAAS,SAAC,QAAD,EAAW,KAAX;AACL,YAAA;QAAA,GAAA,GAAM,IAAC,CAAC,eAAF,CAAkB,QAAlB,EAA4B,KAA5B,CAAkC,CAAC,GAAnC,CAAuC,WAAvC;QAEN,QAAA,GAAW;UAAC,GAAA,EAAK,kBAAN;;QACX,GAAA,GAAM,IAAC,CAAC,gBAAF,CAAmB,QAAnB;QAEN,IAAA,GAAO,GAAA,GAAM,GAAG,CAAC,GAAJ,CAAQ,KAAR,CAAN,GAAuB,GAAvB,GAA6B,GAAG,CAAC,GAAJ,CAAQ,SAAR;AAEpC,eAAO,IAAC,CAAC,QAAF,CAAW,GAAX,EAAgB,IAAhB;MARF,CAvCJ;MAiDL,QAAA,EAAU,SAAC,QAAD,EAAW,KAAX;AACN,YAAA;QAAA,GAAA,GAAM,IAAC,CAAC,eAAF,CAAkB,QAAlB,EAA4B,KAA5B;QACN,GAAA,GAAM,IAAC,CAAC,gBAAF,CAAmB,KAAnB;QAEN,IAAG,KAAK,CAAC,GAAN,KAAa,UAAhB;UACI,IAAA,GAAO,SAAA,CAAU,GAAG,CAAC,GAAJ,CAAQ,MAAR,CAAV,EADX;SAAA,MAEK,IAAG,KAAK,CAAC,GAAN,KAAa,WAAhB;UACD,IAAA,GAAO,GAAG,CAAC,GAAJ,CAAQ,MAAR,EADN;SAAA,MAAA;UAGD,IAAA,GAAO,GAAA,GAAM,GAAG,CAAC,GAAJ,CAAQ,KAAR,CAAN,GAAuB,GAAvB,GAA6B,GAAG,CAAC,GAAJ,CAAQ,SAAR,EAHnC;;AAKL,eAAO,IAAC,CAAC,QAAF,CAAW,GAAX,EAAgB,IAAhB;MAXD,CAjDL;MA8DL,SAAA,EAAW,SAAC,QAAD,EAAW,KAAX;AACP,eAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,CAAf,CAA+C,CAAC,MAAhD,CAAA,CAAwD,CAAC,KAAzD,CAAA;MADA,CA9DN;;;IAkEI,+BAAC,SAAD;MAAC,IAAC,CAAA,YAAD;IAAD;;oCAGb,qBAAA,GAAuB,SAAC,KAAD,EAAQ,QAAR,EAAkB,KAAlB;AACnB,aAAO,IAAC,CAAC,OAAQ,CAAA,KAAA,CAAM,CAAC,IAAjB,CAAsB,IAAtB,EAA4B,QAA5B,EAAsC,KAAtC;IADY;;oCAGvB,eAAA,GAAiB,SAAC,QAAD,EAAW,KAAX;AACb,aAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,KAAK,CAAC,GAAf,CAAf;IADM;;oCAGjB,gBAAA,GAAkB,SAAC,KAAD;AACd,UAAA;MAAA,GAAA,GAAM;QACF,OAAA,EAAS,CAAC,uBAAD,EAA0B,yFAA1B,CADP;QAEF,UAAA,EAAY,CAAC,mBAAD,EAAsB,2FAAtB,CAFV;QAGF,MAAA,EAAQ,CAAC,sBAAD,EAAyB,yFAAzB,CAHN;QAIF,WAAA,EAAa,CAAC,4BAAD,EAA+B,yFAA/B,CAJX;QAKF,kBAAA,EAAoB,CAAC,4BAAD,EAA+B,sGAA/B,CALlB;QAMF,WAAA,EAAa,CAAC,mBAAD,EAAsB,6FAAtB,CANX;;AASN,aAAO,GAAI,CAAA,KAAK,CAAC,GAAN,CAAW,CAAA,CAAA,CAAf,GAAoB,GAAI,CAAA,KAAK,CAAC,GAAN,CAAW,CAAA,CAAA;IAV5B;;oCAYlB,QAAA,GAAU,SAAC,GAAD,EAAM,IAAN,EAAY,KAAZ;MACN,KAAA,GAAQ,KAAA,IAAS;AAEjB,aAAO,CAAA,CAAE,KAAF,CACH,CAAC,IADE,CACG,QADH,EACa,GADb,CAEH,CAAC,IAFE,CAEG,IAFH,CAGH,CAAC,IAHE,CAGG,OAHH,EAGY,KAHZ,CAIH,CAAC,IAJE,CAIG,WAJH;IAHD;;oCASV,gBAAA,GAAkB,SAAC,IAAD;AACd,UAAA;MAAA,KAAA,GAAQ,KAAA,IAAS;AAEjB,aAAO,CAAA,CAAE,QAAF,CACH,CAAC,QADE,CACO,UADP,CAEH,CAAC,IAFE,CAEG,IAFH,CAGH,CAAC,IAHE,CAGG,WAHH;IAHO;;oCAQlB,UAAA,GAAY,SAAC,QAAD,EAAW,KAAX,EAAkB,aAAlB;AACR,UAAA;MAAA,MAAA,GAAS;MAET,aAAa,CAAC,gBAAgB,CAAC,OAA/B,CAAuC,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD;iBACnC,MAAO,CAAA,KAAA,CAAP,GAAgB,KAAC,CAAC,qBAAF,CAAwB,KAAxB,EAA+B,QAA/B,EAAyC,KAAzC;QADmB;MAAA,CAAA,CAAA,CAAA,IAAA,CAAvC;AAGA,aAAO;IANC;;oCAQZ,QAAA,GAAU,SAAC,QAAD,EAAW,KAAX,EAAkB,IAAlB;AACN,aAAO,IAAC,CAAA,SAAS,CAAC,OAAX,CAAmB,IAAI,CAAC,GAAxB,EAA6B,IAAC,CAAC,UAAF,CAAa,QAAb,EAAuB,KAAvB,EAA8B,IAA9B,CAA7B;IADD;;;;;;EAGd,OAAO,CAAC,MAAR,CAAe,mBAAf,CACI,CAAC,OADL,CACa,yBADb,EACwC,qBADxC;AA1JA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,YAAA,GAAe,SAAC,QAAD,EAAW,KAAX;AACX,QAAA;IAAA,KAAA,GAAQ;MACJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa;QADjB,CADX;QAGI,GAAA,EAAK,qBAHT;QAII,gBAAA,EAAkB,CAAC,cAAD,CAJtB;QAKI,MAAA,EAAQ,SAAC,QAAD;AACJ,iBAAO,SAAS,CAAC,GAAV,CAAc;YACjB,IAAA,EAAM,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,CAAf,CADW;YAEjB,IAAA,EAAM,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,CAAf,CAFW;WAAd;QADH,CALZ;OADI,EAYJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,SAAb,IAA0B,KAAK,CAAC,IAAN,KAAc;QAD5C,CADX;QAGI,GAAA,EAAK,sBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,CAJtB;QAKI,WAAA,EAAa,SAAC,QAAD;AACT,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,SAAT,EAAoB,aAApB,CAAf;QADE,CALjB;OAZI,EAoBJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,IAAN,KAAc,QAAd,IACF,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CADE,IAEF,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QAHnD,CADX;QAKI,GAAA,EAAK,4BALT;QAMI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CANtB;OApBI,EA4BJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IAA4B,KAAK,CAAC,IAAN,KAAc;QAD9C,CADX;QAGI,GAAA,EAAK,qBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,CAJtB;OA5BI,EAkCJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,OAAb,IAAwB,KAAK,CAAC,IAAN,KAAc;QAD1C,CADX;QAGI,GAAA,EAAK,wBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,CAJtB;OAlCI,EAwCJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,UAAb,IAA2B,KAAK,CAAC,IAAN,KAAc;QAD7C,CADX;QAGI,GAAA,EAAK,uBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,CAJtB;OAxCI,EA8CJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IAAuB,KAAK,CAAC,IAAN,KAAc,QAArC,IAAiD,CAAC,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,EAAiB,WAAjB,CAAf;QADtD,CADX;QAGI,GAAA,EAAK,uBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,CAJtB;OA9CI,EAoDJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IAAuB,KAAK,CAAC,IAAN,KAAc,QAArC,IAAiD,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,EAAiB,WAAjB,CAAf;QADrD,CADX;QAGI,GAAA,EAAK,+BAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,EAAyC,SAAzC,CAJtB;OApDI,EA0DJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IAA4B,KAAK,CAAC,IAAN,KAAc;QAD9C,CADX;QAGI,GAAA,EAAK,4BAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,cAAb,EAA6B,UAA7B,CAJtB;OA1DI,EAgEJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,SAAT,CAAf,CAAA,IAAuC,KAAK,CAAC,GAAN,KAAa;QADxD,CADX;QAGI,GAAA,EAAK,yBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAJtB;QAKI,WAAA,EAAa,SAAC,QAAD;AACT,iBAAO,CAAA,CAAE,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,cAAT,CAAf,CAAF,CAA2C,CAAC,IAA5C,CAAA;QADE,CALjB;OAhEI,EAwEJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,SAAT,CAAf,CAAA,IAAuC,KAAK,CAAC,GAAN,KAAa;QADxD,CADX;QAGI,GAAA,EAAK,4BAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAJtB;QAKI,WAAA,EAAa,SAAC,QAAD;AACT,iBAAO,CAAA,CAAE,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,cAAT,CAAf,CAAF,CAA2C,CAAC,IAA5C,CAAA;QADE,CALjB;OAxEI,EAgFJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,SAAT,CAAf,CAAA,IAAuC,KAAK,CAAC,GAAN,KAAa;QADxD,CADX;QAGI,GAAA,EAAK,2BAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAJtB;QAKI,WAAA,EAAa,SAAC,QAAD;AACT,iBAAO,CAAA,CAAE,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,cAAT,CAAf,CAAF,CAA2C,CAAC,IAA5C,CAAA;QADE,CALjB;OAhFI,EAwFJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAAA,IACD,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,eADhD,IAED,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,eAAhC,CAAf,CAFC,IAGD,KAAK,CAAC,IAAN,KAAc;QAJjB,CADX;QAMI,GAAA,EAAK,mBANT;QAOI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAPtB;OAxFI,EAiGJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;UACH,IAAG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAAA,IACG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,eADpD,IAEG,KAAK,CAAC,IAAN,KAAc,QAFpB;AAII,mBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,WAAhC,CAAf,CAA4D,CAAC,GAA7D,CAAiE,CAAjE,CAAA,KAAuE,KAJlF;;AAMA,iBAAO;QAPJ,CADX;QASI,GAAA,EAAK,oCATT;QAUI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAVtB;OAjGI,EA6GJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAAA,IACD,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,eADhD,IAED,KAAK,CAAC,IAAN,KAAc;QAHjB,CADX;QAKI,GAAA,EAAK,6BALT;QAMI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,EAAyB,aAAzB,CANtB;OA7GI,EAqHJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;UACH,IAAG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAAA,IACG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,SADpD,IAEG,KAAK,CAAC,IAAN,KAAc,QAFpB;AAGI,mBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,YAAhC,CAAf,CAA6D,CAAC,GAA9D,CAAkE,CAAlE,CAAA,KAAwE,KAHnF;;AAKA,iBAAO;QANJ,CADX;QAQI,GAAA,EAAK,kBART;QASI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CATtB;QAUI,WAAA,EAAa,SAAC,QAAD;UACT,IAAG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,mBAAhC,CAAf,CAAH;AACI,mBAAO,CAAA,CAAE,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,mBAAhC,CAAf,CAAoE,CAAC,GAArE,CAAyE,CAAzE,CAAF,CAA8E,CAAC,IAA/E,CAAA,EADX;WAAA,MAAA;AAGI,mBAAO,MAHX;;QADS,CAVjB;OArHI,EAqIJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;UACH,IAAG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAAA,IACG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,SADpD,IAEG,KAAK,CAAC,IAAN,KAAc,QAFpB;AAGI,mBAAO,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,YAAhC,CAAf,CAA6D,CAAC,GAA9D,CAAkE,CAAlE,CAAA,KAAwE,MAHnF;;AAKA,iBAAO;QANJ,CADX;QAQI,GAAA,EAAK,oBART;QASI,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CATtB;OArII,EAgJJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IAA4B,KAAK,CAAC,IAAN,KAAc;QAD9C,CADX;QAGI,GAAA,EAAK,4BAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAJtB;OAhJI,EAsJJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,UAAb,IAA2B,KAAK,CAAC,IAAN,KAAc;QAD7C,CADX;QAGI,GAAA,EAAK,uBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,EAAa,UAAb,CAJtB;OAtJI,EA4JJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAFG,IAGH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QAJlD,CADX;QAMI,GAAA,EAAK,4BANT;QAOI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,WAAvC,EAAoD,WAApD,CAPtB;OA5JI,EAqKJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAFG,IAGH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QAJlD,CADX;QAMI,GAAA,EAAK,qBANT;QAOI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,CAPtB;OArKI,EA8KJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,WAAb,IACH,KAAK,CAAC,IAAN,KAAc;QAFf,CADX;QAII,GAAA,EAAK,oCAJT;QAKI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,WAAvC,CALtB;OA9KI,EAqLJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,OAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAFG,IAGH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QAJlD,CADX;QAMI,GAAA,EAAK,wBANT;QAOI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,CAPtB;OArLI,EA8LJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,OAAb,IACH,KAAK,CAAC,IAAN,KAAc;QAFf,CADX;QAII,GAAA,EAAK,uCAJT;QAKI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,WAAvC,CALtB;OA9LI,EAqMJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,CAAC,QAAQ,CAAC,KAAT,CAAe,MAAf,EAAuB,MAAvB,EAA+B,WAA/B,CAFE,IAGH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAHG,IAIH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QALlD,CADX;QAOI,GAAA,EAAK,uBAPT;QAQI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,CARtB;OArMI,EA+MJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,QAAQ,CAAC,KAAT,CAAe,MAAf,EAAuB,MAAvB,EAA+B,WAA/B,CAFG,IAGH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,CAAf,CAHG,IAIH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD;QALlD,CADX;QAOI,GAAA,EAAK,+BAPT;QAQI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,SAAvC,CARtB;OA/MI,EAyNJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,CAAC,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,EAAiB,WAAjB,CAAf;QAHF,CADX;QAKI,GAAA,EAAK,sCALT;QAMI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,WAAvC,CANtB;OAzNI,EAiOJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IACH,KAAK,CAAC,IAAN,KAAc,QADX,IAEH,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,MAAT,EAAiB,WAAjB,CAAf;QAHD,CADX;QAKI,GAAA,EAAK,yCALT;QAMI,gBAAA,EAAkB,CAAC,UAAD,EAAa,YAAb,EAA2B,UAA3B,EAAuC,SAAvC,EAAkD,WAAlD,CANtB;OAjOI,EAyOJ;QACI,KAAA,EAAO,SAAC,QAAD,EAAW,KAAX;AACH,iBAAO,KAAK,CAAC,GAAN,KAAa,MAAb,IAAuB,KAAK,CAAC,IAAN,KAAc;QADzC,CADX;QAGI,GAAA,EAAK,mBAHT;QAII,gBAAA,EAAkB,CAAC,UAAD,CAJtB;OAzOI;;AAiPR,WAAO,CAAC,CAAC,IAAF,CAAO,KAAP,EAAc,SAAC,GAAD;AACjB,aAAO,GAAG,CAAC,KAAJ,CAAU,QAAV,EAAoB,KAApB;IADU,CAAd;EAlPI;;EAqPT;;;+BACF,OAAA,GAAS,SAAC,QAAD,EAAW,KAAX;aAAqB,YAAA,CAAa,QAAb,EAAuB,KAAvB;IAArB;;;;;;EAEb,OAAO,CAAC,MAAR,CAAe,mBAAf,CACI,CAAC,OADL,CACa,wBADb,EACuC,gBADvC;AA3QA;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnCA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,8BAAA,GAAiC,SAAA;AAC7B,QAAA;IAAA,GAAA,GAAM;IAEN,GAAG,CAAC,QAAJ,GAAe,SAAC,MAAD;AACX,UAAA;MAAA,IAAA,GAAO;MACP,KAAA,GAAQ,SAAS,CAAC,IAAV,CAAA;MAER,MAAM,CAAC,QAAP,GAAkB,MAAM,CAAC,QAAP,IAAmB;MAErC,IAAA,GAAO,SAAA;QACH,KAAA,GAAQ,SAAS,CAAC,IAAV,CAAA;AACR,eAAO,UAAA,CAAA;MAFJ;MAIP,UAAA,GAAa,SAAA;eACT,MAAM,CAAC,KAAP,CAAa,IAAb,CAAkB,CAAC,IAAnB,CAAwB,SAAC,QAAD;AACpB,cAAA;UAAA,IAAA;UAEA,IAAA,GAAO,QAAQ,CAAC,GAAT,CAAa,MAAb;UAEP,IAAG,MAAM,CAAC,MAAV;YACI,IAAA,GAAO,MAAM,CAAC,MAAP,CAAc,IAAd,EADX;;UAGA,IAAG,MAAM,CAAC,GAAV;YACI,IAAA,GAAO,IAAI,CAAC,GAAL,CAAS,MAAM,CAAC,GAAhB,EADX;;UAGA,KAAA,GAAQ,KAAK,CAAC,MAAN,CAAa,IAAb;UAER,IAAG,KAAK,CAAC,IAAN,GAAa,MAAM,CAAC,QAApB,IAAgC,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAnC;AACI,mBAAO,UAAA,CAAA,EADX;;AAGA,iBAAO,SAAS,CAAC,GAAV,CAAc;YACjB,KAAA,EAAO,KADU;YAEjB,IAAA,EAAM,QAAQ,CAAC,GAAT,CAAa,MAAb,CAFW;WAAd;QAhBa,CAAxB;MADS;AAsBb,aAAO;QACH,IAAA,EAAM,SAAA;iBAAM,IAAA,CAAA;QAAN,CADH;;IAhCI;AAoCf,WAAO;EAvCsB;;EAyCjC,OAAO,CAAC,MAAR,CAAe,mBAAf,CAAmC,CAAC,OAApC,CAA4C,yCAA5C,EAAuF,8BAAvF;AA5DA;;;;ACAA;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA,oCAAA;IAAA;;;EAqBA,KAAA,GAAQ,IAAC,CAAC;;EAEV,KAAA,GAAQ,IAAC,CAAC,KAAK,CAAC;;EAEV;;;IACF,sBAAC,CAAC,OAAF,GAAY,CACR,uBADQ;;IAIC,gCAAC,mBAAD;MAAC,IAAC,CAAA,sBAAD;MACV,IAAC,CAAC,YAAF,GAAiB,SAAS,CAAC,IAAV,CAAA;MACjB,IAAC,CAAC,cAAF,GAAmB;MAEnB,IAAC,CAAC,QAAF,GAAa;MAEb,IAAG,IAAC,CAAC,SAAL;QACI,IAAC,CAAC,QAAF,GAAa,IAAC,CAAA,mBAAmB,CAAC,kBAArB,CAAwC,IAAC,CAAC,SAA1C,EADjB;OAAA,MAEK,IAAG,IAAC,CAAC,WAAL;QACD,IAAC,CAAC,QAAF,GAAa,IAAC,CAAA,mBAAmB,CAAC,kBAArB,CAAwC,IAAC,CAAC,IAAI,CAAC,GAAP,CAAW,IAAX,CAAxC,EADZ;OAAA,MAAA;QAGD,IAAC,CAAC,QAAF,GAAa,IAAC,CAAA,mBAAmB,CAAC,eAArB,CAAqC,IAAC,CAAC,IAAI,CAAC,GAAP,CAAW,IAAX,CAArC,EAHZ;;IARI;;qCAab,YAAA,GAAc,SAAA;MACV,IAAC,CAAC,cAAF,GAAmB;AAEnB,aAAO,IAAC,CAAC,QACL,CAAC,IADE,CAAA,CAEH,CAAC,IAFE,CAEG,CAAA,SAAA,KAAA;eAAA,SAAC,QAAD;UACF,KAAC,CAAC,YAAF,GAAiB,KAAC,CAAC,YAAY,CAAC,MAAf,CAAsB,QAAQ,CAAC,GAAT,CAAa,OAAb,CAAtB;UAEjB,IAAG,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAH;YACI,KAAC,CAAC,cAAF,GAAmB,MADvB;;AAGA,iBAAO,KAAC,CAAC;QANP;MAAA,CAAA,CAAA,CAAA,IAAA,CAFH;IAHG;;;;KAlBmB,KAAA,CAAM,KAAK,CAAC,UAAZ,EAAwB,KAAK,CAAC,SAA9B,EAAyC,KAAK,CAAC,YAA/C;;EA+BrC,OAAO,CAAC,MAAR,CAAe,mBAAf,CACI,CAAC,UADL,CACgB,cADhB,EACgC,sBADhC;AAxDA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAmBA,qBAAA,GAAwB,SAAA;AACpB,WAAO;MACH,WAAA,EAAa,gDADV;MAEH,UAAA,EAAY,cAFT;MAGH,YAAA,EAAc,IAHX;MAIH,KAAA,EAAO;QACH,SAAA,EAAW,YADR;QAEH,IAAA,EAAM,GAFH;QAGH,WAAA,EAAa,GAHV;OAJJ;MASH,gBAAA,EAAkB,IATf;;EADa;;EAaxB,OAAO,CAAC,MAAR,CAAe,cAAf,CAA8B,CAAC,SAA/B,CAAyC,gBAAzC,EAA2D,qBAA3D;AAhCA;;;;ACAA;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA,0BAAA;IAAA;;;EAmBA,KAAA,GAAQ,IAAC,CAAC;;EAEJ;;;IACF,mBAAC,CAAC,OAAF,GAAY,CACR,aADQ,EAER,yCAFQ,EAGR,wBAHQ,EAIR,yBAJQ;;IAOC,6BAAC,EAAD,EAAM,qCAAN,EAA8C,oBAA9C,EAAqE,qBAArE;MAAC,IAAC,CAAA,KAAD;MAAK,IAAC,CAAA,wCAAD;MAAwC,IAAC,CAAA,uBAAD;MAAuB,IAAC,CAAA,wBAAD;IAArE;;kCAEb,aAAA,GAAe,CACX,QADW,EAEX,SAFW,EAGX,kBAHW,EAIX,aAJW,EAKX,QALW,EAMX,UANW,EAOX,UAPW,EAQX,MARW,EASX,aATW,EAUX,YAVW,EAWX,cAXW,EAYX,MAZW,EAaX,kBAbW,EAcX,iBAdW,EAgBX,SAhBW,EAiBX,eAjBW,EAkBX,WAlBW;;kCAqBf,QAAA,GAAU;MACN;QACI,KAAA,EAAO,SAAC,QAAD;AACH,cAAA;UAAA,UAAA,GAAa,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,YAAzB;UAEb,IAAG,UAAH;YACI,QAAA,GAAW,UAAU,CAAC,GAAX,CAAe,KAAf;YAEX,IAAG,IAAC,CAAC,aAAa,CAAC,OAAhB,CAAwB,QAAxB,CAAA,KAAqC,CAAC,CAAzC;AACI,qBAAO,KADX;aAAA,MAEK,IAAG,QAAA,KAAY,aAAZ,IACH,UAAU,CAAC,GAAX,CAAe,OAAf,CAAuB,CAAC,GAAxB,CAA4B,KAA5B,CAAkC,CAAC,IAAnC,KAA2C,CAD3C;AAED,qBAAO,KAFN;aALT;;AASA,iBAAO;QAZJ,CADX;OADM,EAgBN;QACI,KAAA,EAAO,SAAC,QAAD;AACH,cAAA;UAAA,KAAA,GAAQ,QAAQ,CAAC,GAAT,CAAa,YAAb,CAA0B,CAAC,KAA3B,CAAiC,GAAjC;AACR,iBAAO,KAAM,CAAA,CAAA,CAAN,KAAY;QAFhB,CADX;OAhBM,EAqBN;QACI,KAAA,EAAO,SAAC,QAAD;AACH,cAAA;UAAA,KAAA,GAAQ,QAAQ,CAAC,GAAT,CAAa,YAAb,CAA0B,CAAC,KAA3B,CAAiC,GAAjC;AACR,iBAAO,KAAM,CAAA,CAAA,CAAN,KAAY,SAAZ,IAAyB,KAAM,CAAA,CAAA,CAAN,KAAY;QAFzC,CADX;OArBM,EA0BN;QACI,KAAA,EAAO,SAAC,QAAD;AACH,iBAAO,CAAC,CAAC,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,iBAAzB;QADN,CADX;OA1BM,EA8BN;QACI,KAAA,EAAO,SAAC,QAAD;AACH,cAAA;UAAA,KAAA,GAAQ,QAAQ,CAAC,GAAT,CAAa,YAAb,CAA0B,CAAC,KAA3B,CAAiC,GAAjC;UACR,UAAA,GAAa,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,YAAzB;UAEb,IAAG,UAAA,IACE,KAAM,CAAA,CAAA,CAAN,KAAY,MADd,IAEE,KAAM,CAAA,CAAA,CAAN,KAAY,QAFd,IAGE,UAAU,CAAC,GAAX,CAAe,KAAf,CAAA,KAAyB,WAH9B;AAII,mBAAO,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,YAAzB,CAAsC,CAAC,GAAvC,CAA2C,OAA3C,EAJX;;AAMA,iBAAO;QAVJ,CADX;OA9BM;;;kCA6CV,kBAAA,GAAoB,SAAC,QAAD;AAChB,aAAO,CAAC,CAAC,IAAF,CAAO,IAAC,CAAC,QAAT,EAAmB,CAAA,SAAA,KAAA;eAAA,SAAC,OAAD;AACtB,iBAAO,OAAO,CAAC,KAAK,CAAC,IAAd,CAAmB,KAAnB,EAAyB,QAAzB;QADe;MAAA,CAAA,CAAA,CAAA,IAAA,CAAnB;IADS;;kCAIpB,eAAA,GAAiB,SAAC,UAAD;MACb,UAAA,GAAa,UAAU,CAAC,KAAX,CAAiB,GAAjB;AAEb,aAAO;QACH,OAAA,EAAS,UAAW,CAAA,CAAA,CADjB;QAEH,GAAA,EAAK,UAAW,CAAA,CAAA,CAFb;QAGH,IAAA,EAAM,UAAW,CAAA,CAAA,CAHd;;IAHM;;kCASjB,kBAAA,GAAoB,SAAC,QAAD,EAAW,KAAX;MAChB,IAAG,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,KAAK,CAAC,GAA/B,CAAH;AACI,eAAO,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,GAArB,CAAyB,KAAK,CAAC,GAA/B,EADX;;IADgB;;kCAIpB,+BAAA,GAAiC,SAAC,QAAD,EAAW,KAAX,EAAkB,IAAlB;AAC7B,UAAA;MAAA,KAAA,GAAQ,IAAC,CAAA,qBAAqB,CAAC,QAAvB,CAAgC,QAAhC,EAA0C,KAA1C,EAAiD,IAAjD;MAER,QAAA,GAAW,QAAQ,CAAC,GAAT,CAAa,YAAb,EAA2B,KAA3B;MAEX,QAAA,GAAY,QAAQ,CAAC,GAAT,CAAa,KAAb,EAAoB,IAAC,CAAC,kBAAF,CAAqB,QAArB,EAA+B,KAA/B,CAApB;MAEZ,IAAG,IAAI,CAAC,WAAR;QACI,QAAA,GAAW,QAAQ,CAAC,GAAT,CAAa,aAAb,EAA4B,IAAI,CAAC,WAAL,CAAiB,QAAjB,CAA5B,EADf;;MAGA,IAAG,IAAI,CAAC,MAAR;QACI,QAAA,GAAW,QAAQ,CAAC,GAAT,CAAa,QAAb,EAAuB,IAAI,CAAC,MAAL,CAAY,QAAZ,CAAvB,EADf;;MAGA,IAAG,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,KAAvB,CAAf,CAAA,KAAiD,aAAjD,IACD,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,KAAhC,CAAf,CADF;QAEI,QAAA,GAAW,QAAQ,CAAC,GAAT,CAAa,aAAb,EAA4B,QAAQ,CAAC,KAAT,CAAe,CAAC,MAAD,EAAS,YAAT,EAAuB,OAAvB,EAAgC,KAAhC,CAAf,CAA5B,EAFf;;AAIA,aAAO;IAjBsB;;kCAoBjC,cAAA,GAAgB,SAAC,QAAD;AACZ,UAAA;MAAA,OAAA,GAAU,SAAS,CAAC,IAAV,CAAA;MAEV,QAAQ,CAAC,GAAT,CAAa,MAAb,CAAoB,CAAC,OAArB,CAA6B,CAAA,SAAA,KAAA;eAAA,SAAC,IAAD;AACzB,cAAA;UAAA,KAAA,GAAQ,KAAC,CAAC,eAAF,CAAkB,IAAI,CAAC,GAAL,CAAS,YAAT,CAAlB;UAER,IAAA,GAAO,IAAI,CAAC,GAAL,CAAS,MAAT;UACP,WAAA,GAAc,IAAI,CAAC,GAAL,CAAS,aAAT;UAEd,IAAG,WAAA,IAAe,WAAW,CAAC,KAAZ,CAAA,CAAlB;YAEI,IAAG,WAAW,CAAC,GAAZ,CAAgB,YAAhB,CAAH;cACI,WAAA,GAAc,SAAS,CAAC,GAAV,CAAc;gBAAC,SAAA,EAAW,WAAZ;eAAd,EADlB;;YAGA,IAAG,WAAW,CAAC,GAAZ,CAAgB,WAAhB,CAAH;cACI,WAAA,GAAc,SAAS,CAAC,GAAV,CAAc;gBAAC,eAAA,EAAiB,WAAlB;eAAd,EADlB;aAAA,MAEK,IAAG,KAAK,CAAC,GAAN,KAAa,WAAhB;cACA,WAAA,GAAc,SAAS,CAAC,GAAV,CAAc;gBAAC,WAAA,EAAa,WAAd;eAAd,EADd;;mBAGL,WAAW,CAAC,OAAZ,CAAoB,SAAC,KAAD,EAAQ,GAAR;AAChB,kBAAA;cAAA,GAAA,GAAM,SAAS,CAAC,GAAV,CAAc;gBAChB,GAAA,EAAK,GADW;gBAEhB,KAAA,EAAO,KAFS;eAAd;cAKN,OAAA,GAAU,IAAI,CAAC,KAAL,CAAW,CAAC,MAAD,EAAS,YAAT,CAAX,EAAmC,GAAnC;cACV,OAAA,GAAU,OAAO,CAAC,QAAR,CAAiB,CAAC,MAAD,EAAS,aAAT,CAAjB;qBACV,OAAA,GAAU,OAAO,CAAC,IAAR,CAAa,OAAb;YARM,CAApB,EAVJ;WAAA,MAAA;YAoBI,OAAA,GAAU,IAAI,CAAC,QAAL,CAAc,CAAC,MAAD,EAAS,aAAT,CAAd;mBACV,OAAA,GAAU,OAAO,CAAC,IAAR,CAAa,OAAb,EArBd;;QANyB;MAAA,CAAA,CAAA,CAAA,IAAA,CAA7B;AA6BA,aAAO,QAAQ,CAAC,GAAT,CAAa,MAAb,EAAqB,OAArB;IAhCK;;kCAkChB,kBAAA,GAAoB,SAAC,IAAD;AAChB,UAAA;MAAA,KAAA,GAAQ,IAAC,CAAC,eAAF,CAAkB,IAAI,CAAC,GAAL,CAAS,YAAT,CAAlB;MACR,IAAA,GAAO,IAAC,CAAA,oBAAoB,CAAC,OAAtB,CAA8B,IAA9B,EAAoC,KAApC;AAEP,aAAO,IAAC,CAAC,+BAAF,CAAkC,IAAlC,EAAwC,KAAxC,EAA+C,IAA/C;IAJS;;kCAMpB,kBAAA,GAAoB,SAAC,MAAD;AAChB,UAAA;MAAA,MAAA,GAAS;MAET,MAAM,CAAC,KAAP,GAAe,CAAA,SAAA,KAAA;eAAA,SAAC,IAAD;AACX,iBAAO,KAAC,CAAA,EAAE,CAAC,KAAK,CAAC,kBAAV,CAA6B,MAA7B,EAAqC,IAArC,CACH,CAAC,IADE,CACG,SAAC,QAAD;AACF,mBAAO,KAAC,CAAC,cAAF,CAAiB,QAAjB;UADL,CADH;QADI;MAAA,CAAA,CAAA,CAAA,IAAA;MAKf,MAAM,CAAC,GAAP,GAAa,CAAA,SAAA,KAAA;eAAA,SAAC,GAAD;iBAAS,KAAC,CAAC,kBAAF,CAAqB,GAArB;QAAT;MAAA,CAAA,CAAA,CAAA,IAAA;MAEb,MAAM,CAAC,MAAP,GAAgB,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD;AACZ,iBAAO,KAAK,CAAC,SAAN,CAAgB,SAAC,IAAD;mBAAU,KAAC,CAAC,kBAAF,CAAqB,IAArB;UAAV,CAAhB;QADK;MAAA,CAAA,CAAA,CAAA,IAAA;AAGhB,aAAO,IAAC,CAAA,qCAAqC,CAAC,QAAvC,CAAgD,MAAhD;IAbS;;kCAepB,eAAA,GAAiB,SAAC,MAAD;AACb,UAAA;MAAA,MAAA,GAAS;MAET,MAAM,CAAC,KAAP,GAAe,CAAA,SAAA,KAAA;eAAA,SAAC,IAAD;AACX,iBAAO,KAAC,CAAA,EAAE,CAAC,KAAK,CAAC,eAAV,CAA0B,MAA1B,EAAkC,IAAlC,CACH,CAAC,IADE,CACG,SAAC,QAAD;AACF,mBAAO,KAAC,CAAC,cAAF,CAAiB,QAAjB;UADL,CADH;QADI;MAAA,CAAA,CAAA,CAAA,IAAA;MAKf,MAAM,CAAC,GAAP,GAAa,CAAA,SAAA,KAAA;eAAA,SAAC,GAAD;iBAAS,KAAC,CAAC,kBAAF,CAAqB,GAArB;QAAT;MAAA,CAAA,CAAA,CAAA,IAAA;MAEb,MAAM,CAAC,MAAP,GAAgB,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD;AACZ,iBAAO,KAAK,CAAC,SAAN,CAAgB,SAAC,IAAD;mBAAU,KAAC,CAAC,kBAAF,CAAqB,IAArB;UAAV,CAAhB;QADK;MAAA,CAAA,CAAA,CAAA,IAAA;AAGhB,aAAO,IAAC,CAAA,qCAAqC,CAAC,QAAvC,CAAgD,MAAhD;IAbM;;kCAejB,kBAAA,GAAoB,SAAC,SAAD;AAChB,UAAA;MAAA,MAAA,GAAS;MAET,MAAM,CAAC,KAAP,GAAe,CAAA,SAAA,KAAA;eAAA,SAAC,IAAD;AACX,iBAAO,KAAC,CAAA,EAAE,CAAC,QAAQ,CAAC,WAAb,CAAyB,SAAzB,EAAoC,IAApC,CACH,CAAC,IADE,CACG,SAAC,QAAD;AAAc,mBAAO,KAAC,CAAC,cAAF,CAAiB,QAAjB;UAArB,CADH;QADI;MAAA,CAAA,CAAA,CAAA,IAAA;MAIf,MAAM,CAAC,GAAP,GAAa,CAAA,SAAA,KAAA;eAAA,SAAC,GAAD;iBAAS,KAAC,CAAC,kBAAF,CAAqB,GAArB;QAAT;MAAA,CAAA,CAAA,CAAA,IAAA;MAEb,MAAM,CAAC,MAAP,GAAgB,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD;AACZ,iBAAO,KAAK,CAAC,SAAN,CAAgB,SAAC,IAAD;mBAAU,KAAC,CAAC,kBAAF,CAAqB,IAArB;UAAV,CAAhB;QADK;MAAA,CAAA,CAAA,CAAA,IAAA;AAGhB,aAAO,IAAC,CAAA,qCAAqC,CAAC,QAAvC,CAAgD,MAAhD;IAZS;;;;KAvLU,KAAK,CAAC;;EAqMxC,OAAO,CAAC,MAAR,CAAe,mBAAf,CAAmC,CAAC,OAApC,CAA4C,uBAA5C,EAAqE,mBAArE;AA1NA;;;;ACAA;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA,MAAA;;EAqBA,MAAA,GAAS,OAAO,CAAC,MAAR,CAAe,cAAf,EAA+B,CAAC,SAAD,CAA/B;AArBT","file":"app.js","sourcesContent":["###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: app.coffee\n###\n\n@taiga = taiga = {}\n@.taigaContribPlugins = @.taigaContribPlugins or []\n\n# Generic function for generate hash from a arbitrary length\n# collection of parameters.\ntaiga.generateHash = (components=[]) ->\n    components = _.map(components, (x) -> JSON.stringify(x))\n    return hex_sha1(components.join(\":\"))\n\n\ntaiga.generateUniqueSessionIdentifier = ->\n    date = (new Date()).getTime()\n    randomNumber = Math.floor(Math.random() * 0x9000000)\n    return taiga.generateHash([date, randomNumber])\n\n\ntaiga.sessionId = taiga.generateUniqueSessionIdentifier()\n\n\nconfigure = ($routeProvider, $locationProvider, $httpProvider, $provide, $tgEventsProvider,\n             $compileProvider, $translateProvider, $animateProvider) ->\n\n    $animateProvider.classNameFilter(/^(?:(?!ng-animate-disabled).)*$/)\n\n    # wait until the trasnlation is ready to resolve the page\n    originalWhen = $routeProvider.when\n\n    $routeProvider.when = (path, route) ->\n        route.resolve || (route.resolve = {})\n        angular.extend(route.resolve, {\n            languageLoad: [\"$q\", \"$translate\", ($q, $translate) ->\n                deferred = $q.defer()\n\n                $translate().then () -> deferred.resolve()\n\n                return deferred.promise\n            ]\n        })\n\n        return originalWhen.call($routeProvider, path, route)\n\n    $routeProvider.when(\"/\",\n        {\n            templateUrl: \"home/home.html\",\n            access: {\n                requiresLogin: true\n            },\n            loader: true,\n            title: \"HOME.PAGE_TITLE\",\n            loader: true,\n            description: \"HOME.PAGE_DESCRIPTION\",\n            joyride: \"dashboard\"\n        }\n    )\n\n    $routeProvider.when(\"/projects/\",\n        {\n            templateUrl: \"projects/listing/projects-listing.html\",\n            access: {\n                requiresLogin: true\n            },\n            title: \"PROJECTS.PAGE_TITLE\",\n            description: \"PROJECTS.PAGE_DESCRIPTION\",\n            loader: true,\n            controller: \"ProjectsListing\",\n            controllerAs: \"vm\"\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/\",\n        {\n            templateUrl: \"projects/project/project.html\",\n            loader: true,\n            controller: \"Project\",\n            controllerAs: \"vm\"\n            section: \"project-timeline\"\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/search\",\n        {\n            templateUrl: \"search/search.html\",\n            reloadOnSearch: false,\n            section: \"search\",\n            loader: true\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/backlog\",\n        {\n            templateUrl: \"backlog/backlog.html\",\n            loader: true,\n            section: \"backlog\",\n            joyride: \"backlog\"\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/kanban\",\n        {\n            templateUrl: \"kanban/kanban.html\",\n            loader: true,\n            section: \"kanban\",\n            joyride: \"kanban\"\n        }\n    )\n\n    # Milestone\n    $routeProvider.when(\"/project/:pslug/taskboard/:sslug\",\n        {\n            templateUrl: \"taskboard/taskboard.html\",\n            loader: true,\n            section: \"backlog\"\n        }\n    )\n\n    # User stories\n    $routeProvider.when(\"/project/:pslug/us/:usref\",\n        {\n            templateUrl: \"us/us-detail.html\",\n            loader: true,\n            section: \"backlog-kanban\"\n        }\n    )\n\n    # Tasks\n    $routeProvider.when(\"/project/:pslug/task/:taskref\",\n        {\n            templateUrl: \"task/task-detail.html\",\n            loader: true,\n            section: \"backlog-kanban\"\n        }\n    )\n\n    # Wiki\n    $routeProvider.when(\"/project/:pslug/wiki\",\n        {redirectTo: (params) -> \"/project/#{params.pslug}/wiki/home\"}, )\n    $routeProvider.when(\"/project/:pslug/wiki/:slug\",\n        {\n            templateUrl: \"wiki/wiki.html\",\n            loader: true,\n            section: \"wiki\"\n        }\n    )\n\n    # Team\n    $routeProvider.when(\"/project/:pslug/team\",\n        {\n            templateUrl: \"team/team.html\",\n            loader: true,\n            section: \"team\"\n        }\n    )\n\n    # Issues\n    $routeProvider.when(\"/project/:pslug/issues\",\n        {\n            templateUrl: \"issue/issues.html\",\n            loader: true,\n            section: \"issues\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/issue/:issueref\",\n        {\n            templateUrl: \"issue/issues-detail.html\",\n            loader: true,\n            section: \"issues\"\n        }\n    )\n\n    # Admin - Project Profile\n    $routeProvider.when(\"/project/:pslug/admin/project-profile/details\",\n        {\n            templateUrl: \"admin/admin-project-profile.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-profile/default-values\",\n        {\n            templateUrl: \"admin/admin-project-default-values.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-profile/modules\",\n        {\n            templateUrl: \"admin/admin-project-modules.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-profile/export\",\n        {\n            templateUrl: \"admin/admin-project-export.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-profile/reports\",\n        {\n            templateUrl: \"admin/admin-project-reports.html\",\n            section: \"admin\"\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/admin/project-values/status\",\n        {\n            templateUrl: \"admin/admin-project-values-status.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-values/points\",\n        {\n            templateUrl: \"admin/admin-project-values-points.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-values/priorities\",\n        {\n            templateUrl: \"admin/admin-project-values-priorities.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-values/severities\",\n        {\n            templateUrl: \"admin/admin-project-values-severities.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-values/types\",\n        {\n            templateUrl: \"admin/admin-project-values-types.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/project-values/custom-fields\",\n        {\n            templateUrl: \"admin/admin-project-values-custom-fields.html\",\n            section: \"admin\"\n        }\n    )\n\n    $routeProvider.when(\"/project/:pslug/admin/memberships\",\n        {\n            templateUrl: \"admin/admin-memberships.html\",\n            section: \"admin\"\n        }\n    )\n    # Admin - Roles\n    $routeProvider.when(\"/project/:pslug/admin/roles\",\n        {\n            templateUrl: \"admin/admin-roles.html\",\n            section: \"admin\"\n        }\n    )\n\n    # Admin - Third Parties\n    $routeProvider.when(\"/project/:pslug/admin/third-parties/webhooks\",\n        {\n            templateUrl: \"admin/admin-third-parties-webhooks.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/third-parties/github\",\n        {\n            templateUrl: \"admin/admin-third-parties-github.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/third-parties/gitlab\",\n        {\n            templateUrl: \"admin/admin-third-parties-gitlab.html\",\n            section: \"admin\"\n        }\n    )\n    $routeProvider.when(\"/project/:pslug/admin/third-parties/bitbucket\",\n        {\n            templateUrl: \"admin/admin-third-parties-bitbucket.html\",\n            section: \"admin\"\n        }\n    )\n    # Admin - Contrib Plugins\n    $routeProvider.when(\"/project/:pslug/admin/contrib/:plugin\",\n        {templateUrl: \"contrib/main.html\"})\n\n    # User settings\n    $routeProvider.when(\"/user-settings/user-profile\",\n        {templateUrl: \"user/user-profile.html\"})\n    $routeProvider.when(\"/user-settings/user-change-password\",\n        {templateUrl: \"user/user-change-password.html\"})\n    $routeProvider.when(\"/user-settings/mail-notifications\",\n        {templateUrl: \"user/mail-notifications.html\"})\n    $routeProvider.when(\"/change-email/:email_token\",\n        {templateUrl: \"user/change-email.html\"})\n    $routeProvider.when(\"/cancel-account/:cancel_token\",\n        {templateUrl: \"user/cancel-account.html\"})\n\n    # User profile\n    $routeProvider.when(\"/profile\",\n        {\n            templateUrl: \"profile/profile.html\",\n            loader: true,\n            access: {\n                requiresLogin: true\n            },\n            controller: \"Profile\",\n            controllerAs: \"vm\"\n        }\n    )\n\n    $routeProvider.when(\"/profile/:slug\",\n        {\n            templateUrl: \"profile/profile.html\",\n            loader: true,\n            controller: \"Profile\",\n            controllerAs: \"vm\"\n        }\n    )\n\n    # Auth\n    $routeProvider.when(\"/login\",\n        {\n            templateUrl: \"auth/login.html\",\n            title: \"LOGIN.PAGE_TITLE\",\n            description: \"LOGIN.PAGE_DESCRIPTION\",\n            disableHeader: true\n        }\n    )\n    $routeProvider.when(\"/register\",\n        {\n            templateUrl: \"auth/register.html\",\n            title: \"REGISTER.PAGE_TITLE\",\n            description: \"REGISTER.PAGE_DESCRIPTION\",\n            disableHeader: true\n        }\n    )\n    $routeProvider.when(\"/forgot-password\",\n        {\n            templateUrl: \"auth/forgot-password.html\",\n            title: \"FORGOT_PASSWORD.PAGE_TITLE\",\n            description: \"FORGOT_PASSWORD.PAGE_DESCRIPTION\",\n            disableHeader: true\n        }\n    )\n    $routeProvider.when(\"/change-password/:token\",\n        {\n            templateUrl: \"auth/change-password-from-recovery.html\",\n            title: \"CHANGE_PASSWORD.PAGE_TITLE\",\n            description: \"CHANGE_PASSWORD.PAGE_TITLE\",\n            disableHeader: true\n        }\n    )\n    $routeProvider.when(\"/invitation/:token\",\n        {\n            templateUrl: \"auth/invitation.html\",\n            title: \"INVITATION.PAGE_TITLE\",\n            description: \"INVITATION.PAGE_DESCRIPTION\",\n            disableHeader: true\n        }\n    )\n    $routeProvider.when(\"/external-apps\",\n        {\n            templateUrl: \"external-apps/external-app.html\",\n            title: \"EXTERNAL_APP.PAGE_TITLE\",\n            description: \"EXTERNAL_APP.PAGE_DESCRIPTION\",\n            controller: \"ExternalApp\",\n            controllerAs: \"vm\",\n            disableHeader: true,\n            mobileViewport: true\n        }\n    )\n\n    # Errors/Exceptions\n    $routeProvider.when(\"/error\",\n        {templateUrl: \"error/error.html\"})\n    $routeProvider.when(\"/not-found\",\n        {templateUrl: \"error/not-found.html\"})\n    $routeProvider.when(\"/permission-denied\",\n        {templateUrl: \"error/permission-denied.html\"})\n\n    $routeProvider.otherwise({redirectTo: \"/not-found\"})\n    $locationProvider.html5Mode({enabled: true, requireBase: false})\n\n    defaultHeaders = {\n        \"Content-Type\": \"application/json\"\n        \"Accept-Language\": window.taigaConfig.defaultLanguage || \"en\"\n        \"X-Session-Id\": taiga.sessionId\n    }\n\n    $httpProvider.defaults.headers.delete = defaultHeaders\n    $httpProvider.defaults.headers.patch = defaultHeaders\n    $httpProvider.defaults.headers.post = defaultHeaders\n    $httpProvider.defaults.headers.put = defaultHeaders\n    $httpProvider.defaults.headers.get = {\n        \"X-Session-Id\": taiga.sessionId\n    }\n\n    $httpProvider.useApplyAsync(true)\n\n    $tgEventsProvider.setSessionId(taiga.sessionId)\n\n    # Add next param when user try to access to a secction need auth permissions.\n    authHttpIntercept = ($q, $location, $navUrls, $lightboxService) ->\n        httpResponseError = (response) ->\n            if response.status == 0 || response.status == -1\n                $lightboxService.closeAll()\n                $location.path($navUrls.resolve(\"error\"))\n                $location.replace()\n            else if response.status == 401 and $location.url().indexOf('/login') == -1\n                nextUrl = encodeURIComponent($location.url())\n                $location.url($navUrls.resolve(\"login\")).search(\"next=#{nextUrl}\")\n\n            return $q.reject(response)\n\n        return {\n            responseError: httpResponseError\n        }\n\n    $provide.factory(\"authHttpIntercept\", [\"$q\", \"$location\", \"$tgNavUrls\", \"lightboxService\",\n                                           authHttpIntercept])\n\n    $httpProvider.interceptors.push(\"authHttpIntercept\")\n\n\n    loaderIntercept = ($q, loaderService) ->\n        return {\n            request: (config) ->\n                loaderService.logRequest()\n\n                return config\n\n            requestError: (rejection) ->\n                loaderService.logResponse()\n\n                return $q.reject(rejection)\n\n            responseError: (rejection) ->\n                loaderService.logResponse()\n\n                return $q.reject(rejection)\n\n            response: (response) ->\n                loaderService.logResponse()\n\n                return response\n        }\n\n\n    $provide.factory(\"loaderIntercept\", [\"$q\", \"tgLoader\", loaderIntercept])\n\n    $httpProvider.interceptors.push(\"loaderIntercept\")\n\n    # If there is an error in the version throw a notify error.\n    # IMPROVEiMENT: Move this version error handler to USs, issues and tasks repository\n    versionCheckHttpIntercept = ($q) ->\n        httpResponseError = (response) ->\n            if response.status == 400 && response.data.version\n                # HACK: to prevent circular dependencies with [$tgConfirm, $translate]\n                $injector = angular.element(\"body\").injector()\n                $injector.invoke([\"$tgConfirm\", \"$translate\", ($confirm, $translate) =>\n                    versionErrorMsg = $translate.instant(\"ERROR.VERSION_ERROR\")\n                    $confirm.notify(\"error\", versionErrorMsg, null, 10000)\n                ])\n\n            return $q.reject(response)\n\n        return {responseError: httpResponseError}\n\n    $provide.factory(\"versionCheckHttpIntercept\", [\"$q\", versionCheckHttpIntercept])\n\n    $httpProvider.interceptors.push(\"versionCheckHttpIntercept\")\n\n    window.checksley.updateValidators({\n        linewidth: (val, width) ->\n            lines = taiga.nl2br(val).split(\"<br />\")\n\n            valid = _.every lines, (line) ->\n                line.length < width\n\n            return valid\n    })\n\n    $compileProvider.debugInfoEnabled(window.taigaConfig.debugInfo || false)\n\n    if localStorage.userInfo\n        userInfo = JSON.parse(localStorage.userInfo)\n\n    # i18n\n    preferedLangCode = userInfo?.lang || window.taigaConfig.defaultLanguage || \"en\"\n\n    $translateProvider\n        .useStaticFilesLoader({\n            prefix: \"/locales/locale-\",\n            suffix: \".json\"\n        })\n        .addInterpolation('$translateMessageFormatInterpolation')\n        .preferredLanguage(preferedLangCode)\n\n    $translateProvider.fallbackLanguage(preferedLangCode)\n\n    # decoratos\n    decorators = _.where(@.taigaContribPlugins, {\"type\": \"decorator\"})\n\n    _.each decorators, (decorator) ->\n        $provide.decorator decorator.provider, decorator.decorator\n\n    # decoratos\n    decorators = _.where(@.taigaContribPlugins, {\"type\": \"decorator\"})\n\n    _.each decorators, (decorator) ->\n        $provide.decorator decorator.provider, decorator.decorator\n\ni18nInit = (lang, $translate) ->\n    # i18n - moment.js\n    moment.locale(lang)\n\n    # i18n - checksley.js\n    messages = {\n        defaultMessage: $translate.instant(\"COMMON.FORM_ERRORS.DEFAULT_MESSAGE\")\n        type: {\n            email: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_EMAIL\")\n            url: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_URL\")\n            urlstrict: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_URLSTRICT\")\n            number: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_NUMBER\")\n            digits: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_DIGITS\")\n            dateIso: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_DATEISO\")\n            alphanum: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_ALPHANUM\")\n            phone: $translate.instant(\"COMMON.FORM_ERRORS.TYPE_PHONE\")\n        }\n        notnull: $translate.instant(\"COMMON.FORM_ERRORS.NOTNULL\")\n        notblank: $translate.instant(\"COMMON.FORM_ERRORS.NOT_BLANK\")\n        required: $translate.instant(\"COMMON.FORM_ERRORS.REQUIRED\")\n        regexp: $translate.instant(\"COMMON.FORM_ERRORS.REGEXP\")\n        min: $translate.instant(\"COMMON.FORM_ERRORS.MIN\")\n        max: $translate.instant(\"COMMON.FORM_ERRORS.MAX\")\n        range: $translate.instant(\"COMMON.FORM_ERRORS.RANGE\")\n        minlength: $translate.instant(\"COMMON.FORM_ERRORS.MIN_LENGTH\")\n        maxlength: $translate.instant(\"COMMON.FORM_ERRORS.MAX_LENGTH\")\n        rangelength: $translate.instant(\"COMMON.FORM_ERRORS.RANGE_LENGTH\")\n        mincheck: $translate.instant(\"COMMON.FORM_ERRORS.MIN_CHECK\")\n        maxcheck: $translate.instant(\"COMMON.FORM_ERRORS.MAX_CHECK\")\n        rangecheck: $translate.instant(\"COMMON.FORM_ERRORS.RANGE_CHECK\")\n        equalto: $translate.instant(\"COMMON.FORM_ERRORS.EQUAL_TO\")\n    }\n    checksley.updateMessages('default', messages)\n\n\ninit = ($log, $rootscope, $auth, $events, $analytics, $translate, $location, $navUrls, appMetaService, projectService, loaderService, navigationBarService) ->\n    $log.debug(\"Initialize application\")\n\n    # Taiga Plugins\n    $rootscope.contribPlugins = @.taigaContribPlugins\n    $rootscope.adminPlugins = _.where(@.taigaContribPlugins, {\"type\": \"admin\"})\n\n    $rootscope.$on \"$translateChangeEnd\", (e, ctx) ->\n        lang = ctx.language\n        i18nInit(lang, $translate)\n\n    # bluebird\n    Promise.setScheduler (cb) ->\n        $rootscope.$evalAsync(cb)\n\n    # Load user\n    if $auth.isAuthenticated()\n        $events.setupConnection()\n        user = $auth.getUser()\n\n    # Analytics\n    $analytics.initialize()\n\n    # On the first page load the loader is painted in `$routeChangeSuccess`\n    # because we need to hide the tg-navigation-bar.\n    # In the other cases the loader is in `$routeChangeSuccess`\n    # because `location.noreload` prevent to execute this event.\n    un = $rootscope.$on '$routeChangeStart',  (event, next) ->\n        if next.loader\n            loaderService.start(true)\n\n        un()\n\n    $rootscope.$on '$routeChangeSuccess',  (event, next) ->\n        if next.loader\n            loaderService.start(true)\n\n        if next.access && next.access.requiresLogin\n            if !$auth.isAuthenticated()\n                $location.path($navUrls.resolve(\"login\"))\n\n        projectService.setSection(next.section)\n\n        if next.params.pslug\n            projectService.setProjectBySlug(next.params.pslug)\n        else\n            projectService.cleanProject()\n\n        if next.title or next.description\n            title = $translate.instant(next.title or \"\")\n            description = $translate.instant(next.description or \"\")\n            appMetaService.setAll(title, description)\n\n        if next.mobileViewport\n            appMetaService.addMobileViewport()\n          else\n            appMetaService.removeMobileViewport()\n\n        if next.disableHeader\n            navigationBarService.disableHeader()\n        else\n            navigationBarService.enableHeader()\n\npluginsWithModule = _.filter(@.taigaContribPlugins, (plugin) -> plugin.module)\n\npluginsWithModule = _.filter(@.taigaContribPlugins, (plugin) -> plugin.module)\n\nmodules = [\n    # Main Global Modules\n    \"taigaBase\",\n    \"taigaCommon\",\n    \"taigaResources\",\n    \"taigaResources2\",\n    \"taigaAuth\",\n    \"taigaEvents\",\n\n    # Specific Modules\n    \"taigaHome\",\n    \"taigaNavigationBar\",\n    \"taigaProjects\",\n    \"taigaRelatedTasks\",\n    \"taigaBacklog\",\n    \"taigaTaskboard\",\n    \"taigaKanban\",\n    \"taigaIssues\",\n    \"taigaUserStories\",\n    \"taigaTasks\",\n    \"taigaTeam\",\n    \"taigaWiki\",\n    \"taigaSearch\",\n    \"taigaAdmin\",\n    \"taigaProject\",\n    \"taigaUserSettings\",\n    \"taigaFeedback\",\n    \"taigaPlugins\",\n    \"taigaIntegrations\",\n    \"taigaComponents\",\n    # new modules\n    \"taigaProfile\",\n    \"taigaHome\",\n    \"taigaUserTimeline\",\n    \"taigaExternalApps\",\n\n    # template cache\n    \"templates\",\n\n    # Vendor modules\n    \"ngRoute\",\n    \"ngAnimate\",\n    \"ngAria\",\n    \"pascalprecht.translate\",\n    \"infinite-scroll\",\n    \"tgRepeat\"\n].concat(_.map(pluginsWithModule, (plugin) -> plugin.module))\n\n# Main module definition\nmodule = angular.module(\"taiga\", modules)\n\nmodule.config([\n    \"$routeProvider\",\n    \"$locationProvider\",\n    \"$httpProvider\",\n    \"$provide\",\n    \"$tgEventsProvider\",\n    \"$compileProvider\",\n    \"$translateProvider\",\n    \"$animateProvider\",\n    configure\n])\n\nmodule.run([\n    \"$log\",\n    \"$rootScope\",\n    \"$tgAuth\",\n    \"$tgEvents\",\n    \"$tgAnalytics\",\n    \"$translate\",\n    \"$tgLocation\",\n    \"$tgNavUrls\",\n    \"tgAppMetaService\",\n    \"tgProjectService\",\n    \"tgLoader\",\n    \"tgNavigationBarService\",\n    \"$route\",\n    init\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: classes.coffee\n###\n\nclass TaigaBase\nclass TaigaService extends TaigaBase\nclass TaigaController extends TaigaBase\n    onInitialDataError: (xhr) =>\n        if xhr\n            if xhr.status == 404\n                @location.path(@navUrls.resolve(\"not-found\"))\n                @location.replace()\n            else if xhr.status == 403\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n                @location.replace()\n\n        return @q.reject(xhr)\n\n@.taiga.Base = TaigaBase\n@.taiga.Service = TaigaService\n@.taiga.Controller = TaigaController\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: utils.coffee\n###\n\nnl2br = (str) =>\n    breakTag = '<br />'\n    return (str + '').replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + breakTag + '$2')\n\nbindMethods = (object) =>\n    dependencies = _.keys(object)\n\n    methods = []\n\n    _.forIn object, (value, key) =>\n        if key not in dependencies\n            methods.push(key)\n\n    _.bindAll(object, methods)\n\nbindOnce = (scope, attr, continuation) =>\n    val = scope.$eval(attr)\n    if val != undefined\n        return continuation(val)\n\n    delBind = null\n    delBind = scope.$watch attr, (val) ->\n        return if val is undefined\n        continuation(val)\n        delBind() if delBind\n\n\nmixOf = (base, mixins...) ->\n    class Mixed extends base\n\n    for mixin in mixins by -1 #earlier mixins override later ones\n        for name, method of mixin::\n            Mixed::[name] = method\n    Mixed\n\n\ntrim = (data, char) ->\n    return _.str.trim(data, char)\n\n\nslugify = (data) ->\n    return _.str.slugify(data)\n\n\nunslugify = (data) ->\n    if data\n        return _.str.capitalize(data.replace(/-/g, ' '))\n    return data\n\n\ntoggleText = (element, texts) ->\n    nextTextPosition = element.data('nextTextPosition')\n    nextTextPosition = 0 if not nextTextPosition? or nextTextPosition >= texts.length\n    text = texts[nextTextPosition]\n    element.data('nextTextPosition', nextTextPosition + 1)\n    element.text(text)\n\n\ngroupBy = (coll, pred) ->\n    result = {}\n    for item in coll\n        result[pred(item)] = item\n\n    return result\n\n\ntimeout = (wait, continuation) ->\n    return window.setTimeout(continuation, wait)\n\n\ncancelTimeout = (timeoutVar) ->\n    window.clearTimeout(timeoutVar)\n\n\nscopeDefer = (scope, func) ->\n    _.defer =>\n        scope.$apply(func)\n\n\ntoString = (value) ->\n    if _.isNumber(value)\n        return value + \"\"\n    else if _.isString(value)\n        return value\n    else if _.isPlainObject(value)\n        return JSON.stringify(value)\n    else if _.isUndefined(value)\n        return \"\"\n    return value.toString()\n\n\njoinStr = (str, coll) ->\n    return _.str.join(str, coll)\n\n\ndebounce = (wait, func) ->\n    return _.debounce(func, wait, {leading: true, trailing: false})\n\n\ndebounceLeading = (wait, func) ->\n    return _.debounce(func, wait, {leading: false, trailing: true})\n\n\nstartswith = (str1, str2) ->\n    return _.str.startsWith(str1, str2)\n\n\ntruncate = (str, maxLength, suffix=\"...\") ->\n    return str if (typeof str != \"string\") and not (str instanceof String)\n\n    out = str.slice(0)\n\n    if out.length > maxLength\n        out = out.substring(0, maxLength + 1)\n        out = out.substring(0, Math.min(out.length, out.lastIndexOf(\" \")))\n        out = out + suffix\n\n    return out\n\n\nsizeFormat = (input, precision=1) ->\n    if isNaN(parseFloat(input)) or not isFinite(input)\n        return \"-\"\n\n    if input == 0\n        return \"0 bytes\"\n\n    units = [\"bytes\", \"KB\", \"MB\", \"GB\", \"TB\", \"PB\"]\n    number = Math.floor(Math.log(input) / Math.log(1024))\n    if number > 5\n        number = 5\n    size = (input / Math.pow(1024, number)).toFixed(precision)\n    return  \"#{size} #{units[number]}\"\n\nstripTags = (str, exception) ->\n    if exception\n        pattern = new RegExp('<(?!' + exception + '\\s*\\/?)[^>]+>', 'gi')\n        return String(str).replace(pattern, '')\n    else\n        return String(str).replace(/<\\/?[^>]+>/g, '')\n\nreplaceTags = (str, tags, replace) ->\n    # open tag\n    pattern = new RegExp('<(' + tags + ')>', 'gi')\n    str = str.replace(pattern, '<' + replace + '>')\n\n    # close tag\n    pattern = new RegExp('<\\/(' + tags + ')>', 'gi')\n    str = str.replace(pattern, '</' + replace + '>')\n\n    return str\n\ndefineImmutableProperty = (obj, name, fn) =>\n    Object.defineProperty obj, name, {\n        get: () =>\n            if !_.isFunction(fn)\n                throw \"defineImmutableProperty third param must be a function\"\n\n            fn_result = fn()\n            if fn_result && _.isObject(fn_result)\n                if fn_result.size == undefined\n                    throw \"defineImmutableProperty must return immutable data\"\n\n            return fn_result\n    }\n\n_.mixin\n    removeKeys: (obj, keys) ->\n        _.chain([keys]).flatten().reduce(\n            (obj, key) ->\n                delete obj[key]; obj\n            , obj).value()\n\ntaiga = @.taiga\ntaiga.nl2br = nl2br\ntaiga.bindMethods = bindMethods\ntaiga.bindOnce = bindOnce\ntaiga.mixOf = mixOf\ntaiga.trim = trim\ntaiga.slugify = slugify\ntaiga.unslugify = unslugify\ntaiga.toggleText = toggleText\ntaiga.groupBy = groupBy\ntaiga.timeout = timeout\ntaiga.cancelTimeout = cancelTimeout\ntaiga.scopeDefer = scopeDefer\ntaiga.toString = toString\ntaiga.joinStr = joinStr\ntaiga.truncate = truncate\ntaiga.debounce = debounce\ntaiga.debounceLeading = debounceLeading\ntaiga.startswith = startswith\ntaiga.sizeFormat = sizeFormat\ntaiga.stripTags = stripTags\ntaiga.replaceTags = replaceTags\ntaiga.defineImmutableProperty = defineImmutableProperty\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/controllerMixins.coffee\n###\n\ntaiga = @.taiga\n\ngroupBy = @.taiga.groupBy\njoinStr = @.taiga.joinStr\ntrim = @.taiga.trim\ntoString = @.taiga.toString\n\n\n#############################################################################\n## Page Mixin\n#############################################################################\n\nclass PageMixin\n    fillUsersAndRoles: (users, roles) ->\n        activeUsers = _.filter(users, (user) => user.is_active)\n        @scope.activeUsers = _.sortBy(activeUsers, \"full_name_display\")\n        @scope.activeUsersById = groupBy(@scope.activeUsers, (e) -> e.id)\n\n        @scope.users = _.sortBy(users, \"full_name_display\")\n        @scope.usersById = groupBy(@scope.users, (e) -> e.id)\n\n        @scope.roles = _.sortBy(roles, \"order\")\n        computableRoles = _(@scope.project.members).map(\"role\").uniq().value()\n        @scope.computableRoles = _(roles).filter(\"computable\")\n                                         .filter((x) -> _.contains(computableRoles, x.id))\n                                         .value()\n    loadUsersAndRoles: ->\n        promise = @q.all([\n            @rs.projects.usersList(@scope.projectId),\n            @rs.projects.rolesList(@scope.projectId)\n        ])\n\n        return promise.then (results) =>\n            [users, roles] = results\n            @.fillUsersAndRoles(users, roles)\n            return results\n\ntaiga.PageMixin = PageMixin\n\n\n#############################################################################\n## Filters Mixin\n#############################################################################\n# This mixin requires @location ($tgLocation), and @scope\n\nclass FiltersMixin\n    selectFilter: (name, value, load=false) ->\n        params = @location.search()\n        if params[name] != undefined and name != \"page\"\n            existing = _.map(taiga.toString(params[name]).split(\",\"), (x) -> trim(x))\n            existing.push(taiga.toString(value))\n            existing = _.compact(existing)\n            value = joinStr(\",\", _.uniq(existing))\n\n        if !@location.isInCurrentRouteParams(name, value)\n            location = if load then @location else @location.noreload(@scope)\n            location.search(name, value)\n\n    replaceFilter: (name, value, load=false) ->\n        if !@location.isInCurrentRouteParams(name, value)\n            location = if load then @location else @location.noreload(@scope)\n            location.search(name, value)\n\n    replaceAllFilters: (filters, load=false) ->\n        location = if load then @location else @location.noreload(@scope)\n        location.search(filters)\n\n    unselectFilter: (name, value, load=false) ->\n        params = @location.search()\n\n        if params[name] is undefined\n            return\n\n        if value is undefined or value is null\n            delete params[name]\n\n        parsedValues = _.map(taiga.toString(params[name]).split(\",\"), (x) -> trim(x))\n        newValues = _.reject(parsedValues, (x) -> x == taiga.toString(value))\n        newValues = _.compact(newValues)\n\n        if _.isEmpty(newValues)\n            value = null\n        else\n            value = joinStr(\",\", _.uniq(newValues))\n\n        location = if load then @location else @location.noreload(@scope)\n        location.search(name, value)\n\ntaiga.FiltersMixin = FiltersMixin\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin.coffee\n###\n\nmodule = angular.module(\"taigaAdmin\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/auth.coffee\n###\n\ntaiga = @.taiga\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaAuth\", [\"taigaResources\"])\n\n#############################################################################\n## Authentication Service\n#############################################################################\n\nclass AuthService extends taiga.Service\n    @.$inject = [\"$rootScope\",\n                 \"$tgStorage\",\n                 \"$tgModel\",\n                 \"$tgResources\",\n                 \"$tgHttp\",\n                 \"$tgUrls\",\n                 \"$tgConfig\",\n                 \"$translate\",\n                 \"tgCurrentUserService\",\n                 \"tgThemeService\"]\n\n    constructor: (@rootscope, @storage, @model, @rs, @http, @urls, @config, @translate, @currentUserService,\n                  @themeService) ->\n        super()\n\n        @._currentTheme = @config.get(\"defaultTheme\") || \"taiga\" # load on index.jade\n\n        userModel = @.getUser()\n        @.setUserdata(userModel)\n\n    setUserdata: (userModel) ->\n        if userModel\n            @.userData = Immutable.fromJS(userModel.getAttrs())\n            @currentUserService.setUser(@.userData)\n        else\n            @.userData = null\n\n    _getUserTheme: ->\n        return @rootscope.user?.theme || @config.get(\"defaultTheme\") || \"taiga\"\n\n    _setTheme: ->\n        newTheme = @._getUserTheme()\n\n        if @._currentTheme != newTheme\n            @._currentTheme = newTheme\n            @themeService.use(@._currentTheme)\n\n    _setLocales: ->\n        lang = @rootscope.user?.lang || @config.get(\"defaultLanguage\") || \"en\"\n        @translate.preferredLanguage(lang)  # Needed for calls to the api in the correct language\n        @translate.use(lang)                # Needed for change the interface in runtime\n\n    getUser: ->\n        if @rootscope.user\n            return @rootscope.user\n\n        userData = @storage.get(\"userInfo\")\n        if userData\n            user = @model.make_model(\"users\", userData)\n            @rootscope.user = user\n            @._setLocales()\n\n            @._setTheme()\n\n            return user\n\n        return null\n\n    setUser: (user) ->\n        @rootscope.auth = user\n        @storage.set(\"userInfo\", user.getAttrs())\n        @rootscope.user = user\n\n        @.setUserdata(user)\n\n        @._setLocales()\n        @._setTheme()\n\n    clear: ->\n        @rootscope.auth = null\n        @rootscope.user = null\n        @storage.remove(\"userInfo\")\n\n    setToken: (token) ->\n        @storage.set(\"token\", token)\n\n    getToken: ->\n        return @storage.get(\"token\")\n\n    removeToken: ->\n        @storage.remove(\"token\")\n\n    isAuthenticated: ->\n        if @.getUser() != null\n            return true\n        return false\n\n    ## Http interface\n\n    login: (data, type) ->\n        url = @urls.resolve(\"auth\")\n\n        data = _.clone(data, false)\n        data.type = if type then type else \"normal\"\n\n        @.removeToken()\n\n        return @http.post(url, data).then (data, status) =>\n            user = @model.make_model(\"users\", data.data)\n            @.setToken(user.auth_token)\n            @.setUser(user)\n            return user\n\n    logout: ->\n        @.removeToken()\n        @.clear()\n        @currentUserService.removeUser()\n\n        @._setTheme()\n        @._setLocales()\n\n\n    register: (data, type, existing) ->\n        url = @urls.resolve(\"auth-register\")\n\n        data = _.clone(data, false)\n        data.type = if type then type else \"public\"\n        if type == \"private\"\n            data.existing = if existing then existing else false\n\n        @.removeToken()\n\n        return @http.post(url, data).then (response) =>\n            user = @model.make_model(\"users\", response.data)\n            @.setToken(user.auth_token)\n            @.setUser(user)\n            return user\n\n    getInvitation: (token) ->\n        return @rs.invitations.get(token)\n\n    acceptInvitiationWithNewUser: (data) ->\n        return @.register(data, \"private\", false)\n\n    acceptInvitiationWithExistingUser: (data) ->\n        return @.register(data, \"private\", true)\n\n    forgotPassword: (data) ->\n        url = @urls.resolve(\"users-password-recovery\")\n        data = _.clone(data, false)\n        @.removeToken()\n        return @http.post(url, data)\n\n    changePasswordFromRecovery: (data) ->\n        url = @urls.resolve(\"users-change-password-from-recovery\")\n        data = _.clone(data, false)\n        @.removeToken()\n        return @http.post(url, data)\n\n    changeEmail: (data) ->\n        url = @urls.resolve(\"users-change-email\")\n        data = _.clone(data, false)\n        return @http.post(url, data)\n\n    cancelAccount: (data) ->\n        url = @urls.resolve(\"users-cancel-account\")\n        data = _.clone(data, false)\n        return @http.post(url, data)\n\nmodule.service(\"$tgAuth\", AuthService)\n\n\n#############################################################################\n## Login Directive\n#############################################################################\n\n# Directive that manages the visualization of public register\n# message/link on login page.\n\nPublicRegisterMessageDirective = ($config, $navUrls, templates) ->\n    template = templates.get(\"auth/login-text.html\", true)\n\n    templateFn = ->\n        publicRegisterEnabled = $config.get(\"publicRegisterEnabled\")\n        if not publicRegisterEnabled\n            return \"\"\n        return template({url:$navUrls.resolve(\"register\")})\n\n    return {\n        restrict: \"AE\"\n        scope: {}\n        template: templateFn\n    }\n\nmodule.directive(\"tgPublicRegisterMessage\", [\"$tgConfig\", \"$tgNavUrls\", \"$tgTemplate\",\n                                             PublicRegisterMessageDirective])\n\n\nLoginDirective = ($auth, $confirm, $location, $config, $routeParams, $navUrls, $events, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        onSuccess = (response) ->\n            if $routeParams['next'] and $routeParams['next'] != $navUrls.resolve(\"login\")\n                nextUrl = decodeURIComponent($routeParams['next'])\n            else\n                nextUrl = $navUrls.resolve(\"home\")\n\n            $events.setupConnection()\n            $location.url(nextUrl)\n\n        onError = (response) ->\n            $confirm.notify(\"light-error\", $translate.instant(\"LOGIN_FORM.ERROR_AUTH_INCORRECT\"))\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = new checksley.Form($el.find(\"form.login-form\"))\n            if not form.validate()\n                return\n\n            data = {\n                \"username\": $el.find(\"form.login-form input[name=username]\").val(),\n                \"password\": $el.find(\"form.login-form input[name=password]\").val()\n            }\n\n            loginFormType = $config.get(\"loginFormType\", \"normal\")\n\n            promise = $auth.login(data, loginFormType)\n            return promise.then(onSuccess, onError)\n\n        $el.on \"submit\", \"form\", submit\n\n        window.prerenderReady = true\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgLogin\", [\"$tgAuth\", \"$tgConfirm\", \"$tgLocation\", \"$tgConfig\", \"$routeParams\",\n                             \"$tgNavUrls\", \"$tgEvents\", \"$translate\", LoginDirective])\n\n\n#############################################################################\n## Register Directive\n#############################################################################\n\nRegisterDirective = ($auth, $confirm, $location, $navUrls, $config, $analytics, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        if not $config.get(\"publicRegisterEnabled\")\n            $location.path($navUrls.resolve(\"not-found\"))\n            $location.replace()\n\n        $scope.data = {}\n        form = $el.find(\"form\").checksley({onlyOneErrorElement: true})\n\n        onSuccessSubmit = (response) ->\n            $analytics.trackEvent(\"auth\", \"register\", \"user registration\", 1)\n\n            $confirm.notify(\"success\", $translate.instant(\"LOGIN_FORM.SUCCESS\"))\n\n            $location.path($navUrls.resolve(\"home\"))\n\n        onErrorSubmit = (response) ->\n            if response.data._error_message\n                text = $translate.instant(\"COMMON.GENERIC_ERROR\", {error: response.data._error_message})\n                $confirm.notify(\"light-error\", text)\n\n            form.setErrors(response.data)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            promise = $auth.register($scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        window.prerenderReady = true\n\n    return {link:link}\n\nmodule.directive(\"tgRegister\", [\"$tgAuth\", \"$tgConfirm\", \"$tgLocation\", \"$tgNavUrls\", \"$tgConfig\",\n                                \"$tgAnalytics\", \"$translate\", RegisterDirective])\n\n\n#############################################################################\n## Forgot Password Directive\n#############################################################################\n\nForgotPasswordDirective = ($auth, $confirm, $location, $navUrls, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.data = {}\n        form = $el.find(\"form\").checksley()\n\n        onSuccessSubmit = (response) ->\n            $location.path($navUrls.resolve(\"login\"))\n\n            text = $translate.instant(\"FORGOT_PASSWORD_FORM.SUCCESS\")\n            $confirm.success(text)\n\n        onErrorSubmit = (response) ->\n            text = $translate.instant(\"FORGOT_PASSWORD_FORM.ERROR\")\n\n            $confirm.notify(\"light-error\", text)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            promise = $auth.forgotPassword($scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        window.prerenderReady = true\n\n    return {link:link}\n\nmodule.directive(\"tgForgotPassword\", [\"$tgAuth\", \"$tgConfirm\", \"$tgLocation\", \"$tgNavUrls\", \"$translate\",\n                                      ForgotPasswordDirective])\n\n\n#############################################################################\n## Change Password from Recovery Directive\n#############################################################################\n\nChangePasswordFromRecoveryDirective = ($auth, $confirm, $location, $params, $navUrls, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.data = {}\n\n        if $params.token?\n            $scope.tokenInParams = true\n            $scope.data.token = $params.token\n        else\n            $location.path($navUrls.resolve(\"login\"))\n\n            text = $translate.instant(\"CHANGE_PASSWORD_RECOVERY_FORM.ERROR\")\n            $confirm.notify(\"light-error\",text)\n\n        form = $el.find(\"form\").checksley()\n\n        onSuccessSubmit = (response) ->\n            $location.path($navUrls.resolve(\"login\"))\n\n            text = $translate.instant(\"CHANGE_PASSWORD_RECOVERY_FORM.SUCCESS\")\n            $confirm.success(text)\n\n        onErrorSubmit = (response) ->\n            text = $translate.instant(\"CHANGE_PASSWORD_RECOVERY_FORM.ERROR\")\n            $confirm.notify(\"light-error\", text)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            promise = $auth.changePasswordFromRecovery($scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgChangePasswordFromRecovery\", [\"$tgAuth\", \"$tgConfirm\", \"$tgLocation\", \"$routeParams\",\n                                                  \"$tgNavUrls\", \"$translate\",\n                                                  ChangePasswordFromRecoveryDirective])\n\n\n#############################################################################\n## Invitation\n#############################################################################\n\nInvitationDirective = ($auth, $confirm, $location, $params, $navUrls, $analytics, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        token = $params.token\n\n        promise = $auth.getInvitation(token)\n        promise.then (invitation) ->\n            $scope.invitation = invitation\n\n        promise.then null, (response) ->\n            $location.path($navUrls.resolve(\"login\"))\n\n            text = $translate.instant(\"INVITATION_LOGIN_FORM.NOT_FOUND\")\n            $confirm.notify(\"light-error\", text)\n\n        # Login form\n        $scope.dataLogin = {token: token}\n        loginForm = $el.find(\"form.login-form\").checksley({onlyOneErrorElement: true})\n\n        onSuccessSubmitLogin = (response) ->\n            $analytics.trackEvent(\"auth\", \"invitationAccept\", \"invitation accept with existing user\", 1)\n            $location.path($navUrls.resolve(\"project\", {project: $scope.invitation.project_slug}))\n            text = $translate.instant(\"INVITATION_LOGIN_FORM.SUCCESS\", {\n                \"project_name\": $scope.invitation.project_name\n            })\n\n            $confirm.notify(\"success\", text)\n\n        onErrorSubmitLogin = (response) ->\n            text = $translate.instant(\"INVITATION_LOGIN_FORM.ERROR\")\n\n            $confirm.notify(\"light-error\", text)\n\n        submitLogin = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not loginForm.validate()\n                return\n\n            promise = $auth.acceptInvitiationWithExistingUser($scope.dataLogin)\n            promise.then(onSuccessSubmitLogin, onErrorSubmitLogin)\n\n        $el.on \"submit\", \"form.login-form\", submitLogin\n        $el.on \"click\", \".button-login\", submitLogin\n\n        # Register form\n        $scope.dataRegister = {token: token}\n        registerForm = $el.find(\"form.register-form\").checksley({onlyOneErrorElement: true})\n\n        onSuccessSubmitRegister = (response) ->\n            $analytics.trackEvent(\"auth\", \"invitationAccept\", \"invitation accept with new user\", 1)\n            $location.path($navUrls.resolve(\"project\", {project: $scope.invitation.project_slug}))\n            $confirm.notify(\"success\", \"You've successfully joined this project\",\n                                       \"Welcome to #{_.escape($scope.invitation.project_name)}\")\n\n        onErrorSubmitRegister = (response) ->\n            if response.data._error_message\n                text = $translate.instant(\"COMMON.GENERIC_ERROR\", {error: response.data._error_message})\n                $confirm.notify(\"light-error\", text)\n\n            registerForm.setErrors(response.data)\n\n        submitRegister = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not registerForm.validate()\n                return\n\n            promise = $auth.acceptInvitiationWithNewUser($scope.dataRegister)\n            promise.then(onSuccessSubmitRegister, onErrorSubmitRegister)\n\n        $el.on \"submit\", \"form.register-form\", submitRegister\n        $el.on \"click\", \".button-register\", submitRegister\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgInvitation\", [\"$tgAuth\", \"$tgConfirm\", \"$tgLocation\", \"$routeParams\",\n                                  \"$tgNavUrls\", \"$tgAnalytics\", \"$translate\", InvitationDirective])\n\n\n#############################################################################\n## Change Email\n#############################################################################\n\nChangeEmailDirective = ($repo, $model, $auth, $confirm, $location, $params, $navUrls, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.data = {}\n        $scope.data.email_token = $params.email_token\n        form = $el.find(\"form\").checksley()\n\n        onSuccessSubmit = (response) ->\n            if $auth.isAuthenticated()\n                $repo.queryOne(\"users\", $auth.getUser().id).then (data) =>\n                    $auth.setUser(data)\n                    $location.path($navUrls.resolve(\"home\"))\n            else\n                $location.path($navUrls.resolve(\"login\"))\n\n            text = $translate.instant(\"CHANGE_EMAIL_FORM.SUCCESS\")\n            $confirm.success(text)\n\n        onErrorSubmit = (response) ->\n            text = $translate.instant(\"COMMON.GENERIC_ERROR\", {error: response.data._error_message})\n\n            $confirm.notify(\"light-error\", text)\n\n        submit = ->\n            if not form.validate()\n                return\n\n            promise = $auth.changeEmail($scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        $el.on \"submit\", (event) ->\n            event.preventDefault()\n            submit()\n\n        $el.on \"click\", \"a.button-change-email\", (event) ->\n            event.preventDefault()\n            submit()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgChangeEmail\", [\"$tgRepo\", \"$tgModel\", \"$tgAuth\", \"$tgConfirm\", \"$tgLocation\",\n                                   \"$routeParams\", \"$tgNavUrls\", \"$translate\", ChangeEmailDirective])\n\n\n#############################################################################\n## Cancel account\n#############################################################################\n\nCancelAccountDirective = ($repo, $model, $auth, $confirm, $location, $params, $navUrls) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.data = {}\n        $scope.data.cancel_token = $params.cancel_token\n        form = $el.find(\"form\").checksley()\n\n        onSuccessSubmit = (response) ->\n            $auth.logout()\n            $location.path($navUrls.resolve(\"home\"))\n\n            text = $translate.instant(\"CANCEL_ACCOUNT.SUCCESS\")\n\n            $confirm.success(text)\n\n        onErrorSubmit = (response) ->\n            text = $translate.instant(\"COMMON.GENERIC_ERROR\", {error: response.data._error_message})\n\n            $confirm.notify(\"error\", text)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            promise = $auth.cancelAccount($scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgCancelAccount\", [\"$tgRepo\", \"$tgModel\", \"$tgAuth\", \"$tgConfirm\", \"$tgLocation\",\n                                     \"$routeParams\",\"$tgNavUrls\", CancelAccountDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog.coffee\n###\n\nmodule = angular.module(\"taigaBacklog\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base.coffee\n###\n\ntaiga = @.taiga\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaBase\", [])\n\n#############################################################################\n## Main Directive\n#############################################################################\n\nTaigaMainDirective = ($rootscope, $window) ->\n    link = ($scope, $el, $attrs) ->\n        $window.onresize = () ->\n            $rootscope.$broadcast(\"resize\")\n\n    return {link:link}\n\nmodule.directive(\"tgMain\", [\"$rootScope\", \"$window\", TaigaMainDirective])\n\n#############################################################################\n## Navigation\n#############################################################################\n\nurls = {\n    \"home\": \"/\"\n    \"projects\": \"/projects\"\n    \"error\": \"/error\"\n    \"not-found\": \"/not-found\"\n    \"permission-denied\": \"/permission-denied\"\n\n    \"login\": \"/login\"\n    \"forgot-password\": \"/forgot-password\"\n    \"change-password\": \"/change-password/:token\"\n    \"change-email\": \"/change-email/:token\"\n    \"cancel-account\": \"/cancel-account/:token\"\n    \"register\": \"/register\"\n    \"invitation\": \"/invitation/:token\"\n    \"create-project\": \"/create-project\"\n\n    \"profile\": \"/profile\"\n    \"user-profile\": \"/profile/:username\"\n\n    \"project\": \"/project/:project\"\n    \"project-backlog\": \"/project/:project/backlog\"\n    \"project-taskboard\": \"/project/:project/taskboard/:sprint\"\n    \"project-kanban\": \"/project/:project/kanban\"\n    \"project-issues\": \"/project/:project/issues\"\n    \"project-search\": \"/project/:project/search\"\n\n    \"project-userstories-detail\": \"/project/:project/us/:ref\"\n    \"project-tasks-detail\": \"/project/:project/task/:ref\"\n    \"project-issues-detail\": \"/project/:project/issue/:ref\"\n\n    \"project-wiki\": \"/project/:project/wiki\"\n    \"project-wiki-page\": \"/project/:project/wiki/:slug\"\n\n    # Team\n    \"project-team\": \"/project/:project/team\"\n\n    # Admin\n    \"project-admin-home\": \"/project/:project/admin/project-profile/details\"\n    \"project-admin-project-profile-details\": \"/project/:project/admin/project-profile/details\"\n    \"project-admin-project-profile-default-values\": \"/project/:project/admin/project-profile/default-values\"\n    \"project-admin-project-profile-modules\": \"/project/:project/admin/project-profile/modules\"\n    \"project-admin-project-profile-export\": \"/project/:project/admin/project-profile/export\"\n    \"project-admin-project-profile-reports\": \"/project/:project/admin/project-profile/reports\"\n\n    \"project-admin-project-values-status\": \"/project/:project/admin/project-values/status\"\n    \"project-admin-project-values-points\": \"/project/:project/admin/project-values/points\"\n    \"project-admin-project-values-priorities\": \"/project/:project/admin/project-values/priorities\"\n    \"project-admin-project-values-severities\": \"/project/:project/admin/project-values/severities\"\n    \"project-admin-project-values-types\": \"/project/:project/admin/project-values/types\"\n    \"project-admin-project-values-custom-fields\": \"/project/:project/admin/project-values/custom-fields\"\n\n    \"project-admin-memberships\": \"/project/:project/admin/memberships\"\n    \"project-admin-roles\": \"/project/:project/admin/roles\"\n    \"project-admin-third-parties-webhooks\": \"/project/:project/admin/third-parties/webhooks\"\n    \"project-admin-third-parties-github\": \"/project/:project/admin/third-parties/github\"\n    \"project-admin-third-parties-gitlab\": \"/project/:project/admin/third-parties/gitlab\"\n    \"project-admin-third-parties-bitbucket\": \"/project/:project/admin/third-parties/bitbucket\"\n    \"project-admin-contrib\": \"/project/:project/admin/contrib/:plugin\"\n\n    # User settings\n    \"user-settings-user-profile\": \"/user-settings/user-profile\"\n    \"user-settings-user-change-password\": \"/user-settings/user-change-password\"\n    \"user-settings-user-avatar\": \"/user-settings/user-avatar\"\n    \"user-settings-mail-notifications\": \"/user-settings/mail-notifications\"\n\n}\n\ninit = ($log, $navurls) ->\n    $log.debug \"Initialize navigation urls\"\n    $navurls.update(urls)\n\nmodule.run([\"$log\", \"$tgNavUrls\", init])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common.coffee\n###\n\ntaiga = @.taiga\n\nmodule = angular.module(\"taigaCommon\", [])\n\n#############################################################################\n## Default datepicker config\n#############################################################################\nDataPickerConfig = ($translate) ->\n    return {\n        get: () ->\n            return {\n                i18n: {\n                    previousMonth: $translate.instant(\"COMMON.PICKERDATE.PREV_MONTH\"),\n                    nextMonth:  $translate.instant(\"COMMON.PICKERDATE.NEXT_MONTH\"),\n                    months: [\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.JAN\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.FEB\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.MAR\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.APR\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.MAY\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.JUN\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.JUL\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.AUG\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.SEP\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.OCT\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.NOV\"),\n                        $translate.instant(\"COMMON.PICKERDATE.MONTHS.DEC\")\n                    ],\n                    weekdays: [\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.SUN\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.MON\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.TUE\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.WED\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.THU\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.FRI\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS.SAT\")\n                    ],\n                    weekdaysShort: [\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.SUN\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.MON\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.TUE\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.WED\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.THU\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.FRI\"),\n                        $translate.instant(\"COMMON.PICKERDATE.WEEK_DAYS_SHORT.SAT\")\n                    ]\n                },\n                isRTL: $translate.instant(\"COMMON.PICKERDATE.IS_RTL\") == \"true\",\n                firstDay: parseInt($translate.instant(\"COMMON.PICKERDATE.FIRST_DAY_OF_WEEK\"), 10),\n                format: $translate.instant(\"COMMON.PICKERDATE.FORMAT\")\n            }\n    }\n\nmodule.factory(\"tgDatePickerConfigService\", [\"$translate\", DataPickerConfig])\n\n#############################################################################\n## Get the selected text\n#############################################################################\nSelectedText = ($window, $document) ->\n    get = () ->\n        if $window.getSelection\n            return $window.getSelection().toString()\n        else if $document.selection\n            return $document.selection.createRange().text\n        return \"\"\n\n    return {get: get}\n\nmodule.factory(\"$selectedText\", [\"$window\", \"$document\", SelectedText])\n\n#############################################################################\n## Permission directive, hide elements when necessary\n#############################################################################\n\nCheckPermissionDirective = ->\n    render = ($el, project, permission) ->\n        $el.removeClass('hidden') if project.my_permissions.indexOf(permission) > -1\n\n    link = ($scope, $el, $attrs) ->\n        $el.addClass('hidden')\n        permission = $attrs.tgCheckPermission\n\n        $scope.$watch \"project\", (project) ->\n            render($el, project, permission) if project?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgCheckPermission\", CheckPermissionDirective)\n\n#############################################################################\n## Add class based on permissions\n#############################################################################\n\nClassPermissionDirective = ->\n    name = \"tgClassPermission\"\n\n    link = ($scope, $el, $attrs) ->\n        checkPermissions = (project, className, permission) ->\n            negation = permission[0] == \"!\"\n\n            permission = permission.slice(1) if negation\n\n            if negation && project.my_permissions.indexOf(permission) == -1\n                $el.addClass(className)\n            else if !negation && project.my_permissions.indexOf(permission) != -1\n                $el.addClass(className)\n            else\n                $el.removeClass(className)\n\n        tgClassPermissionWatchAction = (project) ->\n            if project\n                unbindWatcher()\n\n                classes = $scope.$eval($attrs[name])\n\n                for className, permission of classes\n                    checkPermissions(project, className, permission)\n\n\n        unbindWatcher = $scope.$watch \"project\", tgClassPermissionWatchAction\n\n    return {link:link}\n\nmodule.directive(\"tgClassPermission\", ClassPermissionDirective)\n\n#############################################################################\n## Animation frame service, apply css changes in the next render frame\n#############################################################################\nAnimationFrame = () ->\n    animationFrame =\n        window.requestAnimationFrame       ||\n        window.webkitRequestAnimationFrame ||\n        window.mozRequestAnimationFrame\n\n    performAnimation = (time) =>\n        fn = tail.shift()\n        fn()\n\n        if (tail.length)\n            animationFrame(performAnimation)\n\n    tail = []\n\n    add = () ->\n        for fn in arguments\n            tail.push(fn)\n\n            if tail.length == 1\n                animationFrame(performAnimation)\n\n    return {add: add}\n\nmodule.factory(\"animationFrame\", AnimationFrame)\n\n#############################################################################\n## Open/close comment\n#############################################################################\n\nToggleCommentDirective = () ->\n    link = ($scope, $el, $attrs) ->\n        $el.find(\"textarea\").on \"focus\", () ->\n            $el.addClass(\"active\")\n\n    return {link:link}\n\nmodule.directive(\"tgToggleComment\", ToggleCommentDirective)\n\n\n#############################################################################\n## Get the appropiate section url for a project\n## according to his enabled modules and user permisions\n#############################################################################\n\nProjectUrl = ($navurls) ->\n    get = (project) ->\n        ctx = {project: project.slug}\n\n        if project.is_backlog_activated and project.my_permissions.indexOf(\"view_us\") > -1\n            return $navurls.resolve(\"project-backlog\", ctx)\n        if project.is_kanban_activated and project.my_permissions.indexOf(\"view_us\") > -1\n            return $navurls.resolve(\"project-kanban\", ctx)\n        if project.is_wiki_activated and project.my_permissions.indexOf(\"view_wiki_pages\") > -1\n            return $navurls.resolve(\"project-wiki\", ctx)\n        if project.is_issues_activated and project.my_permissions.indexOf(\"view_issues\") > -1\n            return $navurls.resolve(\"project-issues\", ctx)\n\n        return $navurls.resolve(\"project\", ctx)\n\n    return {get: get}\n\nmodule.factory(\"$projectUrl\", [\"$tgNavUrls\", ProjectUrl])\n\n\n#############################################################################\n## Limite line size in a text area\n#############################################################################\n\nLimitLineLengthDirective = () ->\n    link = ($scope, $el, $attrs) ->\n        maxColsPerLine = parseInt($el.attr(\"cols\"))\n        $el.on \"keyup\", (event) ->\n            code = event.keyCode\n            lines = $el.val().split(\"\\n\")\n\n            _.each lines, (line, index) ->\n                lines[index] = line.substring(0, maxColsPerLine - 2)\n\n            $el.val(lines.join(\"\\n\"))\n\n    return {link:link}\n\nmodule.directive(\"tgLimitLineLength\", LimitLineLengthDirective)\n\n#############################################################################\n## Queue Q promises\n#############################################################################\n\nQqueue = ($q) ->\n    deferred = $q.defer()\n    deferred.resolve()\n\n    lastPromise = deferred.promise\n\n    qqueue = {\n        bindAdd: (fn) =>\n            return (args...) =>\n                lastPromise = lastPromise.then () => fn.apply(@, args)\n\n            return qqueue\n        add: (fn) =>\n            if !lastPromise\n                lastPromise = fn()\n            else\n                lastPromise = lastPromise.then(fn)\n\n            return qqueue\n    }\n\n    return qqueue\n\nmodule.factory(\"$tgQqueue\", [\"$q\", Qqueue])\n\n#############################################################################\n## Templates\n#############################################################################\n\nTemplate = ($templateCache) ->\n    return {\n        get: (name, lodash = false) =>\n            tmp = $templateCache.get(name)\n\n            if lodash\n                tmp = _.template(tmp)\n\n            return tmp\n    }\n\nmodule.factory(\"$tgTemplate\", [\"$templateCache\", Template])\n\n#############################################################################\n## Permission directive, hide elements when necessary\n#############################################################################\n\nCapslock = ($translate) ->\n    link = ($scope, $el, $attrs) ->\n        open = false\n\n        warningIcon = $('<div>')\n            .addClass('icon')\n            .addClass('icon-capslock')\n            .attr('title', $translate.instant('COMMON.CAPSLOCK_WARNING'))\n\n        hideIcon = () ->\n            warningIcon.fadeOut () ->\n                open = false\n\n                $(this).remove()\n\n        showIcon = (e) ->\n            return if open\n            element = e.currentTarget\n            $(element).parent().append(warningIcon)\n            $('.icon-capslock').fadeIn()\n\n            open = true\n\n        $el.on 'blur', (e) ->\n            hideIcon()\n\n        $el.on 'keyup.capslock, focus', (e) ->\n            if $el.val() == $el.val().toLowerCase()\n                hideIcon(e)\n            else\n                showIcon(e)\n\n        $scope.$on \"$destroy\", ->\n            $el.off('.capslock')\n\n    return {link:link}\n\nmodule.directive(\"tgCapslock\", [\"$translate\", Capslock])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/events.coffee\n###\n\ntaiga = @.taiga\nstartswith = @.taiga.startswith\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaEvents\", [])\n\n\nclass EventsService\n    constructor: (@win, @log, @config, @auth) ->\n        bindMethods(@)\n\n    initialize: (sessionId) ->\n        @.sessionId = sessionId\n        @.subscriptions = {}\n        @.connected = false\n        @.error = false\n        @.pendingMessages = []\n\n        if @win.WebSocket is undefined\n            @log.info \"WebSockets not supported on your browser\"\n\n    setupConnection: ->\n        @.stopExistingConnection()\n\n        url = @config.get(\"eventsUrl\")\n\n        # This allows disable events in case\n        # url is not found on the configuration.\n        return if not url\n\n        # This allows relative urls in configuration.\n        if not startswith(url, \"ws:\") and not startswith(url, \"wss:\")\n            loc = @win.location\n            scheme = if loc.protocol == \"https:\" then \"wss:\" else \"ws:\"\n            path = _.str.ltrim(url, \"/\")\n            url = \"#{scheme}//#{loc.host}/#{path}\"\n\n        @.ws = new @win.WebSocket(url)\n        @.ws.addEventListener(\"open\", @.onOpen)\n        @.ws.addEventListener(\"message\", @.onMessage)\n        @.ws.addEventListener(\"error\", @.onError)\n        @.ws.addEventListener(\"close\", @.onClose)\n\n    stopExistingConnection: ->\n        if @.ws is undefined\n            return\n\n        @.ws.removeEventListener(\"open\", @.onOpen)\n        @.ws.removeEventListener(\"close\", @.onClose)\n        @.ws.removeEventListener(\"error\", @.onError)\n        @.ws.removeEventListener(\"message\", @.onMessage)\n        @.ws.close()\n\n        delete @.ws\n\n    serialize: (message) ->\n        if _.isObject(message)\n            return JSON.stringify(message)\n        return message\n\n    sendMessage: (message) ->\n        @.pendingMessages.push(message)\n\n        if not @.connected\n            return\n\n        messages = _.map(@.pendingMessages, @.serialize)\n        @.pendingMessages = []\n\n        for msg in messages\n            @.ws.send(msg)\n\n    subscribe: (scope, routingKey, callback) ->\n        if @.error\n            return\n\n        @log.debug(\"Subscribe to: #{routingKey}\")\n        subscription = {\n            scope: scope,\n            routingKey: routingKey,\n            callback: _.debounce(callback, 500, {\"leading\": true, \"trailing\": false})\n        }\n\n        message = {\n            \"cmd\": \"subscribe\",\n            \"routing_key\": routingKey\n        }\n\n        @.subscriptions[routingKey] = subscription\n        @.sendMessage(message)\n        scope.$on(\"$destroy\", => @.unsubscribe(routingKey))\n\n    unsubscribe: (routingKey) ->\n        if @.error\n            return\n\n        @log.debug(\"Unsubscribe from: #{routingKey}\")\n\n        message = {\n            \"cmd\": \"unsubscribe\",\n            \"routing_key\": routingKey\n        }\n\n        @.sendMessage(message)\n\n    onOpen: ->\n        @.connected = true\n\n        @log.debug(\"WebSocket connection opened\")\n        token = @auth.getToken()\n\n        message = {\n            cmd: \"auth\"\n            data: {token: token, sessionId: @.sessionId}\n        }\n\n        @.sendMessage(message)\n\n    onMessage: (event) ->\n        @.log.debug \"WebSocket message received: #{event.data}\"\n\n        data = JSON.parse(event.data)\n        routingKey = data.routing_key\n\n        if not @.subscriptions[routingKey]?\n            return\n\n        subscription = @.subscriptions[routingKey]\n        subscription.scope.$apply ->\n            subscription.callback(data.data)\n\n    onError: (error) ->\n        @log.error(\"WebSocket error: #{error}\")\n        @.error = true\n\n    onClose: ->\n        @log.debug(\"WebSocket closed.\")\n        @.connected = false\n\n\nclass EventsProvider\n    setSessionId: (sessionId) ->\n        @.sessionId = sessionId\n\n    $get: ($win, $log, $conf, $auth) ->\n        service = new EventsService($win, $log, $conf, $auth)\n        service.initialize(@.sessionId)\n        return service\n\n    @.prototype.$get.$inject = [\"$window\", \"$log\", \"$tgConfig\", \"$tgAuth\"]\n\nmodule.provider(\"$tgEvents\", EventsProvider)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/feedback.coffee\n###\n\ntaiga = @.taiga\n\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\nmixOf = @.taiga.mixOf\ndebounce = @.taiga.debounce\ntrim = @.taiga.trim\n\nmodule = angular.module(\"taigaFeedback\", [])\n\nFeedbackDirective = ($lightboxService, $repo, $confirm, $loading, feedbackService)->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley()\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.create(\"feedback\", $scope.feedback)\n\n            promise.then (data) ->\n                currentLoading.finish()\n                $lightboxService.close($el)\n                $confirm.notify(\"success\", \"\\\\o/ we'll be happy to read your\")\n\n            promise.then null, ->\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        openLightbox = ->\n            $scope.feedback = {}\n            $lightboxService.open($el)\n            $el.find(\"textarea\").focus()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        openLightbox()\n\n    directive = {\n        link: link,\n        templateUrl: \"common/lightbox-feedback.html\"\n        scope: {}\n    }\n\n    return directive\n\nmodule.directive(\"tgLbFeedback\", [\"lightboxService\", \"$tgRepo\", \"$tgConfirm\",\n    \"$tgLoading\", \"tgFeedbackService\", FeedbackDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/integrations.coffee\n###\n\nmodule = angular.module(\"taigaIntegrations\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/issues.coffee\n###\n\nmodule = angular.module(\"taigaIssues\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/kanban.coffee\n###\n\nmodule = angular.module(\"taigaKanban\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/projects.coffee\n###\n\nmodule = angular.module(\"taigaProject\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/related-tasks.coffee\n###\n\ntaiga = @.taiga\ntrim = @.taiga.trim\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaRelatedTasks\", [])\n\nRelatedTaskRowDirective = ($repo, $compile, $confirm, $rootscope, $loading, $template, $translate) ->\n    templateView = $template.get(\"task/related-task-row.html\", true)\n    templateEdit = $template.get(\"task/related-task-row-edit.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        saveTask = debounce 2000, (task) ->\n            task.subject = $el.find('input').val()\n\n            currentLoading = $loading()\n                .target($el.find('.task-name'))\n                .start()\n\n            promise = $repo.save(task)\n            promise.then =>\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"related-tasks:update\")\n\n            promise.then null, =>\n                currentLoading.finish()\n                $el.find('input').val(task.subject)\n                $confirm.notify(\"error\")\n            return promise\n\n        renderEdit = (task) ->\n            $el.html($compile(templateEdit({task: task}))($scope))\n\n            $el.on \"keyup\", \"input\", (event) ->\n                if event.keyCode == 13\n                    saveTask($model.$modelValue).then ->\n                        renderView($model.$modelValue)\n                else if event.keyCode == 27\n                    renderView($model.$modelValue)\n\n            $el.on \"click\", \".icon-floppy\", (event) ->\n                saveTask($model.$modelValue).then ->\n                    renderView($model.$modelValue)\n\n            $el.on \"click\", \".cancel-edit\", (event) ->\n                renderView($model.$modelValue)\n\n        renderView = (task) ->\n            $el.off()\n\n            perms = {\n                modify_task: $scope.project.my_permissions.indexOf(\"modify_task\") != -1\n                delete_task: $scope.project.my_permissions.indexOf(\"delete_task\") != -1\n            }\n\n            $el.html($compile(templateView({task: task, perms: perms}))($scope))\n\n            $el.on \"click\", \".icon-edit\", ->\n                renderEdit($model.$modelValue)\n                $el.find('input').focus().select()\n\n            $el.on \"click\", \".delete-task\", (event) ->\n                title = $translate.instant(\"TASK.TITLE_DELETE_ACTION\")\n                task = $model.$modelValue\n                message = task.subject\n\n                $confirm.askOnDelete(title, message).then (askResponse) ->\n                    promise = $repo.remove(task)\n                    promise.then ->\n                        askResponse.finish()\n                        $confirm.notify(\"success\")\n                        $scope.$emit(\"related-tasks:delete\")\n\n                    promise.then null, ->\n                        askResponse.finish(false)\n                        $confirm.notify(\"error\")\n\n        $scope.$watch $attrs.ngModel, (val) ->\n            return if not val\n            renderView(val)\n\n        $scope.$on \"related-tasks:assigned-to-changed\", ->\n            $rootscope.$broadcast(\"related-tasks:update\")\n\n        $scope.$on \"related-tasks:status-changed\", ->\n            $rootscope.$broadcast(\"related-tasks:update\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link, require:\"ngModel\"}\n\nmodule.directive(\"tgRelatedTaskRow\", [\"$tgRepo\", \"$compile\", \"$tgConfirm\", \"$rootScope\", \"$tgLoading\", \"$tgTemplate\", \"$translate\", RelatedTaskRowDirective])\n\nRelatedTaskCreateFormDirective = ($repo, $compile, $confirm, $tgmodel, $loading, $analytics, $template) ->\n    template = $template.get(\"task/related-task-create-form.html\", true)\n\n    newTask = {\n        subject: \"\"\n        assigned_to: null\n    }\n\n    link = ($scope, $el, $attrs) ->\n        createTask = debounce 2000, (task) ->\n            task.subject = $el.find('input').val()\n            task.assigned_to = $scope.newTask.assigned_to\n            task.status = $scope.newTask.status\n            $scope.newTask.status = $scope.project.default_task_status\n            $scope.newTask.assigned_to = null\n\n            currentLoading = $loading()\n                .target($el.find('.task-name'))\n                .start()\n\n            promise = $repo.create(\"tasks\", task)\n            promise.then ->\n                $analytics.trackEvent(\"task\", \"create\", \"create task on userstory\", 1)\n                currentLoading.finish()\n                $scope.$emit(\"related-tasks:add\")\n                $confirm.notify(\"success\")\n\n            promise.then null, ->\n                $el.find('input').val(task.subject)\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n            return promise\n\n        close = () ->\n            $el.off()\n            $el.html(\"\")\n\n            $scope.newRelatedTaskFormOpen = false\n\n        render = ->\n            $scope.newRelatedTaskFormOpen = true\n\n            $el.html($compile(template())($scope))\n            $el.find('input').focus().select()\n            $el.addClass('active')\n\n            $el.on \"keyup\", \"input\", (event)->\n                if event.keyCode == 13\n                    createTask(newTask).then ->\n                        render()\n                else if event.keyCode == 27\n                    $scope.$apply () -> close()\n\n            $el.on \"click\", \".icon-delete\", (event)->\n                $scope.$apply () -> close()\n\n            $el.on \"click\", \".icon-floppy\", (event)->\n                createTask(newTask).then ->\n                    close()\n\n        taiga.bindOnce $scope, \"us\", (val) ->\n            newTask[\"status\"] = $scope.project.default_task_status\n            newTask[\"project\"] = $scope.project.id\n            newTask[\"user_story\"] = $scope.us.id\n            $scope.newTask = $tgmodel.make_model(\"tasks\", newTask)\n            $el.html(\"\")\n\n        $scope.$on \"related-tasks:show-form\", ->\n            render()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\nmodule.directive(\"tgRelatedTaskCreateForm\", [\"$tgRepo\", \"$compile\", \"$tgConfirm\", \"$tgModel\", \"$tgLoading\", \"$tgAnalytics\", \"$tgTemplate\", RelatedTaskCreateFormDirective])\n\nRelatedTaskCreateButtonDirective = ($repo, $compile, $confirm, $tgmodel) ->\n    template = _.template(\"\"\"\n        <a ng-show=\"!newRelatedTaskFormOpen\" class=\"icon icon-plus related-tasks-buttons ng-animate-disabled\"></a>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        $scope.$watch \"project\", (val) ->\n            return if not val\n            $el.off()\n            if $scope.project.my_permissions.indexOf(\"add_task\") != -1\n                $el.html($compile(template())($scope))\n            else\n                $el.html(\"\")\n\n            $el.on \"click\", \".icon\", (event)->\n                $scope.$emit(\"related-tasks:add-new-clicked\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\nmodule.directive(\"tgRelatedTaskCreateButton\", [\"$tgRepo\", \"$compile\", \"$tgConfirm\", \"$tgModel\", RelatedTaskCreateButtonDirective])\n\nRelatedTasksDirective = ($repo, $rs, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        loadTasks = ->\n            return $rs.tasks.list($scope.projectId, null, $scope.usId).then (tasks) =>\n                $scope.tasks = _.sortBy(tasks, 'ref')\n                return tasks\n\n        $scope.$on \"related-tasks:add\", ->\n            loadTasks().then ->\n                $rootscope.$broadcast(\"related-tasks:update\")\n\n        $scope.$on \"related-tasks:delete\", ->\n            loadTasks().then ->\n                $rootscope.$broadcast(\"related-tasks:update\")\n\n        $scope.$on \"related-tasks:add-new-clicked\", ->\n            $scope.$broadcast(\"related-tasks:show-form\")\n\n        taiga.bindOnce $scope, \"us\", (val) ->\n            loadTasks()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\nmodule.directive(\"tgRelatedTasks\", [\"$tgRepo\", \"$tgResources\", \"$rootScope\", RelatedTasksDirective])\n\nRelatedTaskAssignedToInlineEditionDirective = ($repo, $rootscope, popoverService) ->\n    template = _.template(\"\"\"\n    <img src=\"<%- imgurl %>\" alt=\"<%- name %>\"/>\n    <figcaption><%- name %></figcaption>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        updateRelatedTask = (task) ->\n            ctx = {name: \"Unassigned\", imgurl: \"/images/unnamed.png\"}\n            member = $scope.usersById[task.assigned_to]\n            if member\n                ctx.imgurl = member.photo\n                ctx.name = member.full_name_display\n\n            $el.find(\".avatar\").html(template(ctx))\n            $el.find(\".task-assignedto\").attr('title', ctx.name)\n\n        $ctrl = $el.controller()\n        task = $scope.$eval($attrs.tgRelatedTaskAssignedToInlineEdition)\n        notAutoSave = $scope.$eval($attrs.notAutoSave)\n        autoSave = !notAutoSave\n\n        updateRelatedTask(task)\n\n        $el.on \"click\", \".task-assignedto\", (event) ->\n            $rootscope.$broadcast(\"assigned-to:add\", task)\n\n        taiga.bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions the click events are unbinded\n            if project.my_permissions.indexOf(\"modify_task\") == -1\n                $el.unbind(\"click\")\n                $el.find(\"a\").addClass(\"not-clickable\")\n\n        $scope.$on \"assigned-to:added\", debounce 2000, (ctx, userId, updatedRelatedTask) =>\n            if updatedRelatedTask.id == task.id\n                updatedRelatedTask.assigned_to = userId\n                if autoSave\n                    $repo.save(updatedRelatedTask).then ->\n                        $scope.$emit(\"related-tasks:assigned-to-changed\")\n                updateRelatedTask(updatedRelatedTask)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgRelatedTaskAssignedToInlineEdition\", [\"$tgRepo\", \"$rootScope\", RelatedTaskAssignedToInlineEditionDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources.coffee\n###\n\ntaiga = @.taiga\n\nclass ResourcesService extends taiga.Service\n\nurls = {\n    # Auth\n    \"auth\": \"/auth\"\n    \"auth-register\": \"/auth/register\"\n    \"invitations\": \"/invitations\"\n\n    # User\n    \"users\": \"/users\"\n    \"by_username\": \"/users/by_username\"\n    \"users-password-recovery\": \"/users/password_recovery\"\n    \"users-change-password-from-recovery\": \"/users/change_password_from_recovery\"\n    \"users-change-password\": \"/users/change_password\"\n    \"users-change-email\": \"/users/change_email\"\n    \"users-cancel-account\": \"/users/cancel\"\n    \"user-stats\": \"/users/%s/stats\"\n    \"user-liked\": \"/users/%s/liked\"\n    \"user-voted\": \"/users/%s/voted\"\n    \"user-watched\": \"/users/%s/watched\"\n    \"user-contacts\": \"/users/%s/contacts\"\n\n    # User - Notification\n    \"permissions\": \"/permissions\"\n    \"notify-policies\": \"/notify-policies\"\n\n    # User - Storage\n    \"user-storage\": \"/user-storage\"\n\n    # Memberships\n    \"memberships\": \"/memberships\"\n    \"bulk-create-memberships\": \"/memberships/bulk_create\"\n\n    # Roles & Permissions\n    \"roles\": \"/roles\"\n    \"permissions\": \"/permissions\"\n\n    # Resolver\n    \"resolver\": \"/resolver\"\n\n    # Project\n    \"projects\": \"/projects\"\n    \"project-templates\": \"/project-templates\"\n    \"project-modules\": \"/projects/%s/modules\"\n    \"bulk-update-projects-order\": \"/projects/bulk_update_order\"\n    \"project-like\": \"/projects/%s/like\"\n    \"project-unlike\": \"/projects/%s/unlike\"\n    \"project-watch\": \"/projects/%s/watch\"\n    \"project-unwatch\": \"/projects/%s/unwatch\"\n\n    # Project Values - Choises\n    \"userstory-statuses\": \"/userstory-statuses\"\n    \"points\": \"/points\"\n    \"task-statuses\": \"/task-statuses\"\n    \"issue-statuses\": \"/issue-statuses\"\n    \"issue-types\": \"/issue-types\"\n    \"priorities\": \"/priorities\"\n    \"severities\": \"/severities\"\n\n    # Milestones/Sprints\n    \"milestones\": \"/milestones\"\n\n    # User stories\n    \"userstories\": \"/userstories\"\n    \"bulk-create-us\": \"/userstories/bulk_create\"\n    \"bulk-update-us-backlog-order\": \"/userstories/bulk_update_backlog_order\"\n    \"bulk-update-us-sprint-order\": \"/userstories/bulk_update_sprint_order\"\n    \"bulk-update-us-kanban-order\": \"/userstories/bulk_update_kanban_order\"\n    \"userstories-filters\": \"/userstories/filters_data\"\n    \"userstory-upvote\": \"/userstories/%s/upvote\"\n    \"userstory-downvote\": \"/userstories/%s/downvote\"\n    \"userstory-watch\": \"/userstories/%s/watch\"\n    \"userstory-unwatch\": \"/userstories/%s/unwatch\"\n\n    # Tasks\n    \"tasks\": \"/tasks\"\n    \"bulk-create-tasks\": \"/tasks/bulk_create\"\n    \"bulk-update-task-taskboard-order\": \"/tasks/bulk_update_taskboard_order\"\n    \"task-upvote\": \"/tasks/%s/upvote\"\n    \"task-downvote\": \"/tasks/%s/downvote\"\n    \"task-watch\": \"/tasks/%s/watch\"\n    \"task-unwatch\": \"/tasks/%s/unwatch\"\n\n    # Issues\n    \"issues\": \"/issues\"\n    \"bulk-create-issues\": \"/issues/bulk_create\"\n    \"issues-filters\": \"/issues/filters_data\"\n    \"issue-upvote\": \"/issues/%s/upvote\"\n    \"issue-downvote\": \"/issues/%s/downvote\"\n    \"issue-watch\": \"/issues/%s/watch\"\n    \"issue-unwatch\": \"/issues/%s/unwatch\"\n\n    # Wiki pages\n    \"wiki\": \"/wiki\"\n    \"wiki-restore\": \"/wiki/%s/restore\"\n    \"wiki-links\": \"/wiki-links\"\n\n    # History\n    \"history/us\": \"/history/userstory\"\n    \"history/issue\": \"/history/issue\"\n    \"history/task\": \"/history/task\"\n    \"history/wiki\": \"/history/wiki\"\n\n    # Attachments\n    \"attachments/us\": \"/userstories/attachments\"\n    \"attachments/issue\": \"/issues/attachments\"\n    \"attachments/task\": \"/tasks/attachments\"\n    \"attachments/wiki_page\": \"/wiki/attachments\"\n\n    # Custom Attributess\n    \"custom-attributes/userstory\": \"/userstory-custom-attributes\"\n    \"custom-attributes/issue\": \"/issue-custom-attributes\"\n    \"custom-attributes/task\": \"/task-custom-attributes\"\n\n    # Custom Attributess - Values\n    \"custom-attributes-values/userstory\": \"/userstories/custom-attributes-values\"\n    \"custom-attributes-values/issue\": \"/issues/custom-attributes-values\"\n    \"custom-attributes-values/task\": \"/tasks/custom-attributes-values\"\n\n    # Webhooks\n    \"webhooks\": \"/webhooks\"\n    \"webhooks-test\": \"/webhooks/%s/test\"\n    \"webhooklogs\": \"/webhooklogs\"\n    \"webhooklogs-resend\": \"/webhooklogs/%s/resend\"\n\n    # Reports - CSV\n    \"userstories-csv\": \"/userstories/csv?uuid=%s\"\n    \"tasks-csv\": \"/tasks/csv?uuid=%s\"\n    \"issues-csv\": \"/issues/csv?uuid=%s\"\n\n    # Timeline\n    \"timeline-profile\": \"/timeline/profile\"\n    \"timeline-user\": \"/timeline/user\"\n    \"timeline-project\": \"/timeline/project\"\n\n    # Search\n    \"search\": \"/search\"\n\n    # Export/Import\n    \"exporter\": \"/exporter\"\n    \"importer\": \"/importer/load_dump\"\n\n    # Feedback\n    \"feedback\": \"/feedback\"\n\n    # locales\n    \"locales\": \"/locales\"\n\n    # Application tokens\n    \"applications\": \"/applications\"\n    \"application-tokens\": \"/application-tokens\"\n}\n\n# Initialize api urls service\ninitUrls = ($log, $urls) ->\n    $log.debug \"Initialize api urls\"\n    $urls.update(urls)\n\n# Initialize resources service populating it with methods\n# defined in separated files.\ninitResources = ($log, $rs) ->\n    $log.debug \"Initialize resources\"\n    providers = _.toArray(arguments).slice(2)\n\n    for provider in providers\n        provider($rs)\n\nmodule = angular.module(\"taigaResources\", [\"taigaBase\"])\nmodule.service(\"$tgResources\", ResourcesService)\n\n# Module entry point\nmodule.run([\"$log\", \"$tgUrls\", initUrls])\nmodule.run([\n    \"$log\",\n    \"$tgResources\",\n    \"$tgProjectsResourcesProvider\",\n    \"$tgCustomAttributesResourcesProvider\",\n    \"$tgCustomAttributesValuesResourcesProvider\",\n    \"$tgMembershipsResourcesProvider\",\n    \"$tgNotifyPoliciesResourcesProvider\",\n    \"$tgInvitationsResourcesProvider\",\n    \"$tgRolesResourcesProvider\",\n    \"$tgUserSettingsResourcesProvider\",\n    \"$tgSprintsResourcesProvider\",\n    \"$tgUserstoriesResourcesProvider\",\n    \"$tgTasksResourcesProvider\",\n    \"$tgIssuesResourcesProvider\",\n    \"$tgWikiResourcesProvider\",\n    \"$tgSearchResourcesProvider\",\n    \"$tgAttachmentsResourcesProvider\",\n    \"$tgMdRenderResourcesProvider\",\n    \"$tgHistoryResourcesProvider\",\n    \"$tgKanbanResourcesProvider\",\n    \"$tgModulesResourcesProvider\",\n    \"$tgWebhooksResourcesProvider\",\n    \"$tgWebhookLogsResourcesProvider\",\n    \"$tgLocalesResourcesProvider\",\n    \"$tgUsersResourcesProvider\",\n    initResources\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/search.coffee\n###\n\ntaiga = @.taiga\n\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\nmixOf = @.taiga.mixOf\ndebounceLeading = @.taiga.debounceLeading\ntrim = @.taiga.trim\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaSearch\", [])\n\n\n#############################################################################\n## Search Controller\n#############################################################################\n\nclass SearchController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @repo, @rs, @params, @q, @location, @appMetaService, @navUrls, @translate) ->\n        @scope.sectionName = \"Search\"\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"SEARCH.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @translate.instant(\"SEARCH.PAGE_DESCRIPTION\", {\n                projectName: @scope.project.name,\n                projectDescription: @scope.project.description\n            })\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        # Search input watcher\n        @scope.searchTerm = null\n        loadSearchData = debounceLeading(100, (t) => @.loadSearchData(t))\n\n        bindOnce @scope, \"projectId\", (projectId) =>\n            if !@scope.searchResults && @scope.searchTerm\n                @.loadSearchData()\n\n        @scope.$watch \"searchTerm\", (term) =>\n            if term != undefined && @scope.projectId\n                @.loadSearchData(term)\n\n    loadFilters: ->\n        defered = @q.defer()\n        defered.resolve()\n        return defered.promise\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            @scope.issueStatusById = groupBy(project.issue_statuses, (x) -> x.id)\n            @scope.taskStatusById = groupBy(project.task_statuses, (x) -> x.id)\n            @scope.severityById = groupBy(project.severities, (x) -> x.id)\n            @scope.priorityById = groupBy(project.priorities, (x) -> x.id)\n            @scope.usStatusById = groupBy(project.us_statuses, (x) -> x.id)\n            return project\n\n    loadSearchData: (term = \"\") ->\n        @scope.loading = true\n\n        @._loadSearchData(term).then (data) =>\n            if data\n                @scope.searchResults = data\n                @scope.loading = false\n\n    _loadSearchData: (term = \"\") ->\n        @.deferredAbort.resolve() if @.deferredAbort\n\n        @.deferredAbort = @q.defer()\n\n        @rs.search.do(@scope.projectId, term).then (data) =>\n            @.deferredAbort.resolve(data)\n\n        return @.deferredAbort.promise\n\n    loadInitialData: ->\n        return @.loadProject().then (project) =>\n            @scope.projectId = project.id\n            @.fillUsersAndRoles(project.members, project.roles)\n\nmodule.controller(\"SearchController\", SearchController)\n\n\n#############################################################################\n## Search box directive\n#############################################################################\n\nSearchBoxDirective = (projectService, $lightboxService, $navurls, $location, $route)->\n    link = ($scope, $el, $attrs) ->\n        project = null\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            if not form.validate()\n                return\n\n            text = $el.find(\"#search-text\").val()\n\n            url = $navurls.resolve(\"project-search\", {project: project.get(\"slug\")})\n\n            $scope.$apply ->\n                $lightboxService.close($el)\n\n                $location.path(url)\n                $location.search(\"text\", text).path(url)\n                $route.reload()\n\n\n        openLightbox = () ->\n            project = projectService.project\n\n            $lightboxService.open($el).then () ->\n                $el.find(\"#search-text\").focus()\n\n        $el.on \"submit\", \"form\", submit\n\n        openLightbox()\n\n    return {\n        templateUrl: \"search/lightbox-search.html\",\n        link:link\n    }\n\nSearchBoxDirective.$inject = [\n    \"tgProjectService\",\n    \"lightboxService\",\n    \"$tgNavUrls\",\n    \"$tgLocation\",\n    \"$route\"\n]\n\nmodule.directive(\"tgSearchBox\", SearchBoxDirective)\n\n\n#############################################################################\n## Search Directive\n#############################################################################\n\nSearchDirective = ($log, $compile, $templatecache, $routeparams, $location) ->\n    linkTable = ($scope, $el, $attrs, $ctrl) ->\n        applyAutoTab = true\n        activeSectionName = \"userstories\"\n        tabsDom = $el.find(\"section.search-filter\")\n        lastSearchResults = null\n\n        getActiveSection = (data) ->\n            maxVal = 0\n            selectedSection = {}\n            selectedSection.name = \"userstories\"\n            selectedSection.value = []\n\n            if !applyAutoTab\n                selectedSection.name = activeSectionName\n                selectedSection.value = data[activeSectionName]\n\n                return selectedSection\n\n            if data\n                for name in [\"userstories\", \"issues\", \"tasks\", \"wikipages\"]\n                    value = data[name]\n\n                    if value.length > maxVal\n                        maxVal = value.length\n                        selectedSection.name = name\n                        selectedSection.value = value\n                        break;\n\n            if maxVal == 0\n                return selectedSection\n\n            return selectedSection\n\n        renderFilterTabs = (data) ->\n            for name, value of data\n                continue if name == \"count\"\n                tabsDom.find(\"li.#{name} .num\").html(value.length)\n\n        markSectionTabActive = (section) ->\n            # Mark as active the item with max amount of results\n            tabsDom.find(\"a.active\").removeClass(\"active\")\n            tabsDom.find(\"li.#{section.name} a\").addClass(\"active\")\n\n            applyAutoTab = false\n            activeSectionName = section.name\n\n        templates = {\n            issues: $templatecache.get(\"search-issues\")\n            tasks: $templatecache.get(\"search-tasks\")\n            userstories: $templatecache.get(\"search-userstories\")\n            wikipages: $templatecache.get(\"search-wikipages\")\n        }\n\n        renderTableContent = (section) ->\n            oldElements = $el.find(\".search-result-table\").children()\n            oldScope = oldElements.scope()\n\n            if oldScope\n                oldScope.$destroy()\n                oldElements.remove()\n\n            scope = $scope.$new()\n            scope[section.name] = section.value\n\n            template = angular.element.parseHTML(trim(templates[section.name]))\n            element = $compile(template)(scope)\n            $el.find(\".search-result-table\").html(element)\n\n        $scope.$watch \"searchResults\", (data) ->\n            lastSearchResults = data\n\n            return if !lastSearchResults\n\n            activeSection = getActiveSection(data)\n\n            renderFilterTabs(data)\n\n            renderTableContent(activeSection)\n            markSectionTabActive(activeSection)\n\n        $scope.$watch \"searchTerm\", (searchTerm) ->\n            $location.search(\"text\", searchTerm) if searchTerm != undefined\n\n        $el.on \"click\", \".search-filter li > a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            sectionName = target.parent().data(\"name\")\n            sectionData = if !lastSearchResults then [] else lastSearchResults[sectionName]\n\n            section = {\n                name: sectionName,\n                value: sectionData\n            }\n\n            $scope.$apply ->\n                renderTableContent(section)\n                markSectionTabActive(section)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        linkTable($scope, $el, $attrs, $ctrl)\n\n        searchText = $routeparams.text\n        $scope.$watch \"projectId\", (projectId) ->\n            $scope.searchTerm =  searchText if projectId?\n\n    return {link:link}\n\nmodule.directive(\"tgSearch\", [\"$log\", \"$compile\", \"$templateCache\", \"$routeParams\", \"$tgLocation\",\n                              SearchDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/taskboard.coffee\n###\n\nmodule = angular.module(\"taigaTaskboard\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/tasks.coffee\n###\n\nmodule = angular.module(\"taigaTasks\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/team.coffee\n###\n\nmodule = angular.module(\"taigaTeam\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/user-settings.coffee\n###\n\nmodule = angular.module(\"taigaUserSettings\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/userstories.coffee\n###\n\nmodule = angular.module(\"taigaUserStories\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/wiki.coffee\n###\n\nmodule = angular.module(\"taigaWiki\", [])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/analytics.coffee\n###\n\ntaiga = @.taiga\nmodule = angular.module(\"taigaCommon\")\n\n\nclass AnalyticsService extends taiga.Service\n    @.$inject = [\"$rootScope\", \"$log\", \"$tgConfig\", \"$window\", \"$document\", \"$location\"]\n\n    constructor: (@rootscope, @log, @config, @win, @doc, @location) ->\n        @.initialized = false\n\n        conf = @config.get(\"analytics\", {})\n\n        @.accountId = conf.accountId\n        @.pageEvent = conf.pageEvent or \"$routeChangeSuccess\"\n        @.trackRoutes = conf.trackRoutes or true\n        @.ignoreFirstPageLoad = conf.ignoreFirstPageLoad or false\n\n    initialize: ->\n        if not @.accountId\n            @log.debug \"Analytics: no acount id provided. Disabling.\"\n            return\n\n        @.injectAnalytics()\n\n        @win.ga(\"create\", @.accountId, \"auto\")\n        @win.ga(\"require\", \"displayfeatures\")\n\n        if @.trackRoutes and (not @.ignoreFirstPageLoad)\n            @win.ga(\"send\", \"pageview\", @.getUrl())\n\n        # activates page tracking\n        if @.trackRoutes\n            @rootscope.$on @.pageEvent, =>\n                @.trackPage(@.getUrl(), \"Taiga\")\n\n        @.initialized = true\n\n    getUrl: ->\n        return @location.path()\n\n    injectAnalytics: ->\n        fn = `(function(i,s,o,g,r,a,m){i[\"GoogleAnalyticsObject\"]=r;i[r]=i[r]||function(){\n              (i[r].q=i[r].q||[]).push(arguments);},i[r].l=1*new Date();a=s.createElement(o),\n              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m);})`\n        fn(window, document, \"script\", \"//www.google-analytics.com/analytics.js\", \"ga\")\n\n    trackPage: (url, title) ->\n        return if not @.initialized\n        return if not @win.ga\n\n        title = title or @doc[0].title\n        @win.ga(\"send\", \"pageview\", {\n            \"page\": url,\n            \"title\": title\n        })\n\n    trackEvent: (category, action, label, value) ->\n        return if not @.initialized\n        return if not @win.ga\n\n        @win.ga(\"send\", \"event\", category, action, label, value)\n\n\nmodule.service(\"$tgAnalytics\", AnalyticsService)\n\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/attachments.coffee\n###\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\nbindOnce = @.taiga.bindOnce\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaCommon\")\n\n\nclass AttachmentsController extends taiga.Controller\n    @.$inject = [\"$scope\", \"$rootScope\", \"$tgRepo\", \"$tgResources\", \"$tgConfirm\", \"$q\", \"$translate\"]\n\n    constructor: (@scope, @rootscope, @repo, @rs, @confirm, @q, @translate) ->\n        bindMethods(@)\n        @.type = null\n        @.objectId = null\n        @.projectId = null\n\n        @.uploadingAttachments = []\n        @.attachments = []\n        @.attachmentsCount = 0\n        @.deprecatedAttachmentsCount = 0\n        @.showDeprecated = false\n\n    initialize: (type, objectId) ->\n        @.type = type\n        @.objectId = objectId\n        @.projectId = @scope.projectId\n\n    loadAttachments: ->\n        return @.attachments if not @.objectId\n\n        urlname = \"attachments/#{@.type}\"\n\n        return @rs.attachments.list(urlname, @.objectId, @.projectId).then (attachments) =>\n            @.attachments = _.sortBy(attachments, \"order\")\n            @.updateCounters()\n            return attachments\n\n    updateCounters: ->\n        @.attachmentsCount = @.attachments.length\n        @.deprecatedAttachmentsCount = _.filter(@.attachments, {is_deprecated: true}).length\n\n    _createAttachment: (attachment) ->\n        urlName = \"attachments/#{@.type}\"\n\n        promise = @rs.attachments.create(urlName, @.projectId, @.objectId, attachment)\n        promise = promise.then (data) =>\n            data.isCreatedRightNow = true\n\n            index = @.uploadingAttachments.indexOf(attachment)\n            @.uploadingAttachments.splice(index, 1)\n            @.attachments.push(data)\n            @rootscope.$broadcast(\"attachment:create\")\n\n        promise = promise.then null, (data) =>\n            @scope.$emit(\"attachments:size-error\") if data.status == 413\n\n            index = @.uploadingAttachments.indexOf(attachment)\n            @.uploadingAttachments.splice(index, 1)\n\n            message = @translate.instant(\"ATTACHMENT.ERROR_UPLOAD_ATTACHMENT\", {\n                            fileName: attachment.name, errorMessage: data.data._error_message})\n            @confirm.notify(\"error\", message)\n            return @q.reject(data)\n\n        return promise\n\n    # Create attachments in bulk\n    createAttachments: (attachments) ->\n        promises = _.map(attachments, (x) => @._createAttachment(x))\n        return @q.all(promises).then =>\n            @.updateCounters()\n\n    # Add uploading attachment tracking.\n    addUploadingAttachments: (attachments) ->\n        @.uploadingAttachments = _.union(@.uploadingAttachments, attachments)\n\n    # Change order of attachment in a ordered list.\n    # This function is mainly executed after sortable ends.\n    reorderAttachment: (attachment, newIndex) ->\n        oldIndex = @.attachments.indexOf(attachment)\n        return if oldIndex == newIndex\n\n        @.attachments.splice(oldIndex, 1)\n        @.attachments.splice(newIndex, 0, attachment)\n\n        _.each(@.attachments, (x,i) -> x.order = i+1)\n\n    # Persist one concrete attachment.\n    # This function is mainly used when user clicks\n    # to save button for save one unique attachment.\n    updateAttachment: (attachment) ->\n        onSuccess = =>\n            @.updateCounters()\n            @rootscope.$broadcast(\"attachment:edit\")\n\n        onError = (response) =>\n            $scope.$emit(\"attachments:size-error\") if response.status == 413\n            @confirm.notify(\"error\")\n            return @q.reject()\n\n        return @repo.save(attachment).then(onSuccess, onError)\n\n    # Persist all pending modifications on attachments.\n    # This function is used mainly for persist the order\n    # after sorting.\n    saveAttachments: ->\n        return @repo.saveAll(@.attachments).then null, =>\n            for item in @.attachments\n                item.revert()\n            @.attachments = _.sortBy(@.attachments, \"order\")\n\n    # Remove one concrete attachment.\n    removeAttachment: (attachment) ->\n        title = @translate.instant(\"ATTACHMENT.TITLE_LIGHTBOX_DELETE_ATTACHMENT\")\n        message = @translate.instant(\"ATTACHMENT.MSG_LIGHTBOX_DELETE_ATTACHMENT\", {fileName: attachment.name})\n\n        return @confirm.askOnDelete(title, message).then (askResponse) =>\n            onSuccess = =>\n                askResponse.finish()\n                index = @.attachments.indexOf(attachment)\n                @.attachments.splice(index, 1)\n                @.updateCounters()\n                @rootscope.$broadcast(\"attachment:delete\")\n\n            onError = =>\n                askResponse.finish(false)\n                message = @translate.instant(\"ATTACHMENT.ERROR_DELETE_ATTACHMENT\", {errorMessage: message})\n                @confirm.notify(\"error\", null, message)\n                return @q.reject()\n\n            return @repo.remove(attachment).then(onSuccess, onError)\n\n    # Function used in template for filter visible attachments\n    filterAttachments: (item) ->\n        if @.showDeprecated\n            return true\n        return not item.is_deprecated\n\n\nAttachmentsDirective = ($config, $confirm, $templates, $translate) ->\n    template = $templates.get(\"attachment/attachments.html\", true)\n\n    link = ($scope, $el, $attrs, $ctrls) ->\n        $ctrl = $ctrls[0]\n        $model = $ctrls[1]\n\n        bindOnce $scope, $attrs.ngModel, (value) ->\n            $ctrl.initialize($attrs.type, value.id)\n            $ctrl.loadAttachments()\n\n        tdom = $el.find(\"div.attachment-body.sortable\")\n        tdom.sortable({\n            items: \"div.single-attachment\"\n            handle: \"a.settings.icon.icon-drag-v\"\n            containment: \".attachments\"\n            dropOnEmpty: true\n            scroll: false\n            tolerance: \"pointer\"\n            placeholder: \"sortable-placeholder single-attachment\"\n        })\n\n        tdom.on \"sortstop\", (event, ui) ->\n            attachment = ui.item.scope().attach\n            newIndex = ui.item.index()\n\n            $ctrl.reorderAttachment(attachment, newIndex)\n            $ctrl.saveAttachments().then ->\n                $scope.$emit(\"attachment:edit\")\n\n        showSizeInfo = ->\n            $el.find(\".size-info\").removeClass(\"hidden\")\n\n        $scope.$on \"attachments:size-error\", ->\n            showSizeInfo()\n\n        $el.on \"change\", \".attachments-header input\", (event) ->\n            files = _.toArray(event.target.files)\n\n            return if files.length < 1\n\n            $scope.$apply ->\n                $ctrl.addUploadingAttachments(files)\n                $ctrl.createAttachments(files)\n\n        $el.on \"click\", \".more-attachments\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            $scope.$apply ->\n                $ctrl.showDeprecated = not $ctrl.showDeprecated\n\n            target.find(\"span.text\").addClass(\"hidden\")\n            if $ctrl.showDeprecated\n                target.find(\"span[data-type=hide]\").removeClass(\"hidden\")\n                target.find(\"more-attachments-num\").addClass(\"hidden\")\n            else\n                target.find(\"span[data-type=show]\").removeClass(\"hidden\")\n                target.find(\"more-attachments-num\").removeClass(\"hidden\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    templateFn = ($el, $attrs) ->\n        maxFileSize = $config.get(\"maxUploadFileSize\", null)\n        maxFileSize = sizeFormat(maxFileSize) if maxFileSize\n        maxFileSizeMsg = if maxFileSize then $translate.instant(\"ATTACHMENT.MAX_UPLOAD_SIZE\", {maxFileSize: maxFileSize}) else \"\"\n        ctx = {\n            type: $attrs.type\n            maxFileSize: maxFileSize\n            maxFileSizeMsg: maxFileSizeMsg\n        }\n        return template(ctx)\n\n    return {\n        require: [\"tgAttachments\", \"ngModel\"]\n        controller: AttachmentsController\n        controllerAs: \"ctrl\"\n        restrict: \"AE\"\n        scope: true\n        link: link\n        template: templateFn\n    }\n\nmodule.directive(\"tgAttachments\", [\"$tgConfig\", \"$tgConfirm\", \"$tgTemplate\", \"$translate\", AttachmentsDirective])\n\n\nAttachmentDirective = ($template, $compile, $translate, $rootScope) ->\n    template = $template.get(\"attachment/attachment.html\", true)\n    templateEdit = $template.get(\"attachment/attachment-edit.html\", true)\n\n    link = ($scope, $el, $attrs, $ctrl) ->\n        render = (attachment, edit=false) ->\n            permissions = $scope.project.my_permissions\n            modifyPermission = permissions.indexOf(\"modify_#{$ctrl.type}\") > -1\n\n            ctx = {\n                id: attachment.id\n                name: attachment.name\n                title : $translate.instant(\"ATTACHMENT.TITLE\", {\n                            fileName: attachment.name,\n                            date: moment(attachment.created_date).format($translate.instant(\"ATTACHMENT.DATE\"))})\n                url: attachment.url\n                size: sizeFormat(attachment.size)\n                description: attachment.description\n                isDeprecated: attachment.is_deprecated\n                modifyPermission: modifyPermission\n            }\n\n            if edit\n                html = $compile(templateEdit(ctx))($scope)\n            else\n                html = $compile(template(ctx))($scope)\n\n            $el.html(html)\n\n            if attachment.is_deprecated\n                $el.addClass(\"deprecated\")\n                $el.find(\"input:checkbox\").prop('checked', true)\n            else\n                $el.removeClass(\"deprecated\")\n\n        saveAttachment = ->\n            attachment.description = $el.find(\"input[name='description']\").val()\n            attachment.is_deprecated = $el.find(\"input[name='is-deprecated']\").prop(\"checked\")\n            attachment.isCreatedRightNow = false\n\n            $scope.$apply ->\n                $ctrl.updateAttachment(attachment).then ->\n                    render(attachment, false)\n\n        ## Actions (on edit mode)\n        $el.on \"click\", \"a.editable-settings.icon-floppy\", (event) ->\n            event.preventDefault()\n            saveAttachment()\n\n        $el.on \"keyup\", \"input[name=description]\", (event) ->\n            if event.keyCode == 13\n                saveAttachment()\n            else if event.keyCode == 27\n                $scope.$apply -> render(attachment, false)\n\n        $el.on \"click\", \"a.editable-settings.icon-delete\", (event) ->\n            event.preventDefault()\n            render(attachment, false)\n\n        ## Actions (on view mode)\n        $el.on \"click\", \"a.settings.icon-edit\", (event) ->\n            event.preventDefault()\n            render(attachment, true)\n            $el.find(\"input[name='description']\").focus().select()\n\n        $el.on \"click\", \"a.settings.icon-delete\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                $ctrl.removeAttachment(attachment)\n\n        $el.on \"click\", \"div.attachment-name a\", (event) ->\n            if null != attachment.name.match(/\\.(jpe?g|png|gif|gifv|webm)/i)\n                event.preventDefault()\n                $scope.$apply ->\n                    $rootScope.$broadcast(\"attachment:preview\", attachment)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        # Bootstrap\n        attachment = $scope.$eval($attrs.tgAttachment)\n        render(attachment, attachment.isCreatedRightNow)\n        if attachment.isCreatedRightNow\n            $el.find(\"input[name='description']\").focus().select()\n\n    return {\n        link: link\n        require: \"^tgAttachments\"\n        restrict: \"AE\"\n    }\n\nmodule.directive(\"tgAttachment\", [\"$tgTemplate\", \"$compile\", \"$translate\", \"$rootScope\", AttachmentDirective])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: bind-scope.coffee\n###\n\nmodule = angular.module(\"taigaCommon\")\n\nBindScope = (config) ->\n    if !config.debugInfo\n        jQuery.fn.scope = () -> this.data('scope')\n\n    link = ($scope, $el) ->\n        if !config.debugInfo\n            $el\n                .data('scope', $scope)\n                .addClass('tg-scope')\n\n    return {link: link}\n\nmodule.directive(\"tgBindScope\", [\"$tgConfig\", BindScope])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: compile-html.directive.coffee\n###\n\nCompileHtmlDirective = ($compile) ->\n    link = (scope, element, attrs) ->\n        scope.$watch attrs.tgCompileHtml, (newValue, oldValue) ->\n            element.html(newValue)\n            $compile(element.contents())(scope)\n\n    return {\n        link: link\n    }\n\nCompileHtmlDirective.$inject = [\"$compile\"]\n\nangular.module(\"taigaCommon\").directive(\"tgCompileHtml\", CompileHtmlDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/components.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaCommon\")\n\n\n#############################################################################\n## Date Range Directive (used mainly for sprint date range)\n#############################################################################\n\nDateRangeDirective = ($translate) ->\n    renderRange = ($el, first, second) ->\n        prettyDate = $translate.instant(\"BACKLOG.SPRINTS.DATE\")\n        initDate = moment(first).format(prettyDate)\n        endDate = moment(second).format(prettyDate)\n        $el.html(\"#{initDate}-#{endDate}\")\n\n    link = ($scope, $el, $attrs) ->\n        [first, second] = $attrs.tgDateRange.split(\",\")\n\n        bindOnce $scope, first, (valFirst) ->\n            bindOnce $scope, second, (valSecond) ->\n                renderRange($el, valFirst, valSecond)\n\n    return {link:link}\n\nmodule.directive(\"tgDateRange\", [\"$translate\", DateRangeDirective])\n\n\n#############################################################################\n## Date Selector Directive (using pikaday)\n#############################################################################\n\nDateSelectorDirective = ($rootscope, datePickerConfigService) ->\n    link = ($scope, $el, $attrs, $model) ->\n        selectedDate = null\n\n        initialize = () ->\n            datePickerConfig = datePickerConfigService.get()\n\n            _.merge(datePickerConfig, {\n                field: $el[0]\n                onSelect: (date) =>\n                    selectedDate = date\n                onOpen: =>\n                    $el.picker.setDate(selectedDate) if selectedDate?\n            })\n\n            $el.picker = new Pikaday(datePickerConfig)\n\n        unbind = $rootscope.$on \"$translateChangeEnd\", (ctx) => initialize()\n\n        $scope.$watch $attrs.ngModel, (val) ->\n            initialize() if val? and not $el.picker\n            $el.picker.setDate(val) if val?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n            unbind()\n\n    return {\n        link: link\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgDateSelector\", [\"$rootScope\", \"tgDatePickerConfigService\", DateSelectorDirective])\n\n\n#############################################################################\n## Sprint Progress Bar Directive\n#############################################################################\n\nSprintProgressBarDirective = ->\n    renderProgress = ($el, percentage, visual_percentage) ->\n        if $el.hasClass(\".current-progress\")\n            $el.css(\"width\", \"#{percentage}%\")\n        else\n            $el.find(\".current-progress\").css(\"width\", \"#{visual_percentage}%\")\n            $el.find(\".number\").html(\"#{percentage} %\")\n\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgSprintProgressbar, (sprint) ->\n            closedPoints = sprint.closed_points\n            totalPoints = sprint.total_points\n            percentage = 0\n            percentage = Math.round(100 * (closedPoints/totalPoints)) if totalPoints != 0\n            visual_percentage = 0\n            #Visual hack for .current-progress bar\n            visual_percentage = Math.round(98 * (closedPoints/totalPoints)) if totalPoints != 0\n\n            renderProgress($el, percentage, visual_percentage)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgSprintProgressbar\", SprintProgressBarDirective)\n\n\n#############################################################################\n## Created-by display directive\n#############################################################################\n\nCreatedByDisplayDirective = ($template, $compile, $translate, $navUrls)->\n    # Display the owner information (full name and photo) and the date of\n    # creation of an object (like USs, tasks and issues).\n    #\n    # Example:\n    #     div.us-created-by(tg-created-by-display, ng-model=\"us\")\n    #\n    # Requirements:\n    #   - model object must have the attributes 'created_date' and\n    #     'owner'(ng-model)\n    #   - scope.usersById object is required.\n\n    template = $template.get(\"common/components/created-by.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        render = (model) ->\n            owner = model.owner_extra_info or {\n                full_name_display: $translate.instant(\"COMMON.EXTERNAL_USER\")\n                photo: \"/images/user-noimage.png\"\n            }\n\n            html = template({\n                owner: owner\n                url: if owner?.is_active then $navUrls.resolve(\"user-profile\", {username: owner.username}) else \"\"\n                date: moment(model.created_date).format($translate.instant(\"COMMON.DATETIME\"))\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        bindOnce $scope, $attrs.ngModel, (model) ->\n            render(model) if model?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgCreatedByDisplay\", [\"$tgTemplate\", \"$compile\", \"$translate\", \"$tgNavUrls\",\n                                        CreatedByDisplayDirective])\n\n\n#############################################################################\n## Watchers directive\n#############################################################################\n\nWatchersDirective = ($rootscope, $confirm, $repo, $qqueue, $template, $compile, $translate) ->\n    # You have to include a div with the tg-lb-watchers directive in the page\n    # where use this directive\n    template = $template.get(\"common/components/watchers.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project?.my_permissions?.indexOf($attrs.requiredPerm) != -1\n\n        save = $qqueue.bindAdd (watchers) =>\n            item = $model.$modelValue.clone()\n            item.watchers = watchers\n            $model.$setViewValue(item)\n\n            promise = $repo.save($model.$modelValue)\n            promise.then ->\n                $confirm.notify(\"success\")\n                watchers = _.map(watchers, (watcherId) -> $scope.usersById[watcherId])\n                renderWatchers(watchers)\n                $rootscope.$broadcast(\"object:updated\")\n\n            promise.then null, ->\n                $model.$modelValue.revert()\n\n        deleteWatcher = $qqueue.bindAdd (watcherIds) =>\n            item = $model.$modelValue.clone()\n            item.watchers = watcherIds\n            $model.$setViewValue(item)\n\n            promise = $repo.save($model.$modelValue)\n            promise.then ->\n                $confirm.notify(\"success\")\n                watchers = _.map(item.watchers, (watcherId) -> $scope.usersById[watcherId])\n                renderWatchers(watchers)\n                $rootscope.$broadcast(\"object:updated\")\n            promise.then null, ->\n                item.revert()\n                $confirm.notify(\"error\")\n\n\n        renderWatchers = (watchers) ->\n            ctx = {\n                watchers: watchers\n                isEditable: isEditable()\n            }\n\n            html = $compile(template(ctx))($scope)\n            $el.html(html)\n\n        $el.on \"click\", \".js-delete-watcher\", (event) ->\n            event.preventDefault()\n            return if not isEditable()\n            target = angular.element(event.currentTarget)\n            watcherId = target.data(\"watcher-id\")\n\n            title = $translate.instant(\"COMMON.WATCHERS.TITLE_LIGHTBOX_DELETE_WARTCHER\")\n            message = $scope.usersById[watcherId].full_name_display\n\n            $confirm.askOnDelete(title, message).then (askResponse) =>\n                askResponse.finish()\n\n                watcherIds = _.clone($model.$modelValue.watchers, false)\n                watcherIds = _.pull(watcherIds, watcherId)\n\n                deleteWatcher(watcherIds)\n\n        $el.on \"click\", \".js-add-watcher\", (event) ->\n            event.preventDefault()\n            return if not isEditable()\n            $scope.$apply ->\n                $rootscope.$broadcast(\"watcher:add\", $model.$modelValue)\n\n        $scope.$on \"watcher:added\", (ctx, watcherId) ->\n            watchers = _.clone($model.$modelValue.watchers, false)\n            watchers.push(watcherId)\n            watchers = _.uniq(watchers)\n\n            save(watchers)\n\n        $scope.$watch $attrs.ngModel, (item) ->\n            return if not item?\n            watchers = _.map(item.watchers, (watcherId) -> $scope.usersById[watcherId])\n            renderWatchers(watchers)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link, require:\"ngModel\"}\n\nmodule.directive(\"tgWatchers\", [\"$rootScope\", \"$tgConfirm\", \"$tgRepo\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\",\n                                \"$translate\", WatchersDirective])\n\n\n#############################################################################\n## Assigned to directive\n#############################################################################\n\nAssignedToDirective = ($rootscope, $confirm, $repo, $loading, $qqueue, $template, $translate, $compile) ->\n    # You have to include a div with the tg-lb-assignedto directive in the page\n    # where use this directive\n    template = $template.get(\"common/components/assigned-to.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project?.my_permissions?.indexOf($attrs.requiredPerm) != -1\n\n        save = $qqueue.bindAdd (userId) =>\n            $model.$modelValue.assigned_to = userId\n\n            currentLoading = $loading()\n                .target($el)\n                .start()\n\n            promise = $repo.save($model.$modelValue)\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                renderAssignedTo($model.$modelValue)\n                $rootscope.$broadcast(\"object:updated\")\n            promise.then null, ->\n                $model.$modelValue.revert()\n                $confirm.notify(\"error\")\n                currentLoading.finish()\n\n            return promise\n\n        renderAssignedTo = (issue) ->\n            assignedToId = issue?.assigned_to\n            assignedTo = if assignedToId? then $scope.usersById[assignedToId] else null\n\n            ctx = {\n                assignedTo: assignedTo\n                isEditable: isEditable()\n            }\n            html = $compile(template(ctx))($scope)\n            $el.html(html)\n\n        $el.on \"click\", \".user-assigned\", (event) ->\n            event.preventDefault()\n            return if not isEditable()\n            $scope.$apply ->\n                $rootscope.$broadcast(\"assigned-to:add\", $model.$modelValue)\n\n        $el.on \"click\", \".icon-delete\", (event) ->\n            event.preventDefault()\n            return if not isEditable()\n            title = $translate.instant(\"COMMON.ASSIGNED_TO.CONFIRM_UNASSIGNED\")\n\n            $confirm.ask(title).then (response) =>\n                response.finish()\n                $model.$modelValue.assigned_to  = null\n                save(null)\n\n        $scope.$on \"assigned-to:added\", (ctx, userId, item) ->\n            return if item.id != $model.$modelValue.id\n\n            save(userId)\n\n        $scope.$watch $attrs.ngModel, (instance) ->\n            renderAssignedTo(instance)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link:link,\n        require:\"ngModel\"\n    }\n\nmodule.directive(\"tgAssignedTo\", [\"$rootScope\", \"$tgConfirm\", \"$tgRepo\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$translate\", \"$compile\",\n                                  AssignedToDirective])\n\n\n#############################################################################\n## Block Button directive\n#############################################################################\n\nBlockButtonDirective = ($rootscope, $loading, $template) ->\n    template = $template.get(\"common/components/block-button.html\")\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_us\") != -1\n\n        $scope.$watch $attrs.ngModel, (item) ->\n            return if not item\n\n            if isEditable()\n                $el.find('.item-block').addClass('editable')\n\n            if item.is_blocked\n                $el.find('.item-block').hide()\n                $el.find('.item-unblock').show()\n            else\n                $el.find('.item-block').show()\n                $el.find('.item-unblock').hide()\n\n        $el.on \"click\", \".item-block\", (event) ->\n            event.preventDefault()\n            $rootscope.$broadcast(\"block\", $model.$modelValue)\n\n        $el.on \"click\", \".item-unblock\", (event) ->\n            event.preventDefault()\n            currentLoading = $loading()\n                .target($el.find(\".item-unblock\"))\n                .start()\n\n            finish = ->\n                currentLoading.finish()\n\n            $rootscope.$broadcast(\"unblock\", $model.$modelValue, finish)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        template: template\n    }\n\nmodule.directive(\"tgBlockButton\", [\"$rootScope\", \"$tgLoading\", \"$tgTemplate\", BlockButtonDirective])\n\n\n#############################################################################\n## Delete Button directive\n#############################################################################\n\nDeleteButtonDirective = ($log, $repo, $confirm, $location, $template) ->\n    template = $template.get(\"common/components/delete-button.html\")\n\n    link = ($scope, $el, $attrs, $model) ->\n        if not $attrs.onDeleteGoToUrl\n            return $log.error \"DeleteButtonDirective requires on-delete-go-to-url set in scope.\"\n        if not $attrs.onDeleteTitle\n            return $log.error \"DeleteButtonDirective requires on-delete-title set in scope.\"\n\n        $el.on \"click\", \".button-delete\", (event) ->\n            title = $attrs.onDeleteTitle\n            subtitle = $model.$modelValue.subject\n\n            $confirm.askOnDelete(title, subtitle).then (askResponse) =>\n                promise = $repo.remove($model.$modelValue)\n                promise.then =>\n                    askResponse.finish()\n                    url = $scope.$eval($attrs.onDeleteGoToUrl)\n                    $location.path(url)\n                promise.then null, =>\n                    askResponse.finish(false)\n                    $confirm.notify(\"error\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        template: template\n    }\n\nmodule.directive(\"tgDeleteButton\", [\"$log\", \"$tgRepo\", \"$tgConfirm\", \"$tgLocation\", \"$tgTemplate\", DeleteButtonDirective])\n\n\n#############################################################################\n## Editable subject directive\n#############################################################################\n\nEditableSubjectDirective = ($rootscope, $repo, $confirm, $loading, $qqueue, $template) ->\n    template = $template.get(\"common/components/editable-subject.html\")\n\n    link = ($scope, $el, $attrs, $model) ->\n\n        $scope.$on \"object:updated\", () ->\n            $el.find('.edit-subject').hide()\n            $el.find('.view-subject').show()\n\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf($attrs.requiredPerm) != -1\n\n        save = $qqueue.bindAdd (subject) =>\n            $model.$modelValue.subject = subject\n\n            currentLoading = $loading()\n                .target($el.find('.save-container'))\n                .start()\n\n            promise = $repo.save($model.$modelValue)\n            promise.then ->\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"object:updated\")\n                $el.find('.edit-subject').hide()\n                $el.find('.view-subject').show()\n            promise.then null, ->\n                $confirm.notify(\"error\")\n            promise.finally ->\n                currentLoading.finish()\n\n            return promise\n\n        $el.click ->\n            return if not isEditable()\n            $el.find('.edit-subject').show()\n            $el.find('.view-subject').hide()\n            $el.find('input').focus()\n\n        $el.on \"click\", \".save\", (e) ->\n            e.preventDefault()\n\n            subject = $scope.item.subject\n            save(subject)\n\n        $el.on \"keyup\", \"input\", (event) ->\n            if event.keyCode == 13\n                subject = $scope.item.subject\n                save(subject)\n            else if event.keyCode == 27\n                $scope.$apply () => $model.$modelValue.revert()\n\n                $el.find('div.edit-subject').hide()\n                $el.find('div.view-subject').show()\n\n        $el.find('div.edit-subject').hide()\n        $el.find('div.view-subject span.edit').hide()\n\n        $scope.$watch $attrs.ngModel, (value) ->\n            return if not value\n            $scope.item = value\n\n            if not isEditable()\n                $el.find('.view-subject .edit').remove()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        template: template\n    }\n\nmodule.directive(\"tgEditableSubject\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\",\n                                       \"$tgTemplate\", EditableSubjectDirective])\n\n\n#############################################################################\n## Editable description directive\n#############################################################################\n\nEditableDescriptionDirective = ($rootscope, $repo, $confirm, $compile, $loading, $selectedText, $qqueue, $template) ->\n    template = $template.get(\"common/components/editable-description.html\")\n    noDescriptionMegEditMode = $template.get(\"common/components/editable-description-msg-edit-mode.html\")\n    noDescriptionMegReadMode = $template.get(\"common/components/editable-description-msg-read-mode.html\")\n\n    link = ($scope, $el, $attrs, $model) ->\n        $el.find('.edit-description').hide()\n        $el.find('.view-description .edit').hide()\n\n        $scope.$on \"object:updated\", () ->\n            $el.find('.edit-description').hide()\n            $el.find('.view-description').show()\n\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf($attrs.requiredPerm) != -1\n\n        save = $qqueue.bindAdd (description) =>\n            $model.$modelValue.description = description\n\n            currentLoading = $loading()\n                .target($el.find('.save-container'))\n                .start()\n\n            promise = $repo.save($model.$modelValue)\n            promise.then ->\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"object:updated\")\n                $el.find('.edit-description').hide()\n                $el.find('.view-description').show()\n            promise.then null, ->\n                $confirm.notify(\"error\")\n            promise.finally ->\n                currentLoading.finish()\n\n        $el.on \"mouseup\", \".view-description\", (event) ->\n            # We want to dettect the a inside the div so we use the target and\n            # not the currentTarget\n            target = angular.element(event.target)\n            return if not isEditable()\n            return if target.is('a')\n            return if $selectedText.get().length\n\n            $el.find('.edit-description').show()\n            $el.find('.view-description').hide()\n            $el.find('textarea').focus()\n\n        $el.on \"click\", \"a\", (event) ->\n            target = angular.element(event.target)\n            href = target.attr('href')\n            if href.indexOf(\"#\") == 0\n                event.preventDefault()\n                $('body').scrollTop($(href).offset().top)\n\n        $el.on \"click\", \".save\", (e) ->\n            e.preventDefault()\n\n            description = $scope.item.description\n            save(description)\n\n        $el.on \"keydown\", \"textarea\", (event) ->\n            if event.keyCode == 27\n                $scope.$apply () => $scope.item.revert()\n                $el.find('.edit-description').hide()\n                $el.find('.view-description').show()\n\n        $scope.$watch $attrs.ngModel, (value) ->\n            return if not value\n            $scope.item = value\n\n            if isEditable()\n                $el.find('.view-description .edit').show()\n                $el.find('.view-description .us-content').addClass('editable')\n                $scope.noDescriptionMsg = $compile(noDescriptionMegEditMode)($scope)\n            else\n                $scope.noDescriptionMsg = $compile(noDescriptionMegReadMode)($scope)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        template: template\n    }\n\nmodule.directive(\"tgEditableDescription\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$compile\", \"$tgLoading\",\n                                            \"$selectedText\", \"$tgQqueue\", \"$tgTemplate\", EditableDescriptionDirective])\n\n\n#############################################################################\n## Common list directives\n#############################################################################\n## NOTE: These directives are used in issues and search and are\n##       completely bindonce, they only serves for visualization of data.\n#############################################################################\n\nListItemUsStatusDirective = ->\n    link = ($scope, $el, $attrs) ->\n        us = $scope.$eval($attrs.tgListitemUsStatus)\n        bindOnce $scope, \"usStatusById\", (usStatusById) ->\n            $el.html(usStatusById[us.status].name)\n\n    return {link:link}\n\nmodule.directive(\"tgListitemUsStatus\", ListItemUsStatusDirective)\n\n\nListItemTaskStatusDirective = ->\n    link = ($scope, $el, $attrs) ->\n        task = $scope.$eval($attrs.tgListitemTaskStatus)\n        bindOnce $scope, \"taskStatusById\", (taskStatusById) ->\n            $el.html(taskStatusById[task.status].name)\n\n    return {link:link}\n\nmodule.directive(\"tgListitemTaskStatus\", ListItemTaskStatusDirective)\n\n\nListItemAssignedtoDirective = ($template) ->\n    template = $template.get(\"common/components/list-item-assigned-to-avatar.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, \"usersById\", (usersById) ->\n            item = $scope.$eval($attrs.tgListitemAssignedto)\n            ctx = {name: \"Unassigned\", imgurl: \"/images/unnamed.png\"}\n\n            member = usersById[item.assigned_to]\n            if member\n                ctx.imgurl = member.photo\n                ctx.name = member.full_name_display\n\n            $el.html(template(ctx))\n\n    return {link:link}\n\nmodule.directive(\"tgListitemAssignedto\", [\"$tgTemplate\", ListItemAssignedtoDirective])\n\n\nListItemIssueStatusDirective = ->\n    link = ($scope, $el, $attrs) ->\n        issue = $scope.$eval($attrs.tgListitemIssueStatus)\n        bindOnce $scope, \"issueStatusById\", (issueStatusById) ->\n            $el.html(issueStatusById[issue.status].name)\n\n    return {link:link}\n\nmodule.directive(\"tgListitemIssueStatus\", ListItemIssueStatusDirective)\n\n\nListItemTypeDirective = ->\n    link = ($scope, $el, $attrs) ->\n        render = (issueTypeById, issue) ->\n            type = issueTypeById[issue.type]\n            domNode = $el.find(\".level\")\n            domNode.css(\"background-color\", type.color)\n            domNode.attr(\"title\", type.name)\n\n        bindOnce $scope, \"issueTypeById\", (issueTypeById) ->\n            issue = $scope.$eval($attrs.tgListitemType)\n            render(issueTypeById, issue)\n\n        $scope.$watch $attrs.tgListitemType, (issue) ->\n            render($scope.issueTypeById, issue)\n\n    return {\n        link: link\n        templateUrl: \"common/components/level.html\"\n    }\n\nmodule.directive(\"tgListitemType\", ListItemTypeDirective)\n\n\nListItemPriorityDirective = ->\n    link = ($scope, $el, $attrs) ->\n        render = (priorityById, issue) ->\n            priority = priorityById[issue.priority]\n            domNode = $el.find(\".level\")\n            domNode.css(\"background-color\", priority.color)\n            domNode.attr(\"title\", priority.name)\n\n        bindOnce $scope, \"priorityById\", (priorityById) ->\n            issue = $scope.$eval($attrs.tgListitemPriority)\n            render(priorityById, issue)\n\n        $scope.$watch $attrs.tgListitemPriority, (issue) ->\n            render($scope.priorityById, issue)\n\n    return {\n        link: link\n        templateUrl: \"common/components/level.html\"\n    }\n\nmodule.directive(\"tgListitemPriority\", ListItemPriorityDirective)\n\n\nListItemSeverityDirective = ->\n    link = ($scope, $el, $attrs) ->\n        render = (severityById, issue) ->\n            severity = severityById[issue.severity]\n            domNode = $el.find(\".level\")\n            domNode.css(\"background-color\", severity.color)\n            domNode.attr(\"title\", severity.name)\n\n        bindOnce $scope, \"severityById\", (severityById) ->\n            issue = $scope.$eval($attrs.tgListitemSeverity)\n            render(severityById, issue)\n\n        $scope.$watch $attrs.tgListitemSeverity, (issue) ->\n            render($scope.severityById, issue)\n\n    return {\n        link: link\n        templateUrl: \"common/components/level.html\"\n    }\n\nmodule.directive(\"tgListitemSeverity\", ListItemSeverityDirective)\n\n\n#############################################################################\n## Progress bar directive\n#############################################################################\n\nTgProgressBarDirective = ($template) ->\n    template = $template.get(\"common/components/progress-bar.html\", true)\n\n    render = (el, percentage) ->\n        el.html(template({percentage: percentage}))\n\n    link = ($scope, $el, $attrs) ->\n        element = angular.element($el)\n\n        $scope.$watch $attrs.tgProgressBar, (percentage) ->\n            percentage = _.max([0 , percentage])\n            percentage = _.min([100, percentage])\n            render($el, percentage)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgProgressBar\", [\"$tgTemplate\", TgProgressBarDirective])\n\n\n#############################################################################\n## Main title directive\n#############################################################################\n\nTgMainTitleDirective = ($translate) ->\n    link = ($scope, $el, $attrs) ->\n        $attrs.$observe \"i18nSectionName\", (i18nSectionName) ->\n            $scope.sectionName = $translate.instant(i18nSectionName)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        templateUrl: \"common/components/main-title.html\"\n        scope: {\n            projectName : \"=projectName\"\n        }\n    }\n\nmodule.directive(\"tgMainTitle\", [\"$translate\",  TgMainTitleDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/confirm.coffee\n###\n\ntaiga = @.taiga\ntimeout = @.taiga.timeout\ncancelTimeout = @.taiga.cancelTimeout\ndebounce = @.taiga.debounce\nbindMethods = @.taiga.bindMethods\n\nNOTIFICATION_MSG = {\n    \"success\":\n        title: \"NOTIFICATION.OK\"\n        message: \"NOTIFICATION.SAVED\"\n    \"error\":\n        title: \"NOTIFICATION.WARNING\"\n        message: \"NOTIFICATION.WARNING_TEXT\"\n    \"light-error\":\n        title: \"NOTIFICATION.WARNING\"\n        message: \"NOTIFICATION.WARNING_TEXT\"\n}\n\n\nclass ConfirmService extends taiga.Service\n    @.$inject = [\"$q\", \"lightboxService\", \"$tgLoading\", \"$translate\"]\n\n    constructor: (@q, @lightboxService, @loading, @translate) ->\n        bindMethods(@)\n\n    hide: (el)->\n        if el\n            @lightboxService.close(el)\n\n            el.off(\".confirm-dialog\")\n\n    ask: (title, subtitle, message, lightboxSelector=\".lightbox-generic-ask\") ->\n        defered = @q.defer()\n\n        el = angular.element(lightboxSelector)\n\n        # Render content\n        el.find(\"h2.title\").html(title)\n        el.find(\"span.subtitle\").html(subtitle)\n        el.find(\"span.message\").html(message)\n\n        # Assign event handlers\n        el.on \"click.confirm-dialog\", \"a.button-green\", debounce 2000, (event) =>\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            currentLoading = @loading()\n                .target(target)\n                .start()\n            defered.resolve {\n                finish: (ok=true) =>\n                    currentLoading.finish()\n                    if ok\n                        @.hide(el)\n            }\n\n        el.on \"click.confirm-dialog\", \"a.button-red\", (event) =>\n            event.preventDefault()\n            defered.reject()\n            @.hide(el)\n\n        @lightboxService.open(el)\n\n        return defered.promise\n\n    askOnDelete: (title, message) ->\n        return @.ask(title, @translate.instant(\"NOTIFICATION.ASK_DELETE\"), message)\n\n    askChoice: (title, subtitle, choices, replacement, warning, lightboxSelector=\".lightbox-ask-choice\") ->\n        defered = @q.defer()\n\n        el = angular.element(lightboxSelector)\n\n        # Render content\n        el.find(\".title\").html(title)\n        el.find(\".subtitle\").html(subtitle)\n\n        if replacement\n            el.find(\".replacement\").html(replacement)\n        else\n            el.find(\".replacement\").remove()\n\n        if warning\n            el.find(\".warning\").html(warning)\n        else\n            el.find(\".warning\").remove()\n\n        choicesField = el.find(\".choices\")\n        choicesField.html('')\n        _.each choices, (value, key) ->\n            choicesField.append(angular.element(\"<option value='#{key}'>#{value}</option>\"))\n\n        # Assign event handlers\n        el.on \"click.confirm-dialog\", \"a.button-green\", debounce 2000, (event) =>\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            currentLoading = @loading()\n                .target(target)\n                .start()\n            defered.resolve {\n                selected: choicesField.val()\n                finish: (ok=true) =>\n                    currentLoading.finish()\n                    if ok\n                        @.hide(el)\n            }\n\n        el.on \"click.confirm-dialog\", \"a.button-red\", (event) =>\n            event.preventDefault()\n            defered.reject()\n            @.hide(el)\n\n        @lightboxService.open(el)\n\n        return defered.promise\n\n    error: (message) ->\n        defered = @q.defer()\n\n        el = angular.element(\".lightbox-generic-error\")\n\n        # Render content\n        el.find(\"h2.title\").html(message)\n\n        # Assign event handlers\n        el.on \"click.confirm-dialog\", \"a.button-green\", (event) =>\n            event.preventDefault()\n            defered.resolve()\n            @.hide(el)\n\n        el.on \"click.confirm-dialog\", \"a.close\", (event) =>\n            event.preventDefault()\n            defered.resolve()\n            @.hide(el)\n\n        @lightboxService.open(el)\n\n        return defered.promise\n\n    success: (title, message) ->\n        defered = @q.defer()\n\n        el = angular.element(\".lightbox-generic-success\")\n\n        # Render content\n        el.find(\"h2.title\").html(title) if title\n        el.find(\"p.message\").html(message) if message\n\n        # Assign event handlers\n        el.on \"click.confirm-dialog\", \"a.button-green\", (event) =>\n            event.preventDefault()\n            defered.resolve()\n            @.hide(el)\n\n        el.on \"click.confirm-dialog\", \"a.close\", (event) =>\n            event.preventDefault()\n            defered.resolve()\n            @.hide(el)\n\n        @lightboxService.open(el)\n\n        return defered.promise\n\n    loader: (title, message) ->\n        el = angular.element(\".lightbox-generic-loading\")\n\n        # Render content\n        el.find(\"h2.title\").html(title) if title\n        el.find(\"p.message\").html(message) if message\n\n        return {\n            start: => @lightboxService.open(el)\n            stop: => @lightboxService.close(el)\n            update: (status, title, message, percent) =>\n                el.find(\"h2.title\").html(title) if title\n                el.find(\"p.message\").html(message) if message\n\n                if percent\n                    el.find(\".spin\").addClass(\"hidden\")\n                    el.find(\".progress-bar-wrapper\").removeClass(\"hidden\")\n                    el.find(\".progress-bar-wrapper > .bar\").width(percent + '%')\n                    el.find(\".progress-bar-wrapper > span\").html(percent + '%').css('left', (percent - 9) + '%' )\n                else\n                    el.find(\".spin\").removeClass(\"hidden\")\n                    el.find(\".progress-bar-wrapper\").addClass(\"hidden\")\n        }\n\n    notify: (type, message, title, time) ->\n        # NOTE: Typesi are: error, success, light-error\n        #       See partials/components/notification-message.jade)\n        #       Add default texts to NOTIFICATION_MSG for new notification types\n\n        selector = \".notification-message-#{type}\"\n        el = angular.element(selector)\n\n        return if el.hasClass(\"active\")\n\n        if title\n            el.find(\"h4\").html(title)\n        else\n            el.find(\"h4\").html(@translate.instant(NOTIFICATION_MSG[type].title))\n\n        if message\n            el.find(\"p\").html(message)\n        else\n            el.find(\"p\").html(@translate.instant(NOTIFICATION_MSG[type].message))\n\n        body = angular.element(\"body\")\n        body.find(\".notification-message .notification-light\")\n            .removeClass('active')\n            .addClass('inactive')\n\n        body.find(selector)\n            .removeClass('inactive')\n            .addClass('active')\n\n        if @.tsem\n            cancelTimeout(@.tsem)\n\n        if !time\n            time = if type == 'error' or type == 'light-error' then 3500 else 1500\n\n        @.tsem = timeout time, =>\n            body.find(selector)\n                .removeClass('active')\n                .addClass('inactive')\n\n            delete @.tsem\n\n        el.on \"click\", \".icon-delete, .close\", (event) =>\n            body.find(selector)\n                .removeClass('active')\n                .addClass('inactive')\n\n\nmodule = angular.module(\"taigaCommon\")\nmodule.service(\"$tgConfirm\", ConfirmService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/custom-field-values.coffee\n###\n\ntaiga = @.taiga\nbindMethods = @.taiga.bindMethods\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\ngenerateHash = taiga.generateHash\n\nmodule = angular.module(\"taigaCommon\")\n\n# Custom attributes types (see taiga-back/taiga/projects/custom_attributes/choices.py)\nTEXT_TYPE = \"text\"\nMULTILINE_TYPE = \"multiline\"\nDATE_TYPE = \"date\"\n\n\nTYPE_CHOICES = [\n    {\n        key: TEXT_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_TEXT\"\n    },\n    {\n        key: MULTILINE_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_MULTI\"\n    },\n    {\n        key: DATE_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_DATE\"\n    }\n]\n\n\n\nclass CustomAttributesValuesController extends taiga.Controller\n    @.$inject = [\"$scope\", \"$rootScope\", \"$tgRepo\", \"$tgResources\", \"$tgConfirm\", \"$q\"]\n\n    constructor: (@scope, @rootscope, @repo, @rs, @confirm, @q) ->\n        bindMethods(@)\n        @.type = null\n        @.objectId = null\n        @.projectId = null\n        @.customAttributes = []\n        @.customAttributesValues = null\n\n    initialize: (type, objectId) ->\n        @.project = @scope.project\n        @.type = type\n        @.objectId = objectId\n        @.projectId = @scope.projectId\n\n    loadCustomAttributesValues: ->\n        return @.customAttributesValues if not @.objectId\n        return @rs.customAttributesValues[@.type].get(@.objectId).then (customAttributesValues) =>\n            @.customAttributes = @.project[\"#{@.type}_custom_attributes\"]\n            @.customAttributesValues = customAttributesValues\n            return customAttributesValues\n\n    getAttributeValue: (attribute) ->\n        attributeValue = _.clone(attribute, false)\n        attributeValue.value = @.customAttributesValues.attributes_values[attribute.id]\n        return attributeValue\n\n    updateAttributeValue: (attributeValue) ->\n        onSuccess = =>\n            @rootscope.$broadcast(\"custom-attributes-values:edit\")\n\n        onError = (response) =>\n            @confirm.notify(\"error\")\n            return @q.reject()\n\n        # We need to update the full array so angular understand the model is modified\n        attributesValues = _.clone(@.customAttributesValues.attributes_values, true)\n        attributesValues[attributeValue.id] = attributeValue.value\n        @.customAttributesValues.attributes_values = attributesValues\n        @.customAttributesValues.id = @.objectId\n        return @repo.save(@.customAttributesValues).then(onSuccess, onError)\n\n\nCustomAttributesValuesDirective = ($templates, $storage) ->\n    template = $templates.get(\"custom-attributes/custom-attributes-values.html\", true)\n    collapsedHash = (type) ->\n        return generateHash([\"custom-attributes-collapsed\", type])\n\n    link = ($scope, $el, $attrs, $ctrls) ->\n        $ctrl = $ctrls[0]\n        $model = $ctrls[1]\n\n        bindOnce $scope, $attrs.ngModel, (value) ->\n            $ctrl.initialize($attrs.type, value.id)\n            $ctrl.loadCustomAttributesValues()\n\n        $el.on \"click\", \".custom-fields-header a\", ->\n            hash = collapsedHash($attrs.type)\n            collapsed = not($storage.get(hash) or false)\n            $storage.set(hash, collapsed)\n            if collapsed\n                $el.find(\".custom-fields-header a\").removeClass(\"open\")\n                $el.find(\".custom-fields-body\").removeClass(\"open\")\n            else\n                $el.find(\".custom-fields-header a\").addClass(\"open\")\n                $el.find(\".custom-fields-body\").addClass(\"open\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    templateFn = ($el, $attrs) ->\n        collapsed = $storage.get(collapsedHash($attrs.type)) or false\n\n        return template({\n            requiredEditionPerm: $attrs.requiredEditionPerm\n            collapsed: collapsed\n        })\n\n    return {\n        require: [\"tgCustomAttributesValues\", \"ngModel\"]\n        controller: CustomAttributesValuesController\n        controllerAs: \"ctrl\"\n        restrict: \"AE\"\n        scope: true\n        link: link\n        template: templateFn\n    }\n\nmodule.directive(\"tgCustomAttributesValues\", [\"$tgTemplate\", \"$tgStorage\", \"$translate\",\n                                              CustomAttributesValuesDirective])\n\n\nCustomAttributeValueDirective = ($template, $selectedText, $compile, $translate, datePickerConfigService) ->\n    template = $template.get(\"custom-attributes/custom-attribute-value.html\", true)\n    templateEdit = $template.get(\"custom-attributes/custom-attribute-value-edit.html\", true)\n\n    link = ($scope, $el, $attrs, $ctrl) ->\n        prettyDate = $translate.instant(\"COMMON.PICKERDATE.FORMAT\")\n\n        render = (attributeValue, edit=false) ->\n            if attributeValue.type is DATE_TYPE and attributeValue.value\n                value = moment(attributeValue.value, \"YYYY-MM-DD\").format(prettyDate)\n            else\n                value = attributeValue.value\n            editable = isEditable()\n\n            ctx = {\n                id: attributeValue.id\n                name: attributeValue.name\n                description: attributeValue.description\n                value: value\n                isEditable: editable\n                type: attributeValue.type\n            }\n\n            if editable and (edit or not value)\n                html = templateEdit(ctx)\n                html = $compile(html)($scope)\n                $el.html(html)\n\n                if attributeValue.type == DATE_TYPE\n                    datePickerConfig = datePickerConfigService.get()\n                    _.merge(datePickerConfig, {\n                        field: $el.find(\"input[name=value]\")[0]\n                        onSelect: (date) =>\n                            selectedDate = date\n                        onOpen: =>\n                            $el.picker.setDate(selectedDate) if selectedDate?\n                    })\n                    $el.picker = new Pikaday(datePickerConfig)\n            else\n                html = template(ctx)\n                html = $compile(html)($scope)\n                $el.html(html)\n\n        isEditable = ->\n            permissions = $scope.project.my_permissions\n            requiredEditionPerm = $attrs.requiredEditionPerm\n            return permissions.indexOf(requiredEditionPerm) > -1\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            attributeValue.value = $el.find(\"input[name=value], textarea[name='value']\").val()\n            if attributeValue.type is DATE_TYPE\n                if moment(attributeValue.value, prettyDate).isValid()\n                    attributeValue.value = moment(attributeValue.value, prettyDate).format(\"YYYY-MM-DD\")\n                else\n                    attributeValue.value = \"\"\n\n            $scope.$apply ->\n                $ctrl.updateAttributeValue(attributeValue).then ->\n                    render(attributeValue, false)\n\n        setFocusAndSelectOnInputField = ->\n            $el.find(\"input[name='value'], textarea[name='value']\").focus().select()\n\n        # Bootstrap\n        attributeValue = $scope.$eval($attrs.tgCustomAttributeValue)\n        render(attributeValue)\n\n        ## Actions (on view mode)\n        $el.on \"click\", \".js-value-view-mode\", ->\n            return if not isEditable()\n            return if $selectedText.get().length\n            render(attributeValue, true)\n            setFocusAndSelectOnInputField()\n\n        $el.on \"click\", \"a.icon-edit\", (event) ->\n            event.preventDefault()\n            render(attributeValue, true)\n            setFocusAndSelectOnInputField()\n\n        ## Actions (on edit mode)\n        $el.on \"keyup\", \"input[name=value], textarea[name='value']\", (event) ->\n            if event.keyCode is 13 and event.currentTarget.type isnt \"textarea\"\n                submit(event)\n            else if event.keyCode == 27\n                render(attributeValue, false)\n\n        $el.on \"submit\", \"form\", submit\n\n        $el.on \"click\", \"a.icon-floppy\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        require: \"^tgCustomAttributesValues\"\n        restrict: \"AE\"\n    }\n\nmodule.directive(\"tgCustomAttributeValue\", [\"$tgTemplate\", \"$selectedText\", \"$compile\", \"$translate\",\n                                            \"tgDatePickerConfigService\", CustomAttributeValueDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/estimation.coffee\n###\n\ntaiga = @.taiga\ngroupBy = @.taiga.groupBy\n\nmodule = angular.module(\"taigaCommon\")\n\n#############################################################################\n## User story estimation directive (for Lightboxes)\n#############################################################################\n\nLbUsEstimationDirective = ($tgEstimationsService, $rootScope, $repo, $confirm, $template, $compile) ->\n    # Display the points of a US and you can edit it.\n    #\n    # Example:\n    #     tg-lb-us-estimation-progress-bar(ng-model=\"us\")\n    #\n    # Requirements:\n    #   - Us object (ng-model)\n    #   - scope.project object\n\n    link = ($scope, $el, $attrs, $model) ->\n        $scope.$watch $attrs.ngModel, (us) ->\n            if us\n                estimationProcess = $tgEstimationsService.create($el, us, $scope.project)\n                estimationProcess.onSelectedPointForRole = (roleId, pointId) ->\n                    $scope.$apply ->\n                        $model.$setViewValue(us)\n\n\n                estimationProcess.render = () ->\n                    ctx = {\n                        totalPoints: @calculateTotalPoints()\n                        roles: @calculateRoles()\n                        editable: @isEditable\n                    }\n                    mainTemplate = \"common/estimation/us-estimation-points-per-role.html\"\n                    template = $template.get(mainTemplate, true)\n                    html = template(ctx)\n                    html = $compile(html)($scope)\n                    @$el.html(html)\n\n                estimationProcess.render()\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgLbUsEstimation\", [\"$tgEstimationsService\", \"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgTemplate\", \"$compile\", LbUsEstimationDirective])\n\n\n#############################################################################\n## User story estimation directive\n#############################################################################\n\nUsEstimationDirective = ($tgEstimationsService, $rootScope, $repo, $confirm, $qqueue, $template, $compile) ->\n    # Display the points of a US and you can edit it.\n    #\n    # Example:\n    #     tg-us-estimation-progress-bar(ng-model=\"us\")\n    #\n    # Requirements:\n    #   - Us object (ng-model)\n    #   - scope.project object\n\n    link = ($scope, $el, $attrs, $model) ->\n        $scope.$watch $attrs.ngModel, (us) ->\n            if us\n                estimationProcess = $tgEstimationsService.create($el, us, $scope.project)\n                estimationProcess.onSelectedPointForRole = (roleId, pointId) ->\n                    @save(roleId, pointId).then ->\n                        $rootScope.$broadcast(\"object:updated\")\n\n                estimationProcess.render = () ->\n                    ctx = {\n                        totalPoints: @calculateTotalPoints()\n                        roles: @calculateRoles()\n                        editable: @isEditable\n                    }\n                    mainTemplate = \"common/estimation/us-estimation-points-per-role.html\"\n                    template = $template.get(mainTemplate, true)\n                    html = template(ctx)\n                    html = $compile(html)($scope)\n                    @$el.html(html)\n\n                estimationProcess.render()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgUsEstimation\", [\"$tgEstimationsService\", \"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\"\n                                    UsEstimationDirective])\n\n\n#############################################################################\n## Estimations service\n#############################################################################\n\nEstimationsService = ($template, $qqueue, $repo, $confirm, $q) ->\n    pointsTemplate = $template.get(\"common/estimation/us-estimation-points.html\", true)\n\n    class EstimationProcess\n        constructor: (@$el, @us, @project) ->\n            @isEditable = @project.my_permissions.indexOf(\"modify_us\") != -1\n            @roles = @project.roles\n            @points = @project.points\n            @pointsById = groupBy(@points, (x) -> x.id)\n            @onSelectedPointForRole =  (roleId, pointId) ->\n            @render = () ->\n\n        save: (roleId, pointId) ->\n            deferred = $q.defer()\n            $qqueue.add () =>\n                onSuccess = =>\n                    deferred.resolve()\n                    $confirm.notify(\"success\")\n\n                onError = =>\n                    $confirm.notify(\"error\")\n                    @us.revert()\n                    @render()\n                    deferred.reject()\n\n                $repo.save(@us).then(onSuccess, onError)\n\n            return deferred.promise\n\n        calculateTotalPoints: () ->\n            values = _.map(@us.points, (v, k) => @pointsById[v]?.value)\n\n            if values.length == 0\n                return \"0\"\n\n            notNullValues = _.filter(values, (v) -> v?)\n            if notNullValues.length == 0\n                return \"?\"\n\n            return _.reduce(notNullValues, (acc, num) -> acc + num)\n\n        calculateRoles: () ->\n            computableRoles = _.filter(@project.roles, \"computable\")\n            roles = _.map computableRoles, (role) =>\n                pointId = @us.points[role.id]\n                pointObj = @pointsById[pointId]\n                role = _.clone(role, true)\n                role.points = if pointObj? and pointObj.name? then pointObj.name else \"?\"\n                return role\n\n            return roles\n\n        bindClickEvents: =>\n            @$el.on \"click\", \".total.clickable\", (event) =>\n                event.preventDefault()\n                event.stopPropagation()\n                target = angular.element(event.currentTarget)\n                roleId = target.data(\"role-id\")\n                @renderPointsSelector(roleId, target)\n                target.siblings().removeClass('active')\n                target.addClass('active')\n\n            @$el.on \"click\", \".point\", (event) =>\n                event.preventDefault()\n                event.stopPropagation()\n                target = angular.element(event.currentTarget)\n                roleId = target.data(\"role-id\")\n                pointId = target.data(\"point-id\")\n                @$el.find(\".popover\").popover().close()\n                points = _.clone(@us.points, true)\n                points[roleId] = pointId\n                @us.points = points\n                @render()\n                @onSelectedPointForRole(roleId, pointId)\n\n        renderPointsSelector: (roleId, target) ->\n            points = _.map @points, (point) =>\n                point = _.clone(point, true)\n                point.selected = if @us.points[roleId] == point.id then false else true\n                return point\n\n            maxPointLength = 5\n            horizontalList =  _.some points, (point) => point.name.length > maxPointLength\n\n            html = pointsTemplate({\"points\": points, roleId: roleId, horizontal: horizontalList})\n            # Remove any previous state\n            @$el.find(\".popover\").popover().close()\n            @$el.find(\".pop-points-open\").remove()\n            # Render into DOM and show the new created element\n            if target?\n                @$el.find(target).append(html)\n            else\n                @$el.append(html)\n\n            @$el.find(\".pop-points-open\").popover().open ->\n                $(this)\n                    .removeClass(\"active\")\n                    .closest(\"li\").removeClass(\"active\")\n\n            @$el.find(\".pop-points-open\").show()\n\n            pop = @$el.find(\".pop-points-open\")\n            if pop.offset().top + pop.height() > document.body.clientHeight\n                pop.addClass('pop-bottom')\n\n    create = ($el, us, project) ->\n        $el.unbind(\"click\")\n\n        estimationProcess = new EstimationProcess($el, us, project)\n\n        if estimationProcess.isEditable\n            estimationProcess.bindClickEvents()\n\n        return estimationProcess\n\n    return {\n        create: create\n    }\n\nmodule.factory(\"$tgEstimationsService\", [\"$tgTemplate\", \"$tgQqueue\",  \"$tgRepo\", \"$tgConfirm\", \"$q\", EstimationsService])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/filters.coffee\n###\n\ntaiga = @.taiga\n\nmodule = angular.module(\"taigaCommon\")\n\n\ndefaultFilter = ->\n    return (value, defaultValue) ->\n        if value is [null, undefined]\n            return defaultValue\n        return value\n\nmodule.filter(\"default\", defaultFilter)\n\n\nyesNoFilter = ($translate) ->\n    return (value) ->\n        if value\n            return $translate.instant(\"COMMON.YES\")\n\n        return $translate.instant(\"COMMON.NO\")\n\nmodule.filter(\"yesNo\", [\"$translate\", yesNoFilter])\n\n\nunslugify = ->\n    return taiga.unslugify\n\nmodule.filter(\"unslugify\", unslugify)\n\n\nmomentFormat = ->\n    return (input, format) ->\n        if input\n            return moment(input).format(format)\n        return \"\"\n\nmodule.filter(\"momentFormat\", momentFormat)\n\n\nmomentFromNow = ->\n    return (input, without_suffix) ->\n        if input\n            return moment(input).fromNow(without_suffix or false)\n        return \"\"\n\nmodule.filter(\"momentFromNow\", momentFromNow)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/history.coffee\n###\n\ntaiga = @.taiga\ntrim = @.taiga.trim\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaCommon\")\n\nIGNORED_FIELDS = {\n    \"userstories.userstory\": [\n        \"watchers\", \"kanban_order\", \"backlog_order\", \"sprint_order\", \"finish_date\"\n    ]\n    \"tasks.task\": [\n        \"watchers\", \"us_order\", \"taskboard_order\"\n    ]\n}\n\n#############################################################################\n## History Directive (Main)\n#############################################################################\n\n\nclass HistoryController extends taiga.Controller\n    @.$inject = [\"$scope\", \"$tgRepo\", \"$tgResources\"]\n\n    constructor: (@scope, @repo, @rs) ->\n\n    initialize: (type, objectId) ->\n        @.type = type\n        @.objectId = objectId\n\n    loadHistory: (type, objectId) ->\n        return @rs.history.get(type, objectId).then (history) =>\n            for historyResult in history\n                # If description was modified take only the description_html field\n                if historyResult.values_diff.description_diff?\n                    historyResult.values_diff.description = historyResult.values_diff.description_diff\n\n                delete historyResult.values_diff.description_html\n                delete historyResult.values_diff.description_diff\n\n                # If block note was modified take only the blocked_note_html field\n                if historyResult.values_diff.blocked_note_diff?\n                    historyResult.values_diff.blocked_note = historyResult.values_diff.blocked_note_diff\n\n                delete historyResult.values_diff.blocked_note_html\n                delete historyResult.values_diff.blocked_note_diff\n\n            @scope.history = history\n            @scope.comments = _.filter(history, (item) -> item.comment != \"\")\n\n    deleteComment: (type, objectId, activityId) ->\n        return @rs.history.deleteComment(type, objectId, activityId).then => @.loadHistory(type, objectId)\n\n    undeleteComment: (type, objectId, activityId) ->\n        return @rs.history.undeleteComment(type, objectId, activityId).then => @.loadHistory(type, objectId)\n\n\nHistoryDirective = ($log, $loading, $qqueue, $template, $confirm, $translate, $compile, $navUrls, $rootScope) ->\n    templateChangeDiff = $template.get(\"common/history/history-change-diff.html\", true)\n    templateChangePoints = $template.get(\"common/history/history-change-points.html\", true)\n    templateChangeGeneric = $template.get(\"common/history/history-change-generic.html\", true)\n    templateChangeAttachment = $template.get(\"common/history/history-change-attachment.html\", true)\n    templateChangeList = $template.get(\"common/history/history-change-list.html\", true)\n    templateDeletedComment = $template.get(\"common/history/history-deleted-comment.html\", true)\n    templateActivity = $template.get(\"common/history/history-activity.html\", true)\n    templateBaseEntries = $template.get(\"common/history/history-base-entries.html\", true)\n    templateBase = $template.get(\"common/history/history-base.html\", true)\n\n    link = ($scope, $el, $attrs, $ctrl) ->\n        # Bootstraping\n        type = $attrs.type\n        objectId = null\n\n        showAllComments = false\n        showAllActivity = false\n\n        getPrettyDateFormat = ->\n            return $translate.instant(\"ACTIVITY.DATETIME\")\n\n        bindOnce $scope, $attrs.ngModel, (model) ->\n            type = $attrs.type\n            objectId = model.id\n\n            $ctrl.initialize(type, objectId)\n            $ctrl.loadHistory(type, objectId)\n\n        # Helpers\n        getHumanizedFieldName = (field) ->\n            humanizedFieldNames = {\n                subject :              $translate.instant(\"ACTIVITY.FIELDS.SUBJECT\")\n                name:                  $translate.instant(\"ACTIVITY.FIELDS.NAME\")\n                description :          $translate.instant(\"ACTIVITY.FIELDS.DESCRIPTION\")\n                content:               $translate.instant(\"ACTIVITY.FIELDS.CONTENT\")\n                status:                $translate.instant(\"ACTIVITY.FIELDS.STATUS\")\n                is_closed :            $translate.instant(\"ACTIVITY.FIELDS.IS_CLOSED\")\n                finish_date :          $translate.instant(\"ACTIVITY.FIELDS.FINISH_DATE\")\n                type:                  $translate.instant(\"ACTIVITY.FIELDS.TYPE\")\n                priority:              $translate.instant(\"ACTIVITY.FIELDS.PRIORITY\")\n                severity:              $translate.instant(\"ACTIVITY.FIELDS.SEVERITY\")\n                assigned_to :          $translate.instant(\"ACTIVITY.FIELDS.ASSIGNED_TO\")\n                watchers :             $translate.instant(\"ACTIVITY.FIELDS.WATCHERS\")\n                milestone :            $translate.instant(\"ACTIVITY.FIELDS.MILESTONE\")\n                user_story:            $translate.instant(\"ACTIVITY.FIELDS.USER_STORY\")\n                project:               $translate.instant(\"ACTIVITY.FIELDS.PROJECT\")\n                is_blocked:            $translate.instant(\"ACTIVITY.FIELDS.IS_BLOCKED\")\n                blocked_note:          $translate.instant(\"ACTIVITY.FIELDS.BLOCKED_NOTE\")\n                points:                $translate.instant(\"ACTIVITY.FIELDS.POINTS\")\n                client_requirement :   $translate.instant(\"ACTIVITY.FIELDS.CLIENT_REQUIREMENT\")\n                team_requirement :     $translate.instant(\"ACTIVITY.FIELDS.TEAM_REQUIREMENT\")\n                is_iocaine:            $translate.instant(\"ACTIVITY.FIELDS.IS_IOCAINE\")\n                tags:                  $translate.instant(\"ACTIVITY.FIELDS.TAGS\")\n                attachments :          $translate.instant(\"ACTIVITY.FIELDS.ATTACHMENTS\")\n                is_deprecated:         $translate.instant(\"ACTIVITY.FIELDS.IS_DEPRECATED\")\n                blocked_note:          $translate.instant(\"ACTIVITY.FIELDS.BLOCKED_NOTE\")\n                is_blocked:            $translate.instant(\"ACTIVITY.FIELDS.IS_BLOCKED\")\n                order:                 $translate.instant(\"ACTIVITY.FIELDS.ORDER\")\n                backlog_order:         $translate.instant(\"ACTIVITY.FIELDS.BACKLOG_ORDER\")\n                sprint_order:          $translate.instant(\"ACTIVITY.FIELDS.SPRINT_ORDER\")\n                kanban_order:          $translate.instant(\"ACTIVITY.FIELDS.KANBAN_ORDER\")\n                taskboard_order:       $translate.instant(\"ACTIVITY.FIELDS.TASKBOARD_ORDER\")\n                us_order:              $translate.instant(\"ACTIVITY.FIELDS.US_ORDER\")\n            }\n\n            return humanizedFieldNames[field] or field\n\n        countChanges = (comment) ->\n            return _.keys(comment.values_diff).length\n\n        formatChange = (change) ->\n            if _.isArray(change)\n                if change.length == 0\n                    return $translate.instant(\"ACTIVITY.VALUES.EMPTY\")\n                return change.join(\", \")\n\n            if change == \"\"\n                return $translate.instant(\"ACTIVITY.VALUES.EMPTY\")\n\n            if not change? or change == false\n                return $translate.instant(\"ACTIVITY.VALUES.NO\")\n\n            if change == true\n                return $translate.instant(\"ACTIVITY.VALUES.YES\")\n\n            return change\n\n        # Render into string (operations without mutability)\n\n        renderAttachmentEntry = (value) ->\n            attachments = _.map value, (changes, type) ->\n                if type == \"new\"\n                    return _.map changes, (change) ->\n                        return templateChangeDiff({\n                            name: $translate.instant(\"ACTIVITY.NEW_ATTACHMENT\"),\n                            diff: change.filename\n                        })\n                else if type == \"deleted\"\n                    return _.map changes, (change) ->\n                        return templateChangeDiff({\n                            name: $translate.instant(\"ACTIVITY.DELETED_ATTACHMENT\"),\n                            diff: change.filename\n                        })\n                else\n                    return _.map changes, (change) ->\n                        name = $translate.instant(\"ACTIVITY.UPDATED_ATTACHMENT\", {filename: change.filename})\n\n                        diff = _.map change.changes, (values, name) ->\n                            return {\n                                name: getHumanizedFieldName(name)\n                                from: formatChange(values[0])\n                                to: formatChange(values[1])\n                            }\n\n                        return templateChangeAttachment({name: name, diff: diff})\n\n            return _.flatten(attachments).join(\"\\n\")\n\n        renderCustomAttributesEntry = (value) ->\n            customAttributes = _.map value, (changes, type) ->\n                if type == \"new\"\n                    return _.map changes, (change) ->\n                        html = templateChangeGeneric({\n                            name: change.name,\n                            from: formatChange(\"\"),\n                            to: formatChange(change.value)\n                        })\n\n                        html = $compile(html)($scope)\n\n                        return html[0].outerHTML\n                else if type == \"deleted\"\n                    return _.map changes, (change) ->\n                        return templateChangeDiff({\n                            name: $translate.instant(\"ACTIVITY.DELETED_CUSTOM_ATTRIBUTE\")\n                            diff: change.name\n                        })\n                else\n                    return _.map changes, (change) ->\n                        customAttrsChanges = _.map change.changes, (values) ->\n                            return templateChangeGeneric({\n                                name: change.name\n                                from: formatChange(values[0])\n                                to: formatChange(values[1])\n                            })\n                        return _.flatten(customAttrsChanges).join(\"\\n\")\n\n            return _.flatten(customAttributes).join(\"\\n\")\n\n        renderChangeEntry = (field, value) ->\n            if field == \"description\"\n                return templateChangeDiff({name: getHumanizedFieldName(\"description\"), diff: value[1]})\n            else if field == \"blocked_note\"\n                return templateChangeDiff({name: getHumanizedFieldName(\"blocked_note\"), diff: value[1]})\n            else if field == \"points\"\n                html = templateChangePoints({points: value})\n\n                html = $compile(html)($scope)\n\n                return html[0].outerHTML\n            else if field == \"attachments\"\n                return renderAttachmentEntry(value)\n            else if field == \"custom_attributes\"\n                return renderCustomAttributesEntry(value)\n            else if field in [\"tags\", \"watchers\"]\n                name = getHumanizedFieldName(field)\n                removed = _.difference(value[0], value[1])\n                added = _.difference(value[1], value[0])\n                html = templateChangeList({name:name, removed:removed, added: added})\n\n                html = $compile(html)($scope)\n\n                return html[0].outerHTML\n            else if field == \"assigned_to\"\n                name = getHumanizedFieldName(field)\n                from = formatChange(value[0] or $translate.instant(\"ACTIVITY.VALUES.UNASSIGNED\"))\n                to = formatChange(value[1] or $translate.instant(\"ACTIVITY.VALUES.UNASSIGNED\"))\n                return templateChangeGeneric({name:name, from:from, to: to})\n            else\n                name = getHumanizedFieldName(field)\n                from = formatChange(value[0])\n                to = formatChange(value[1])\n                return templateChangeGeneric({name:name, from:from, to: to})\n\n        renderChangeEntries = (change) ->\n            changeModel = change.key.split(\":\")[0]\n            if IGNORED_FIELDS[changeModel]?\n                change.values_diff = _.removeKeys(change.values_diff, IGNORED_FIELDS[changeModel])\n\n            return _.map(change.values_diff, (value, field) -> renderChangeEntry(field, value))\n\n        renderChangesHelperText = (change) ->\n            size = countChanges(change)\n            return $translate.instant(\"ACTIVITY.SIZE_CHANGE\", {size: size}, 'messageformat')\n\n        renderComment = (comment) ->\n            if (comment.delete_comment_date or comment.delete_comment_user?.name)\n                html = templateDeletedComment({\n                    deleteCommentDate: moment(comment.delete_comment_date).format(getPrettyDateFormat()) if comment.delete_comment_date\n                    deleteCommentUser: comment.delete_comment_user.name\n                    deleteComment: comment.comment_html\n                    activityId: comment.id\n                    canRestoreComment: ($scope.user and\n                                        (comment.delete_comment_user.pk == $scope.user.id or\n                                        $scope.project.my_permissions.indexOf(\"modify_project\") > -1))\n                })\n\n                html = $compile(html)($scope)\n\n                return html[0].outerHTML\n\n            html = templateActivity({\n                avatar: comment.user.photo\n                userFullName: comment.user.name\n                userProfileUrl: if comment.user.is_active then $navUrls.resolve(\"user-profile\", {username: comment.user.username})  else \"\"\n                creationDate: moment(comment.created_at).format(getPrettyDateFormat())\n                comment: comment.comment_html\n                changesText: renderChangesHelperText(comment)\n                changes: renderChangeEntries(comment)\n                mode: \"comment\"\n                deleteCommentDate: moment(comment.delete_comment_date).format(getPrettyDateFormat()) if comment.delete_comment_date\n                deleteCommentUser: comment.delete_comment_user.name if comment.delete_comment_user?.name\n                activityId: comment.id\n                canDeleteComment: comment.user.pk == $scope.user?.id or $scope.project.my_permissions.indexOf(\"modify_project\") > -1\n            })\n\n            html = $compile(html)($scope)\n\n            return html[0].outerHTML\n\n        renderChange = (change) ->\n            return templateActivity({\n                avatar: change.user.photo\n                userFullName: change.user.name\n                userProfileUrl: if change.user.is_active then $navUrls.resolve(\"user-profile\", {username: change.user.username})  else \"\"\n                creationDate: moment(change.created_at).format(getPrettyDateFormat())\n                comment: change.comment_html\n                changes: renderChangeEntries(change)\n                changesText: \"\"\n                mode: \"activity\"\n                deleteCommentDate: moment(change.delete_comment_date).format(getPrettyDateFormat()) if change.delete_comment_date\n                deleteCommentUser: change.delete_comment_user.name if change.delete_comment_user?.name\n                activityId: change.id\n            })\n\n        renderHistory = (entries, totalEntries) ->\n            if entries.length == totalEntries\n                showMore = 0\n            else\n                showMore = totalEntries - entries.length\n\n            html = templateBaseEntries({entries: entries, showMore:showMore})\n            html = $compile(html)($scope)\n            return html\n\n        # Render into DOM (operations with dom mutability)\n\n        renderComments = ->\n            comments = $scope.comments or []\n            totalComments = comments.length\n            if not showAllComments\n                comments = _.last(comments, 4)\n\n            comments = _.map(comments, (x) -> renderComment(x))\n            html = renderHistory(comments, totalComments)\n            $el.find(\".comments-list\").html(html)\n\n        renderActivity = ->\n            changes = $scope.history or []\n            totalChanges = changes.length\n            if not showAllActivity\n                changes = _.last(changes, 4)\n\n            changes = _.map(changes, (x) -> renderChange(x))\n            html = renderHistory(changes, totalChanges)\n            $el.find(\".changes-list\").html(html)\n\n        save = $qqueue.bindAdd (target) =>\n            $scope.$broadcast(\"markdown-editor:submit\")\n\n            $el.find(\".comment-list\").addClass(\"activeanimation\")\n\n            currentLoading = $loading()\n                .target(target)\n                .start()\n\n            onSuccess = ->\n                $rootScope.$broadcast(\"comment:new\")\n\n                $ctrl.loadHistory(type, objectId).finally ->\n                    currentLoading.finish()\n\n            onError = ->\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n            model = $scope.$eval($attrs.ngModel)\n\n            $ctrl.repo.save(model).then(onSuccess, onError)\n\n        # Watchers\n\n        $scope.$watch(\"comments\", renderComments)\n        $scope.$watch(\"history\",  renderActivity)\n\n        $scope.$on(\"object:updated\", -> $ctrl.loadHistory(type, objectId))\n\n        # Events\n\n        $el.on \"click\", \".add-comment button.button-green\", debounce 2000, (event) ->\n            event.preventDefault()\n\n            target = angular.element(event.currentTarget)\n            save(target)\n\n        $el.on \"click\", \"a\", (event) ->\n            target = angular.element(event.target)\n            href = target.attr('href')\n            if href && href.indexOf(\"#\") == 0\n                event.preventDefault()\n                $('body').scrollTop($(href).offset().top)\n\n        $el.on \"click\", \".show-more\", (event) ->\n            event.preventDefault()\n\n            target = angular.element(event.currentTarget)\n            if target.parent().is(\".changes-list\")\n                showAllActivity = not showAllActivity\n                renderActivity()\n            else\n                showAllComments = not showAllComments\n                renderComments()\n\n        $el.on \"click\", \".show-deleted-comment\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            target.parents('.activity-single').find('.hide-deleted-comment').show()\n            target.parents('.activity-single').find('.show-deleted-comment').hide()\n            target.parents('.activity-single').find('.comment-body').show()\n\n        $el.on \"click\", \".hide-deleted-comment\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            target.parents('.activity-single').find('.hide-deleted-comment').hide()\n            target.parents('.activity-single').find('.show-deleted-comment').show()\n            target.parents('.activity-single').find('.comment-body').hide()\n\n        $el.on \"click\", \".changes-title\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            target.parent().find(\".change-entry\").toggleClass(\"active\")\n\n        $el.on \"focus\", \".add-comment textarea\", (event) ->\n            $(this).addClass('active')\n\n        $el.on \"click\", \".history-tabs li a\", (event) ->\n            target = angular.element(event.currentTarget)\n\n            $el.find(\".history-tabs li a\").removeClass(\"active\")\n            target.addClass(\"active\")\n\n            $el.find(\".history section\").addClass(\"hidden\")\n            $el.find(\".history section.#{target.data('section-class')}\").removeClass(\"hidden\")\n\n        $el.on \"click\", \".comment-delete\", debounce 2000, (event) ->\n            event.preventDefault()\n\n            target = angular.element(event.currentTarget)\n            activityId = target.data('activity-id')\n            $ctrl.deleteComment(type, objectId, activityId)\n\n        $el.on \"click\", \".comment-restore\", debounce 2000, (event) ->\n            event.preventDefault()\n\n            target = angular.element(event.currentTarget)\n            activityId = target.data('activity-id')\n            $ctrl.undeleteComment(type, objectId, activityId)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    templateFn = ($el, $attrs) ->\n        html = templateBase({ngmodel: $attrs.ngModel, type: $attrs.type, mode: $attrs.mode})\n\n        return html\n\n    return {\n        controller: HistoryController\n        template: templateFn\n        restrict: \"AE\"\n        link: link\n        # require: [\"ngModel\", \"tgHistory\"]\n    }\n\n\nmodule.directive(\"tgHistory\", [\"$log\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$tgConfirm\", \"$translate\",\n                               \"$compile\", \"$tgNavUrls\", \"$rootScope\", HistoryDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/importer.coffee\n###\n\nmodule = angular.module(\"taigaCommon\")\n\n\nImportProjectButtonDirective = ($rs, $confirm, $location, $navUrls, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $el.on \"click\", \".import-project-button\", (event) ->\n            event.preventDefault()\n            $el.find(\"input.import-file\").val(\"\")\n            $el.find(\"input.import-file\").trigger(\"click\")\n\n        $el.on \"change\", \"input.import-file\", (event) ->\n            event.preventDefault()\n            file = event.target.files[0]\n            return if not file\n\n            loader = $confirm.loader($translate.instant(\"PROJECT.IMPORT.UPLOADING_FILE\"))\n\n            onSuccess = (result) ->\n                loader.stop()\n                if result.status == 202 # Async mode\n                    title = $translate.instant(\"PROJECT.IMPORT.ASYNC_IN_PROGRESS_TITLE\")\n                    message = $translate.instant(\"PROJECT.IMPORT.ASYNC_IN_PROGRESS_MESSAGE\")\n                    $confirm.success(title, message)\n\n                else # result.status == 201 # Sync mode\n                    ctx = {project: result.data.slug}\n                    $location.path($navUrls.resolve(\"project-admin-project-profile-details\", ctx))\n                    msg = $translate.instant(\"PROJECT.IMPORT.SYNC_SUCCESS\")\n                    $confirm.notify(\"success\", msg)\n\n            onError = (result) ->\n                loader.stop()\n                errorMsg = $translate.instant(\"PROJECT.IMPORT.ERROR\")\n\n                if result.status == 429  # TOO MANY REQUESTS\n                    errorMsg = $translate.instant(\"PROJECT.IMPORT.ERROR_TOO_MANY_REQUEST\")\n                else if result.data?._error_message\n                    errorMsg = $translate.instant(\"PROJECT.IMPORT.ERROR_MESSAGE\", {error_message: result.data._error_message})\n                $confirm.notify(\"error\", errorMsg)\n\n            loader.start()\n            $rs.projects.import(file, loader.update).then(onSuccess, onError)\n\n    return {link: link}\n\nmodule.directive(\"tgImportProjectButton\", [\"$tgResources\", \"$tgConfirm\", \"$location\", \"$tgNavUrls\", \"$translate\",\n                                           ImportProjectButtonDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/lightboxes.coffee\n###\n\nmodule = angular.module(\"taigaCommon\")\n\nbindOnce = @.taiga.bindOnce\ntimeout = @.taiga.timeout\ndebounce = @.taiga.debounce\n\n#############################################################################\n## Common Lightbox Services\n#############################################################################\n\n# the lightboxContent hide/show doesn't have sense because is an IE hack\nclass LightboxService extends taiga.Service\n    constructor: (@animationFrame, @q) ->\n\n    open: ($el) ->\n        defered = @q.defer()\n\n        lightboxContent = $el.children().not(\".close\")\n        lightboxContent.hide()\n\n        @animationFrame.add ->\n            $el.css('display', 'flex')\n\n        @animationFrame.add ->\n            $el.addClass(\"open\")\n\n        @animationFrame.add ->\n            $el.find('input,textarea').first().focus()\n\n        @animationFrame.add =>\n            lightboxContent.show()\n            defered.resolve()\n\n        docEl = angular.element(document)\n        docEl.on \"keydown.lightbox\", (e) =>\n            code = if e.keyCode then e.keyCode else e.which\n            @.close($el) if code == 27\n\n        return defered.promise\n\n    close: ($el) ->\n        docEl = angular.element(document)\n        docEl.off(\".lightbox\")\n        docEl.off(\".keyboard-navigation\") # Hack: to fix problems in the WYSIWYG textareas when press ENTER\n        $el.one \"transitionend\", =>\n            $el.removeAttr('style')\n            $el.removeClass(\"open\").removeClass('close')\n\n        $el.addClass('close')\n\n        if $el.hasClass(\"remove-on-close\")\n            scope = $el.data(\"scope\")\n            scope.$destroy()\n            $el.remove()\n\n    closeAll: ->\n        docEl = angular.element(document)\n        for lightboxEl in docEl.find(\".lightbox.open\")\n            @.close($(lightboxEl))\n\n\nmodule.service(\"lightboxService\", [\"animationFrame\", \"$q\", LightboxService])\n\n\nclass LightboxKeyboardNavigationService extends taiga.Service\n    stop: ->\n        docEl = angular.element(document)\n        docEl.off(\".keyboard-navigation\")\n\n    dispatch: ($el, code) ->\n        activeElement = $el.find(\".active\")\n\n        # Key: enter\n        if code == 13\n            if $el.find(\".watcher-single\").length == 1\n                $el.find('.watcher-single:first').trigger(\"click\")\n            else\n                activeElement.trigger(\"click\")\n\n        # Key: down\n        else if code == 40\n            if not activeElement.length\n                $el.find('.watcher-single:first').addClass('active')\n            else\n                next = activeElement.next('.watcher-single')\n                if next.length\n                    activeElement.removeClass('active')\n                    next.addClass('active')\n        # Key: up\n        else if code == 38\n            if not activeElement.length\n                $el.find('.watcher-single:last').addClass('active')\n            else\n                prev = activeElement.prev('.watcher-single')\n\n                if prev.length\n                    activeElement.removeClass('active')\n                    prev.addClass('active')\n\n    init: ($el) ->\n        @stop()\n        docEl = angular.element(document)\n        docEl.on \"keydown.keyboard-navigation\", (event) =>\n            code = if event.keyCode then event.keyCode else event.which\n            if code == 40 || code == 38 || code == 13\n                event.preventDefault()\n                @.dispatch($el, code)\n\nmodule.service(\"lightboxKeyboardNavigationService\", LightboxKeyboardNavigationService)\n\n\n#############################################################################\n## Generic Lighthbox Directive\n#############################################################################\n\n# This adds generic behavior to all blocks with lightbox class like\n# close button event handlers.\n\nLightboxDirective = (lightboxService) ->\n    link = ($scope, $el, $attrs) ->\n        $el.on \"click\", \".close\", (event) ->\n            event.preventDefault()\n            lightboxService.close($el)\n\n    return {restrict: \"C\", link: link}\n\nmodule.directive(\"lightbox\", [\"lightboxService\", LightboxDirective])\n\n#############################################################################\n## Block Lightbox Directive\n#############################################################################\n\n# Issue/Userstory blocking message lightbox directive.\n\nBlockLightboxDirective = ($rootscope, $tgrepo, $confirm, lightboxService, $loading, $qqueue, $translate) ->\n    link = ($scope, $el, $attrs, $model) ->\n        title = $translate.instant($attrs.title)\n        $el.find(\"h2.title\").text(title)\n\n        unblock = $qqueue.bindAdd (item, finishCallback) =>\n            promise = $tgrepo.save(item)\n            promise.then ->\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"object:updated\")\n                $model.$setViewValue(item)\n                finishCallback()\n\n            promise.then null, ->\n                $confirm.notify(\"error\")\n                item.revert()\n                $model.$setViewValue(item)\n\n            promise.finally ->\n                finishCallback()\n\n            return promise\n\n        block = $qqueue.bindAdd (item) =>\n            $model.$setViewValue(item)\n\n            currentLoading = $loading()\n                .target($el.find(\".button-green\"))\n                .start()\n\n            promise = $tgrepo.save($model.$modelValue)\n            promise.then ->\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"object:updated\")\n\n            promise.then null, ->\n                $confirm.notify(\"error\")\n                item.revert()\n                $model.$setViewValue(item)\n\n            promise.finally ->\n                currentLoading.finish()\n                lightboxService.close($el)\n\n        $scope.$on \"block\", ->\n            $el.find(\".reason\").val($model.$modelValue.blocked_note)\n            lightboxService.open($el)\n\n        $scope.$on \"unblock\", (event, model, finishCallback) =>\n            item = $model.$modelValue.clone()\n            item.is_blocked = false\n            item.blocked_note = \"\"\n\n            unblock(item, finishCallback)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        $el.on \"click\", \".button-green\", (event) ->\n            event.preventDefault()\n\n            item = $model.$modelValue.clone()\n            item.is_blocked = true\n            item.blocked_note = $el.find(\".reason\").val()\n\n            block(item)\n\n    return {\n        templateUrl: \"common/lightbox/lightbox-block.html\"\n        link: link\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgLbBlock\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"lightboxService\", \"$tgLoading\", \"$tgQqueue\", \"$translate\", BlockLightboxDirective])\n\n\n#############################################################################\n## Generic Lightbox Blocking-Message Input Directive\n#############################################################################\n\nBlockingMessageInputDirective = ($log, $template, $compile) ->\n    template = $template.get(\"common/lightbox/lightbox-blocking-message-input.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        if not $attrs.watch\n            return $log.error \"No watch attribute on tg-blocking-message-input directive\"\n\n        $scope.$watch $attrs.watch, (value) ->\n            if value is not undefined and value == true\n                $el.find(\".blocked-note\").removeClass(\"hidden\")\n            else\n                $el.find(\".blocked-note\").addClass(\"hidden\")\n\n    templateFn = ($el, $attrs) ->\n        return template({ngmodel: $attrs.ngModel})\n\n    return {\n        template: templateFn\n        link: link\n        require: \"ngModel\"\n        restrict: \"EA\"\n    }\n\nmodule.directive(\"tgBlockingMessageInput\", [\"$log\", \"$tgTemplate\", \"$compile\", BlockingMessageInputDirective])\n\n\n#############################################################################\n## Create/Edit Userstory Lightbox Directive\n#############################################################################\n\nCreateEditUserstoryDirective = ($repo, $model, $rs, $rootScope, lightboxService, $loading, $translate) ->\n    link = ($scope, $el, attrs) ->\n        $scope.isNew = true\n\n        $scope.$on \"usform:new\", (ctx, projectId, status, statusList) ->\n            $scope.isNew = true\n            $scope.usStatusList = statusList\n\n            $scope.us = $model.make_model(\"userstories\", {\n                project: projectId\n                points : {}\n                status: status\n                is_archived: false\n                tags: []\n            })\n\n            # Update texts for creation\n            $el.find(\".button-green\").html($translate.instant(\"COMMON.CREATE\"))\n            $el.find(\".title\").html($translate.instant(\"LIGHTBOX.CREATE_EDIT_US.NEW_US\"))\n            $el.find(\".tag-input\").val(\"\")\n\n            $el.find(\".blocked-note\").addClass(\"hidden\")\n            $el.find(\"label.blocked\").removeClass(\"selected\")\n            $el.find(\"label.team-requirement\").removeClass(\"selected\")\n            $el.find(\"label.client-requirement\").removeClass(\"selected\")\n\n            lightboxService.open($el)\n\n        $scope.$on \"usform:edit\", (ctx, us) ->\n            $scope.us = us\n            $scope.isNew = false\n\n            # Update texts for edition\n            $el.find(\".button-green\").html($translate.instant(\"COMMON.SAVE\"))\n            $el.find(\".title\").html($translate.instant(\"LIGHTBOX.CREATE_EDIT_US.EDIT_US\"))\n            $el.find(\".tag-input\").val(\"\")\n\n            # Update requirement info (team, client or blocked)\n            if us.is_blocked\n                $el.find(\".blocked-note\").removeClass(\"hidden\")\n                $el.find(\"label.blocked\").addClass(\"selected\")\n            else\n                $el.find(\".blocked-note\").addClass(\"hidden\")\n                $el.find(\"label.blocked\").removeClass(\"selected\")\n\n            if us.team_requirement\n                $el.find(\"label.team-requirement\").addClass(\"selected\")\n            else\n                $el.find(\"label.team-requirement\").removeClass(\"selected\")\n            if us.client_requirement\n                $el.find(\"label.client-requirement\").addClass(\"selected\")\n            else\n                $el.find(\"label.client-requirement\").removeClass(\"selected\")\n\n            lightboxService.open($el)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            if $scope.isNew\n                promise = $repo.create(\"userstories\", $scope.us)\n                broadcastEvent = \"usform:new:success\"\n            else\n                promise = $repo.save($scope.us)\n                broadcastEvent = \"usform:edit:success\"\n\n            promise.then (data) ->\n                currentLoading.finish()\n                lightboxService.close($el)\n                $rootScope.$broadcast(broadcastEvent, data)\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $el.on \"click\", \".close\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                $scope.us.revert()\n            lightboxService.close($el)\n\n        $el.keydown (event) ->\n            code = if event.keyCode then event.keyCode else event.which\n            if code == 27\n                lightboxService.close($el)\n                $scope.$apply ->\n                    $scope.us.revert()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgLbCreateEditUserstory\", [\n    \"$tgRepo\",\n    \"$tgModel\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"lightboxService\",\n    \"$tgLoading\",\n    \"$translate\",\n    CreateEditUserstoryDirective\n])\n\n\n#############################################################################\n## Creare Bulk Userstories Lightbox Directive\n#############################################################################\n\nCreateBulkUserstoriesDirective = ($repo, $rs, $rootscope, lightboxService, $loading) ->\n    link = ($scope, $el, attrs) ->\n        $scope.$on \"usform:bulk\", (ctx, projectId, status) ->\n            $scope.new = {\n                projectId: projectId\n                statusId: status\n                bulk: \"\"\n            }\n            lightboxService.open($el)\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley({onlyOneErrorElement: true})\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $rs.userstories.bulkCreate($scope.new.projectId, $scope.new.statusId, $scope.new.bulk)\n            promise.then (result) ->\n                currentLoading.finish()\n                $rootscope.$broadcast(\"usform:bulk:success\", result)\n                lightboxService.close($el)\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgLbCreateBulkUserstories\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"lightboxService\",\n    \"$tgLoading\",\n    CreateBulkUserstoriesDirective\n])\n\n\n#############################################################################\n## AssignedTo Lightbox Directive\n#############################################################################\n\nAssignedToLightboxDirective = (lightboxService, lightboxKeyboardNavigationService, $template, $compile) ->\n    link = ($scope, $el, $attrs) ->\n        selectedUser = null\n        selectedItem = null\n        usersTemplate = $template.get(\"common/lightbox/lightbox-assigned-to-users.html\", true)\n\n        normalizeString = (string) ->\n            normalizedString = string\n            normalizedString = normalizedString.replace(\"\", \"A\").replace(\"\", \"A\").replace(\"\", \"A\")\n            normalizedString = normalizedString.replace(\"\", \"E\").replace(\"\", \"E\").replace(\"\", \"E\")\n            normalizedString = normalizedString.replace(\"\", \"I\").replace(\"\", \"I\").replace(\"\", \"I\")\n            normalizedString = normalizedString.replace(\"\", \"O\").replace(\"\", \"O\").replace(\"\", \"O\")\n            normalizedString = normalizedString.replace(\"\", \"U\").replace(\"\", \"U\").replace(\"\", \"U\")\n            return normalizedString\n\n        filterUsers = (text, user) ->\n            username = user.full_name_display.toUpperCase()\n            username = normalizeString(username)\n            text = text.toUpperCase()\n            text = normalizeString(text)\n            return _.contains(username, text)\n\n        render = (selected, text) ->\n            users = _.clone($scope.activeUsers, true)\n            users = _.reject(users, {\"id\": selected.id}) if selected?\n            users = _.filter(users, _.partial(filterUsers, text)) if text?\n\n            ctx = {\n                selected: selected\n                users: _.first(users, 5)\n                showMore: users.length > 5\n            }\n\n            html = usersTemplate(ctx)\n            html = $compile(html)($scope)\n\n            $el.find(\".assigned-to-list\").html(html)\n\n        closeLightbox = () ->\n            lightboxKeyboardNavigationService.stop()\n            lightboxService.close($el)\n\n        $scope.$on \"assigned-to:add\", (ctx, item) ->\n            selectedItem = item\n            assignedToId = item.assigned_to\n            selectedUser = $scope.usersById[assignedToId]\n\n            render(selectedUser)\n            lightboxService.open($el).then ->\n                $el.find('input').focus()\n                lightboxKeyboardNavigationService.init($el)\n\n        $scope.$watch \"usersSearch\", (searchingText) ->\n            if searchingText?\n                render(selectedUser, searchingText)\n                $el.find('input').focus()\n\n        $el.on \"click\", \".user-list-single\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            closeLightbox()\n\n            $scope.$apply ->\n                $scope.$broadcast(\"assigned-to:added\", target.data(\"user-id\"), selectedItem)\n                $scope.usersSearch = null\n\n        $el.on \"click\", \".remove-assigned-to\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n\n            closeLightbox()\n\n            $scope.$apply ->\n                $scope.usersSearch = null\n                $scope.$broadcast(\"assigned-to:added\", null, selectedItem)\n\n        $el.on \"click\", \".close\", (event) ->\n            event.preventDefault()\n\n            closeLightbox()\n\n            $scope.$apply ->\n                $scope.usersSearch = null\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        templateUrl: \"common/lightbox/lightbox-assigned-to.html\"\n        link:link\n    }\n\n\nmodule.directive(\"tgLbAssignedto\", [\"lightboxService\", \"lightboxKeyboardNavigationService\", \"$tgTemplate\", \"$compile\", AssignedToLightboxDirective])\n\n\n#############################################################################\n## Watchers Lightbox directive\n#############################################################################\n\nWatchersLightboxDirective = ($repo, lightboxService, lightboxKeyboardNavigationService, $template, $compile) ->\n    link = ($scope, $el, $attrs) ->\n        selectedItem = null\n        usersTemplate = $template.get(\"common/lightbox/lightbox-assigned-to-users.html\", true)\n\n        # Get prefiltered users by text\n        # and without now watched users.\n        getFilteredUsers = (text=\"\") ->\n            _filterUsers = (text, user) ->\n                if selectedItem && _.find(selectedItem.watchers, (x) -> x == user.id)\n                    return false\n\n                username = user.full_name_display.toUpperCase()\n                text = text.toUpperCase()\n                return _.contains(username, text)\n\n            users = _.clone($scope.activeUsers, true)\n            users = _.filter(users, _.partial(_filterUsers, text))\n            return users\n\n        # Render the specific list of users.\n        render = (users) ->\n            ctx = {\n                selected: false\n                users: _.first(users, 5)\n                showMore: users.length > 5\n            }\n\n            html = usersTemplate(ctx)\n            html = $compile(html)($scope)\n            $el.find(\".ticket-watchers\").html(html)\n\n        closeLightbox = () ->\n            lightboxKeyboardNavigationService.stop()\n            lightboxService.close($el)\n\n        $scope.$on \"watcher:add\", (ctx, item) ->\n            selectedItem = item\n\n            users = getFilteredUsers()\n            render(users)\n\n            lightboxService.open($el).then ->\n                $el.find(\"input\").focus()\n                lightboxKeyboardNavigationService.init($el)\n\n        $scope.$watch \"usersSearch\", (searchingText) ->\n            if not searchingText?\n                return\n\n            users = getFilteredUsers(searchingText)\n            render(users)\n            $el.find(\"input\").focus()\n\n        $el.on \"click\", \".user-list-single\", debounce 2000, (event) ->\n            closeLightbox()\n\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            $scope.$apply ->\n                $scope.usersSearch = null\n                $scope.$broadcast(\"watcher:added\", target.data(\"user-id\"))\n\n        $el.on \"click\", \".close\", (event) ->\n            event.preventDefault()\n\n            closeLightbox()\n\n            $scope.$apply ->\n                $scope.usersSearch = null\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        templateUrl: \"common/lightbox/lightbox-users.html\"\n        link:link\n    }\n\nmodule.directive(\"tgLbWatchers\", [\"$tgRepo\", \"lightboxService\", \"lightboxKeyboardNavigationService\", \"$tgTemplate\", \"$compile\", WatchersLightboxDirective])\n\n\n#############################################################################\n## Attachment Preview Lighbox\n#############################################################################\n\nAttachmentPreviewLightboxDirective = ($repo, lightboxService, lightboxKeyboardNavigationService, $template, $compile) ->\n    link = ($scope, $el, attrs) ->\n        template = $template.get(\"common/lightbox/lightbox-attachment-preview.html\", true)\n\n        $scope.$on \"attachment:preview\", (event, attachment) ->\n            lightboxService.open($el)\n            render(attachment)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        render = (attachment) ->\n            ctx = {\n                url: attachment.url,\n                title: attachment.description,\n                name: attachment.name\n            }\n\n            html = template(ctx)\n            html = $compile(html)($scope)\n            $el.html(html)\n\n    return {\n        link: link\n    }\n\nmodule.directive(\"tgLbAttachmentPreview\", [\"$tgRepo\", \"lightboxService\", \"lightboxKeyboardNavigationService\", \"$tgTemplate\", \"$compile\", AttachmentPreviewLightboxDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n# Copyright (C) 2014-2015 Juan Francisco Alcntara <juanfran.alcantara@kaleidos.net>\n# Copyright (C) 2014-2015 Alejandro Alonso <alejandro.alonso@kaleidos.net>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/loader.coffee\n###\n\n# FIXME: this code not follows any style and any good practices on coffeescript\n# and it should be rewritten in coffeescript style classes.\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\ntimeout = @.taiga.timeout\n\nmodule = angular.module(\"taigaCommon\")\n\nLoaderDirective = (tgLoader, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        tgLoader.onStart () ->\n            $(document.body).addClass(\"loader-active\")\n            $el.addClass(\"active\")\n\n        tgLoader.onEnd () ->\n            $(document.body).removeClass(\"loader-active\")\n            $el.removeClass(\"active\")\n\n    return {\n        link: link\n    }\n\nmodule.directive(\"tgLoader\", [\"tgLoader\", \"$rootScope\", LoaderDirective])\n\nLoader = ($rootscope) ->\n    config = {\n        minTime: 300\n    }\n\n    open = false\n    startLoadTime = 0\n    requestCount = 0\n    lastResponseDate = 0\n\n    pageLoaded = (force = false) ->\n        if startLoadTime\n            timeoutValue = 0\n\n            if !force\n                endTime = new Date().getTime()\n                diff = endTime - startLoadTime\n\n                if diff < config.minTime\n                    timeoutValue = config.minTime - diff\n\n            timeout timeoutValue, ->\n                $rootscope.$broadcast(\"loader:end\")\n                open = false\n                window.prerenderReady = true # Needed by Prerender Server\n\n        startLoadTime = 0\n        requestCount = 0\n        lastResponseDate = 0\n\n    autoClose = () ->\n        intervalAuto = setInterval (() ->\n            if lastResponseDate && requestCount == 0\n                pageLoaded()\n\n                clearInterval(intervalAuto)\n        ), 50\n\n    start = () ->\n        startLoadTime = new Date().getTime()\n        $rootscope.$broadcast(\"loader:start\")\n        open = true\n\n    return {\n        pageLoaded: pageLoaded\n        start: (auto=false) ->\n            if !open\n                start()\n                autoClose() if auto\n        onStart: (fn) ->\n            $rootscope.$on(\"loader:start\", fn)\n\n        onEnd: (fn) ->\n            $rootscope.$on(\"loader:end\", fn)\n\n        logRequest: () ->\n            requestCount++\n\n        logResponse: () ->\n            requestCount--\n            lastResponseDate = new Date().getTime()\n    }\n\n\nLoader.$inject = [\"$rootScope\"]\n\nmodule.factory(\"tgLoader\", Loader)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/lightboxes.coffee\n###\n\nmodule = angular.module(\"taigaCommon\")\n\nTgLoadingService = ($compile) ->\n    spinner = \"<img class='loading-spinner' src='/svg/spinner-circle.svg' alt='loading...' />\"\n\n    return () ->\n        service = {\n            settings: {\n                target: null,\n                scope: null,\n                classes: []\n                timeout: 0,\n                template: null\n            },\n            target: (target) ->\n                service.settings.target = target\n\n                return service\n            scope: (scope) ->\n                service.settings.scope = scope\n\n                return service\n            template: (template) ->\n                service.settings.template = template\n\n                return service\n            removeClasses: (classess...) ->\n                service.settings.classes = classess\n\n                return service\n            timeout: (timeout) ->\n                service.settings.timeout = timeout\n\n                return service\n\n            start: ->\n                target = service.settings.target\n                service.settings.classes.map (className) -> target.removeClass(className)\n\n                # The loader is shown after that quantity of milliseconds\n                timeoutId = setTimeout (->\n                    if not target.hasClass('loading')\n                        if !service.settings.template\n                            service.settings.template = target.html()\n\n                        target.addClass('loading')\n\n                        target.html(spinner)\n                    ), service.settings.timeout\n\n                service.settings.timeoutId = timeoutId\n\n                return service\n\n            finish: ->\n                target = service.settings.target\n                timeoutId = service.settings.timeoutId\n\n                if timeoutId\n                    clearTimeout(timeoutId)\n\n                    removeClasses = service.settings.classes\n                    removeClasses.map (className) -> service.settings.target.addClass(className)\n\n                    target.html(service.settings.template)\n                    target.removeClass('loading')\n\n                    if service.settings.scope\n                        $compile(target.contents())(service.settings.scope)\n\n                return service\n        }\n\n        return service\n\nTgLoadingService.$inject = [\n    \"$compile\"\n]\n\nmodule.factory(\"$tgLoading\", TgLoadingService)\n\nLoadingDirective = ($loading) ->\n    link = ($scope, $el, attr) ->\n        currentLoading = null\n        template = $el.html()\n\n        $scope.$watch attr.tgLoading, (showLoading) =>\n            if showLoading\n                currentLoading = $loading()\n                    .target($el)\n                    .timeout(50)\n                    .template(template)\n                    .scope($scope)\n                    .start()\n             else if currentLoading\n                 currentLoading.finish()\n\n    return {\n        link:link\n    }\n\nmodule.directive(\"tgLoading\", [\"$tgLoading\", LoadingDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/popovers.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaCommon\")\n\n#############################################################################\n## UserStory status Directive (popover for change status)\n#############################################################################\n\nUsStatusDirective = ($repo, $template) ->\n    ###\n    Print the status of a US and a popover to change it.\n    - tg-us-status: The user story\n    - on-update: Method call after US is updated\n\n    Example:\n\n      div.status(tg-us-status=\"us\" on-update=\"ctrl.loadSprintState()\")\n        a.us-status(href=\"\", title=\"Status Name\")\n\n    NOTE: This directive need 'usStatusById' and 'project'.\n    ###\n    template = $template.get(\"common/popover/popover-us-status.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        render = (us) ->\n            usStatusDomParent = $el.find(\".us-status\")\n            usStatusDom = $el.find(\".us-status .us-status-bind\")\n            usStatusById = $scope.usStatusById\n\n            if usStatusById[us.status]\n                usStatusDom.text(usStatusById[us.status].name)\n                usStatusDomParent.css(\"color\", usStatusById[us.status].color)\n\n        $el.on \"click\", \".us-status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            $el.find(\".pop-status\").popover().open()\n\n        $el.on \"click\", \".status\", debounce 2000, (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n\n            target = angular.element(event.currentTarget)\n\n            us = $scope.$eval($attrs.tgUsStatus)\n            us.status = target.data(\"status-id\")\n            render(us)\n\n            $el.find(\".pop-status\").popover().close()\n\n            $scope.$apply () ->\n                $repo.save(us).then ->\n                    $scope.$eval($attrs.onUpdate)\n\n\n        $scope.$on(\"userstories:loaded\", -> render($scope.$eval($attrs.tgUsStatus)))\n        $scope.$on(\"$destroy\", -> $el.off())\n\n        # Bootstrap\n        us = $scope.$eval($attrs.tgUsStatus)\n        render(us)\n\n        bindOnce $scope, \"project\", (project) ->\n            html = template({\"statuses\": project.us_statuses})\n            $el.append(html)\n\n            # If the user has not enough permissions the click events are unbinded\n            if $scope.project.my_permissions.indexOf(\"modify_us\") == -1\n                $el.unbind(\"click\")\n                $el.find(\"a\").addClass(\"not-clickable\")\n\n\n    return {link: link}\n\nmodule.directive(\"tgUsStatus\", [\"$tgRepo\", \"$tgTemplate\", UsStatusDirective])\n\n#############################################################################\n## Related Task Status Directive\n#############################################################################\n\nRelatedTaskStatusDirective = ($repo, $template) ->\n    ###\n    Print the status of a related task and a popover to change it.\n    - tg-related-task-status: The related task\n    - on-update: Method call after US is updated\n\n    Example:\n\n      div.status(tg-related-task-status=\"task\" on-update=\"ctrl.loadSprintState()\")\n        a.task-status(href=\"\", title=\"Status Name\")\n\n    NOTE: This directive need 'taskStatusById' and 'project'.\n    ###\n    selectionTemplate = $template.get(\"common/popover/popover-related-task-status.html\", true)\n\n    updateTaskStatus = ($el, task, taskStatusById) ->\n        taskStatusDomParent = $el.find(\".us-status\")\n        taskStatusDom = $el.find(\".task-status .task-status-bind\")\n\n        if taskStatusById[task.status]\n            taskStatusDom.text(taskStatusById[task.status].name)\n            taskStatusDomParent.css('color', taskStatusById[task.status].color)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        task = $scope.$eval($attrs.tgRelatedTaskStatus)\n        notAutoSave = $scope.$eval($attrs.notAutoSave)\n        autoSave = !notAutoSave\n\n        $el.on \"click\", \".task-status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n\n            $el.find(\".pop-status\").popover().open()\n\n            # pop = $el.find(\".pop-status\")\n            # popoverService.open(pop)\n\n        $el.on \"click\", \".status\", debounce 2000, (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            target = angular.element(event.currentTarget)\n            task.status = target.data(\"status-id\")\n            $el.find(\".pop-status\").popover().close()\n            updateTaskStatus($el, task, $scope.taskStatusById)\n\n            if autoSave\n                $scope.$apply () ->\n                    $repo.save(task).then ->\n                        $scope.$eval($attrs.onUpdate)\n                        $scope.$emit(\"related-tasks:status-changed\")\n\n        taiga.bindOnce $scope, \"project\", (project) ->\n            $el.append(selectionTemplate({ 'statuses':  project.task_statuses }))\n            updateTaskStatus($el, task, $scope.taskStatusById)\n\n            # If the user has not enough permissions the click events are unbinded\n            if project.my_permissions.indexOf(\"modify_task\") == -1\n                $el.unbind(\"click\")\n                $el.find(\"a\").addClass(\"not-clickable\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgRelatedTaskStatus\", [\"$tgRepo\", \"$tgTemplate\", RelatedTaskStatusDirective])\n\n#############################################################################\n## jQuery plugin for Popover\n#############################################################################\n\n$.fn.popover = () ->\n    $el = @\n\n    isVisible = () =>\n        $el.css({\n            \"display\": \"block\",\n            \"visibility\": \"hidden\"\n        })\n\n        docViewTop = $(window).scrollTop()\n        docViewBottom = docViewTop + $(window).height()\n\n        docViewWidth = $(window).width()\n        docViewRight = docViewWidth\n        docViewLeft = 0\n\n        elemTop = $el.offset().top\n        elemBottom = elemTop + $el.height()\n\n        elemWidth = $el.width()\n        elemLeft = $el.offset().left\n        elemRight = $el.offset().left + elemWidth\n\n        $el.css({\n            \"display\": \"none\",\n            \"visibility\": \"visible\"\n        })\n\n        return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop) && (elemLeft >= docViewLeft) && (elemRight <= docViewRight))\n\n    closePopover = (onClose) =>\n        if onClose then onClose.call($el)\n\n        $el.fadeOut () =>\n            $el\n                .removeClass(\"active\")\n                .removeClass(\"fix\")\n\n        $el.off(\"popup:close\")\n\n\n    closeAll = () =>\n        $(\".popover.active\").each () ->\n            $(this).trigger(\"popup:close\")\n\n    open = (onClose) =>\n        if $el.hasClass(\"active\")\n            close()\n        else\n            closeAll()\n\n            if !isVisible()\n                $el.addClass(\"fix\")\n\n            $el.fadeIn () =>\n                $el.addClass(\"active\")\n                $(document.body).off(\"popover\")\n\n                $(document.body).one \"click.popover\", () =>\n                    closeAll()\n\n            $el.on \"popup:close\", (e) => closePopover(onClose)\n\n    close = () =>\n        $el.trigger(\"popup:close\")\n\n    return {open: open, close: close, closeAll: closeAll}\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/raven-logger.coffee\n###\n\n\ntaiga = @.taiga\n\nmodule = angular.module(\"taigaCommon\")\n\nExceptionHandlerFactory = ($log, @config) ->\n    ravenConfig = @config.get(\"ravenConfig\", null)\n    if ravenConfig\n      $log.debug \"Using the RavenJS exception handler.\"\n      Raven.config(ravenConfig).install()\n      return (exception, cause) ->\n        $log.error.apply($log, arguments)\n        Raven.captureException(exception)\n\n    else\n      $log.debug \"Using the default logging exception handler.\"\n      return (exception, cause) ->\n          $log.error.apply($log, arguments)\n\nmodule.factory(\"$exceptionHandler\", [\"$log\", \"$tgConfig\", ExceptionHandlerFactory])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/tags.coffee\n###\n\ntaiga = @.taiga\ntrim = @.taiga.trim\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaCommon\")\n\n# Directive that parses/format tags inputfield.\n\nTagsDirective = ->\n    formatter = (v) ->\n        if _.isArray(v)\n            return v.join(\", \")\n        return \"\"\n\n    parser = (v) ->\n        return [] if not v\n        result = _(v.split(\",\")).map((x) -> _.str.trim(x))\n\n        return result.value()\n\n    link = ($scope, $el, $attrs, $ctrl) ->\n        $ctrl.$formatters.push(formatter)\n        $ctrl.$parsers.push(parser)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        require: \"ngModel\"\n        link: link\n    }\n\nmodule.directive(\"tgTags\", TagsDirective)\n\n\nColorizeTagsDirective = ->\n    templates = {\n        backlog: _.template(\"\"\"\n        <% _.each(tags, function(tag) { %>\n            <span class=\"tag\" style=\"border-left: 5px solid <%- tag.color %>\"><%- tag.name %></span>\n        <% }) %>\n        \"\"\")\n        kanban: _.template(\"\"\"\n        <% _.each(tags, function(tag) { %>\n            <a class=\"kanban-tag\" href=\"\" style=\"border-color: <%- tag.color %>\" title=\"<%- tag.name %>\" />\n        <% }) %>\n        \"\"\")\n        taskboard: _.template(\"\"\"\n        <% _.each(tags, function(tag) { %>\n            <a class=\"taskboard-tag\" href=\"\" style=\"border-color: <%- tag.color %>\" title=\"<%- tag.name %>\" />\n        <% }) %>\n        \"\"\")\n    }\n\n    link = ($scope, $el, $attrs, $ctrl) ->\n        render = (srcTags) ->\n            template = templates[$attrs.tgColorizeTagsType]\n            srcTags.sort()\n            tags = _.map srcTags, (tag) ->\n                color = $scope.project.tags_colors[tag]\n                return {name: tag, color: color}\n\n            html = template({tags: tags})\n            $el.html(html)\n\n        $scope.$watch $attrs.tgColorizeTags, (tags) ->\n            render(tags) if tags?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgColorizeTags\", ColorizeTagsDirective)\n\n\n#############################################################################\n## TagLine  Directive (for Lightboxes)\n#############################################################################\n\nLbTagLineDirective = ($rs, $template, $compile) ->\n    ENTER_KEY = 13\n    COMMA_KEY = 188\n\n    templateTags = $template.get(\"common/tag/lb-tag-line-tags.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        ## Render\n        renderTags = (tags, tagsColors) ->\n            ctx = {\n                tags: _.map(tags, (t) -> {name: t, color: tagsColors[t]})\n            }\n\n            _.map ctx.tags, (tag) =>\n                if tag.color\n                    tag.style = \"border-left: 5px solid #{tag.color}\"\n\n            html = $compile(templateTags(ctx))($scope)\n            $el.find(\"div.tags-container\").html(html)\n\n        showSaveButton = -> $el.find(\".save\").removeClass(\"hidden\")\n        hideSaveButton = -> $el.find(\".save\").addClass(\"hidden\")\n\n        resetInput = ->\n            $el.find(\"input\").val(\"\")\n            $el.find(\"input\").autocomplete(\"close\")\n\n        ## Aux methods\n        addValue = (value) ->\n            value = trim(value.toLowerCase())\n            return if value.length == 0\n\n            tags = _.clone($model.$modelValue, false)\n            tags = [] if not tags?\n            tags.push(value) if value not in tags\n\n            $scope.$apply ->\n                $model.$setViewValue(tags)\n\n            hideSaveButton()\n\n        deleteValue = (value) ->\n            value = trim(value.toLowerCase())\n            return if value.length == 0\n\n            tags = _.clone($model.$modelValue, false)\n            tags = _.pull(tags, value)\n\n            $scope.$apply ->\n                $model.$setViewValue(tags)\n\n        saveInputTag = () ->\n            value = $el.find(\"input\").val()\n\n            addValue(value)\n            resetInput()\n\n        removeInputLastCharacter = (input) =>\n            inputValue = input.val()\n            input.val inputValue.substring(0, inputValue.length - 1)\n\n        ## Events\n        $el.on \"keypress\", \"input\", (event) ->\n            return if event.keyCode != ENTER_KEY\n            event.preventDefault()\n\n        $el.on \"keyup\", \"input\", (event) ->\n            target = angular.element(event.currentTarget)\n\n            if event.keyCode == ENTER_KEY\n                saveInputTag()\n            else if event.keyCode == COMMA_KEY\n                removeInputLastCharacter(target)\n                saveInputTag()\n            else\n                if target.val().length\n                    showSaveButton()\n                else\n                    hideSaveButton()\n\n        $el.on \"click\", \".save\", (event) ->\n            event.preventDefault()\n            saveInputTag()\n\n        $el.on \"click\", \".icon-delete\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            value = target.siblings(\".tag-name\").text()\n            deleteValue(value)\n\n        bindOnce $scope, \"project\", (project) ->\n            positioningFunction = (position, elements) ->\n                menu = elements.element.element\n                menu.css(\"width\", elements.target.width)\n                menu.css(\"top\", position.top)\n                menu.css(\"left\", position.left)\n\n            $el.find(\"input\").autocomplete({\n                source: _.keys(project.tags_colors)\n                position: {\n                    my: \"left top\",\n                    using: positioningFunction\n                }\n                select: (event, ui) ->\n                    addValue(ui.item.value)\n                    ui.item.value = \"\"\n            })\n\n        $scope.$watch $attrs.ngModel, (tags) ->\n            tagsColors = $scope.project?.tags_colors or []\n            renderTags(tags, tagsColors)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link:link,\n        require:\"ngModel\"\n        templateUrl: \"common/tag/lb-tag-line.html\"\n    }\n\nmodule.directive(\"tgLbTagLine\", [\"$tgResources\", \"$tgTemplate\", \"$compile\", LbTagLineDirective])\n\n\n#############################################################################\n## TagLine  Directive (for detail pages)\n#############################################################################\n\nTagLineDirective = ($rootScope, $repo, $rs, $confirm, $qqueue, $template, $compile) ->\n    ENTER_KEY = 13\n    ESC_KEY = 27\n    COMMA_KEY = 188\n\n    templateTags = $template.get(\"common/tag/tags-line-tags.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            if $attrs.requiredPerm?\n                return $scope.project.my_permissions.indexOf($attrs.requiredPerm) != -1\n\n            return true\n\n        ## Render\n        renderTags = (tags, tagsColors) ->\n            ctx = {\n                tags: _.map(tags, (t) -> {name: t, color: tagsColors[t]})\n                isEditable: isEditable()\n            }\n            html = $compile(templateTags(ctx))($scope)\n            $el.find(\"div.tags-container\").html(html)\n\n        renderInReadModeOnly = ->\n            $el.find(\".add-tag\").remove()\n            $el.find(\"input\").remove()\n            $el.find(\".save\").remove()\n\n        showAddTagButton = -> $el.find(\".add-tag\").removeClass(\"hidden\")\n        hideAddTagButton = -> $el.find(\".add-tag\").addClass(\"hidden\")\n\n        showAddTagButtonText = -> $el.find(\".add-tag-text\").removeClass(\"hidden\")\n        hideAddTagButtonText = -> $el.find(\".add-tag-text\").addClass(\"hidden\")\n\n        showSaveButton = -> $el.find(\".save\").removeClass(\"hidden\")\n        hideSaveButton = -> $el.find(\".save\").addClass(\"hidden\")\n\n        showInput = -> $el.find(\"input\").removeClass(\"hidden\").focus()\n        hideInput = -> $el.find(\"input\").addClass(\"hidden\").blur()\n        resetInput = ->\n            $el.find(\"input\").val(\"\")\n            $el.find(\"input\").autocomplete(\"close\")\n\n        ## Aux methods\n        addValue = $qqueue.bindAdd (value) ->\n            value = trim(value.toLowerCase())\n            return if value.length == 0\n\n            tags = _.clone($model.$modelValue.tags, false)\n            tags = [] if not tags?\n            tags.push(value) if value not in tags\n\n            model = $model.$modelValue.clone()\n            model.tags = tags\n            $model.$setViewValue(model)\n\n            onSuccess = ->\n                $rootScope.$broadcast(\"object:updated\")\n            onError = ->\n                $confirm.notify(\"error\")\n                model.revert()\n                $model.$setViewValue(model)\n            $repo.save(model).then(onSuccess, onError)\n\n            hideSaveButton()\n\n        deleteValue = $qqueue.bindAdd (value) ->\n            value = trim(value.toLowerCase())\n            return if value.length == 0\n\n            tags = _.clone($model.$modelValue.tags, false)\n            tags = _.pull(tags, value)\n\n            model = $model.$modelValue.clone()\n            model.tags = tags\n            $model.$setViewValue(model)\n\n            onSuccess = ->\n                $rootScope.$broadcast(\"object:updated\")\n            onError = ->\n                $confirm.notify(\"error\")\n                model.revert()\n                $model.$setViewValue(model)\n\n            return $repo.save(model).then(onSuccess, onError)\n\n        saveInputTag = () ->\n            value = $el.find(\"input\").val()\n\n            addValue(value)\n            resetInput()\n\n        removeInputLastCharacter = (input) =>\n            inputValue = input.val()\n            input.val inputValue.substring(0, inputValue.length - 1)\n\n        ## Events\n        $el.on \"keypress\", \"input\", (event) ->\n            return if event.keyCode not in [ENTER_KEY, ESC_KEY]\n            event.preventDefault()\n\n        $el.on \"keyup\", \"input\", (event) ->\n            target = angular.element(event.currentTarget)\n\n            if event.keyCode == ENTER_KEY\n                saveInputTag()\n            else if event.keyCode == COMMA_KEY\n                removeInputLastCharacter(target)\n                saveInputTag()\n            else if event.keyCode == ESC_KEY\n                resetInput()\n                hideInput()\n                hideSaveButton()\n                showAddTagButton()\n            else\n                if target.val().length\n                    showSaveButton()\n                else\n                    hideSaveButton()\n\n        $el.on \"click\", \".save\", (event) ->\n            event.preventDefault()\n            saveInputTag()\n\n        $el.on \"click\", \".add-tag\", (event) ->\n            event.preventDefault()\n            hideAddTagButton()\n            showInput()\n\n        $el.on \"click\", \".icon-delete\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            value = target.siblings(\".tag-name\").text()\n\n            deleteValue(value)\n\n        bindOnce $scope, \"project.tags_colors\", (tags_colors) ->\n            if not isEditable()\n                renderInReadModeOnly()\n                return\n\n            showAddTagButton()\n\n            positioningFunction = (position, elements) ->\n                menu = elements.element.element\n                menu.css(\"width\", elements.target.width)\n                menu.css(\"top\", position.top)\n                menu.css(\"left\", position.left)\n\n            $el.find(\"input\").autocomplete({\n                source: _.keys(tags_colors)\n                position: {\n                    my: \"left top\",\n                    using: positioningFunction\n                }\n                select: (event, ui) ->\n                    addValue(ui.item.value)\n                    ui.item.value = \"\"\n            })\n\n        $scope.$watch $attrs.ngModel, (model) ->\n            return if not model\n\n            if model.tags?.length\n                hideAddTagButtonText()\n            else\n                showAddTagButtonText()\n\n            tagsColors = $scope.project?.tags_colors or []\n            renderTags(model.tags, tagsColors)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link:link,\n        require:\"ngModel\"\n        templateUrl: \"common/tag/tag-line.html\"\n    }\n\nmodule.directive(\"tgTagLine\", [\"$rootScope\", \"$tgRepo\", \"$tgResources\", \"$tgConfirm\", \"$tgQqueue\",\n                               \"$tgTemplate\", \"$compile\", TagLineDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/wisiwyg.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaCommon\")\n\n# How to test lists (-, *, 1.)\n# test it with text after & before the list\n# + is the cursor position\n\n# CASE 1\n# - aa+\n# --> enter\n# - aa\n# - +\n\n# CASE 1\n# - +\n# --> enter\n\n# +\n\n# CASE 3\n# - bb+cc\n# --> enter\n# - bb\n# - cc\n\n# CASE 3\n# +- aa\n# --> enter\n\n# - aa\n\n#############################################################################\n## WYSIWYG markitup editor directive\n#############################################################################\nMarkitupDirective = ($rootscope, $rs, $selectedText, $template, $compile, $translate) ->\n    previewTemplate = $template.get(\"common/wysiwyg/wysiwyg-markitup-preview.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        element = angular.element($el)\n        previewDomNode = $(\"<div/>\", {class: \"preview\"})\n\n        closePreviewMode = ->\n            element.parents(\".markdown\").find(\".preview\").remove()\n            element.parents(\".markItUp\").show()\n\n        $scope.$on \"markdown-editor:submit\", ->\n            closePreviewMode()\n\n        preview = ->\n            markdownDomNode = element.parents(\".markdown\")\n            markItUpDomNode = element.parents(\".markItUp\")\n            $rs.mdrender.render($scope.projectId, $model.$modelValue).then (data) ->\n                html = previewTemplate({data: data.data})\n                html = $compile(html)($scope)\n\n                markdownDomNode.append(html)\n                markItUpDomNode.hide()\n\n                markdown = element.closest(\".markdown\")\n\n                markdown.on \"mouseup.preview\", \".preview\", (event) ->\n                    event.preventDefault()\n                    target = angular.element(event.target)\n\n                    if !target.is('a') and $selectedText.get().length\n                        return\n\n                    markdown.off(\".preview\")\n                    closePreviewMode()\n\n        setCaretPosition = (textarea, caretPosition) ->\n            if textarea.createTextRange\n                range = textarea.createTextRange()\n                range.move(\"character\", caretPosition)\n                range.select()\n\n            else if textarea.selectionStart\n                textarea.focus()\n                textarea.setSelectionRange(caretPosition, caretPosition)\n\n            # Calculate the scroll position\n            totalLines = textarea.value.split(\"\\n\").length\n            line = textarea.value[0..(caretPosition - 1)].split(\"\\n\").length\n            scrollRelation = line / totalLines\n            $el.scrollTop((scrollRelation * $el[0].scrollHeight) - ($el.height() / 2))\n\n        addLine = (textarea, nline, replace) ->\n            lines = textarea.value.split(\"\\n\")\n\n            if replace\n                lines[nline] = replace + lines[nline]\n            else\n                lines[nline] = \"\"\n\n            cursorPosition = 0\n\n            for line, key in lines\n                cursorPosition += line.length + 1 || 1\n\n                break if key == nline\n\n            textarea.value = lines.join(\"\\n\")\n\n            #return the new position\n            if replace\n                return cursorPosition - lines[nline].length + replace.length - 1\n            else\n                return cursorPosition\n\n        prepareUrlFormatting = (markItUp) ->\n            regex = /(<<<|>>>)/gi\n            result = 0\n            indices = []\n            (indices.push(result.index)) while ( (result = regex.exec(markItUp.textarea.value)) )\n            markItUp.donotparse = indices\n\n        urlFormatting = (markItUp) ->\n            regex = /<<</gi\n            result = 0\n            startIndex = 0\n\n            loop\n                result = regex.exec(markItUp.textarea.value)\n                break if !result\n                if result.index not in markItUp.donotparse\n                    startIndex = result.index\n                    break\n\n            return if !result\n\n            regex = />>>/gi\n            endIndex = 0\n            loop\n                result = regex.exec(markItUp.textarea.value)\n                break if !result\n                if result.index not in markItUp.donotparse\n                    endIndex = result.index\n                    break\n\n            value = markItUp.textarea.value\n            url = value.substring(startIndex, endIndex).replace('<<<', '').replace('>>>', '')\n            url = url.replace('(', '%28').replace(')', '%29')\n            url = url.replace('[', '%5B').replace(']', '%5D')\n            value = value.substring(0, startIndex) + url + value.substring(endIndex+3, value.length)\n            markItUp.textarea.value = value\n            markItUp.donotparse = undefined\n\n        markdownTitle = (markItUp, char) ->\n            heading = \"\"\n            n = $.trim(markItUp.selection or markItUp.placeHolder).length\n\n            for i in [0..n-1]\n                heading += char\n\n            return \"\\n\"+heading+\"\\n\"\n\n        renderMarkItUp = () ->\n            markdownSettings =\n                nameSpace: \"markdown\"\n                onShiftEnter: {keepDefault:false, openWith:\"\\n\\n\"}\n                onEnter:\n                    keepDefault: false,\n                    replaceWith: () ->\n                        # Allow textcomplete to intercept the enter key if the options list is displayed\n                        # @todo There doesn't seem to be a more graceful way to do this with the textcomplete API.\n                        if not $('.textcomplete-dropdown').is(':visible')\n                            \"\\n\"\n                    afterInsert: (data) ->\n                        lines = data.textarea.value.split(\"\\n\")\n                        # Detect if we are in this situation +- aa at the beginning if the textarea\n                        if data.caretPosition > 0\n                            cursorLine = data.textarea.value[0..(data.caretPosition - 1)].split(\"\\n\").length\n                        else\n                            cursorLine = 1\n\n                        newLineContent = data.textarea.value[data.caretPosition..].split(\"\\n\")[0]\n                        lastLine = lines[cursorLine - 1]\n\n                        # unordered list -\n                        match = lastLine.match /^(\\s*- ).*/\n\n                        if match\n                            emptyListItem = lastLine.match /^(\\s*)\\-\\s$/\n\n                            if emptyListItem\n                                nline = cursorLine - 1\n                                replace = null\n                            else\n                                nline = cursorLine\n                                replace = \"#{match[1]}\"\n\n                            markdownCaretPositon = addLine(data.textarea, nline, replace)\n\n                        # unordered list *\n                        match = lastLine.match /^(\\s*\\* ).*/\n\n                        if match\n                            emptyListItem = lastLine.match /^(\\s*\\* )$/\n\n                            if emptyListItem\n                                nline = cursorLine - 1\n                                replace = null\n                            else\n                                nline = cursorLine\n                                replace = \"#{match[1]}\"\n\n                            markdownCaretPositon = addLine(data.textarea, nline, replace)\n\n                        # ordered list\n                        match = lastLine.match /^(\\s*)(\\d+)\\.\\s/\n\n                        if match\n                            emptyListItem = lastLine.match /^(\\s*)(\\d+)\\.\\s$/\n\n                            if emptyListItem\n                                nline = cursorLine - 1\n                                replace = null\n                            else\n                                nline = cursorLine\n                                replace = \"#{match[1] + (parseInt(match[2], 10) + 1)}. \"\n\n                            markdownCaretPositon = addLine(data.textarea, nline, replace)\n\n                        setCaretPosition(data.textarea, markdownCaretPositon) if markdownCaretPositon\n\n                markupSet: [\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.H1_BUTTON\")\n                        key: \"1\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.H1_SAMPLE_TEXT\")\n                        closeWith: (markItUp) -> markdownTitle(markItUp, \"=\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.H2_BUTTON\")\n                        key: \"2\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.H2_SAMPLE_TEXT\")\n                        closeWith: (markItUp) -> markdownTitle(markItUp, \"-\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.H3_BUTTON\")\n                        key: \"3\"\n                        openWith: \"### \"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.H3_SAMPLE_TEXT\")\n                    },\n                    {\n                        separator: \"---------------\"\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.BOLD_BUTTON\")\n                        key: \"B\"\n                        openWith: \"**\"\n                        closeWith: \"**\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.BOLD_BUTTON_SAMPLE_TEXT\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.ITALIC_SAMPLE_TEXT\")\n                        key: \"I\"\n                        openWith: \"_\"\n                        closeWith: \"_\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.ITALIC_SAMPLE_TEXT\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.STRIKE_BUTTON\")\n                        key: \"S\"\n                        openWith: \"~~\"\n                        closeWith: \"~~\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.STRIKE_SAMPLE_TEXT\")\n                    },\n                    {\n                        separator: \"---------------\"\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.BULLETED_LIST_BUTTON\")\n                        openWith: \"- \"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.BULLETED_LIST_SAMPLE_TEXT\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.NUMERIC_LIST_BUTTON\")\n                        openWith: (markItUp) -> markItUp.line+\". \"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.NUMERIC_LIST_SAMPLE_TEXT\")\n                    },\n                    {\n                        separator: \"---------------\"\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.PICTURE_BUTTON\")\n                        key: \"P\"\n                        openWith: \"![\"\n                        closeWith: '](<<<[![Url:!:http://]!]>>> \"[![Title]!]\")'\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.PICTURE_SAMPLE_TEXT\")\n                        beforeInsert:(markItUp) -> prepareUrlFormatting(markItUp)\n                        afterInsert:(markItUp) -> urlFormatting(markItUp)\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.LINK_BUTTON\")\n                        key: \"L\"\n                        openWith: \"[\"\n                        closeWith: '](<<<[![Url:!:http://]!]>>> \"[![Title]!]\")'\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.LINK_SAMPLE_TEXT\")\n                        beforeInsert:(markItUp) -> prepareUrlFormatting(markItUp)\n                        afterInsert:(markItUp) -> urlFormatting(markItUp)\n                    },\n                    {\n                        separator: \"---------------\"\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.QUOTE_BLOCK_BUTTON\")\n                        openWith: \"> \"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.QUOTE_BLOCK_SAMPLE_TEXT\")\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.CODE_BLOCK_BUTTON\")\n                        openWith: \"```\\n\"\n                        placeHolder: $translate.instant(\"COMMON.WYSIWYG.CODE_BLOCK_SAMPLE_TEXT\")\n                        closeWith: \"\\n```\"\n                    },\n                    {\n                        separator: \"---------------\"\n                    },\n                    {\n                        name: $translate.instant(\"COMMON.WYSIWYG.PREVIEW_BUTTON\")\n                        call: preview\n                        className: \"preview-icon\"\n                    },\n                ]\n                afterInsert: (event) ->\n                    target = angular.element(event.textarea)\n                    $model.$setViewValue(target.val())\n\n            element\n                .markItUpRemove()\n                .markItUp(markdownSettings)\n                .textcomplete([\n                    # us, task, and issue autocomplete: #id or #<part of title>\n                    {\n                        cache: true\n                        match: /(^|\\s)#([a-z0-9]+)$/i,\n                        search: (term, callback) ->\n                            term = taiga.slugify(term)\n\n                            searchTypes = ['issues', 'tasks', 'userstories']\n                            searchProps = ['ref', 'subject']\n\n                            filter = (item) =>\n                                for prop in searchProps\n                                    if taiga.slugify(item[prop]).indexOf(term) >= 0\n                                        return true\n                                return false\n\n                            $rs.search.do($scope.projectId, term).then (res) =>\n                                # ignore wikipages if they're the only results. can't exclude them in search\n                                if res.count < 1 or res.count == res.wikipages.length\n                                    callback([])\n\n                                else\n                                    for type in searchTypes\n                                        if res[type] and res[type].length > 0\n                                            callback(res[type].filter(filter), true)\n\n                            # must signal end of lists\n                            callback([])\n\n                        replace: (res) ->\n                            return \"$1\\##{res.ref} \"\n\n                        template: (res, term) ->\n                            return \"\\##{res.ref} - #{res.subject}\"\n                    }\n\n                    # username autocomplete: @username or @<part of name>\n                    {\n                        cache: true\n                        match: /(^|\\s)@([a-z0-9\\-\\._]{2,})$/i\n                        search: (term, callback) ->\n                            username = taiga.slugify(term)\n                            searchProps = ['username', 'full_name', 'full_name_display']\n\n                            if $scope.project.members.length < 1\n                                callback([])\n\n                            else\n                                callback $scope.project.members.filter (user) =>\n                                    for prop in searchProps\n                                        if taiga.slugify(user[prop]).indexOf(username) >= 0\n                                            return true\n                                    return false\n\n                        replace: (user) ->\n                            return \"$1@#{user.username} \"\n\n                        template: (user) ->\n                            return \"#{user.username} - #{user.full_name_display}\"\n                    }\n\n                    # wiki pages autocomplete: [[slug or [[<part of slug>\n                    # if the search function was called with the 3rd param the regex\n                    # like the docs claim, we could combine this with the #123 search\n                    {\n                        cache: true\n                        match: /(^|\\s)\\[\\[([a-z0-9\\-]+)$/i\n                        search: (term, callback) ->\n                            term = taiga.slugify(term)\n\n                            $rs.search.do($scope.projectId, term).then (res) =>\n                                if res.count < 1\n                                    callback([])\n\n                                if res.count < 1 or not res.wikipages or res.wikipages.length <= 0\n                                    callback([])\n\n                                else\n                                    callback res.wikipages.filter((page) =>\n                                        return taiga.slugify(page['slug']).indexOf(term) >= 0\n                                    ), true\n\n                                # must signal end of lists\n                                callback([])\n\n\n                        replace: (res) ->\n                            return \"$1[[#{res.slug}]]\"\n\n                        template: (res, term) ->\n                            return res.slug\n                    }\n                ],\n                {\n                    debounce: 200\n                }\n            )\n\n        renderMarkItUp()\n\n        unbind = $rootscope.$on \"$translateChangeEnd\", renderMarkItUp\n\n        element.on \"keypress\", (event) ->\n            $scope.$apply()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n            unbind()\n\n    return {link:link, require:\"ngModel\"}\n\nmodule.directive(\"tgMarkitup\", [\"$rootScope\", \"$tgResources\", \"$selectedText\", \"$tgTemplate\", \"$compile\",\n                                \"$translate\", MarkitupDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog/main.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\ndebounceLeading = @.taiga.debounceLeading\n\n\nmodule = angular.module(\"taigaBacklog\")\n\n#############################################################################\n## Issues Filters Directive\n#############################################################################\n\nBacklogFiltersDirective = ($q, $log, $location, $templates) ->\n    template = $templates.get(\"backlog/filters.html\", true)\n    templateSelected = $templates.get(\"backlog/filter-selected.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        currentFiltersType = ''\n\n        $ctrl = $el.closest(\".wrapper\").controller()\n        selectedFilters = []\n\n        showFilters = (title, type) ->\n            $el.find(\".filters-cats\").hide()\n            $el.find(\".filter-list\").removeClass(\"hidden\")\n            $el.find(\"h2.breadcrumb\").removeClass(\"hidden\")\n            $el.find(\"h2 a.subfilter span.title\").html(title)\n            $el.find(\"h2 a.subfilter span.title\").prop(\"data-type\", type)\n\n            currentFiltersType = getFiltersType()\n\n        showCategories = ->\n            $el.find(\".filters-cats\").show()\n            $el.find(\".filter-list\").addClass(\"hidden\")\n            $el.find(\"h2.breadcrumb\").addClass(\"hidden\")\n\n        initializeSelectedFilters = () ->\n            showCategories()\n            selectedFilters = []\n\n            for name, values of $scope.filters\n                for val in values\n                    selectedFilters.push(val) if val.selected\n\n            renderSelectedFilters()\n\n        renderSelectedFilters = ->\n            _.map selectedFilters, (f) =>\n                if f.color\n                    f.style = \"border-left: 3px solid #{f.color}\"\n\n            html = templateSelected({filters: selectedFilters})\n            $el.find(\".filters-applied\").html(html)\n\n        renderFilters = (filters) ->\n            _.map filters, (f) =>\n                if f.color\n                    f.style = \"border-left: 3px solid #{f.color}\"\n\n            html = template({filters:filters})\n            $el.find(\".filter-list\").html(html)\n\n        getFiltersType = () ->\n            return $el.find(\"h2 a.subfilter span.title\").prop('data-type')\n\n        reloadUserstories = () ->\n            currentFiltersType = getFiltersType()\n\n            $q.all([$ctrl.loadUserstories(), $ctrl.generateFilters()]).then () ->\n                currentFilters = $scope.filters[currentFiltersType]\n                renderFilters(_.reject(currentFilters, \"selected\"))\n\n        toggleFilterSelection = (type, id) ->\n            currentFiltersType = getFiltersType()\n\n            filters = $scope.filters[type]\n            filter = _.find(filters, {id: id})\n            filter.selected = (not filter.selected)\n\n            if filter.selected\n                selectedFilters.push(filter)\n                $scope.$apply ->\n                    $ctrl.selectFilter(type, id)\n            else\n                selectedFilters = _.reject selectedFilters, (selected) ->\n                    return filter.type == selected.type &&  filter.id == selected.id\n\n                $ctrl.unselectFilter(type, id)\n\n            renderSelectedFilters(selectedFilters)\n\n            if type == currentFiltersType\n                renderFilters(_.reject(filters, \"selected\"))\n\n            reloadUserstories()\n\n        selectQFilter = debounceLeading 100, (value) ->\n            return if value is undefined\n\n            if value.length == 0\n                $ctrl.replaceFilter(\"q\", null)\n            else\n                $ctrl.replaceFilter(\"q\", value)\n\n            reloadUserstories()\n\n        $scope.$watch(\"filtersQ\", selectQFilter)\n\n        ## Angular Watchers\n        $scope.$on \"backlog:loaded\", (ctx) ->\n            initializeSelectedFilters()\n\n        $scope.$on \"filters:update\", (ctx) ->\n            $ctrl.generateFilters().then () ->\n                filters = $scope.filters[currentFiltersType]\n\n                if currentFiltersType\n                    renderFilters(_.reject(filters, \"selected\"))\n\n        ## Dom Event Handlers\n        $el.on \"click\", \".filters-cats > ul > li > a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            tags = $scope.filters[target.data(\"type\")]\n\n            renderFilters(_.reject(tags, \"selected\"))\n            showFilters(target.attr(\"title\"), target.data('type'))\n\n        $el.on \"click\", \".filters-inner > .filters-step-cat > .breadcrumb > .back\", (event) ->\n            event.preventDefault()\n            showCategories()\n\n        $el.on \"click\", \".filters-applied a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            id = target.data(\"id\")\n            type = target.data(\"type\")\n            toggleFilterSelection(type, id)\n\n        $el.on \"click\", \".filter-list .single-filter\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            if target.hasClass(\"active\")\n                target.removeClass(\"active\")\n            else\n                target.addClass(\"active\")\n\n            id = target.data(\"id\")\n            type = target.data(\"type\")\n            toggleFilterSelection(type, id)\n\n    return {link:link}\n\nmodule.directive(\"tgBacklogFilters\", [\"$q\", \"$log\", \"$tgLocation\", \"$tgTemplate\", BacklogFiltersDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog/lightboxes.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaBacklog\")\n\n#############################################################################\n## Creare/Edit Sprint Lightbox Directive\n#############################################################################\n\nCreateEditSprint = ($repo, $confirm, $rs, $rootscope, lightboxService, $loading, $translate) ->\n    link = ($scope, $el, attrs) ->\n        hasErrors = false\n        createSprint = true\n\n        resetSprint = () ->\n            $scope.sprint = {\n                project: null\n                name: null\n                estimated_start: null\n                estimated_finish: null\n            }\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            prettyDate = $translate.instant(\"COMMON.PICKERDATE.FORMAT\")\n\n            submitButton = $el.find(\".submit-button\")\n            form = $el.find(\"form\").checksley()\n\n            if not form.validate()\n                hasErrors = true\n                $el.find(\".last-sprint-name\").addClass(\"disappear\")\n                return\n\n            hasErrors = false\n            newSprint = angular.copy($scope.sprint)\n            broadcastEvent = null\n\n            if createSprint\n                newSprint.estimated_start = moment(newSprint.estimated_start, prettyDate).format(\"YYYY-MM-DD\")\n                newSprint.estimated_finish = moment(newSprint.estimated_finish,prettyDate).format(\"YYYY-MM-DD\")\n                promise = $repo.create(\"milestones\", newSprint)\n                broadcastEvent = \"sprintform:create:success\"\n            else\n                newSprint.setAttr(\"estimated_start\",\n                                  moment(newSprint.estimated_start, prettyDate).format(\"YYYY-MM-DD\"))\n                newSprint.setAttr(\"estimated_finish\",\n                                  moment(newSprint.estimated_finish, prettyDate).format(\"YYYY-MM-DD\"))\n                promise = $repo.save(newSprint)\n                broadcastEvent = \"sprintform:edit:success\"\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise.then (data) ->\n                currentLoading.finish()\n                $scope.sprintsCounter += 1 if createSprint\n                $rootscope.$broadcast(broadcastEvent, data)\n\n                lightboxService.close($el)\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"light-error\", data._error_message)\n                else if data.__all__\n                    $confirm.notify(\"light-error\", data.__all__[0])\n\n        remove = ->\n            title = $translate.instant(\"LIGHTBOX.DELETE_SPRINT.TITLE\")\n            message = $scope.sprint.name\n\n            $confirm.askOnDelete(title, message).then (askResponse) =>\n                onSuccess = ->\n                    askResponse.finish()\n                    $scope.milestonesCounter -= 1\n                    lightboxService.close($el)\n                    $rootscope.$broadcast(\"sprintform:remove:success\", $scope.sprint)\n\n                onError = ->\n                    askResponse.finish(false)\n                    $confirm.notify(\"error\")\n                $repo.remove($scope.sprint).then(onSuccess, onError)\n\n        getLastSprint = ->\n            openSprints = _.filter $scope.sprints, (sprint) ->\n                return !sprint.closed\n\n            sortedSprints = _.sortBy openSprints, (sprint) ->\n                return moment(sprint.estimated_finish, 'YYYY-MM-DD').format('X')\n\n            return sortedSprints[sortedSprints.length - 1]\n\n        $scope.$on \"sprintform:create\", (event, projectId) ->\n            resetSprint()\n\n            form = $el.find(\"form\").checksley()\n            form.reset()\n\n            createSprint = true\n            prettyDate = $translate.instant(\"COMMON.PICKERDATE.FORMAT\")\n            $scope.sprint.project = projectId\n            $scope.sprint.name = null\n            $scope.sprint.slug = null\n\n            lastSprint = getLastSprint()\n\n            estimatedStart = moment()\n\n            if lastSprint\n                estimatedStart = moment(lastSprint.estimated_finish)\n            else if $scope.sprint.estimated_start\n                estimatedStart = moment($scope.sprint.estimated_start)\n\n            $scope.sprint.estimated_start = estimatedStart.format(prettyDate)\n\n            estimatedFinish = moment().add(2, \"weeks\")\n\n            if lastSprint\n                estimatedFinish = moment(lastSprint.estimated_finish).add(2, \"weeks\")\n            else if $scope.sprint.estimated_finish\n                estimatedFinish = moment($scope.sprint.estimated_finish)\n\n            $scope.sprint.estimated_finish = estimatedFinish.format(prettyDate)\n\n            lastSprintNameDom = $el.find(\".last-sprint-name\")\n            if lastSprint?.name?\n                text = $translate.instant(\"LIGHTBOX.ADD_EDIT_SPRINT.LAST_SPRINT_NAME\", {\n                            lastSprint: lastSprint.name})\n                lastSprintNameDom.html(text)\n\n            $el.find(\".delete-sprint\").addClass(\"hidden\")\n\n            text = $translate.instant(\"LIGHTBOX.ADD_EDIT_SPRINT.TITLE\")\n            $el.find(\".title\").text(text)\n\n            text = $translate.instant(\"COMMON.CREATE\")\n            $el.find(\".button-green\").text(text)\n\n            lightboxService.open($el)\n            $el.find(\".sprint-name\").focus()\n            $el.find(\".last-sprint-name\").removeClass(\"disappear\")\n\n        $scope.$on \"sprintform:edit\", (ctx, sprint) ->\n            resetSprint()\n\n            createSprint = false\n            prettyDate = $translate.instant(\"COMMON.PICKERDATE.FORMAT\")\n\n            $scope.$apply ->\n                $scope.sprint = sprint\n                $scope.sprint.estimated_start = moment($scope.sprint.estimated_start).format(prettyDate)\n                $scope.sprint.estimated_finish = moment($scope.sprint.estimated_finish).format(prettyDate)\n\n            $el.find(\".delete-sprint\").removeClass(\"hidden\")\n\n            editSprint = $translate.instant(\"BACKLOG.EDIT_SPRINT\")\n            $el.find(\".title\").text(editSprint)\n\n            save = $translate.instant(\"COMMON.SAVE\")\n            $el.find(\".button-green\").text(save)\n\n            lightboxService.open($el)\n            $el.find(\".sprint-name\").focus().select()\n            $el.find(\".last-sprint-name\").addClass(\"disappear\")\n\n        $el.on \"keyup\", \".sprint-name\", (event) ->\n            if $el.find(\".sprint-name\").val().length > 0 or hasErrors\n                $el.find(\".last-sprint-name\").addClass(\"disappear\")\n            else\n                $el.find(\".last-sprint-name\").removeClass(\"disappear\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $el.on \"click\", \".delete-sprint .icon-delete\", (event) ->\n            event.preventDefault()\n            remove()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        resetSprint()\n\n    return {link: link}\n\n\nmodule.directive(\"tgLbCreateEditSprint\", [\n    \"$tgRepo\",\n    \"$tgConfirm\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"lightboxService\"\n    \"$tgLoading\",\n    \"$translate\",\n    CreateEditSprint\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog/main.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\ntimeout = @.taiga.timeout\nbindMethods = @.taiga.bindMethods\ngenerateHash = @.taiga.generateHash\n\nmodule = angular.module(\"taigaBacklog\")\n\n#############################################################################\n## Backlog Controller\n#############################################################################\n\nclass BacklogController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgEvents\",\n        \"$tgAnalytics\",\n        \"$translate\",\n        \"$tgLoading\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q,\n                  @location, @appMetaService, @navUrls, @events, @analytics, @translate, @loading) ->\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"BACKLOG.SECTION_NAME\")\n        @showTags = false\n        @activeFilters = false\n        @scope.showGraphPlaceholder = null\n\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            title = @translate.instant(\"BACKLOG.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @translate.instant(\"BACKLOG.PAGE_DESCRIPTION\", {\n                projectName: @scope.project.name,\n                projectDescription: @scope.project.description\n            })\n            @appMetaService.setAll(title, description)\n\n            if @rs.userstories.getShowTags(@scope.projectId)\n                @showTags = true\n\n                @scope.$broadcast(\"showTags\", @showTags)\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    initializeEventHandlers: ->\n        @scope.$on \"usform:bulk:success\", =>\n            @.loadUserstories()\n            @.loadProjectStats()\n            @analytics.trackEvent(\"userstory\", \"create\", \"bulk create userstory on backlog\", 1)\n\n        @scope.$on \"sprintform:create:success\", =>\n            @.loadSprints()\n            @.loadProjectStats()\n            @analytics.trackEvent(\"sprint\", \"create\", \"create sprint on backlog\", 1)\n\n        @scope.$on \"usform:new:success\", =>\n            @.loadUserstories()\n            @.loadProjectStats()\n\n            @rootscope.$broadcast(\"filters:update\")\n            @analytics.trackEvent(\"userstory\", \"create\", \"create userstory on backlog\", 1)\n\n        @scope.$on \"sprintform:edit:success\", =>\n            @.loadProjectStats()\n\n        @scope.$on \"sprintform:remove:success\", (event, sprint) =>\n            @.loadSprints()\n            @.loadProjectStats()\n            @.loadUserstories()\n\n            if sprint.closed\n                @.loadClosedSprints()\n\n            @rootscope.$broadcast(\"filters:update\")\n\n        @scope.$on \"usform:edit:success\", =>\n            @.loadUserstories()\n            @rootscope.$broadcast(\"filters:update\")\n\n        @scope.$on(\"sprint:us:move\", @.moveUs)\n        @scope.$on(\"sprint:us:moved\", @.loadSprints)\n        @scope.$on(\"sprint:us:moved\", @.loadProjectStats)\n\n        @scope.$on(\"backlog:load-closed-sprints\", @.loadClosedSprints)\n        @scope.$on(\"backlog:unload-closed-sprints\", @.unloadClosedSprints)\n\n    initializeSubscription: ->\n        routingKey1 = \"changes.project.#{@scope.projectId}.userstories\"\n        @events.subscribe @scope, routingKey1, (message) =>\n            @.loadUserstories()\n            @.loadSprints()\n\n        routingKey2 = \"changes.project.#{@scope.projectId}.milestones\"\n        @events.subscribe @scope, routingKey2, (message) =>\n            @.loadSprints()\n\n    toggleShowTags: ->\n        @scope.$apply =>\n            @showTags = !@showTags\n            @rs.userstories.storeShowTags(@scope.projectId, @showTags)\n\n    toggleActiveFilters: ->\n        @activeFilters = !@activeFilters\n\n    loadProjectStats: ->\n        return @rs.projects.stats(@scope.projectId).then (stats) =>\n            @scope.stats = stats\n            totalPoints = if stats.total_points then stats.total_points else stats.defined_points\n\n            if totalPoints\n                @scope.stats.completedPercentage = Math.round(100 * stats.closed_points / totalPoints)\n            else\n                @scope.stats.completedPercentage = 0\n\n            @scope.showGraphPlaceholder = !(stats.total_points? && stats.total_milestones?)\n            return stats\n\n    unloadClosedSprints: ->\n        @scope.$apply =>\n            @scope.closedSprints =  []\n            @rootscope.$broadcast(\"closed-sprints:reloaded\", [])\n\n    loadClosedSprints: ->\n        params = {closed: true}\n        return @rs.sprints.list(@scope.projectId, params).then (result) =>\n            sprints = result.milestones\n\n            @scope.totalClosedMilestones = result.closed\n\n            # NOTE: Fix order of USs because the filter orderBy does not work propertly in partials files\n            for sprint in sprints\n                sprint.user_stories = _.sortBy(sprint.user_stories, \"sprint_order\")\n            @scope.closedSprints =  sprints\n            @scope.closedSprintsById = groupBy(sprints, (x) -> x.id)\n            @rootscope.$broadcast(\"closed-sprints:reloaded\", sprints)\n            return sprints\n\n    loadSprints: ->\n        params = {closed: false}\n        return @rs.sprints.list(@scope.projectId, params).then (result) =>\n            sprints = result.milestones\n\n            @scope.totalMilestones = sprints\n            @scope.totalClosedMilestones = result.closed\n            @scope.totalOpenMilestones = result.open\n            @scope.totalMilestones = @scope.totalOpenMilestones + @scope.totalClosedMilestones\n\n            # NOTE: Fix order of USs because the filter orderBy does not work propertly in partials files\n            for sprint in sprints\n                sprint.user_stories = _.sortBy(sprint.user_stories, \"sprint_order\")\n\n            @scope.sprints = sprints\n            @scope.openSprints = _.filter(sprints, (sprint) => not sprint.closed).reverse()\n            @scope.closedSprints =  [] if !@scope.closedSprints\n\n            @scope.sprintsCounter = sprints.length\n            @scope.sprintsById = groupBy(sprints, (x) -> x.id)\n            @rootscope.$broadcast(\"sprints:loaded\", sprints)\n            return sprints\n\n    resetFilters: ->\n        selectedTags = _.filter(@scope.filters.tags, \"selected\")\n        selectedStatuses = _.filter(@scope.filters.status, \"selected\")\n\n        @scope.filtersQ = \"\"\n\n        _.each [selectedTags, selectedStatuses], (filterGrp) =>\n            _.each filterGrp, (item) =>\n                filters = @scope.filters[item.type]\n                filter = _.find(filters, {id: taiga.toString(item.id)})\n                filter.selected = false\n\n                @.unselectFilter(item.type, item.id)\n\n        @.loadUserstories()\n        @rootscope.$broadcast(\"filters:update\")\n\n    loadUserstories: ->\n        @scope.httpParams = @.getUrlFilters()\n        @rs.userstories.storeQueryParams(@scope.projectId, @scope.httpParams)\n\n        promise = @rs.userstories.listUnassigned(@scope.projectId, @scope.httpParams)\n\n        return promise.then (userstories) =>\n            # NOTE: Fix order of USs because the filter orderBy does not work propertly in the partials files\n            @scope.userstories = _.sortBy(userstories, \"backlog_order\")\n\n            @.setSearchDataFilters()\n\n            # The broadcast must be executed when the DOM has been fully reloaded.\n            # We can't assure when this exactly happens so we need a defer\n            scopeDefer @scope, =>\n                @scope.$broadcast(\"userstories:loaded\")\n\n            return userstories\n\n    loadBacklog: ->\n        return @q.all([\n            @.loadProjectStats(),\n            @.loadSprints(),\n            @.loadUserstories()\n        ])\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.is_backlog_activated\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.closedMilestones = !!project.total_closed_milestones\n            @scope.$emit('project:loaded', project)\n            @scope.points = _.sortBy(project.points, \"order\")\n            @scope.pointsById = groupBy(project.points, (x) -> x.id)\n            @scope.usStatusById = groupBy(project.us_statuses, (x) -> x.id)\n            @scope.usStatusList = _.sortBy(project.us_statuses, \"id\")\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.initializeSubscription()\n\n        return promise\n            .then(=> @.loadBacklog())\n            .then(=> @.generateFilters())\n            .then(=> @scope.$emit(\"backlog:loaded\"))\n\n    prepareBulkUpdateData: (uses, field=\"backlog_order\") ->\n         return _.map(uses, (x) -> {\"us_id\": x.id, \"order\": x[field]})\n\n    resortUserStories: (uses, field=\"backlog_order\") ->\n        items = []\n\n        for item, index in uses\n            item[field] = index\n            if item.isModified()\n                items.push(item)\n\n        return items\n\n    moveUs: (ctx, usList, newUsIndex, newSprintId) ->\n        oldSprintId = usList[0].milestone\n        project = usList[0].project\n\n        movedFromClosedSprint = false\n        movedToClosedSprint = false\n\n        sprint = @scope.sprintsById[oldSprintId]\n\n        # Move from closed sprint\n        if !sprint && @scope.closedSprintsById\n            sprint = @scope.closedSprintsById[oldSprintId]\n            movedFromClosedSprint = true if sprint\n\n        newSprint = @scope.sprintsById[newSprintId]\n\n        # Move to closed sprint\n        if !newSprint && newSprintId\n            newSprint = @scope.closedSprintsById[newSprintId]\n            movedToClosedSprint = true if newSprint\n\n        # In the same sprint or in the backlog\n        if newSprintId == oldSprintId\n            items = null\n            userstories = null\n\n            if newSprintId == null\n                userstories = @scope.userstories\n            else\n                userstories = newSprint.user_stories\n\n            @scope.$apply ->\n                for us, key in usList\n                    r = userstories.indexOf(us)\n                    userstories.splice(r, 1)\n\n                args = [newUsIndex, 0].concat(usList)\n                Array.prototype.splice.apply(userstories, args)\n\n            # If in backlog\n            if newSprintId == null\n                # Rehash userstories order field\n\n                items = @.resortUserStories(userstories, \"backlog_order\")\n                data = @.prepareBulkUpdateData(items, \"backlog_order\")\n\n                # Persist in bulk all affected\n                # userstories with order change\n                @rs.userstories.bulkUpdateBacklogOrder(project, data).then =>\n                    for us in usList\n                        @rootscope.$broadcast(\"sprint:us:moved\", us, oldSprintId, newSprintId)\n\n            # For sprint\n            else\n                # Rehash userstories order field\n                items = @.resortUserStories(userstories, \"sprint_order\")\n                data = @.prepareBulkUpdateData(items, \"sprint_order\")\n\n                # Persist in bulk all affected\n                # userstories with order change\n                @rs.userstories.bulkUpdateSprintOrder(project, data).then =>\n                    for us in usList\n                        @rootscope.$broadcast(\"sprint:us:moved\", us, oldSprintId, newSprintId)\n\n            return promise\n\n        # From sprint to backlog\n        if newSprintId == null\n            us.milestone = null for us in usList\n\n            @scope.$apply =>\n                # Add new us to backlog userstories list\n                # @scope.userstories.splice(newUsIndex, 0, us)\n                args = [newUsIndex, 0].concat(usList)\n                Array.prototype.splice.apply(@scope.userstories, args)\n\n                for us, key in usList\n                    r = sprint.user_stories.indexOf(us)\n                    sprint.user_stories.splice(r, 1)\n\n            # Persist the milestone change of userstory\n            promise = @repo.save(us)\n\n            # Rehash userstories order field\n            # and persist in bulk all changes.\n            promise = promise.then =>\n                items = @.resortUserStories(@scope.userstories, \"backlog_order\")\n                data = @.prepareBulkUpdateData(items, \"backlog_order\")\n                return @rs.userstories.bulkUpdateBacklogOrder(us.project, data).then =>\n                    @rootscope.$broadcast(\"sprint:us:moved\", us, oldSprintId, newSprintId)\n\n                    if movedFromClosedSprint\n                        @rootscope.$broadcast(\"backlog:load-closed-sprints\")\n\n            promise.then null, ->\n                console.log \"FAIL\" # TODO\n\n            return promise\n\n        # From backlog to sprint\n        if oldSprintId == null\n            us.milestone = newSprintId for us in usList\n\n            @scope.$apply =>\n                args = [newUsIndex, 0].concat(usList)\n\n                # Add moving us to sprint user stories list\n                Array.prototype.splice.apply(newSprint.user_stories, args)\n\n                # Remove moving us from backlog userstories lists.\n                for us, key in usList\n                    r = @scope.userstories.indexOf(us)\n                    @scope.userstories.splice(r, 1)\n\n        # From sprint to sprint\n        else\n            us.milestone = newSprintId for us in usList\n\n            @scope.$apply =>\n                args = [newUsIndex, 0].concat(usList)\n\n                # Add new us to backlog userstories list\n                Array.prototype.splice.apply(newSprint.user_stories, args)\n\n                # Remove the us from the sprint list.\n                for us in usList\n                    r = sprint.user_stories.indexOf(us)\n                    sprint.user_stories.splice(r, 1)\n\n        # Persist the milestone change of userstory\n        promises = _.map usList, (us) => @repo.save(us)\n\n        # Rehash userstories order field\n        # and persist in bulk all changes.\n        promise = @q.all(promises).then =>\n            items = @.resortUserStories(newSprint.user_stories, \"sprint_order\")\n            data = @.prepareBulkUpdateData(items, \"sprint_order\")\n\n            @rs.userstories.bulkUpdateSprintOrder(project, data).then (result) =>\n                @rootscope.$broadcast(\"sprint:us:moved\", us, oldSprintId, newSprintId)\n\n            @rs.userstories.bulkUpdateBacklogOrder(project, data).then =>\n                for us in usList\n                    @rootscope.$broadcast(\"sprint:us:moved\", us, oldSprintId, newSprintId)\n\n            if movedToClosedSprint || movedFromClosedSprint\n                @scope.$broadcast(\"backlog:load-closed-sprints\")\n\n        promise.then null, ->\n            console.log \"FAIL\" # TODO\n\n        return promise\n\n    isFilterSelected: (type, id) ->\n        if @searchdata[type]? and @searchdata[type][id]\n            return true\n        return false\n\n    setSearchDataFilters: () ->\n        urlfilters = @.getUrlFilters()\n\n        if urlfilters.q\n            @scope.filtersQ = @scope.filtersQ or urlfilters.q\n\n        @searchdata = {}\n        for name, value of urlfilters\n            if not @searchdata[name]?\n                @searchdata[name] = {}\n\n            for val in taiga.toString(value).split(\",\")\n                @searchdata[name][val] = true\n\n    getUrlFilters: ->\n        return _.pick(@location.search(), \"status\", \"tags\", \"q\")\n\n    generateFilters: ->\n        urlfilters = @.getUrlFilters()\n        @scope.filters =  {}\n\n        loadFilters = {}\n        loadFilters.project = @scope.projectId\n        loadFilters.tags = urlfilters.tags\n        loadFilters.status = urlfilters.status\n        loadFilters.q = urlfilters.q\n        loadFilters.milestone = 'null'\n\n        return @rs.userstories.filtersData(loadFilters).then (data) =>\n            choicesFiltersFormat = (choices, type, byIdObject) =>\n                _.map choices, (t) ->\n                    t.type = type\n                    return t\n\n            tagsFilterFormat = (tags) =>\n                return _.map tags, (t) ->\n                    t.id = t.name\n                    t.type = 'tags'\n                    return t\n\n            # Build filters data structure\n            @scope.filters.status = choicesFiltersFormat(data.statuses, \"status\", @scope.usStatusById)\n            @scope.filters.tags = tagsFilterFormat(data.tags)\n\n            selectedTags = _.filter(@scope.filters.tags, \"selected\")\n            selectedTags = _.map(selectedTags, \"id\")\n\n            selectedStatuses = _.filter(@scope.filters.status, \"selected\")\n            selectedStatuses = _.map(selectedStatuses, \"id\")\n\n            @.markSelectedFilters(@scope.filters, urlfilters)\n\n            #store query params\n            @rs.userstories.storeQueryParams(@scope.projectId, {\n                \"status\": selectedStatuses,\n                \"tags\": selectedTags,\n                \"project\": @scope.projectId\n                \"milestone\": null\n            })\n\n    markSelectedFilters: (filters, urlfilters) ->\n        # Build selected filters (from url) fast lookup data structure\n        searchdata = {}\n        for name, value of _.omit(urlfilters, \"page\", \"orderBy\")\n            if not searchdata[name]?\n                searchdata[name] = {}\n\n            for val in \"#{value}\".split(\",\")\n                searchdata[name][val] = true\n\n        isSelected = (type, id) ->\n            if searchdata[type]? and searchdata[type][id]\n                return true\n            return false\n\n        for key, value of filters\n            for obj in value\n                obj.selected = if isSelected(obj.type, obj.id) then true else undefined\n\n    ## Template actions\n\n    updateUserStoryStatus: () ->\n        @.setSearchDataFilters()\n        @.generateFilters().then () =>\n            @rootscope.$broadcast(\"filters:update\")\n            @.loadProjectStats()\n\n    editUserStory: (projectId, ref, $event) ->\n        target = $($event.target)\n\n        currentLoading = @loading()\n            .target(target)\n            .removeClasses(\"icon-edit\")\n            .timeout(200)\n            .start()\n\n        @rs.userstories.getByRef(projectId, ref).then (us) =>\n            @rootscope.$broadcast(\"usform:edit\", us)\n\n            currentLoading.finish()\n\n    deleteUserStory: (us) ->\n        title = @translate.instant(\"US.TITLE_DELETE_ACTION\")\n\n        message = us.subject\n\n        @confirm.askOnDelete(title, message).then (askResponse) =>\n            # We modify the userstories in scope so the user doesn't see the removed US for a while\n            @scope.userstories = _.without(@scope.userstories, us)\n            promise = @.repo.remove(us)\n            promise.then =>\n                askResponse.finish()\n                @.loadBacklog()\n            promise.then null, =>\n                askResponse.finish(false)\n                @confirm.notify(\"error\")\n\n    addNewUs: (type) ->\n        switch type\n            when \"standard\" then @rootscope.$broadcast(\"usform:new\", @scope.projectId,\n                                                       @scope.project.default_us_status, @scope.usStatusList)\n            when \"bulk\" then @rootscope.$broadcast(\"usform:bulk\", @scope.projectId,\n                                                   @scope.project.default_us_status)\n\n    addNewSprint: () ->\n        @rootscope.$broadcast(\"sprintform:create\", @scope.projectId)\n\nmodule.controller(\"BacklogController\", BacklogController)\n\n#############################################################################\n## Backlog Directive\n#############################################################################\n\nBacklogDirective = ($repo, $rootscope, $translate) ->\n    ## Doom line Link\n    doomLineTemplate = _.template(\"\"\"\n    <div class=\"doom-line\"><span><%- text %></span></div>\n    \"\"\")\n\n    linkDoomLine = ($scope, $el, $attrs, $ctrl) ->\n        reloadDoomLine = ->\n            if $scope.stats? and $scope.stats.total_points? and $scope.stats.total_points != 0\n                removeDoomlineDom()\n\n                stats = $scope.stats\n\n                total_points = stats.total_points\n                current_sum = stats.assigned_points\n\n                return if not $scope.userstories\n\n                for us, i in $scope.userstories\n                    current_sum += us.total_points\n\n                    if current_sum > total_points\n                        domElement = $el.find('.backlog-table-body .us-item-row')[i]\n                        addDoomLineDom(domElement)\n\n                        break\n\n        removeDoomlineDom = ->\n            $el.find(\".doom-line\").remove()\n\n        addDoomLineDom = (element) ->\n            text = $translate.instant(\"BACKLOG.DOOMLINE\")\n            $(element).before(doomLineTemplate({\"text\": text}))\n\n        getUsItems = ->\n            rowElements = $el.find('.backlog-table-body .us-item-row')\n            return _.map(rowElements, (x) -> angular.element(x))\n\n        $scope.$on(\"userstories:loaded\", reloadDoomLine)\n        $scope.$watch \"stats\", reloadDoomLine\n\n    ## Move to current sprint link\n\n    linkToolbar = ($scope, $el, $attrs, $ctrl) ->\n        moveToCurrentSprint = (selectedUss) ->\n            ussCurrent = _($scope.userstories)\n\n            # Remove them from backlog\n            $scope.userstories = ussCurrent.without.apply(ussCurrent, selectedUss).value()\n\n            extraPoints = _.map(selectedUss, (v, k) -> v.total_points)\n            totalExtraPoints =  _.reduce(extraPoints, (acc, num) -> acc + num)\n\n            # Add them to current sprint\n            $scope.sprints[0].user_stories = _.union($scope.sprints[0].user_stories, selectedUss)\n\n            # Update the total of points\n            $scope.sprints[0].total_points += totalExtraPoints\n\n            $repo.saveAll(selectedUss).then ->\n                $ctrl.loadSprints()\n                $ctrl.loadProjectStats()\n\n\n        shiftPressed = false\n        lastChecked = null\n\n        checkSelected = (target) ->\n            lastChecked = target.closest(\".us-item-row\")\n            moveToCurrentSprintDom = $el.find(\"#move-to-current-sprint\")\n            selectedUsDom = $el.find(\".backlog-table-body input:checkbox:checked\")\n\n            if selectedUsDom.length > 0 and $scope.sprints.length > 0\n                moveToCurrentSprintDom.show()\n            else\n                moveToCurrentSprintDom.hide()\n\n            target.closest('.us-item-row').toggleClass('ui-multisortable-multiple')\n\n        $(window).on \"keydown.shift-pressed keyup.shift-pressed\", (event) ->\n            shiftPressed = !!event.shiftKey\n\n            return true\n\n        # Enable move to current sprint only when there are selected us's\n        $el.on \"change\", \".backlog-table-body input:checkbox\", (event) ->\n            # check elements between the last two if shift is pressed\n            if lastChecked && shiftPressed\n                elements = []\n                current = $(event.currentTarget).closest(\".us-item-row\")\n                nextAll = lastChecked.nextAll()\n                prevAll = lastChecked.prevAll()\n\n                if _.some(nextAll, (next) -> next == current[0])\n                    elements = lastChecked.nextUntil(current)\n                else if _.some(prevAll, (prev) -> prev == current[0])\n                    elements = lastChecked.prevUntil(current)\n\n                _.map elements, (elm) ->\n                    input = $(elm).find(\"input:checkbox\")\n                    input.prop('checked', true)\n                    checkSelected(input)\n\n            target = angular.element(event.currentTarget)\n            target.closest(\".us-item-row\").toggleClass('is-checked')\n            checkSelected(target)\n\n        $el.on \"click\", \"#move-to-current-sprint\", (event) =>\n            # Calculating the us's to be modified\n            ussDom = $el.find(\".backlog-table-body input:checkbox:checked\")\n\n            ussToMove = _.map ussDom, (item) ->\n                item =  $(item).closest('.tg-scope')\n                itemScope = item.scope()\n                itemScope.us.milestone = $scope.sprints[0].id\n                return itemScope.us\n\n            $scope.$apply(_.partial(moveToCurrentSprint, ussToMove))\n\n        $el.on \"click\", \"#show-tags\", (event) ->\n            event.preventDefault()\n\n            $ctrl.toggleShowTags()\n\n            showHideTags($ctrl)\n\n    showHideTags = ($ctrl) ->\n        elm = angular.element(\"#show-tags\")\n\n        if $ctrl.showTags\n            elm.addClass(\"active\")\n\n            text = $translate.instant(\"BACKLOG.TAGS.HIDE\")\n            elm.text(text)\n        else\n            elm.removeClass(\"active\")\n\n            text = $translate.instant(\"BACKLOG.TAGS.SHOW\")\n            elm.text(text)\n\n    showHideFilter = ($scope, $el, $ctrl) ->\n        sidebar = $el.find(\"sidebar.filters-bar\")\n        sidebar.one \"transitionend\", () ->\n            timeout 150, ->\n                $rootscope.$broadcast(\"resize\")\n                $('.burndown').css(\"visibility\", \"visible\")\n\n        target = angular.element(\"#show-filters-button\")\n        $('.burndown').css(\"visibility\", \"hidden\")\n        sidebar.toggleClass(\"active\")\n        target.toggleClass(\"active\")\n\n        hideText = $translate.instant(\"BACKLOG.FILTERS.HIDE\")\n        showText = $translate.instant(\"BACKLOG.FILTERS.SHOW\")\n\n        toggleText(target.find(\".text\"), [hideText, showText])\n\n        if !sidebar.hasClass(\"active\")\n            $ctrl.resetFilters()\n\n        $ctrl.toggleActiveFilters()\n\n    ## Filters Link\n\n    linkFilters = ($scope, $el, $attrs, $ctrl) ->\n        $scope.filtersSearch = {}\n        $el.on \"click\", \"#show-filters-button\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                showHideFilter($scope, $el, $ctrl)\n\n    link = ($scope, $el, $attrs, $rootscope) ->\n        $ctrl = $el.controller()\n\n        linkToolbar($scope, $el, $attrs, $ctrl)\n        linkFilters($scope, $el, $attrs, $ctrl)\n        linkDoomLine($scope, $el, $attrs, $ctrl)\n\n        $el.find(\".backlog-table-body\").disableSelection()\n\n        filters = $ctrl.getUrlFilters()\n        if filters.status ||\n           filters.tags ||\n           filters.q\n            showHideFilter($scope, $el, $ctrl)\n\n        $scope.$on \"showTags\", () ->\n            showHideTags($ctrl)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n            $(window).off(\".shift-pressed\")\n\n    return {link: link}\n\n\nmodule.directive(\"tgBacklog\", [\"$tgRepo\", \"$rootScope\", \"$translate\", BacklogDirective])\n\n#############################################################################\n## User story points directive\n#############################################################################\n\nUsRolePointsSelectorDirective = ($rootscope, $template, $compile, $translate) ->\n    selectionTemplate = $template.get(\"backlog/us-role-points-popover.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        # Watchers\n        bindOnce $scope, \"project\", (project) ->\n            roles = _.filter(project.roles, \"computable\")\n            numberOfRoles = _.size(roles)\n\n            if numberOfRoles > 1\n                $el.append($compile(selectionTemplate({\"roles\": roles}))($scope))\n            else\n                $el.find(\".icon-arrow-bottom\").remove()\n                $el.find(\".header-points\").addClass(\"not-clickable\")\n\n        $scope.$on \"uspoints:select\", (ctx, roleId, roleName) ->\n            $el.find(\".popover\").popover().close()\n            $el.find(\".header-points\").html(\"#{roleName}/<span>Total</span>\")\n\n        $scope.$on \"uspoints:clear-selection\", (ctx, roleId) ->\n            $el.find(\".popover\").popover().close()\n\n            text = $translate.instant(\"COMMON.FIELDS.POINTS\")\n            $el.find(\".header-points\").text(text)\n\n        # Dom Event Handlers\n        $el.on \"click\", (event) ->\n            target = angular.element(event.target)\n\n            if target.is(\"span\") or target.is(\"div\")\n                event.stopPropagation()\n\n            $el.find(\".popover\").popover().open()\n\n        $el.on \"click\", \".clear-selection\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            $rootscope.$broadcast(\"uspoints:clear-selection\")\n\n        $el.on \"click\", \".role\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            target = angular.element(event.currentTarget)\n            rolScope = target.scope()\n            $rootscope.$broadcast(\"uspoints:select\", target.data(\"role-id\"), target.text())\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgUsRolePointsSelector\", [\"$rootScope\", \"$tgTemplate\", \"$compile\", UsRolePointsSelectorDirective])\n\n\nUsPointsDirective = ($tgEstimationsService, $repo, $tgTemplate) ->\n    rolesTemplate = $tgTemplate.get(\"common/estimation/us-points-roles-popover.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        updatingSelectedRoleId = null\n        selectedRoleId = null\n        filteringRoleId = null\n        estimationProcess = null\n\n        $scope.$on \"uspoints:select\", (ctx, roleId, roleName) ->\n            us = $scope.$eval($attrs.tgBacklogUsPoints)\n            selectedRoleId = roleId\n            estimationProcess.render()\n\n        $scope.$on \"uspoints:clear-selection\", (ctx) ->\n            us = $scope.$eval($attrs.tgBacklogUsPoints)\n            selectedRoleId = null\n            estimationProcess.render()\n\n        $scope.$watch $attrs.tgBacklogUsPoints, (us) ->\n            if us\n                estimationProcess = $tgEstimationsService.create($el, us, $scope.project)\n\n                # Update roles\n                roles = estimationProcess.calculateRoles()\n                if roles.length == 0\n                    $el.find(\".icon-arrow-bottom\").remove()\n                    $el.find(\"a.us-points\").addClass(\"not-clickable\")\n\n                else if roles.length == 1\n                    # Preselect the role if we have only one\n                    selectedRoleId = _.keys(us.points)[0]\n\n                if estimationProcess.isEditable\n                    bindClickElements()\n\n                estimationProcess.onSelectedPointForRole = (roleId, pointId) ->\n                    @save(roleId, pointId).then ->\n                        $ctrl.loadProjectStats()\n\n                estimationProcess.render = () ->\n                    totalPoints = @calculateTotalPoints()\n                    if not selectedRoleId? or roles.length == 1\n                        text = totalPoints\n                        title = totalPoints\n                    else\n                        pointId = @us.points[selectedRoleId]\n                        pointObj = @pointsById[pointId]\n                        text = \"#{pointObj.name} / <span>#{totalPoints}</span>\"\n                        title = \"#{pointObj.name} / #{totalPoints}\"\n\n                    ctx = {\n                        totalPoints: totalPoints\n                        roles: @calculateRoles()\n                        editable: @isEditable\n                        text:  text\n                        title: title\n                    }\n                    mainTemplate = \"common/estimation/us-estimation-total.html\"\n                    template = $tgTemplate.get(mainTemplate, true)\n                    html = template(ctx)\n                    @$el.html(html)\n\n                estimationProcess.render()\n\n        renderRolesSelector = () ->\n            roles = estimationProcess.calculateRoles()\n            html = rolesTemplate({\"roles\": roles})\n            # Render into DOM and show the new created element\n            $el.append(html)\n            $el.find(\".pop-role\").popover().open(() -> $(this).remove())\n\n        bindClickElements = () ->\n            $el.on \"click\", \"a.us-points span\", (event) ->\n                event.preventDefault()\n                event.stopPropagation()\n                us = $scope.$eval($attrs.tgBacklogUsPoints)\n                updatingSelectedRoleId = selectedRoleId\n                if selectedRoleId?\n                    estimationProcess.renderPointsSelector(selectedRoleId)\n                else\n                    renderRolesSelector()\n\n            $el.on \"click\", \".role\", (event) ->\n                event.preventDefault()\n                event.stopPropagation()\n                target = angular.element(event.currentTarget)\n                us = $scope.$eval($attrs.tgBacklogUsPoints)\n                updatingSelectedRoleId = target.data(\"role-id\")\n                popRolesDom = $el.find(\".pop-role\")\n                popRolesDom.find(\"a\").removeClass(\"active\")\n                popRolesDom.find(\"a[data-role-id='#{updatingSelectedRoleId}']\").addClass(\"active\")\n                estimationProcess.renderPointsSelector(updatingSelectedRoleId)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgBacklogUsPoints\", [\"$tgEstimationsService\", \"$tgRepo\", \"$tgTemplate\", UsPointsDirective])\n\n\n#############################################################################\n## Burndown graph directive\n#############################################################################\nToggleBurndownVisibility = ($storage) ->\n    hide = () ->\n        $(\".js-burndown-graph\").removeClass(\"shown\")\n        $(\".js-toggle-burndown-visibility-button\").removeClass(\"active\")\n        $(\".js-burndown-graph\").removeClass(\"open\")\n\n    show = (firstLoad) ->\n        $(\".js-toggle-burndown-visibility-button\").addClass(\"active\")\n\n        if firstLoad\n            $(\".js-burndown-graph\").addClass(\"shown\")\n        else\n            $(\".js-burndown-graph\").addClass(\"open\")\n\n    link = ($scope, $el, $attrs) ->\n        firstLoad = true\n        hash = generateHash([\"is-burndown-grpahs-collapsed\"])\n        $scope.isBurndownGraphCollapsed = $storage.get(hash) or false\n\n        toggleGraph = ->\n            if $scope.isBurndownGraphCollapsed\n                hide(firstLoad)\n            else\n                show(firstLoad)\n\n            firstLoad = false\n\n        $scope.$watch \"showGraphPlaceholder\", () ->\n            if $scope.showGraphPlaceholder?\n                $scope.isBurndownGraphCollapsed = $scope.isBurndownGraphCollapsed || $scope.showGraphPlaceholder\n                toggleGraph()\n\n        $el.on \"click\", \".js-toggle-burndown-visibility-button\", ->\n            $scope.isBurndownGraphCollapsed = !$scope.isBurndownGraphCollapsed\n            $storage.set(hash, $scope.isBurndownGraphCollapsed)\n            toggleGraph()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n    }\n\nmodule.directive(\"tgToggleBurndownVisibility\", [\"$tgStorage\", ToggleBurndownVisibility])\n\n\n#############################################################################\n## Burndown graph directive\n#############################################################################\n\nBurndownBacklogGraphDirective = ($translate) ->\n    redrawChart = (element, dataToDraw) ->\n        width = element.width()\n        element.height(width/6)\n        milestonesRange = [0..(dataToDraw.milestones.length - 1)]\n        data = []\n        zero_line = _.map(dataToDraw.milestones, (ml) -> 0)\n        data.push({\n            data: _.zip(milestonesRange, zero_line)\n            lines:\n                fillColor : \"rgba(0,0,0,0)\"\n            points:\n                show: false\n        })\n        optimal_line = _.map(dataToDraw.milestones, (ml) -> ml.optimal)\n        data.push({\n            data: _.zip(milestonesRange, optimal_line)\n            lines:\n                fillColor : \"rgba(120,120,120,0.2)\"\n        })\n        evolution_line = _.filter(_.map(dataToDraw.milestones, (ml) -> ml.evolution), (evolution) -> evolution?)\n        data.push({\n            data: _.zip(milestonesRange, evolution_line)\n            lines:\n                fillColor : \"rgba(102,153,51,0.3)\"\n        })\n        team_increment_line = _.map(dataToDraw.milestones, (ml) -> -ml[\"team-increment\"])\n        data.push({\n            data: _.zip(milestonesRange, team_increment_line)\n            lines:\n                fillColor : \"rgba(153,51,51,0.3)\"\n        })\n        client_increment_line = _.map dataToDraw.milestones, (ml) ->\n            -ml[\"team-increment\"] - ml[\"client-increment\"]\n        data.push({\n            data: _.zip(milestonesRange, client_increment_line)\n            lines:\n                fillColor : \"rgba(255,51,51,0.3)\"\n        })\n\n        colors = [\n            \"rgba(0,0,0,1)\"\n            \"rgba(120,120,120,0.2)\"\n            \"rgba(102,153,51,1)\"\n            \"rgba(153,51,51,1)\"\n            \"rgba(255,51,51,1)\"\n        ]\n\n        options = {\n            grid: {\n                borderWidth: { top: 0, right: 1, left:0, bottom: 0 }\n                borderColor: \"#ccc\"\n                hoverable: true\n            }\n            xaxis: {\n                ticks: dataToDraw.milestones.length\n                axisLabel: $translate.instant(\"BACKLOG.CHART.XAXIS_LABEL\"),\n                axisLabelUseCanvas: true\n                axisLabelFontSizePixels: 12\n                axisLabelFontFamily: \"Verdana, Arial, Helvetica, Tahoma, sans-serif\"\n                axisLabelPadding: 5\n                tickFormatter: (val, axis) -> \"\"\n            }\n            yaxis: {\n                axisLabel: $translate.instant(\"BACKLOG.CHART.YAXIS_LABEL\"),\n                axisLabelUseCanvas: true\n                axisLabelFontSizePixels: 12\n                axisLabelFontFamily: \"Verdana, Arial, Helvetica, Tahoma, sans-serif\"\n                axisLabelPadding: 5\n            }\n            series: {\n                shadowSize: 0\n                lines: {\n                    show: true\n                    fill: true\n                }\n                points: {\n                    show: true\n                    fill: true\n                    radius: 4\n                    lineWidth: 2\n                }\n            }\n            colors: colors\n            tooltip: true\n            tooltipOpts: {\n                content: (label, xval, yval, flotItem) ->\n                    if flotItem.seriesIndex == 1\n                        ctx = {sprintName: dataToDraw.milestones[xval].name, value: Math.abs(yval)}\n                        return $translate.instant(\"BACKLOG.CHART.OPTIMAL\", ctx)\n                    else if flotItem.seriesIndex == 2\n                        ctx = {sprintName: dataToDraw.milestones[xval].name, value: Math.abs(yval)}\n                        return $translate.instant(\"BACKLOG.CHART.REAL\", ctx)\n                    else if flotItem.seriesIndex == 3\n                        ctx = {sprintName: dataToDraw.milestones[xval].name, value: Math.abs(yval)}\n                        return $translate.instant(\"BACKLOG.CHART.INCREMENT_TEAM\", ctx)\n                    else\n                        ctx = {sprintName: dataToDraw.milestones[xval].name, value: Math.abs(yval)}\n                        return $translate.instant(\"BACKLOG.CHART.INCREMENT_CLIENT\", ctx)\n            }\n        }\n\n        element.empty()\n        element.plot(data, options).data(\"plot\")\n\n    link = ($scope, $el, $attrs) ->\n        element = angular.element($el)\n\n        $scope.$watch \"stats\", (value) ->\n            if $scope.stats?\n                redrawChart(element, $scope.stats)\n\n                $scope.$on \"resize\", ->\n                    redrawChart(element, $scope.stats)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgBurndownBacklogGraph\", [\"$translate\", BurndownBacklogGraphDirective])\n\n\n#############################################################################\n## Backlog progress bar directive\n#############################################################################\n\nTgBacklogProgressBarDirective = ($template, $compile) ->\n    template = $template.get(\"backlog/progress-bar.html\", true)\n\n    render = (scope, el, projectPointsPercentaje, closedPointsPercentaje) ->\n        html = template({\n            projectPointsPercentaje: projectPointsPercentaje,\n            closedPointsPercentaje:closedPointsPercentaje\n        })\n        html = $compile(html)(scope)\n        el.html(html)\n\n    adjustPercentaje = (percentage) ->\n        adjusted = _.max([0 , percentage])\n        adjusted = _.min([100, adjusted])\n        return Math.round(adjusted)\n\n    link = ($scope, $el, $attrs) ->\n        element = angular.element($el)\n\n        $scope.$watch $attrs.tgBacklogProgressBar, (stats) ->\n            if stats?\n                totalPoints = if stats.total_points then stats.total_points else stats.defined_points\n                definedPoints = stats.defined_points\n                closedPoints = stats.closed_points\n                if definedPoints > totalPoints\n                    projectPointsPercentaje = totalPoints * 100 / definedPoints\n                    closedPointsPercentaje = closedPoints * 100 / definedPoints\n                else\n                    projectPointsPercentaje = 100\n                    closedPointsPercentaje = closedPoints * 100 / totalPoints\n\n                projectPointsPercentaje = adjustPercentaje(projectPointsPercentaje - 3)\n                closedPointsPercentaje = adjustPercentaje(closedPointsPercentaje - 3)\n                render($scope, $el, projectPointsPercentaje, closedPointsPercentaje)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgBacklogProgressBar\", [\"$tgTemplate\", \"$compile\", TgBacklogProgressBarDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog/sortable.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\n\nmodule = angular.module(\"taigaBacklog\")\n\n\n#############################################################################\n## Sortable Directive\n#############################################################################\n\ndeleteElement = (el) ->\n    el.scope().$destroy()\n    el.off()\n    el.remove()\n\nBacklogSortableDirective = ($repo, $rs, $rootscope, $tgConfirm, $translate) ->\n    # Notes about jquery bug:\n    # http://stackoverflow.com/questions/5791886/jquery-draggable-shows-\n    # helper-in-wrong-place-when-scrolled-down-page\n\n    link = ($scope, $el, $attrs) ->\n        getUsIndex = (us) =>\n            return $(us).index(\".backlog-table-body .row\")\n\n        bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions we don't enable the sortable\n            if not (project.my_permissions.indexOf(\"modify_us\") > -1)\n                return\n\n            filterError = ->\n                text = $translate.instant(\"BACKLOG.SORTABLE_FILTER_ERROR\")\n                $tgConfirm.notify(\"error\", text)\n\n            $el.sortable({\n                items: \".us-item-row\",\n                cancel: \".popover\"\n                connectWith: \".sprint\"\n                dropOnEmpty: true\n                placeholder: \"row us-item-row us-item-drag sortable-placeholder\"\n                scroll: true\n                disableHorizontalScroll: true\n                # A consequence of length of backlog user story item\n                # the default tolerance (\"intersection\") not works properly.\n                tolerance: \"pointer\"\n                # Revert on backlog is disabled bacause it works bad. Something\n                # on the current taiga backlog structure or style makes jquery ui\n                # works unexpectly (in some circumstances calculates wrong\n                # position for revert).\n                revert: false\n                start: () ->\n                    $(document.body).addClass(\"drag-active\")\n                stop: () ->\n                    $(document.body).removeClass(\"drag-active\")\n\n                    if $el.hasClass(\"active-filters\")\n                        $el.sortable(\"cancel\")\n                        filterError()\n            })\n\n            $el.on \"multiplesortreceive\", (event, ui) ->\n                if $el.hasClass(\"active-filters\")\n                    ui.source.sortable(\"cancel\")\n                    filterError()\n\n                    return\n\n                itemUs = ui.item.scope().us\n                itemIndex = getUsIndex(ui.item)\n\n                deleteElement(ui.item)\n\n                $scope.$emit(\"sprint:us:move\", [itemUs], itemIndex, null)\n                ui.item.find('a').removeClass('noclick')\n\n            $el.on \"multiplesortstop\", (event, ui) ->\n                # When parent not exists, do nothing\n                if $(ui.items[0]).parent().length == 0\n                    return\n\n                if $el.hasClass(\"active-filters\")\n                    return\n\n                items = _.sortBy ui.items, (item) ->\n                    return $(item).index()\n\n                index = _.min _.map items, (item) ->\n                    return getUsIndex(item)\n\n                us = _.map items, (item) ->\n                    item = $(item)\n                    itemUs = item.scope().us\n\n                    # HACK: setTimeout prevents that firefox click\n                    # event fires just after drag ends\n                    setTimeout ( =>\n                        item.find('a').removeClass('noclick')\n                    ), 300\n\n                    return itemUs\n\n                $scope.$emit(\"sprint:us:move\", us, index, null)\n\n            $el.on \"sortstart\", (event, ui) ->\n                ui.item.find('a').addClass('noclick')\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nBacklogEmptySortableDirective = ($repo, $rs, $rootscope) ->\n    # Notes about jquery bug:\n    # http://stackoverflow.com/questions/5791886/jquery-draggable-shows-\n    # helper-in-wrong-place-when-scrolled-down-page\n\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions we don't enable the sortable\n            if project.my_permissions.indexOf(\"modify_us\") > -1\n                $el.sortable({\n                    items: \".us-item-row\",\n                    dropOnEmpty: true\n                })\n\n                $el.on \"sortreceive\", (event, ui) ->\n                    itemUs = ui.item.scope().us\n                    itemIndex = ui.item.index()\n\n                    deleteElement(ui.item)\n                    $scope.$emit(\"sprint:us:move\", [itemUs], itemIndex, null)\n\n                    ui.item.find('a').removeClass('noclick')\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nSprintSortableDirective = ($repo, $rs, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions we don't enable the sortable\n            if project.my_permissions.indexOf(\"modify_us\") > -1\n                $el.sortable({\n                    scroll: true\n                    dropOnEmpty: true\n                    items: \".sprint-table .milestone-us-item-row\"\n                    disableHorizontalScroll: true\n                    connectWith: \".sprint,.backlog-table-body,.empty-backlog\"\n                    placeholder: \"row us-item-row sortable-placeholder\"\n                    forcePlaceholderSize:true\n                })\n\n                $el.on \"multiplesortreceive\", (event, ui) ->\n                    items = _.sortBy ui.items, (item) ->\n                        return $(item).index()\n\n                    index = _.min _.map items, (item) ->\n                        return $(item).index()\n\n                    us = _.map items, (item) ->\n                        item = $(item)\n                        itemUs = item.scope().us\n\n                        deleteElement(item)\n\n                        return itemUs\n\n                    $scope.$emit(\"sprint:us:move\", us, index, $scope.sprint.id)\n\n                $el.on \"multiplesortstop\", (event, ui) ->\n                    # When parent not exists, do nothing\n                    if ui.item.parent().length == 0\n                        return\n\n                    itemUs = ui.item.scope().us\n                    itemIndex = ui.item.index()\n\n                    # HACK: setTimeout prevents that firefox click\n                    # event fires just after drag ends\n                    setTimeout ( =>\n                        ui.item.find('a').removeClass('noclick')\n                    ), 300\n\n                    $scope.$emit(\"sprint:us:move\", [itemUs], itemIndex, $scope.sprint.id)\n\n                $el.on \"sortstart\", (event, ui) ->\n                    ui.item.find('a').addClass('noclick')\n\n    return {link:link}\n\n\nmodule.directive(\"tgBacklogSortable\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"$tgConfirm\",\n    \"$translate\",\n    BacklogSortableDirective\n])\n\nmodule.directive(\"tgBacklogEmptySortable\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    BacklogEmptySortableDirective\n])\n\nmodule.directive(\"tgSprintSortable\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    SprintSortableDirective\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog/sprints.coffee\n###\n\ntaiga = @.taiga\n\nmodule = angular.module(\"taigaBacklog\")\n\n\n#############################################################################\n## Sprint Actions Directive\n#############################################################################\n\nBacklogSprintDirective = ($repo, $rootscope) ->\n    sprintTableMinHeight = 50\n    slideOptions = {\n        duration: 500,\n        easing: 'linear'\n    }\n\n    toggleSprint = ($el) =>\n        sprintTable = $el.find(\".sprint-table\")\n        sprintArrow = $el.find(\".icon-arrow-up\")\n\n        sprintArrow.toggleClass('active')\n        sprintTable.toggleClass('open')\n\n    link = ($scope, $el, $attrs) ->\n        $scope.$watch $attrs.tgBacklogSprint, (sprint) ->\n            sprint = $scope.$eval($attrs.tgBacklogSprint)\n\n            if sprint.closed\n                $el.addClass(\"sprint-closed\")\n            else\n                toggleSprint($el)\n\n        # Event Handlers\n        $el.on \"click\", \".sprint-name > .icon-arrow-up\", (event) ->\n            event.preventDefault()\n\n            toggleSprint($el)\n\n            $el.find(\".sprint-table\").slideToggle(slideOptions)\n\n        $el.on \"click\", \".sprint-name > .icon-edit\", (event) ->\n            event.preventDefault()\n\n            sprint = $scope.$eval($attrs.tgBacklogSprint)\n            $rootscope.$broadcast(\"sprintform:edit\", sprint)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgBacklogSprint\", [\"$tgRepo\", \"$rootScope\", BacklogSprintDirective])\n\n\n#############################################################################\n## Sprint Header Directive\n#############################################################################\n\nBacklogSprintHeaderDirective = ($navUrls, $template, $compile, $translate) ->\n    template = $template.get(\"backlog/sprint-header.html\")\n\n    link = ($scope, $el, $attrs, $model) ->\n        prettyDate = $translate.instant(\"BACKLOG.SPRINTS.DATE\")\n\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_milestone\") != -1\n\n        isVisible = ->\n            return $scope.project.my_permissions.indexOf(\"view_milestones\") != -1\n\n        render = (sprint) ->\n            taskboardUrl = $navUrls.resolve(\"project-taskboard\",\n                                            {project: $scope.project.slug, sprint: sprint.slug})\n\n            start = moment(sprint.estimated_start).format(prettyDate)\n            finish = moment(sprint.estimated_finish).format(prettyDate)\n            estimatedDateRange = \"#{start}-#{finish}\"\n\n            ctx = {\n                name: sprint.name\n                taskboardUrl: taskboardUrl\n                estimatedDateRange: estimatedDateRange\n                closedPoints: sprint.closed_points or 0\n                totalPoints: sprint.total_points or 0\n                isVisible: isVisible()\n                isEditable: isEditable()\n            }\n\n            templateScope = $scope.$new()\n\n            _.assign(templateScope, ctx)\n\n            compiledTemplate = $compile(template)(templateScope)\n            $el.html(compiledTemplate)\n\n        $scope.$watch $attrs.ngModel, (sprint) ->\n            render(sprint)\n\n        $scope.$on \"sprintform:edit:success\", ->\n            render($model.$modelValue)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgBacklogSprintHeader\", [\"$tgNavUrls\", \"$tgTemplate\", \"$compile\", \"$translate\"\n                                           BacklogSprintHeaderDirective])\n\n\n#############################################################################\n## Toggle Closed Sprints Directive\n#############################################################################\n\nToggleExcludeClosedSprintsVisualization = ($rootscope, $loading, $translate) ->\n    excludeClosedSprints = true\n\n    link = ($scope, $el, $attrs) ->\n        # insert loading wrapper\n        loadingElm = $(\"<div>\")\n        $el.after(loadingElm)\n\n        currentLoading = null\n\n        # Event Handlers\n        $el.on \"click\", (event) ->\n            event.preventDefault()\n            excludeClosedSprints  = not excludeClosedSprints\n\n            currentLoading = $loading()\n                .target(loadingElm)\n                .start()\n\n            if excludeClosedSprints\n                $rootscope.$broadcast(\"backlog:unload-closed-sprints\")\n            else\n                $rootscope.$broadcast(\"backlog:load-closed-sprints\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        $scope.$on \"closed-sprints:reloaded\", (ctx, sprints) =>\n            currentLoading.finish()\n\n            if sprints.length > 0\n                key = \"BACKLOG.SPRINTS.ACTION_HIDE_CLOSED_SPRINTS\"\n            else\n                key = \"BACKLOG.SPRINTS.ACTION_SHOW_CLOSED_SPRINTS\"\n\n            text = $translate.instant(key)\n\n            $el.find(\".text\").text(text)\n\n    return {link: link}\n\nmodule.directive(\"tgBacklogToggleClosedSprintsVisualization\", [\"$rootScope\", \"$tgLoading\", \"$translate\",\n                                                               ToggleExcludeClosedSprintsVisualization])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/taskboard/charts.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\ntimeout = @.taiga.timeout\n\nmodule = angular.module(\"taigaTaskboard\")\n\n#############################################################################\n## Sprint burndown graph directive\n#############################################################################\n\nSprintGraphDirective = ($translate)->\n    redrawChart = (element, dataToDraw) ->\n        width = element.width()\n        element.height(240)\n\n        days = _.map(dataToDraw, (x) -> moment(x.day))\n\n        data = []\n        data.unshift({\n            data: _.zip(days, _.map(dataToDraw, (d) -> d.optimal_points))\n            lines:\n                fillColor : \"rgba(120,120,120,0.2)\"\n        })\n        data.unshift({\n            data: _.zip(days, _.map(dataToDraw, (d) -> d.open_points))\n            lines:\n                fillColor : \"rgba(102,153,51,0.3)\"\n        })\n\n        options =\n            grid:\n                borderWidth: { top: 0, right: 1, left:0, bottom: 0 }\n                borderColor: '#ccc'\n                hoverable: true\n            xaxis:\n                tickSize: [1, \"day\"]\n                min: days[0]\n                max: _.last(days)\n                mode: \"time\"\n                daysNames: days\n                axisLabel: $translate.instant(\"TASKBOARD.CHARTS.XAXIS_LABEL\")\n                axisLabelUseCanvas: true\n                axisLabelFontSizePixels: 12\n                axisLabelFontFamily: 'Verdana, Arial, Helvetica, Tahoma, sans-serif'\n                axisLabelPadding: 5\n            yaxis:\n                min: 0\n                axisLabel: $translate.instant(\"TASKBOARD.CHARTS.YAXIS_LABEL\")\n                axisLabelUseCanvas: true\n                axisLabelFontSizePixels: 12\n                axisLabelFontFamily: 'Verdana, Arial, Helvetica, Tahoma, sans-serif'\n                axisLabelPadding: 5\n            series:\n                shadowSize: 0\n                lines:\n                    show: true\n                    fill: true\n                points:\n                    show: true\n                    fill: true\n                    radius: 4\n                    lineWidth: 2\n            colors: [\"rgba(102,153,51,1)\", \"rgba(120,120,120,0.2)\"]\n            tooltip: true\n            tooltipOpts:\n                content: (label, xval, yval, flotItem) ->\n                    formattedDate = moment(xval).format($translate.instant(\"TASKBOARD.CHARTS.DATE\"))\n                    roundedValue = Math.round(yval)\n\n                    if flotItem.seriesIndex == 1\n                        return $translate.instant(\"TASKBOARD.CHARTS.OPTIMAL\", {\n                            formattedDate: formattedDate,\n                            roundedValue: roundedValue\n                        })\n\n                    else\n                        return $translate.instant(\"TASKBOARD.CHARTS.REAL\", {\n                            formattedDate: formattedDate,\n                            roundedValue: roundedValue\n                        })\n\n        element.empty()\n        element.plot(data, options).data(\"plot\")\n\n    link = ($scope, $el, $attrs) ->\n        element = angular.element($el)\n\n        $scope.$on \"resize\", ->\n            redrawChart(element, $scope.stats.days) if $scope.stats\n\n        $scope.$on \"taskboard:graph:toggle-visibility\", ->\n            $el.parent().toggleClass('open')\n\n            # fix chart overflow\n            timeout(100, ->\n                redrawChart(element, $scope.stats.days) if $scope.stats\n            )\n\n        $scope.$watch 'stats', (value) ->\n            if not $scope.stats?\n                return\n            redrawChart(element, $scope.stats.days)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgSprintGraph\", [\"$translate\", SprintGraphDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/taskboard/lightboxes.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nCreateEditTaskDirective = ($repo, $model, $rs, $rootscope, $loading, lightboxService, $translate) ->\n    link = ($scope, $el, attrs) ->\n        $scope.isNew = true\n\n        $scope.$on \"taskform:new\", (ctx, sprintId, usId) ->\n            $scope.task = {\n                project: $scope.projectId\n                milestone: sprintId\n                user_story: usId\n                is_archived: false\n                status: $scope.project.default_task_status\n                assigned_to: null\n                tags: []\n            }\n            $scope.isNew = true\n\n            # Update texts for creation\n            create = $translate.instant(\"COMMON.CREATE\")\n            $el.find(\".button-green\").html(create)\n\n            newTask = $translate.instant(\"LIGHTBOX.CREATE_EDIT_TASK.TITLE\")\n            $el.find(\".title\").html(newTask + \"  \")\n\n            $el.find(\".tag-input\").val(\"\")\n            lightboxService.open($el)\n\n        $scope.$on \"taskform:edit\", (ctx, task) ->\n            $scope.task = task\n            $scope.isNew = false\n\n            # Update texts for edition\n            save = $translate.instant(\"COMMON.SAVE\")\n            edit = $translate.instant(\"LIGHTBOX.CREATE_EDIT_TASK.ACTION_EDIT\")\n\n            $el.find(\".button-green\").html(save)\n            $el.find(\".title\").html(edit + \"  \")\n\n            $el.find(\".tag-input\").val(\"\")\n            lightboxService.open($el)\n\n\n        submitButton = $el.find(\".submit-button\")\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            if not form.validate()\n                return\n\n            if $scope.isNew\n                promise = $repo.create(\"tasks\", $scope.task)\n                broadcastEvent = \"taskform:new:success\"\n            else\n                promise = $repo.save($scope.task)\n                broadcastEvent = \"taskform:edit:success\"\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            # FIXME: error handling?\n            promise.then (data) ->\n                currentLoading.finish()\n                lightboxService.close($el)\n                $rootscope.$broadcast(broadcastEvent, data)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nCreateBulkTasksDirective = ($repo, $rs, $rootscope, $loading, lightboxService) ->\n    link = ($scope, $el, attrs) ->\n        $scope.form = {data: \"\", usId: null}\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            data = $scope.form.data\n            projectId = $scope.projectId\n            sprintId = $scope.form.sprintId\n            usId = $scope.form.usId\n\n            promise = $rs.tasks.bulkCreate(projectId, sprintId, usId, data)\n            promise.then (result) ->\n                currentLoading.finish()\n                $rootscope.$broadcast(\"taskform:bulk:success\", result)\n                lightboxService.close($el)\n\n            # TODO: error handling\n            promise.then null, ->\n                currentLoading.finish()\n                console.log \"FAIL\"\n\n        $scope.$on \"taskform:bulk\", (ctx, sprintId, usId)->\n            lightboxService.open($el)\n            $scope.form = {data: \"\", sprintId: sprintId, usId: usId}\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule = angular.module(\"taigaTaskboard\")\n\nmodule.directive(\"tgLbCreateEditTask\", [\n    \"$tgRepo\",\n    \"$tgModel\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"$tgLoading\",\n    \"lightboxService\",\n    \"$translate\"\n    CreateEditTaskDirective\n])\n\nmodule.directive(\"tgLbCreateBulkTasks\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    \"$tgLoading\",\n    \"lightboxService\",\n    CreateBulkTasksDirective\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/taskboard.coffee\n###\n\ntaiga = @.taiga\ntoggleText = @.taiga.toggleText\nmixOf = @.taiga.mixOf\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\nscopeDefer = @.taiga.scopeDefer\ntimeout = @.taiga.timeout\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaTaskboard\")\n\n\n#############################################################################\n## Taskboard Controller\n#############################################################################\n\nclass TaskboardController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"tgAppMetaService\",\n        \"$tgLocation\",\n        \"$tgNavUrls\"\n        \"$tgEvents\"\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @appMetaService, @location, @navUrls,\n                  @events, @analytics, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"TASKBOARD.SECTION_NAME\")\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then => @._setMeta()\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    _setMeta: ->\n        prettyDate = @translate.instant(\"BACKLOG.SPRINTS.DATE\")\n\n        title = @translate.instant(\"TASKBOARD.PAGE_TITLE\", {\n            projectName: @scope.project.name\n            sprintName: @scope.sprint.name\n        })\n        description =  @translate.instant(\"TASKBOARD.PAGE_DESCRIPTION\", {\n            projectName: @scope.project.name\n            sprintName: @scope.sprint.name\n            startDate: moment(@scope.sprint.estimated_start).format(prettyDate)\n            endDate: moment(@scope.sprint.estimated_finish).format(prettyDate)\n            completedPercentage: @scope.stats.completedPercentage or \"0\"\n            completedPoints: @scope.stats.completedPointsSum or \"--\"\n            totalPoints: @scope.stats.totalPointsSum or \"--\"\n            openTasks: @scope.stats.openTasks or \"--\"\n            totalTasks: @scope.stats.total_tasks or \"--\"\n        })\n\n        @appMetaService.setAll(title, description)\n\n    initializeEventHandlers: ->\n        # TODO: Reload entire taskboard after create/edit tasks seems\n        # a big overhead. It should be optimized in near future.\n        @scope.$on \"taskform:bulk:success\", =>\n            @.loadTaskboard()\n            @analytics.trackEvent(\"task\", \"create\", \"bulk create task on taskboard\", 1)\n\n        @scope.$on \"taskform:new:success\", =>\n            @.loadTaskboard()\n            @analytics.trackEvent(\"task\", \"create\", \"create task on taskboard\", 1)\n\n        @scope.$on(\"taskform:edit:success\", => @.loadTaskboard())\n        @scope.$on(\"taskboard:task:move\", @.taskMove)\n\n        @scope.$on \"assigned-to:added\", (ctx, userId, task) =>\n            task.assigned_to = userId\n            promise = @repo.save(task)\n            promise.then null, ->\n                console.log \"FAIL\" # TODO\n\n    initializeSubscription: ->\n        routingKey = \"changes.project.#{@scope.projectId}.tasks\"\n        @events.subscribe @scope, routingKey, (message) =>\n            @.loadTaskboard()\n\n        routingKey1 = \"changes.project.#{@scope.projectId}.userstories\"\n        @events.subscribe @scope, routingKey1, (message) =>\n            @.refreshTagsColors()\n            @.loadSprintStats()\n            @.loadSprint()\n\n    loadProject: ->\n        return @rs.projects.get(@scope.projectId).then (project) =>\n            if not project.is_backlog_activated\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.project = project\n            # Not used at this momment\n            @scope.pointsList = _.sortBy(project.points, \"order\")\n            # @scope.roleList = _.sortBy(project.roles, \"order\")\n            @scope.pointsById = groupBy(project.points, (e) -> e.id)\n            @scope.roleById = groupBy(project.roles, (e) -> e.id)\n            @scope.taskStatusList = _.sortBy(project.task_statuses, \"order\")\n            @scope.usStatusList = _.sortBy(project.us_statuses, \"order\")\n            @scope.usStatusById = groupBy(project.us_statuses, (e) -> e.id)\n\n            @scope.$emit('project:loaded', project)\n\n            @.fillUsersAndRoles(project.members, project.roles)\n\n            return project\n\n    loadSprintStats: ->\n        return @rs.sprints.stats(@scope.projectId, @scope.sprintId).then (stats) =>\n            totalPointsSum =_.reduce(_.values(stats.total_points), ((res, n) -> res + n), 0)\n            completedPointsSum = _.reduce(_.values(stats.completed_points), ((res, n) -> res + n), 0)\n            remainingPointsSum = totalPointsSum - completedPointsSum\n            remainingTasks = stats.total_tasks - stats.completed_tasks\n            @scope.stats = stats\n            @scope.stats.totalPointsSum = totalPointsSum\n            @scope.stats.completedPointsSum = completedPointsSum\n            @scope.stats.remainingPointsSum = remainingPointsSum\n            @scope.stats.remainingTasks = remainingTasks\n            if stats.totalPointsSum\n                @scope.stats.completedPercentage = Math.round(100*stats.completedPointsSum/stats.totalPointsSum)\n            else\n                @scope.stats.completedPercentage = 0\n\n            @scope.stats.openTasks = stats.total_tasks - stats.completed_tasks\n            return stats\n\n    refreshTagsColors: ->\n        return @rs.projects.tagsColors(@scope.projectId).then (tags_colors) =>\n            @scope.project.tags_colors = tags_colors\n\n    loadSprint: ->\n        return @rs.sprints.get(@scope.projectId, @scope.sprintId).then (sprint) =>\n            @scope.sprint = sprint\n            @scope.userstories = _.sortBy(sprint.user_stories, \"sprint_order\")\n            return sprint\n\n    loadTasks: ->\n        return @rs.tasks.list(@scope.projectId, @scope.sprintId).then (tasks) =>\n            @scope.tasks = _.sortBy(tasks, 'taskboard_order')\n            @scope.usTasks = {}\n\n            # Iterate over all userstories and\n            # null userstory for unassigned tasks\n            for us in _.union(@scope.userstories, [{id:null}])\n                @scope.usTasks[us.id] = {}\n                for status in @scope.taskStatusList\n                    @scope.usTasks[us.id][status.id] = []\n\n            for task in @scope.tasks\n                if @scope.usTasks[task.user_story]? and @scope.usTasks[task.user_story][task.status]?\n                    @scope.usTasks[task.user_story][task.status].push(task)\n\n            if tasks.length == 0\n                \n                if @scope.userstories.length > 0\n                    usId = @scope.userstories[0].id\n                else\n                    usId = null\n\n                @scope.usTasks[usId][@scope.taskStatusList[0].id].push({isPlaceholder: true})\n\n            return tasks\n\n    loadTaskboard: ->\n        return @q.all([\n            @.refreshTagsColors(),\n            @.loadSprintStats(),\n            @.loadSprint().then(=> @.loadTasks())\n        ])\n\n    loadInitialData: ->\n        params = {\n            pslug: @params.pslug\n            sslug: @params.sslug\n        }\n\n        promise = @repo.resolve(params).then (data) =>\n            @scope.projectId = data.project\n            @scope.sprintId = data.milestone\n            @.initializeSubscription()\n            return data\n\n        return promise.then(=> @.loadProject())\n                      .then(=> @.loadTaskboard())\n\n    refreshTasksOrder: (tasks) ->\n            items = @.resortTasks(tasks)\n            data = @.prepareBulkUpdateData(items)\n\n            return @rs.tasks.bulkUpdateTaskTaskboardOrder(@scope.project.id, data)\n\n    resortTasks: (tasks) ->\n        items = []\n\n        for item, index in tasks\n            item[\"taskboard_order\"] = index\n            if item.isModified()\n                items.push(item)\n\n        return items\n\n    prepareBulkUpdateData: (uses) ->\n         return _.map(uses, (x) -> {\"task_id\": x.id, \"order\": x[\"taskboard_order\"]})\n\n    taskMove: (ctx, task, usId, statusId, order) ->\n        # Remove task from old position\n        r = @scope.usTasks[task.user_story][task.status].indexOf(task)\n        @scope.usTasks[task.user_story][task.status].splice(r, 1)\n\n        # Add task to new position\n        tasks = @scope.usTasks[usId][statusId]\n        tasks.splice(order, 0, task)\n\n        task.user_story = usId\n        task.status = statusId\n        task.taskboard_order = order\n\n        promise = @repo.save(task)\n\n        @rootscope.$broadcast(\"sprint:task:moved\", task)\n\n        promise.then =>\n            @.refreshTasksOrder(tasks)\n            @.loadSprintStats()\n\n        promise.then null, =>\n            console.log \"FAIL TASK SAVE\"\n\n    ## Template actions\n    addNewTask: (type, us) ->\n        switch type\n            when \"standard\" then @rootscope.$broadcast(\"taskform:new\", @scope.sprintId, us?.id)\n            when \"bulk\" then @rootscope.$broadcast(\"taskform:bulk\", @scope.sprintId, us?.id)\n\n    editTaskAssignedTo: (task) ->\n        @rootscope.$broadcast(\"assigned-to:add\", task)\n\nmodule.controller(\"TaskboardController\", TaskboardController)\n\n\n#############################################################################\n## TaskboardDirective\n#############################################################################\n\nTaskboardDirective = ($rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        $el.on \"click\", \".toggle-analytics-visibility\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            target.toggleClass('active')\n            $rootscope.$broadcast(\"taskboard:graph:toggle-visibility\")\n\n        tableBodyDom = $el.find(\".taskboard-table-body\")\n        tableBodyDom.on \"scroll\", (event) ->\n            target = angular.element(event.currentTarget)\n            tableHeaderDom = $el.find(\".taskboard-table-header .taskboard-table-inner\")\n            tableHeaderDom.css(\"left\", -1 * target.scrollLeft())\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgTaskboard\", [\"$rootScope\", TaskboardDirective])\n\n\n#############################################################################\n## Taskboard Task Directive\n#############################################################################\n\nTaskboardTaskDirective = ($rootscope, $loading, $rs) ->\n    link = ($scope, $el, $attrs, $model) ->\n        $el.disableSelection()\n\n        $scope.$watch \"task\", (task) ->\n            if task.is_blocked and not $el.hasClass(\"blocked\")\n                $el.addClass(\"blocked\")\n            else if not task.is_blocked and $el.hasClass(\"blocked\")\n                $el.removeClass(\"blocked\")\n\n        $el.find(\".icon-edit\").on \"click\", (event) ->\n            if $el.find('.icon-edit').hasClass('noclick')\n                return\n            $scope.$apply ->\n                target = $(event.target)\n\n                currentLoading = $loading()\n                    .target(target)\n                    .timeout(200)\n                    .removeClasses(\"icon-edit\")\n                    .start()\n\n                task = $scope.task\n                $rs.tasks.getByRef(task.project, task.ref).then (editingTask) =>\n                    $rootscope.$broadcast(\"taskform:edit\", editingTask)\n                    currentLoading.finish()\n\n    return {link:link}\n\n\nmodule.directive(\"tgTaskboardTask\", [\"$rootScope\", \"$tgLoading\", \"$tgResources\", TaskboardTaskDirective])\n\n#############################################################################\n## Taskboard Squish Column Directive\n#############################################################################\n\nTaskboardSquishColumnDirective = (rs) ->\n    avatarWidth = 40\n    maxColumnWidth = 300\n\n    link = ($scope, $el, $attrs) ->\n        $scope.$on \"sprint:task:moved\", () =>\n            recalculateTaskboardWidth()\n\n        bindOnce $scope, \"usTasks\", (project) ->\n            $scope.statusesFolded = rs.tasks.getStatusColumnModes($scope.project.id)\n            $scope.usFolded = rs.tasks.getUsRowModes($scope.project.id, $scope.sprintId)\n\n            recalculateTaskboardWidth()\n\n        $scope.foldStatus = (status) ->\n            $scope.statusesFolded[status.id] = !!!$scope.statusesFolded[status.id]\n            rs.tasks.storeStatusColumnModes($scope.projectId, $scope.statusesFolded)\n\n            recalculateTaskboardWidth()\n\n        $scope.foldUs = (us) ->\n            if !us\n                $scope.usFolded[null] = !!!$scope.usFolded[null]\n            else\n                $scope.usFolded[us.id] = !!!$scope.usFolded[us.id]\n\n            rs.tasks.storeUsRowModes($scope.projectId, $scope.sprintId, $scope.usFolded)\n\n            recalculateTaskboardWidth()\n\n        getCeilWidth = (usId, statusId) =>\n            tasks = $scope.usTasks[usId][statusId].length\n\n            if $scope.statusesFolded[statusId]\n                if tasks and $scope.usFolded[usId]\n                    tasksMatrixSize = Math.round(Math.sqrt(tasks))\n                    width = avatarWidth * tasksMatrixSize\n                else\n                    width = avatarWidth\n\n                return width\n\n            return 0\n\n        setStatusColumnWidth = (statusId, width) =>\n            column = $el.find(\".squish-status-#{statusId}\")\n\n            if width\n                column.css('max-width', width)\n            else\n                column.css(\"max-width\", maxColumnWidth)\n\n        refreshTaskboardTableWidth = () =>\n            columnWidths = []\n\n            columns = $el.find(\".task-colum-name\")\n\n            columnWidths = _.map columns, (column) ->\n                return $(column).outerWidth(true)\n\n            totalWidth = _.reduce columnWidths, (total, width) ->\n                return total + width\n\n            $el.find('.taskboard-table-inner').css(\"width\", totalWidth)\n\n        recalculateStatusColumnWidth = (statusId) =>\n            #unassigned ceil\n            statusFoldedWidth = getCeilWidth(null, statusId)\n\n            _.forEach $scope.userstories, (us) ->\n                width = getCeilWidth(us.id, statusId)\n                statusFoldedWidth = width if width > statusFoldedWidth\n\n            setStatusColumnWidth(statusId, statusFoldedWidth)\n\n        recalculateTaskboardWidth = () =>\n            _.forEach $scope.taskStatusList, (status) ->\n                recalculateStatusColumnWidth(status.id)\n\n            refreshTaskboardTableWidth()\n\n            return\n\n    return {link: link}\n\nmodule.directive(\"tgTaskboardSquishColumn\", [\"$tgResources\", TaskboardSquishColumnDirective])\n\n#############################################################################\n## Taskboard User Directive\n#############################################################################\n\nTaskboardUserDirective = ($log) ->\n    clickable = false\n\n    link = ($scope, $el, $attrs) ->\n        username_label = $el.parent().find(\"a.task-assigned\")\n        username_label.addClass(\"not-clickable\")\n\n        $scope.$watch 'task.assigned_to', (assigned_to) ->\n            user = $scope.usersById[assigned_to]\n\n            if user is undefined\n                _.assign($scope, {name: \"Unassigned\", imgurl: \"/images/unnamed.png\", clickable: clickable})\n            else\n                _.assign($scope, {name: user.full_name_display, imgurl: user.photo, clickable: clickable})\n\n            username_label.text($scope.name)\n\n\n        bindOnce $scope, \"project\", (project) ->\n            if project.my_permissions.indexOf(\"modify_task\") > -1\n                clickable = true\n                $el.find(\".avatar-assigned-to\").on \"click\", (event) =>\n                    if $el.find('a').hasClass('noclick')\n                        return\n\n                    $ctrl = $el.controller()\n                    $ctrl.editTaskAssignedTo($scope.task)\n\n                username_label.removeClass(\"not-clickable\")\n                username_label.on \"click\", (event) ->\n                    if $el.find('a').hasClass('noclick')\n                        return\n\n                    $ctrl = $el.controller()\n                    $ctrl.editTaskAssignedTo($scope.task)\n\n\n    return {\n        link: link,\n        templateUrl: \"taskboard/taskboard-user.html\",\n        scope: {\n            \"usersById\": \"=users\",\n            \"project\": \"=\",\n            \"task\": \"=\",\n        }\n    }\n\n\nmodule.directive(\"tgTaskboardUserAvatar\", [\"$log\", TaskboardUserDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/taskboard/sortable.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\n\nmodule = angular.module(\"taigaBacklog\")\n\n\n#############################################################################\n## Sortable Directive\n#############################################################################\n\nTaskboardSortableDirective = ($repo, $rs, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions we don't enable the sortable\n            if not (project.my_permissions.indexOf(\"modify_us\") > -1)\n                return\n\n            oldParentScope = null\n            newParentScope = null\n            itemEl = null\n            tdom = $el\n\n            deleteElement = (itemEl) ->\n                # Completelly remove item and its scope from dom\n                itemEl.scope().$destroy()\n                itemEl.off()\n                itemEl.remove()\n\n            tdom.sortable({\n                handle: \".taskboard-task-inner\",\n                dropOnEmpty: true\n                connectWith: \".taskboard-tasks-box\"\n                revert: 400\n            })\n\n            tdom.on \"sortstop\", (event, ui) ->\n                parentEl = ui.item.parent()\n                itemEl = ui.item\n                itemTask = itemEl.scope().task\n                itemIndex = itemEl.index()\n                newParentScope = parentEl.scope()\n\n                oldUsId = if oldParentScope.us then oldParentScope.us.id else null\n                oldStatusId = oldParentScope.st.id\n                newUsId = if newParentScope.us then newParentScope.us.id else null\n                newStatusId = newParentScope.st.id\n\n                if newStatusId != oldStatusId or newUsId != oldUsId\n                    deleteElement(itemEl)\n\n                $scope.$apply ->\n                    $rootscope.$broadcast(\"taskboard:task:move\", itemTask, newUsId, newStatusId, itemIndex)\n\n                ui.item.find('a').removeClass('noclick')\n\n            tdom.on \"sortstart\", (event, ui) ->\n                oldParentScope = ui.item.parent().scope()\n                ui.item.find('a').addClass('noclick')\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgTaskboardSortable\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    TaskboardSortableDirective\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/kanban/main.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\ntimeout = @.taiga.timeout\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaKanban\")\n\n# Vars\n\ndefaultViewMode = \"maximized\"\nviewModes = [\n    \"maximized\",\n    \"minimized\"\n]\n\n\n#############################################################################\n## Kanban Controller\n#############################################################################\n\nclass KanbanController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgEvents\",\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location,\n                  @appMetaService, @navUrls, @events, @analytics, @translate) ->\n\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"KANBAN.SECTION_NAME\")\n        @scope.statusViewModes = {}\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            title = @translate.instant(\"KANBAN.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @translate.instant(\"KANBAN.PAGE_DESCRIPTION\", {\n                projectName: @scope.project.name,\n                projectDescription: @scope.project.description\n            })\n            @appMetaService.setAll(title, description)\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    initializeEventHandlers: ->\n        @scope.$on \"usform:new:success\", =>\n            @.loadUserstories()\n            @.refreshTagsColors()\n            @analytics.trackEvent(\"userstory\", \"create\", \"create userstory on kanban\", 1)\n\n        @scope.$on \"usform:bulk:success\", =>\n            @.loadUserstories()\n            @analytics.trackEvent(\"userstory\", \"create\", \"bulk create userstory on kanban\", 1)\n\n        @scope.$on \"usform:edit:success\", =>\n            @.loadUserstories()\n            @.refreshTagsColors()\n\n        @scope.$on(\"assigned-to:added\", @.onAssignedToChanged)\n        @scope.$on(\"kanban:us:move\", @.moveUs)\n        @scope.$on(\"kanban:show-userstories-for-status\", @.loadUserStoriesForStatus)\n        @scope.$on(\"kanban:hide-userstories-for-status\", @.hideUserStoriesForStatus)\n\n    # Template actions\n\n    addNewUs: (type, statusId) ->\n        switch type\n            when \"standard\" then @rootscope.$broadcast(\"usform:new\", @scope.projectId, statusId, @scope.usStatusList)\n            when \"bulk\" then @rootscope.$broadcast(\"usform:bulk\", @scope.projectId, statusId)\n\n    changeUsAssignedTo: (us) ->\n        @rootscope.$broadcast(\"assigned-to:add\", us)\n\n    # Scope Events Handlers\n\n    onAssignedToChanged: (ctx, userid, us) ->\n        us.assigned_to = userid\n\n        promise = @repo.save(us)\n        promise.then null, ->\n            console.log \"FAIL\" # TODO\n\n    # Load data methods\n    refreshTagsColors: ->\n        return @rs.projects.tagsColors(@scope.projectId).then (tags_colors) =>\n            @scope.project.tags_colors = tags_colors\n\n    loadUserstories: ->\n        params = {\n            status__is_archived: false\n        }\n\n        return @rs.userstories.listAll(@scope.projectId, params).then (userstories) =>\n            @scope.userstories = userstories\n\n            usByStatus = _.groupBy(userstories, \"status\")\n            us_archived = []\n            for status in @scope.usStatusList\n                if not usByStatus[status.id]?\n                    usByStatus[status.id] = []\n                if @scope.usByStatus?\n                    for us in @scope.usByStatus[status.id]\n                        if us.status != status.id\n                            us_archived.push(us)\n\n                # Must preserve the archived columns if loaded\n                if status.is_archived and @scope.usByStatus? and @scope.usByStatus[status.id].length != 0\n                    for us in @scope.usByStatus[status.id].concat(us_archived)\n                        if us.status == status.id\n                            usByStatus[status.id].push(us)\n\n                usByStatus[status.id] = _.sortBy(usByStatus[status.id], \"kanban_order\")\n\n            if userstories.length == 0\n                status = @scope.usStatusList[0]\n                usByStatus[status.id].push({isPlaceholder: true})\n\n            @scope.usByStatus = usByStatus\n\n            # The broadcast must be executed when the DOM has been fully reloaded.\n            # We can't assure when this exactly happens so we need a defer\n            scopeDefer @scope, =>\n                @scope.$broadcast(\"userstories:loaded\", userstories)\n\n            return userstories\n\n    loadUserStoriesForStatus: (ctx, statusId) ->\n        params = { status: statusId }\n        return @rs.userstories.listAll(@scope.projectId, params).then (userstories) =>\n            @scope.usByStatus[statusId] = _.sortBy(userstories, \"kanban_order\")\n            @scope.$broadcast(\"kanban:shown-userstories-for-status\", statusId, userstories)\n            return userstories\n\n    hideUserStoriesForStatus: (ctx, statusId) ->\n        @scope.usByStatus[statusId] = []\n        @scope.$broadcast(\"kanban:hidden-userstories-for-status\", statusId)\n\n    loadKanban: ->\n        return @q.all([\n            @.refreshTagsColors(),\n            @.loadUserstories()\n        ])\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.is_kanban_activated\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.projectId = project.id\n            @scope.points = _.sortBy(project.points, \"order\")\n            @scope.pointsById = groupBy(project.points, (x) -> x.id)\n            @scope.usStatusById = groupBy(project.us_statuses, (x) -> x.id)\n            @scope.usStatusList = _.sortBy(project.us_statuses, \"order\")\n\n            @.generateStatusViewModes()\n\n            @scope.$emit(\"project:loaded\", project)\n            return project\n\n    initializeSubscription: ->\n        routingKey1 = \"changes.project.#{@scope.projectId}.userstories\"\n        @events.subscribe @scope, routingKey1, (message) =>\n            @.loadUserstories()\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.initializeSubscription()\n            @.loadKanban().then( => @scope.$broadcast(\"redraw:wip\"))\n\n\n    ## View Mode methods\n\n    generateStatusViewModes: ->\n        storedStatusViewModes = @rs.kanban.getStatusViewModes(@scope.projectId)\n\n        @scope.statusViewModes = {}\n        for status in @scope.usStatusList\n            mode = storedStatusViewModes[status.id] || defaultViewMode\n\n            @scope.statusViewModes[status.id] = mode\n\n        @.storeStatusViewModes()\n\n    storeStatusViewModes: ->\n        @rs.kanban.storeStatusViewModes(@scope.projectId, @scope.statusViewModes)\n\n    updateStatusViewMode: (statusId, newViewMode) ->\n        @scope.statusViewModes[statusId] = newViewMode\n        @.storeStatusViewModes()\n\n    isMaximized: (statusId) ->\n        mode = @scope.statusViewModes[statusId] or defaultViewMode\n        return mode == 'maximized'\n\n    isMinimized: (statusId) ->\n        mode = @scope.statusViewModes[statusId] or defaultViewMode\n        return mode == 'minimized'\n\n    # Utils methods\n\n    prepareBulkUpdateData: (uses, field=\"kanban_order\") ->\n        return _.map(uses, (x) -> {\"us_id\": x.id, \"order\": x[field]})\n\n    resortUserStories: (uses) ->\n        items = []\n        for item, index in uses\n            item.kanban_order = index\n            if item.isModified()\n                items.push(item)\n\n        return items\n\n    moveUs: (ctx, us, oldStatusId, newStatusId, index) ->\n        if oldStatusId != newStatusId\n            # Remove us from old status column\n            r = @scope.usByStatus[oldStatusId].indexOf(us)\n            @scope.usByStatus[oldStatusId].splice(r, 1)\n\n            # Add us to new status column.\n            @scope.usByStatus[newStatusId].splice(index, 0, us)\n            us.status = newStatusId\n        else\n            r = @scope.usByStatus[newStatusId].indexOf(us)\n            @scope.usByStatus[newStatusId].splice(r, 1)\n            @scope.usByStatus[newStatusId].splice(index, 0, us)\n\n        itemsToSave = @.resortUserStories(@scope.usByStatus[newStatusId])\n        @scope.usByStatus[newStatusId] = _.sortBy(@scope.usByStatus[newStatusId], \"kanban_order\")\n\n        # Persist the userstory\n        promise = @repo.save(us)\n\n        # Rehash userstories order field\n        # and persist in bulk all changes.\n        promise = promise.then =>\n            itemsToSave = _.reject(itemsToSave, {\"id\": us.id})\n            data = @.prepareBulkUpdateData(itemsToSave)\n\n            return @rs.userstories.bulkUpdateKanbanOrder(us.project, data).then =>\n                return itemsToSave\n\n        return promise\n\n\nmodule.controller(\"KanbanController\", KanbanController)\n\n#############################################################################\n## Kanban Directive\n#############################################################################\n\nKanbanDirective = ($repo, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        tableBodyDom = $el.find(\".kanban-table-body\")\n\n        tableBodyDom.on \"scroll\", (event) ->\n            target = angular.element(event.currentTarget)\n            tableHeaderDom = $el.find(\".kanban-table-header .kanban-table-inner\")\n            tableHeaderDom.css(\"left\", -1 * target.scrollLeft())\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgKanban\", [\"$tgRepo\", \"$rootScope\", KanbanDirective])\n\n#############################################################################\n## Kanban Archived Status Column Header Control\n#############################################################################\n\nKanbanArchivedStatusHeaderDirective = ($rootscope, $translate) ->\n    showArchivedText = $translate.instant(\"KANBAN.ACTION_SHOW_ARCHIVED\")\n    hideArchivedText = $translate.instant(\"KANBAN.ACTION_HIDE_ARCHIVED\")\n\n    link = ($scope, $el, $attrs) ->\n        status = $scope.$eval($attrs.tgKanbanArchivedStatusHeader)\n        hidden = true\n\n        $scope.class = \"icon-open-eye\"\n        $scope.title = showArchivedText\n\n        $el.on \"click\", (event) ->\n            hidden = not hidden\n\n            $scope.$apply ->\n                if hidden\n                    $scope.class = \"icon-open-eye\"\n                    $scope.title = showArchivedText\n                    $rootscope.$broadcast(\"kanban:hide-userstories-for-status\", status.id)\n\n                else\n                    $scope.class = \"icon-closed-eye\"\n                    $scope.title = hideArchivedText\n                    $rootscope.$broadcast(\"kanban:show-userstories-for-status\", status.id)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgKanbanArchivedStatusHeader\", [ \"$rootScope\", \"$translate\", KanbanArchivedStatusHeaderDirective])\n\n\n#############################################################################\n## Kanban Archived Status Column Intro Directive\n#############################################################################\n\nKanbanArchivedStatusIntroDirective = ($translate) ->\n    userStories = []\n\n    link = ($scope, $el, $attrs) ->\n        hiddenUserStoriexText = $translate.instant(\"KANBAN.HIDDEN_USER_STORIES\")\n        status = $scope.$eval($attrs.tgKanbanArchivedStatusIntro)\n        $el.text(hiddenUserStoriexText)\n\n        updateIntroText = ->\n            if userStories.length > 0\n                $el.text(\"\")\n            else\n                $el.text(hiddenUserStoriexText)\n\n        $scope.$on \"kanban:us:move\", (ctx, itemUs, oldStatusId, newStatusId, itemIndex) ->\n            # The destination columnd is this one\n            if status.id == newStatusId\n                # Reorder\n                if status.id == oldStatusId\n                    r = userStories.indexOf(itemUs)\n                    userStories.splice(r, 1)\n                    userStories.splice(itemIndex, 0, itemUs)\n\n                # Archiving user story\n                else\n                    itemUs.isArchived = true\n                    userStories.splice(itemIndex, 0, itemUs)\n\n            # Unarchiving user story\n            else if status.id == oldStatusId\n                itemUs.isArchived = false\n                r = userStories.indexOf(itemUs)\n                userStories.splice(r, 1)\n\n            updateIntroText()\n\n        $scope.$on \"kanban:shown-userstories-for-status\", (ctx, statusId, userStoriesLoaded) ->\n            if statusId == status.id\n                userStories = _.filter(userStoriesLoaded, (us) -> us.status == status.id)\n                updateIntroText()\n\n        $scope.$on \"kanban:hidden-userstories-for-status\", (ctx, statusId) ->\n            if statusId == status.id\n                userStories = []\n                updateIntroText()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgKanbanArchivedStatusIntro\", [\"$translate\", KanbanArchivedStatusIntroDirective])\n\n\n#############################################################################\n## Kanban User Story Directive\n#############################################################################\n\nKanbanUserstoryDirective = ($rootscope, $loading, $rs) ->\n    link = ($scope, $el, $attrs, $model) ->\n        $el.disableSelection()\n\n        $scope.$watch \"us\", (us) ->\n            if us.is_blocked and not $el.hasClass(\"blocked\")\n                $el.addClass(\"blocked\")\n            else if not us.is_blocked and $el.hasClass(\"blocked\")\n                $el.removeClass(\"blocked\")\n\n        $el.on 'click', '.icon-edit', (event) ->\n            if $el.find(\".icon-edit\").hasClass(\"noclick\")\n                return\n\n            target = $(event.target)\n\n            currentLoading = $loading()\n                .target(target)\n                .timeout(200)\n                .removeClasses(\"icon-edit\")\n                .start()\n\n            us = $model.$modelValue\n            $rs.userstories.getByRef(us.project, us.ref).then (editingUserStory) =>\n                $rootscope.$broadcast(\"usform:edit\", editingUserStory)\n                currentLoading.finish()\n\n        $scope.getTemplateUrl = () ->\n            if $scope.us.isPlaceholder\n                return \"common/components/kanban-placeholder.html\"\n            else\n                return \"kanban/kanban-task.html\"\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        template: '<ng-include src=\"getTemplateUrl()\"/>',\n        link: link\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgKanbanUserstory\", [\"$rootScope\", \"$tgLoading\", \"$tgResources\", KanbanUserstoryDirective])\n\n#############################################################################\n## Kanban Squish Column Directive\n#############################################################################\n\nKanbanSquishColumnDirective = (rs) ->\n\n    link = ($scope, $el, $attrs) ->\n        $scope.$on \"project:loaded\", (event, project) ->\n            $scope.folds = rs.kanban.getStatusColumnModes(project.id)\n            updateTableWidth()\n\n        $scope.foldStatus = (status) ->\n            $scope.folds[status.id] = !!!$scope.folds[status.id]\n            rs.kanban.storeStatusColumnModes($scope.projectId, $scope.folds)\n            updateTableWidth()\n            return\n\n        updateTableWidth = ->\n            columnWidths = _.map $scope.usStatusList, (status) ->\n                if $scope.folds[status.id]\n                    return 40\n                else\n                    return 310\n            totalWidth = _.reduce columnWidths, (total, width) ->\n                return total + width\n            $el.find('.kanban-table-inner').css(\"width\", totalWidth)\n\n    return {link: link}\n\nmodule.directive(\"tgKanbanSquishColumn\", [\"$tgResources\", KanbanSquishColumnDirective])\n\n#############################################################################\n## Kanban WIP Limit Directive\n#############################################################################\n\nKanbanWipLimitDirective = ->\n    link = ($scope, $el, $attrs) ->\n        $el.disableSelection()\n\n        status = $scope.$eval($attrs.tgKanbanWipLimit)\n\n        redrawWipLimit = =>\n            $el.find(\".kanban-wip-limit\").remove()\n            timeout 200, =>\n                element = $el.find(\".kanban-task\")[status.wip_limit]\n                if element\n                    angular.element(element).before(\"<div class='kanban-wip-limit'></div>\")\n\n        if status and not status.is_archived\n            $scope.$on \"redraw:wip\", redrawWipLimit\n            $scope.$on \"kanban:us:move\", redrawWipLimit\n            $scope.$on \"usform:new:success\", redrawWipLimit\n            $scope.$on \"usform:bulk:success\", redrawWipLimit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgKanbanWipLimit\", KanbanWipLimitDirective)\n\n\n#############################################################################\n## Kanban User Directive\n#############################################################################\n\nKanbanUserDirective = ($log, $compile) ->\n    template = _.template(\"\"\"\n    <figure class=\"avatar\">\n        <a href=\"#\" title=\"{{'US.ASSIGN' | translate}}\" <% if (!clickable) {%>class=\"not-clickable\"<% } %>>\n            <img src=\"<%- imgurl %>\" alt=\"<%- name %>\" class=\"avatar\">\n        </a>\n    </figure>\n    \"\"\")\n\n    clickable = false\n\n    link = ($scope, $el, $attrs, $model) ->\n        username_label = $el.parent().find(\"a.task-assigned\")\n        username_label.addClass(\"not-clickable\")\n\n        if not $attrs.tgKanbanUserAvatar\n            return $log.error \"KanbanUserDirective: no attr is defined\"\n\n        wtid = $scope.$watch $attrs.tgKanbanUserAvatar, (v) ->\n            if not $scope.usersById?\n                $log.error \"KanbanUserDirective requires userById set in scope.\"\n                wtid()\n            else\n                user = $scope.usersById[v]\n                render(user)\n\n        render = (user) ->\n            if user is undefined\n                ctx = {name: \"Unassigned\", imgurl: \"/images/unnamed.png\", clickable: clickable}\n            else\n                ctx = {name: user.full_name_display, imgurl: user.photo, clickable: clickable}\n\n            html = $compile(template(ctx))($scope)\n            $el.html(html)\n            username_label.text(ctx.name)\n\n        bindOnce $scope, \"project\", (project) ->\n            if project.my_permissions.indexOf(\"modify_us\") > -1\n                clickable = true\n                $el.on \"click\", (event) =>\n                    if $el.find(\"a\").hasClass(\"noclick\")\n                        return\n\n                    us = $model.$modelValue\n                    $ctrl = $el.controller()\n                    $ctrl.changeUsAssignedTo(us)\n\n                username_label.removeClass(\"not-clickable\")\n                username_label.on \"click\", (event) ->\n                    if $el.find(\"a\").hasClass(\"noclick\")\n                        return\n\n                    us = $model.$modelValue\n                    $ctrl = $el.controller()\n                    $ctrl.changeUsAssignedTo(us)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link, require:\"ngModel\"}\n\nmodule.directive(\"tgKanbanUserAvatar\", [\"$log\", \"$compile\", KanbanUserDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/kanban/sortable.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoggleText = @.taiga.toggleText\nscopeDefer = @.taiga.scopeDefer\nbindOnce = @.taiga.bindOnce\ngroupBy = @.taiga.groupBy\ntimeout = @.taiga.timeout\n\nmodule = angular.module(\"taigaKanban\")\n\n\n#############################################################################\n## Sortable Directive\n#############################################################################\n\nKanbanSortableDirective = ($repo, $rs, $rootscope) ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, \"project\", (project) ->\n            if not (project.my_permissions.indexOf(\"modify_us\") > -1)\n                return\n\n            oldParentScope = null\n            newParentScope = null\n            itemEl = null\n            tdom = $el\n\n            deleteElement = (itemEl) ->\n                # Completelly remove item and its scope from dom\n                itemEl.scope().$destroy()\n                itemEl.off()\n                itemEl.remove()\n\n            tdom.sortable({\n                handle: \".kanban-task-inner\"\n                dropOnEmpty: true\n                connectWith: \".kanban-uses-box\"\n                revert: 400\n            })\n\n            tdom.on \"sortstop\", (event, ui) ->\n                parentEl = ui.item.parent()\n                itemEl = ui.item\n                itemUs = itemEl.scope().us\n                itemIndex = itemEl.index()\n                newParentScope = parentEl.scope()\n\n                newStatusId = newParentScope.s.id\n                oldStatusId = oldParentScope.s.id\n\n                if newStatusId != oldStatusId\n                    deleteElement(itemEl)\n\n                $scope.$apply ->\n                    $rootscope.$broadcast(\"kanban:us:move\", itemUs, itemUs.status, newStatusId, itemIndex)\n\n                ui.item.find('a').removeClass('noclick')\n\n            tdom.on \"sortstart\", (event, ui) ->\n                oldParentScope = ui.item.parent().scope()\n                ui.item.find('a').addClass('noclick')\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgKanbanSortable\", [\n    \"$tgRepo\",\n    \"$tgResources\",\n    \"$rootScope\",\n    KanbanSortableDirective\n])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/issues/detail.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntoString = @.taiga.toString\njoinStr = @.taiga.joinStr\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaIssues\")\n\n#############################################################################\n## Issue Detail Controller\n#############################################################################\n\nclass IssueDetailController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$log\",\n        \"tgAppMetaService\",\n        \"$tgAnalytics\",\n        \"$tgNavUrls\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location,\n                  @log, @appMetaService, @analytics, @navUrls, @translate) ->\n        bindMethods(@)\n\n        @scope.issueRef = @params.issueref\n        @scope.sectionName = @translate.instant(\"ISSUES.SECTION_NAME\")\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            @._setMeta()\n            @.initializeOnDeleteGoToUrl()\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    _setMeta: ->\n        title = @translate.instant(\"ISSUE.PAGE_TITLE\", {\n            issueRef: \"##{@scope.issue.ref}\"\n            issueSubject: @scope.issue.subject\n            projectName: @scope.project.name\n        })\n        description = @translate.instant(\"ISSUE.PAGE_DESCRIPTION\", {\n            issueStatus: @scope.statusById[@scope.issue.status]?.name or \"--\"\n            issueType: @scope.typeById[@scope.issue.type]?.name or \"--\"\n            issueSeverity: @scope.severityById[@scope.issue.severity]?.name or \"--\"\n            issuePriority: @scope.priorityById[@scope.issue.priority]?.name or \"--\"\n            issueDescription: angular.element(@scope.issue.description_html or \"\").text()\n        })\n        @appMetaService.setAll(title, description)\n\n    initializeEventHandlers: ->\n        @scope.$on \"attachment:create\", =>\n            @analytics.trackEvent(\"attachment\", \"create\", \"create attachment on issue\", 1)\n\n        @scope.$on \"promote-issue-to-us:success\", =>\n            @analytics.trackEvent(\"issue\", \"promoteToUserstory\", \"promote issue to userstory\", 1)\n            @rootscope.$broadcast(\"object:updated\")\n            @.loadIssue()\n\n        @scope.$on \"comment:new\", =>\n            @.loadIssue()\n\n        @scope.$on \"custom-attributes-values:edit\", =>\n            @rootscope.$broadcast(\"object:updated\")\n\n    initializeOnDeleteGoToUrl: ->\n       ctx = {project: @scope.project.slug}\n       if @scope.project.is_issues_activated\n           @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-issues\", ctx)\n       else\n           @scope.onDeleteGoToUrl = @navUrls.resolve(\"project\", ctx)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            @scope.statusList = project.issue_statuses\n            @scope.statusById = groupBy(project.issue_statuses, (x) -> x.id)\n            @scope.typeById = groupBy(project.issue_types, (x) -> x.id)\n            @scope.typeList = _.sortBy(project.issue_types, \"order\")\n            @scope.severityList = project.severities\n            @scope.severityById = groupBy(project.severities, (x) -> x.id)\n            @scope.priorityList = project.priorities\n            @scope.priorityById = groupBy(project.priorities, (x) -> x.id)\n            return project\n\n    loadIssue: ->\n        return @rs.issues.getByRef(@scope.projectId, @params.issueref).then (issue) =>\n            @scope.issue = issue\n            @scope.issueId = issue.id\n            @scope.commentModel = issue\n\n            if @scope.issue.neighbors.previous.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.issue.neighbors.previous.ref\n                }\n                @scope.previousUrl = @navUrls.resolve(\"project-issues-detail\", ctx)\n\n            if @scope.issue.neighbors.next.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.issue.neighbors.next.ref\n                }\n                @scope.nextUrl = @navUrls.resolve(\"project-issues-detail\", ctx)\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.loadIssue()\n\n    ###\n    # Note: This methods (onUpvote() and onDownvote()) are related to tg-vote-button.\n    #       See app/modules/components/vote-button for more info\n    ###\n    onUpvote: ->\n        onSuccess = =>\n            @.loadIssue()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.issues.upvote(@scope.issueId).then(onSuccess, onError)\n\n    onDownvote: ->\n        onSuccess = =>\n            @.loadIssue()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.issues.downvote(@scope.issueId).then(onSuccess, onError)\n\n    ###\n    # Note: This methods (onWatch() and onUnwatch()) are related to tg-watch-button.\n    #       See app/modules/components/watch-button for more info\n    ###\n    onWatch: ->\n        onSuccess = =>\n            @.loadIssue()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.issues.watch(@scope.issueId).then(onSuccess, onError)\n\n    onUnwatch: ->\n        onSuccess = =>\n            @.loadIssue()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.issues.unwatch(@scope.issueId).then(onSuccess, onError)\n\nmodule.controller(\"IssueDetailController\", IssueDetailController)\n\n\n#############################################################################\n## Issue status display directive\n#############################################################################\n\nIssueStatusDisplayDirective = ($template, $compile)->\n    # Display if a Issue is open or closed and its issueboard status.\n    #\n    # Example:\n    #     tg-issue-status-display(ng-model=\"issue\")\n    #\n    # Requirements:\n    #   - Issue object (ng-model)\n    #   - scope.statusById object\n\n    template = $template.get(\"common/components/status-display.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        render = (issue) ->\n            status = $scope.statusById[issue.status]\n\n            html = template({\n                is_closed: status.is_closed\n                status: status\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        $scope.$watch $attrs.ngModel, (issue) ->\n            render(issue) if issue?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgIssueStatusDisplay\", [\"$tgTemplate\", \"$compile\", IssueStatusDisplayDirective])\n\n\n#############################################################################\n## Issue status button directive\n#############################################################################\n\nIssueStatusButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $template, $compile) ->\n    # Display the status of Issue and you can edit it.\n    #\n    # Example:\n    #     tg-issue-status-button(ng-model=\"issue\")\n    #\n    # Requirements:\n    #   - Issue object (ng-model)\n    #   - scope.statusById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"issue/issues-status-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_issue\") != -1\n\n        render = (issue) =>\n            status = $scope.statusById[issue.status]\n\n            html = template({\n                status: status\n                statuses: $scope.statusList\n                editable: isEditable()\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (statusId) =>\n            $.fn.popover().closeAll()\n\n            issue = $model.$modelValue.clone()\n            issue.status = statusId\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $confirm.notify(\"success\")\n                $model.$setViewValue(issue)\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n            onError = ->\n                $confirm.notify(\"error\")\n                issue.revert()\n                $model.$setViewValue(issue)\n                currentLoading.finish()\n\n\n            $repo.save(issue).then(onSuccess, onError)\n\n        $el.on \"click\", \".status-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-status\").popover().open()\n\n        $el.on \"click\", \".status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n\n            save(target.data(\"status-id\"))\n\n        $scope.$watch $attrs.ngModel, (issue) ->\n            render(issue) if issue\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgIssueStatusButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\", IssueStatusButtonDirective])\n\n#############################################################################\n## Issue type button directive\n#############################################################################\n\nIssueTypeButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $template, $compile) ->\n    # Display the type of Issue and you can edit it.\n    #\n    # Example:\n    #     tg-issue-type-button(ng-model=\"issue\")\n    #\n    # Requirements:\n    #   - Issue object (ng-model)\n    #   - scope.typeById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"issue/issue-type-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_issue\") != -1\n\n        render = (issue) =>\n            type = $scope.typeById[issue.type]\n\n            html = template({\n                type: type\n                typees: $scope.typeList\n                editable: isEditable()\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (type) =>\n            $.fn.popover().closeAll()\n            issue = $model.$modelValue.clone()\n            issue.type = type\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $confirm.notify(\"success\")\n                $model.$setViewValue(issue)\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n\n            onError = ->\n                $confirm.notify(\"error\")\n                issue.revert()\n                $model.$setViewValue(issue)\n                currentLoading.finish()\n\n            $repo.save(issue).then(onSuccess, onError)\n\n        $el.on \"click\", \".type-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-type\").popover().open()\n\n        $el.on \"click\", \".type\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n            type = target.data(\"type-id\")\n            save(type)\n\n        $scope.$watch $attrs.ngModel, (issue) ->\n            render(issue) if issue\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgIssueTypeButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\", IssueTypeButtonDirective])\n\n\n#############################################################################\n## Issue severity button directive\n#############################################################################\n\nIssueSeverityButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $template, $compile) ->\n    # Display the severity of Issue and you can edit it.\n    #\n    # Example:\n    #     tg-issue-severity-button(ng-model=\"issue\")\n    #\n    # Requirements:\n    #   - Issue object (ng-model)\n    #   - scope.severityById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"issue/issue-severity-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_issue\") != -1\n\n        render = (issue) =>\n            severity = $scope.severityById[issue.severity]\n\n            html = template({\n                severity: severity\n                severityes: $scope.severityList\n                editable: isEditable()\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (severity) =>\n            $.fn.popover().closeAll()\n\n            issue = $model.$modelValue.clone()\n            issue.severity = severity\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $confirm.notify(\"success\")\n                $model.$setViewValue(issue)\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n            onError = ->\n                $confirm.notify(\"error\")\n                issue.revert()\n                $model.$setViewValue(issue)\n                currentLoading.finish()\n\n            $repo.save(issue).then(onSuccess, onError)\n\n        $el.on \"click\", \".severity-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-severity\").popover().open()\n\n        $el.on \"click\", \".severity\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n            severity = target.data(\"severity-id\")\n\n            save(severity)\n\n        $scope.$watch $attrs.ngModel, (issue) ->\n            render(issue) if issue\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgIssueSeverityButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\", IssueSeverityButtonDirective])\n\n\n#############################################################################\n## Issue priority button directive\n#############################################################################\n\nIssuePriorityButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $template, $compile) ->\n    # Display the priority of Issue and you can edit it.\n    #\n    # Example:\n    #     tg-issue-priority-button(ng-model=\"issue\")\n    #\n    # Requirements:\n    #   - Issue object (ng-model)\n    #   - scope.priorityById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"issue/issue-priority-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_issue\") != -1\n\n        render = (issue) =>\n            priority = $scope.priorityById[issue.priority]\n\n            html = template({\n                priority: priority\n                priorityes: $scope.priorityList\n                editable: isEditable()\n            })\n\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (priority) =>\n            $.fn.popover().closeAll()\n\n            issue = $model.$modelValue.clone()\n            issue.priority = priority\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $confirm.notify(\"success\")\n                $model.$setViewValue(issue)\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n            onError = ->\n                $confirm.notify(\"error\")\n                issue.revert()\n                $model.$setViewValue(issue)\n                currentLoading.finish()\n\n            $repo.save(issue).then(onSuccess, onError)\n\n        $el.on \"click\", \".priority-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-priority\").popover().open()\n\n        $el.on \"click\", \".priority\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n            priority = target.data(\"priority-id\")\n\n            save(priority)\n\n        $scope.$watch $attrs.ngModel, (issue) ->\n            render(issue) if issue\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgIssuePriorityButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\", IssuePriorityButtonDirective])\n\n\n#############################################################################\n## Promote Issue to US button directive\n#############################################################################\n\nPromoteIssueToUsButtonDirective = ($rootScope, $repo, $confirm, $qqueue, $translate) ->\n    link = ($scope, $el, $attrs, $model) ->\n\n        save = $qqueue.bindAdd (issue, askResponse) =>\n            data = {\n                generated_from_issue: issue.id\n                project: issue.project,\n                subject: issue.subject\n                description: issue.description\n                tags: issue.tags\n                is_blocked: issue.is_blocked\n                blocked_note: issue.blocked_note\n            }\n\n            onSuccess = ->\n                askResponse.finish()\n                $confirm.notify(\"success\")\n                $rootScope.$broadcast(\"promote-issue-to-us:success\")\n\n            onError = ->\n                askResponse.finish()\n                $confirm.notify(\"error\")\n\n            $repo.create(\"userstories\", data).then(onSuccess, onError)\n\n\n        $el.on \"click\", \"a\", (event) ->\n            event.preventDefault()\n            issue = $model.$modelValue\n\n            title = $translate.instant(\"ISSUES.CONFIRM_PROMOTE.TITLE\")\n            message = $translate.instant(\"ISSUES.CONFIRM_PROMOTE.MESSAGE\")\n            subtitle = issue.subject\n\n            $confirm.ask(title, subtitle, message).then (response) =>\n                save(issue, response)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        restrict: \"AE\"\n        require: \"ngModel\"\n        templateUrl: \"issue/promote-issue-to-us-button.html\"\n        link: link\n    }\n\nmodule.directive(\"tgPromoteIssueToUsButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgQqueue\", \"$translate\"\n                                              PromoteIssueToUsButtonDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/issues/lightboxes.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaIssues\")\n\n#############################################################################\n## Issue Create Lightbox Directive\n#############################################################################\n\nCreateIssueDirective = ($repo, $confirm, $rootscope, lightboxService, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley()\n        $scope.issue = {}\n\n        $scope.$on \"issueform:new\", (ctx, project)->\n            $el.find(\".tag-input\").val(\"\")\n\n            lightboxService.open($el)\n\n            $scope.issue = {\n                project: project.id\n                subject: \"\"\n                status: project.default_issue_status\n                type: project.default_issue_type\n                priority: project.default_priority\n                severity: project.default_severity\n                tags: []\n            }\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.create(\"issues\", $scope.issue)\n\n            promise.then (data) ->\n                currentLoading.finish()\n                $rootscope.$broadcast(\"issueform:new:success\", data)\n                lightboxService.close($el)\n                $confirm.notify(\"success\")\n\n            promise.then null, ->\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n\n    return {link:link}\n\nmodule.directive(\"tgLbCreateIssue\", [\"$tgRepo\", \"$tgConfirm\", \"$rootScope\", \"lightboxService\", \"$tgLoading\",\n                                     CreateIssueDirective])\n\n\n#############################################################################\n## Issue Bulk Create Lightbox Directive\n#############################################################################\n\nCreateBulkIssuesDirective = ($repo, $rs, $confirm, $rootscope, $loading, lightboxService) ->\n    link = ($scope, $el, attrs) ->\n        $scope.$on \"issueform:bulk\", (ctx, projectId, status)->\n            lightboxService.open($el)\n            $scope.new = {\n                projectId: projectId\n                bulk: \"\"\n            }\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            data = $scope.new.bulk\n            projectId = $scope.new.projectId\n\n            promise = $rs.issues.bulkCreate(projectId, data)\n            promise.then (result) ->\n                currentLoading.finish()\n                $rootscope.$broadcast(\"issueform:new:success\", result)\n                lightboxService.close($el)\n                $confirm.notify(\"success\")\n\n            promise.then null, ->\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgLbCreateBulkIssues\", [\"$tgRepo\", \"$tgResources\", \"$tgConfirm\", \"$rootScope\", \"$tgLoading\",\n                                          \"lightboxService\", CreateBulkIssuesDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/issues/list.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntrim = @.taiga.trim\ntoString = @.taiga.toString\njoinStr = @.taiga.joinStr\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\ndebounceLeading = @.taiga.debounceLeading\nstartswith = @.taiga.startswith\n\nmodule = angular.module(\"taigaIssues\")\n\n#############################################################################\n## Issues Controller\n#############################################################################\n\nclass IssuesController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$tgUrls\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgEvents\",\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @urls, @params, @q, @location, @appMetaService,\n                  @navUrls, @events, @analytics, @translate) ->\n        @scope.sectionName = \"Issues\"\n        @scope.filters = {}\n\n        if _.isEmpty(@location.search())\n            filters = @rs.issues.getFilters(@params.pslug)\n            filters.page = 1\n            @location.search(filters)\n            @location.replace()\n            return\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            title = @translate.instant(\"ISSUES.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @translate.instant(\"ISSUES.PAGE_DESCRIPTION\", {\n                projectName: @scope.project.name,\n                projectDescription: @scope.project.description\n            })\n            @appMetaService.setAll(title, description)\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"issueform:new:success\", =>\n            @analytics.trackEvent(\"issue\", \"create\", \"create issue on issues list\", 1)\n            @.loadIssues()\n\n    initializeSubscription: ->\n        routingKey = \"changes.project.#{@scope.projectId}.issues\"\n        @events.subscribe @scope, routingKey, (message) =>\n            @.loadIssues()\n\n    storeFilters: ->\n        @rs.issues.storeFilters(@params.pslug, @location.search())\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.is_issues_activated\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n\n            @scope.issueStatusById = groupBy(project.issue_statuses, (x) -> x.id)\n            @scope.issueStatusList = _.sortBy(project.issue_statuses, \"order\")\n            @scope.severityById = groupBy(project.severities, (x) -> x.id)\n            @scope.severityList = _.sortBy(project.severities, \"order\")\n            @scope.priorityById = groupBy(project.priorities, (x) -> x.id)\n            @scope.priorityList = _.sortBy(project.priorities, \"order\")\n            @scope.issueTypes = _.sortBy(project.issue_types, \"order\")\n            @scope.issueTypeById = groupBy(project.issue_types, (x) -> x.id)\n\n            return project\n\n    getUrlFilters: ->\n        filters = _.pick(@location.search(), \"page\", \"tags\", \"status\", \"types\",\n                                             \"q\", \"severities\", \"priorities\",\n                                             \"assignedTo\", \"createdBy\", \"orderBy\")\n\n        filters.page = 1 if not filters.page\n        return filters\n\n    getUrlFilter: (name) ->\n        filters = _.pick(@location.search(), name)\n        return filters[name]\n\n    loadMyFilters: ->\n        return @rs.issues.getMyFilters(@scope.projectId).then (filters) =>\n            return _.map filters, (value, key) =>\n                return {id: key, name: key, type: \"myFilters\", selected: false}\n\n    removeNotExistingFiltersFromUrl: ->\n        currentSearch = @location.search()\n        urlfilters = @.getUrlFilters()\n\n        for filterName, filterValue of urlfilters\n            if filterName == \"page\" or filterName == \"orderBy\" or filterName == \"q\"\n                continue\n\n            if filterName == \"tags\"\n                splittedValues = _.map(\"#{filterValue}\".split(\",\"))\n            else\n                splittedValues = _.map(\"#{filterValue}\".split(\",\"), (x) -> if x == \"null\" then null else parseInt(x))\n\n            existingValues = _.intersection(splittedValues, _.map(@scope.filters[filterName], \"id\"))\n            if splittedValues.length != existingValues.length\n                @location.search(filterName, existingValues.join())\n\n        if currentSearch != @location.search()\n           @location.replace()\n\n    markSelectedFilters: (filters, urlfilters) ->\n        # Build selected filters (from url) fast lookup data structure\n        searchdata = {}\n        for name, value of _.omit(urlfilters, \"page\", \"orderBy\")\n            if not searchdata[name]?\n                searchdata[name] = {}\n\n            for val in \"#{value}\".split(\",\")\n                searchdata[name][val] = true\n\n        isSelected = (type, id) ->\n            if searchdata[type]? and searchdata[type][id]\n                return true\n            return false\n\n        for key, value of filters\n            for obj in value\n                obj.selected = if isSelected(obj.type, obj.id) then true else undefined\n\n    loadFilters: ->\n        urlfilters = @.getUrlFilters()\n\n        if urlfilters.q\n            @scope.filtersQ = urlfilters.q\n\n        # Load My Filters\n        promise = @.loadMyFilters().then (myFilters) =>\n            @scope.filters.myFilters = myFilters\n            return myFilters\n\n        loadFilters = {}\n        loadFilters.project = @scope.projectId\n        loadFilters.tags = urlfilters.tags\n        loadFilters.status = urlfilters.status\n        loadFilters.q = urlfilters.q\n        loadFilters.types = urlfilters.types\n        loadFilters.severities = urlfilters.severities\n        loadFilters.priorities = urlfilters.priorities\n        loadFilters.assigned_to = urlfilters.assignedTo\n        loadFilters.owner = urlfilters.createdBy\n\n        # Load default filters data\n        promise = promise.then =>\n            return @rs.issues.filtersData(loadFilters)\n\n        # Format filters and set them on scope\n        return promise.then (data) =>\n            usersFiltersFormat = (users, type, unknownOption) =>\n                reformatedUsers = _.map users, (t) =>\n                    t.type = type\n                    t.name = if t.full_name then t.full_name else unknownOption\n\n                    return t\n\n                unknownItem = _.remove(reformatedUsers, (u) -> not u.id)\n                reformatedUsers = _.sortBy(reformatedUsers, (u) -> u.name.toUpperCase())\n                if unknownItem.length > 0\n                    reformatedUsers.unshift(unknownItem[0])\n                return reformatedUsers\n\n            choicesFiltersFormat = (choices, type, byIdObject) =>\n                _.map choices, (t) ->\n                    t.type = type\n                    return t\n\n            tagsFilterFormat = (tags) =>\n                return _.map tags, (t) ->\n                    t.id = t.name\n                    t.type = 'tags'\n                    return t\n\n            # Build filters data structure\n            @scope.filters.status = choicesFiltersFormat(data.statuses, \"status\", @scope.issueStatusById)\n            @scope.filters.severities = choicesFiltersFormat(data.severities, \"severities\", @scope.severityById)\n            @scope.filters.priorities = choicesFiltersFormat(data.priorities, \"priorities\", @scope.priorityById)\n            @scope.filters.assignedTo = usersFiltersFormat(data.assigned_to, \"assignedTo\", \"Unassigned\")\n            @scope.filters.createdBy = usersFiltersFormat(data.owners, \"createdBy\", \"Unknown\")\n            @scope.filters.types = choicesFiltersFormat(data.types, \"types\", @scope.issueTypeById)\n            @scope.filters.tags = tagsFilterFormat(data.tags)\n\n            @.removeNotExistingFiltersFromUrl()\n            @.markSelectedFilters(@scope.filters, urlfilters)\n\n            @rootscope.$broadcast(\"filters:loaded\", @scope.filters)\n\n    # We need to guarantee that the last petition done here is the finally used\n    # When searching by text loadIssues can be called fastly with different parameters and\n    # can be resolved in a different order than generated\n    # We count the requests made and only if the callback is for the last one data is updated\n    loadIssuesRequests: 0\n    loadIssues: =>\n        @scope.urlFilters = @.getUrlFilters()\n\n        # Convert stored filters to http parameters\n        # ready filters (the name difference exists\n        # because of some automatic lookups and is\n        # the simplest way todo it without adding\n        # additional complexity to code.\n        @scope.httpParams = {}\n        for name, values of @scope.urlFilters\n            if name == \"severities\"\n                name = \"severity\"\n            else if name == \"orderBy\"\n                name = \"order_by\"\n            else if name == \"priorities\"\n                name = \"priority\"\n            else if name == \"assignedTo\"\n                name = \"assigned_to\"\n            else if name == \"createdBy\"\n                name = \"owner\"\n            else if name == \"status\"\n                name = \"status\"\n            else if name == \"types\"\n                name = \"type\"\n            @scope.httpParams[name] = values\n\n        promise = @rs.issues.list(@scope.projectId, @scope.httpParams)\n        @.loadIssuesRequests += 1\n        promise.index = @.loadIssuesRequests\n        promise.then (data) =>\n            if promise.index == @.loadIssuesRequests\n                @scope.issues = data.models\n                @scope.page = data.current\n                @scope.count = data.count\n                @scope.paginatedBy = data.paginatedBy\n\n            return data\n\n        return promise\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.initializeSubscription()\n            @.loadFilters()\n\n            return @.loadIssues()\n\n    saveCurrentFiltersTo: (newFilter) ->\n        deferred = @q.defer()\n        @rs.issues.getMyFilters(@scope.projectId).then (filters) =>\n            filters[newFilter] = @location.search()\n            @rs.issues.storeMyFilters(@scope.projectId, filters).then =>\n                deferred.resolve()\n        return deferred.promise\n\n    deleteMyFilter: (filter) ->\n        deferred = @q.defer()\n        @rs.issues.getMyFilters(@scope.projectId).then (filters) =>\n            delete filters[filter]\n            @rs.issues.storeMyFilters(@scope.projectId, filters).then =>\n                deferred.resolve()\n        return deferred.promise\n\n    # Functions used from templates\n    addNewIssue: ->\n        @rootscope.$broadcast(\"issueform:new\", @scope.project)\n\n    addIssuesInBulk: ->\n        @rootscope.$broadcast(\"issueform:bulk\", @scope.projectId)\n\n\nmodule.controller(\"IssuesController\", IssuesController)\n\n#############################################################################\n## Issues Directive\n#############################################################################\n\nIssuesDirective = ($log, $location, $template, $compile) ->\n    ## Issues Pagination\n    template = $template.get(\"issue/issue-paginator.html\", true)\n\n    linkPagination = ($scope, $el, $attrs, $ctrl) ->\n        # Constants\n        afterCurrent = 2\n        beforeCurrent = 4\n        atBegin = 2\n        atEnd = 2\n\n        $pagEl = $el.find(\".issues-paginator\")\n\n        getNumPages = ->\n            numPages = $scope.count / $scope.paginatedBy\n            if parseInt(numPages, 10) < numPages\n                numPages = parseInt(numPages, 10) + 1\n            else\n                numPages = parseInt(numPages, 10)\n\n            return numPages\n\n        renderPagination = ->\n            numPages = getNumPages()\n\n            if numPages <= 1\n                $pagEl.hide()\n                return\n            $pagEl.show()\n\n            pages = []\n            options = {}\n            options.pages = pages\n            options.showPrevious = ($scope.page > 1)\n            options.showNext = not ($scope.page == numPages)\n\n            cpage = $scope.page\n\n            for i in [1..numPages]\n                if i == (cpage + afterCurrent) and numPages > (cpage + afterCurrent + atEnd)\n                    pages.push({classes: \"dots\", type: \"dots\"})\n                else if i == (cpage - beforeCurrent) and cpage > (atBegin + beforeCurrent)\n                    pages.push({classes: \"dots\", type: \"dots\"})\n                else if i > (cpage + afterCurrent) and i <= (numPages - atEnd)\n                else if i < (cpage - beforeCurrent) and i > atBegin\n                else if i == cpage\n                    pages.push({classes: \"active\", num: i, type: \"page-active\"})\n                else\n                    pages.push({classes: \"page\", num: i, type: \"page\"})\n\n\n            html = template(options)\n            html = $compile(html)($scope)\n\n            $pagEl.html(html)\n\n        $scope.$watch \"issues\", (value) ->\n            # Do nothing if value is not logical true\n            return if not value\n\n            renderPagination()\n\n        $el.on \"click\", \".issues-paginator a.next\", (event) ->\n            event.preventDefault()\n\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", $scope.page + 1)\n                $ctrl.loadIssues()\n\n        $el.on \"click\", \".issues-paginator a.previous\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", $scope.page - 1)\n                $ctrl.loadIssues()\n\n        $el.on \"click\", \".issues-paginator li.page > a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            pagenum = target.data(\"pagenum\")\n\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", pagenum)\n                $ctrl.loadIssues()\n\n    ## Issues Filters\n    linkOrdering = ($scope, $el, $attrs, $ctrl) ->\n        # Draw the arrow the first time\n        currentOrder = $ctrl.getUrlFilter(\"orderBy\") or \"created_date\"\n        if currentOrder\n            icon = if startswith(currentOrder, \"-\") then \"icon-arrow-up\" else \"icon-arrow-bottom\"\n            colHeadElement = $el.find(\".row.title > div[data-fieldname='#{trim(currentOrder, \"-\")}']\")\n            colHeadElement.html(\"#{colHeadElement.html()}<span class='icon #{icon}'></span>\")\n\n        $el.on \"click\", \".row.title > div\", (event) ->\n            target = angular.element(event.currentTarget)\n\n            currentOrder = $ctrl.getUrlFilter(\"orderBy\")\n            newOrder = target.data(\"fieldname\")\n\n            finalOrder = if currentOrder == newOrder then \"-#{newOrder}\" else newOrder\n\n            $scope.$apply ->\n                $ctrl.replaceFilter(\"orderBy\", finalOrder)\n                $ctrl.storeFilters()\n                $ctrl.loadIssues().then ->\n                    # Update the arrow\n                    $el.find(\".row.title > div > span.icon\").remove()\n                    icon = if startswith(finalOrder, \"-\") then \"icon-arrow-up\" else \"icon-arrow-bottom\"\n                    target.html(\"#{target.html()}<span class='icon #{icon}'></span>\")\n\n    ## Issues Link\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        linkOrdering($scope, $el, $attrs, $ctrl)\n        linkPagination($scope, $el, $attrs, $ctrl)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgIssues\", [\"$log\", \"$tgLocation\", \"$tgTemplate\", \"$compile\", IssuesDirective])\n\n\n#############################################################################\n## Issues Filters Directive\n#############################################################################\n\nIssuesFiltersDirective = ($q, $log, $location, $rs, $confirm, $loading, $template, $translate, $compile, $auth) ->\n    template = $template.get(\"issue/issues-filters.html\", true)\n    templateSelected = $template.get(\"issue/issues-filters-selected.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.closest(\".wrapper\").controller()\n\n        selectedFilters = []\n\n        showFilters = (title, type) ->\n            $el.find(\".filters-cats\").hide()\n            $el.find(\".filter-list\").removeClass(\"hidden\")\n            $el.find(\"h2.breadcrumb\").removeClass(\"hidden\")\n            $el.find(\"h2 a.subfilter span.title\").html(title)\n            $el.find(\"h2 a.subfilter span.title\").prop(\"data-type\", type)\n\n        showCategories = ->\n            $el.find(\".filters-cats\").show()\n            $el.find(\".filter-list\").addClass(\"hidden\")\n            $el.find(\"h2.breadcrumb\").addClass(\"hidden\")\n\n        initializeSelectedFilters = (filters) ->\n            selectedFilters = []\n            for name, values of filters\n                for val in values\n                    selectedFilters.push(val) if val.selected\n\n            renderSelectedFilters(selectedFilters)\n\n        renderSelectedFilters = (selectedFilters) ->\n            _.filter selectedFilters, (f) =>\n                if f.color\n                    f.style = \"border-left: 3px solid #{f.color}\"\n\n            html = templateSelected({filters:selectedFilters})\n            html = $compile(html)($scope)\n            $el.find(\".filters-applied\").html(html)\n\n            if $auth.isAuthenticated() && selectedFilters.length > 0\n                $el.find(\".save-filters\").show()\n            else\n                $el.find(\".save-filters\").hide()\n\n        renderFilters = (filters) ->\n            _.filter filters, (f) =>\n                if f.color\n                    f.style = \"border-left: 3px solid #{f.color}\"\n\n            html = template({filters:filters})\n            html = $compile(html)($scope)\n            $el.find(\".filter-list\").html(html)\n\n        getFiltersType = () ->\n            return $el.find(\"h2 a.subfilter span.title\").prop('data-type')\n\n        reloadIssues = () ->\n            currentFiltersType = getFiltersType()\n\n            $q.all([$ctrl.loadIssues(), $ctrl.loadFilters()]).then () ->\n                filters = $scope.filters[currentFiltersType]\n                renderFilters(_.reject(filters, \"selected\"))\n\n        toggleFilterSelection = (type, id) ->\n            if type == \"myFilters\"\n                $rs.issues.getMyFilters($scope.projectId).then (data) ->\n                    myFilters = data\n                    filters = myFilters[id]\n                    filters.page = 1\n                    $ctrl.replaceAllFilters(filters)\n                    $ctrl.storeFilters()\n                    $ctrl.loadIssues()\n                    $ctrl.markSelectedFilters($scope.filters, filters)\n                    initializeSelectedFilters($scope.filters)\n                return null\n\n            filters = $scope.filters[type]\n            filterId = if type == 'tags' then taiga.toString(id) else id\n            filter = _.find(filters, {id: filterId})\n            filter.selected = (not filter.selected)\n\n            # Convert id to null as string for properly\n            # put null value on url parameters\n            id = \"null\" if id is null\n\n            if filter.selected\n                selectedFilters.push(filter)\n                $ctrl.selectFilter(type, id)\n                $ctrl.selectFilter(\"page\", 1)\n                $ctrl.storeFilters()\n            else\n                selectedFilters = _.reject selectedFilters, (f) ->\n                    return f.id == filter.id && f.type == filter.type\n\n                $ctrl.unselectFilter(type, id)\n                $ctrl.selectFilter(\"page\", 1)\n                $ctrl.storeFilters()\n\n            reloadIssues()\n\n            renderSelectedFilters(selectedFilters)\n\n            currentFiltersType = getFiltersType()\n\n            if type == currentFiltersType\n                renderFilters(_.reject(filters, \"selected\"))\n\n        # Angular Watchers\n        $scope.$on \"filters:loaded\", (ctx, filters) ->\n            initializeSelectedFilters(filters)\n\n        $scope.$on \"filters:issueupdate\", (ctx, filters) ->\n            html = template({filters:filters.status})\n            html = $compile(html)($scope)\n            $el.find(\".filter-list\").html(html)\n\n        selectQFilter = debounceLeading 100, (value) ->\n            return if value is undefined\n\n            $ctrl.replaceFilter(\"page\", null, true)\n\n            if value.length == 0\n                $ctrl.replaceFilter(\"q\", null)\n                $ctrl.storeFilters()\n            else\n                $ctrl.replaceFilter(\"q\", value)\n                $ctrl.storeFilters()\n\n            reloadIssues()\n\n        $scope.$watch(\"filtersQ\", selectQFilter)\n\n        # Dom Event Handlers\n        $el.on \"click\", \".filters-cats > ul > li > a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            tags = $scope.filters[target.data(\"type\")]\n            renderFilters(_.reject(tags, \"selected\"))\n            showFilters(target.attr(\"title\"), target.data(\"type\"))\n\n        $el.on \"click\", \".filters-inner > .filters-step-cat > .breadcrumb > .back\", (event) ->\n            event.preventDefault()\n            showCategories($el)\n\n        $el.on \"click\", \".filters-applied a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            id = target.data(\"id\") or null\n            type = target.data(\"type\")\n            toggleFilterSelection(type, id)\n\n        $el.on \"click\", \".filter-list .single-filter\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            target.toggleClass(\"active\")\n\n            id = target.data(\"id\") or null\n            type = target.data(\"type\")\n\n            # A saved filter can't be active\n            if type == \"myFilters\"\n                target.removeClass(\"active\")\n\n            toggleFilterSelection(type, id)\n\n        $el.on \"click\", \".filter-list .single-filter .icon-delete\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n\n            target = angular.element(event.currentTarget)\n            customFilterName = target.parent().data('id')\n            title = $translate.instant(\"ISSUES.FILTERS.CONFIRM_DELETE.TITLE\")\n            message = $translate.instant(\"ISSUES.FILTERS.CONFIRM_DELETE.MESSAGE\", {customFilterName: customFilterName})\n\n            $confirm.askOnDelete(title, message).then (askResponse) ->\n                promise = $ctrl.deleteMyFilter(customFilterName)\n                promise.then ->\n                    promise = $ctrl.loadMyFilters()\n                    promise.then (filters) ->\n                        askResponse.finish()\n                        $scope.filters.myFilters = filters\n                        renderFilters($scope.filters.myFilters)\n                    promise.then null, ->\n                        askResponse.finish()\n                promise.then null, ->\n                    askResponse.finish(false)\n                    $confirm.notify(\"error\")\n\n\n        $el.on \"click\", \".save-filters\", (event) ->\n            event.preventDefault()\n            renderFilters($scope.filters[\"myFilters\"])\n            showFilters(\"My filters\", \"myFilters\")\n            $el.find('.save-filters').hide()\n            $el.find('.my-filter-name').removeClass(\"hidden\")\n            $el.find('.my-filter-name').focus()\n            $scope.$apply()\n\n        $el.on \"keyup\", \".my-filter-name\", (event) ->\n            event.preventDefault()\n            if event.keyCode == 13\n                target = angular.element(event.currentTarget)\n                newFilter = target.val()\n                currentLoading = $loading()\n                    .target($el.find(\".new\"))\n                    .start()\n                promise = $ctrl.saveCurrentFiltersTo(newFilter)\n                promise.then ->\n                    loadPromise = $ctrl.loadMyFilters()\n                    loadPromise.then (filters) ->\n                        currentLoading.finish()\n                        $scope.filters.myFilters = filters\n\n                        currentfilterstype = $el.find(\"h2 a.subfilter span.title\").prop('data-type')\n                        if currentfilterstype == \"myFilters\"\n                            renderFilters($scope.filters.myFilters)\n\n                        $el.find('.my-filter-name').addClass(\"hidden\")\n                        $el.find('.save-filters').show()\n\n                    loadPromise.then null, ->\n                        currentLoading.finish()\n                        $confirm.notify(\"error\", \"Error loading custom filters\")\n\n                promise.then null, ->\n                    currentLoading.finish()\n                    $el.find(\".my-filter-name\").val(newFilter).focus().select()\n                    $confirm.notify(\"error\", \"Filter not saved\")\n\n            else if event.keyCode == 27\n                $el.find('.my-filter-name').val('')\n                $el.find('.my-filter-name').addClass(\"hidden\")\n                $el.find('.save-filters').show()\n\n    return {link:link}\n\nmodule.directive(\"tgIssuesFilters\", [\"$q\", \"$log\", \"$tgLocation\", \"$tgResources\", \"$tgConfirm\", \"$tgLoading\",\n                                     \"$tgTemplate\", \"$translate\", \"$compile\", \"$tgAuth\", IssuesFiltersDirective])\n\n\n#############################################################################\n## Issue status Directive (popover for change status)\n#############################################################################\n\nIssueStatusInlineEditionDirective = ($repo, $template, $rootscope) ->\n    ###\n    Print the status of an Issue and a popover to change it.\n    - tg-issue-status-inline-edition: The issue\n\n    Example:\n\n      div.status(tg-issue-status-inline-edition=\"issue\")\n        a.issue-status(href=\"\")\n\n    NOTE: This directive need 'issueStatusById' and 'project'.\n    ###\n    selectionTemplate = $template.get(\"issue/issue-status-inline-edition-selection.html\", true)\n\n    updateIssueStatus = ($el, issue, issueStatusById) ->\n        issueStatusDomParent = $el.find(\".issue-status\")\n        issueStatusDom = $el.find(\".issue-status .issue-status-bind\")\n\n        status = issueStatusById[issue.status]\n\n        if status\n            issueStatusDom.text(status.name)\n            issueStatusDom.prop(\"title\", status.name)\n            issueStatusDomParent.css('color', status.color)\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        issue = $scope.$eval($attrs.tgIssueStatusInlineEdition)\n\n        $el.on \"click\", \".issue-status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            $el.find(\".pop-status\").popover().open()\n\n        $el.on \"click\", \".status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            target = angular.element(event.currentTarget)\n\n            for filter in $scope.filters.status\n                if filter.id == issue.status\n                    filter.count--\n\n            issue.status = target.data(\"status-id\")\n            $el.find(\".pop-status\").popover().close()\n            updateIssueStatus($el, issue, $scope.issueStatusById)\n\n            $scope.$apply () ->\n                $repo.save(issue).then ->\n                    $ctrl.loadIssues()\n\n                for filter in $scope.filters.status\n                    if filter.id == issue.status\n                        filter.count++\n\n                $rootscope.$broadcast(\"filters:issueupdate\", $scope.filters)\n\n        taiga.bindOnce $scope, \"project\", (project) ->\n            $el.append(selectionTemplate({ 'statuses':  project.issue_statuses }))\n            updateIssueStatus($el, issue, $scope.issueStatusById)\n\n            # If the user has not enough permissions the click events are unbinded\n            if project.my_permissions.indexOf(\"modify_issue\") == -1\n                $el.unbind(\"click\")\n                $el.find(\"a\").addClass(\"not-clickable\")\n\n        $scope.$watch $attrs.tgIssueStatusInlineEdition, (val) =>\n            updateIssueStatus($el, val, $scope.issueStatusById)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgIssueStatusInlineEdition\", [\"$tgRepo\", \"$tgTemplate\", \"$rootScope\",\n                                                IssueStatusInlineEditionDirective])\n\n\n#############################################################################\n## Issue assigned to Directive\n#############################################################################\n\nIssueAssignedToInlineEditionDirective = ($repo, $rootscope, popoverService) ->\n    template = _.template(\"\"\"\n    <img src=\"<%- imgurl %>\" alt=\"<%- name %>\"/>\n    <figcaption><%- name %></figcaption>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        updateIssue = (issue) ->\n            ctx = {name: \"Unassigned\", imgurl: \"/images/unnamed.png\"}\n            member = $scope.usersById[issue.assigned_to]\n            if member\n                ctx.imgurl = member.photo\n                ctx.name = member.full_name_display\n\n            $el.find(\".avatar\").html(template(ctx))\n            $el.find(\".issue-assignedto\").attr('title', ctx.name)\n\n        $ctrl = $el.controller()\n        issue = $scope.$eval($attrs.tgIssueAssignedToInlineEdition)\n        updateIssue(issue)\n\n        $el.on \"click\", \".issue-assignedto\", (event) ->\n            $rootscope.$broadcast(\"assigned-to:add\", issue)\n\n        taiga.bindOnce $scope, \"project\", (project) ->\n            # If the user has not enough permissions the click events are unbinded\n            if project.my_permissions.indexOf(\"modify_issue\") == -1\n                $el.unbind(\"click\")\n                $el.find(\"a\").addClass(\"not-clickable\")\n\n        $scope.$on \"assigned-to:added\", (ctx, userId, updatedIssue) =>\n            if updatedIssue.id == issue.id\n                updatedIssue.assigned_to = userId\n                $repo.save(updatedIssue)\n                updateIssue(updatedIssue)\n\n        $scope.$watch $attrs.tgIssueAssignedToInlineEdition, (val) =>\n            updateIssue(val)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgIssueAssignedToInlineEdition\", [\"$tgRepo\", \"$rootScope\",\n                                                    IssueAssignedToInlineEditionDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/userstories/detail.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaUserStories\")\n\n#############################################################################\n## User story Detail Controller\n#############################################################################\n\nclass UserStoryDetailController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$log\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location,\n                  @log, @appMetaService, @navUrls, @analytics, @translate) ->\n        bindMethods(@)\n\n        @scope.usRef = @params.usref\n        @scope.sectionName = @translate.instant(\"US.SECTION_NAME\")\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            @._setMeta()\n            @.initializeOnDeleteGoToUrl()\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    _setMeta: ->\n        totalTasks = @scope.tasks.length\n        closedTasks = _.filter(@scope.tasks, (t) => @scope.taskStatusById[t.status].is_closed).length\n        progressPercentage = if totalTasks > 0 then Math.round(100 * closedTasks / totalTasks) else 0\n\n        title = @translate.instant(\"US.PAGE_TITLE\", {\n            userStoryRef: \"##{@scope.us.ref}\"\n            userStorySubject: @scope.us.subject\n            projectName: @scope.project.name\n        })\n        description = @translate.instant(\"US.PAGE_DESCRIPTION\", {\n            userStoryStatus: @scope.statusById[@scope.us.status]?.name or \"--\"\n            userStoryPoints: @scope.us.total_points\n            userStoryDescription: angular.element(@scope.us.description_html or \"\").text()\n            userStoryClosedTasks: closedTasks\n            userStoryTotalTasks: totalTasks\n            userStoryProgressPercentage: progressPercentage\n        })\n\n        @appMetaService.setAll(title, description)\n\n    initializeEventHandlers: ->\n        @scope.$on \"related-tasks:update\", =>\n            @scope.tasks = _.clone(@scope.tasks, false)\n\n        @scope.$on \"attachment:create\", =>\n            @analytics.trackEvent(\"attachment\", \"create\", \"create attachment on userstory\", 1)\n\n        @scope.$on \"comment:new\", =>\n            @.loadUs()\n\n    initializeOnDeleteGoToUrl: ->\n        ctx = {project: @scope.project.slug}\n        @scope.onDeleteGoToUrl = @navUrls.resolve(\"project\", ctx)\n        if @scope.project.is_backlog_activated\n            if @scope.us.milestone\n                ctx.sprint = @scope.sprint.slug\n                @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-taskboard\", ctx)\n            else\n                @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-backlog\", ctx)\n        else if @scope.project.is_kanban_activated\n            @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-kanban\", ctx)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            @scope.statusList = project.us_statuses\n            @scope.statusById = groupBy(project.us_statuses, (x) -> x.id)\n            @scope.taskStatusById = groupBy(project.task_statuses, (x) -> x.id)\n            @scope.pointsList = _.sortBy(project.points, \"order\")\n            @scope.pointsById = groupBy(@scope.pointsList, (e) -> e.id)\n            return project\n\n    loadUs: ->\n        httpParams = _.pick(@location.search(), \"milestone\", \"no-milestone\", \"kanban-status\")\n        milestone = httpParams.milestone\n        if milestone\n            @rs.userstories.storeQueryParams(@scope.projectId, {\n                milestone: milestone\n                order_by: \"sprint_order\"\n            })\n\n        noMilestone = httpParams[\"no-milestone\"]\n        if noMilestone\n            @rs.userstories.storeQueryParams(@scope.projectId, {\n                milestone: \"null\"\n                order_by: \"backlog_order\"\n            })\n\n        kanbanStaus = httpParams[\"kanban-status\"]\n        if kanbanStaus\n            @rs.userstories.storeQueryParams(@scope.projectId, {\n                status: kanbanStaus\n                order_by: \"kanban_order\"\n            })\n\n\n\n        return @rs.userstories.getByRef(@scope.projectId, @params.usref).then (us) =>\n            @scope.us = us\n            @scope.usId = us.id\n            @scope.commentModel = us\n\n            if @scope.us.neighbors.previous.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.us.neighbors.previous.ref\n                }\n                @scope.previousUrl = @navUrls.resolve(\"project-userstories-detail\", ctx)\n\n            if @scope.us.neighbors.next.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.us.neighbors.next.ref\n                }\n                @scope.nextUrl = @navUrls.resolve(\"project-userstories-detail\", ctx)\n\n            return us\n\n    loadSprint: ->\n        if @scope.us.milestone\n            return @rs.sprints.get(@scope.us.project, @scope.us.milestone).then (sprint) =>\n                @scope.sprint = sprint\n                return sprint\n\n    loadTasks: ->\n        return @rs.tasks.list(@scope.projectId, null, @scope.usId).then (tasks) =>\n            @scope.tasks = tasks\n            return tasks\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.loadUs().then(=> @q.all([@.loadSprint(), @.loadTasks()]))\n\n    ###\n    # Note: This methods (onUpvote() and onDownvote()) are related to tg-vote-button.\n    #       See app/modules/components/vote-button for more info\n    ###\n    onUpvote: ->\n        onSuccess = =>\n            @.loadUs()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.userstories.upvote(@scope.usId).then(onSuccess, onError)\n\n    onDownvote: ->\n        onSuccess = =>\n            @.loadUs()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.userstories.downvote(@scope.usId).then(onSuccess, onError)\n\n    ###\n    # Note: This methods (onWatch() and onUnwatch()) are related to tg-watch-button.\n    #       See app/modules/components/watch-button for more info\n    ###\n    onWatch: ->\n        onSuccess = =>\n            @.loadUs()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.userstories.watch(@scope.usId).then(onSuccess, onError)\n\n    onUnwatch: ->\n        onSuccess = =>\n            @.loadUs()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.userstories.unwatch(@scope.usId).then(onSuccess, onError)\n\nmodule.controller(\"UserStoryDetailController\", UserStoryDetailController)\n\n\n#############################################################################\n## User story status display directive\n#############################################################################\n\nUsStatusDisplayDirective = ($template, $compile) ->\n    # Display if a US is open or closed and its kanban status.\n    #\n    # Example:\n    #     tg-us-status-display(ng-model=\"us\")\n    #\n    # Requirements:\n    #   - US object (ng-model)\n    #   - scope.statusById object\n\n    template = $template.get(\"common/components/status-display.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        render = (us) ->\n            status = $scope.statusById[us.status]\n\n            html = template({\n                is_closed: us.is_closed\n                status: status\n            })\n\n            html = $compile(html)($scope)\n            $el.html(html)\n\n        $scope.$watch $attrs.ngModel, (us) ->\n            render(us) if us?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgUsStatusDisplay\", [\"$tgTemplate\", \"$compile\", UsStatusDisplayDirective])\n\n\n#############################################################################\n## User story related tasts progress splay Directive\n#############################################################################\n\nUsTasksProgressDisplayDirective = ($template, $compile) ->\n    # Display a progress bar with the stats of completed tasks.\n    #\n    # Example:\n    #     tg-us-tasks-progress-display(ng-model=\"tasks\")\n    #\n    # Requirements:\n    #   - Task object list (ng-model)\n    #   - scope.taskStatusById object\n\n    link = ($scope, $el, $attrs) ->\n        render = (tasks) ->\n            totalTasks = tasks.length\n            totalClosedTasks = _.filter(tasks, (task) => $scope.taskStatusById[task.status].is_closed).length\n\n            progress = if totalTasks > 0 then 100 * totalClosedTasks / totalTasks else 0\n\n            _.assign($scope, {\n                totalTasks: totalTasks\n                totalClosedTasks: totalClosedTasks\n                progress: progress,\n                style: {\n                    width: progress + \"%\"\n                }\n            })\n\n        $scope.$watch $attrs.ngModel, (tasks) ->\n            render(tasks) if tasks?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        templateUrl: \"us/us-task-progress.html\"\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        scope: true\n    }\n\nmodule.directive(\"tgUsTasksProgressDisplay\", [\"$tgTemplate\", \"$compile\", UsTasksProgressDisplayDirective])\n\n\n#############################################################################\n## User story status button directive\n#############################################################################\n\nUsStatusButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $template) ->\n    # Display the status of a US and you can edit it.\n    #\n    # Example:\n    #     tg-us-status-button(ng-model=\"us\")\n    #\n    # Requirements:\n    #   - Us object (ng-model)\n    #   - scope.statusById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"us/us-status-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_us\") != -1\n\n        render = (us) =>\n            status = $scope.statusById[us.status]\n\n            html = template({\n                status: status\n                statuses: $scope.statusList\n                editable: isEditable()\n            })\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (status) =>\n            us = $model.$modelValue.clone()\n\n            us.status = status\n\n            $.fn.popover().closeAll()\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $confirm.notify(\"success\")\n                $model.$setViewValue(us)\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n\n            onError = ->\n                $confirm.notify(\"error\")\n                currentLoading.finish()\n\n            $repo.save(us).then(onSuccess, onError)\n\n        $el.on \"click\", \".status-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-status\").popover().open()\n\n        $el.on \"click\", \".status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n            status = target.data(\"status-id\")\n\n            save(status)\n\n        $scope.$watch $attrs.ngModel, (us) ->\n            render(us) if us\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgUsStatusButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\",\"$tgQqueue\", \"$tgTemplate\",\n                                      UsStatusButtonDirective])\n\n\n#############################################################################\n## User story team requirements button directive\n#############################################################################\n\nUsTeamRequirementButtonDirective = ($rootscope, $tgrepo, $confirm, $loading, $qqueue, $template, $compile) ->\n    template = $template.get(\"us/us-team-requirement-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        canEdit = ->\n            return $scope.project.my_permissions.indexOf(\"modify_us\") != -1\n\n        render = (us) ->\n            if not canEdit() and not us.team_requirement\n                $el.html(\"\")\n                return\n\n            ctx = {\n                canEdit: canEdit()\n                isRequired: us.team_requirement\n            }\n            html = template(ctx)\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (team_requirement) =>\n            us = $model.$modelValue.clone()\n            us.team_requirement = team_requirement\n\n            currentLoading = $loading()\n                .target($el.find(\"label\"))\n                .start()\n\n            promise = $tgrepo.save(us)\n            promise.then =>\n                $model.$setViewValue(us)\n                currentLoading.finish()\n                $rootscope.$broadcast(\"object:updated\")\n\n            promise.then null, ->\n                currentLoading.finish()\n                $confirm.notify(\"error\")\n\n        $el.on \"click\", \".team-requirement\", (event) ->\n            return if not canEdit()\n\n            team_requirement = not $model.$modelValue.team_requirement\n\n            save(team_requirement)\n\n        $scope.$watch $attrs.ngModel, (us) ->\n            render(us) if us\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgUsTeamRequirementButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\", UsTeamRequirementButtonDirective])\n\n#############################################################################\n## User story client requirements button directive\n#############################################################################\n\nUsClientRequirementButtonDirective = ($rootscope, $tgrepo, $confirm, $loading, $qqueue, $template, $compile) ->\n    template = $template.get(\"us/us-client-requirement-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        canEdit = ->\n            return $scope.project.my_permissions.indexOf(\"modify_us\") != -1\n\n        render = (us) ->\n            if not canEdit() and not us.client_requirement\n                $el.html(\"\")\n                return\n\n            ctx = {\n                canEdit: canEdit()\n                isRequired: us.client_requirement\n            }\n            html = $compile(template(ctx))($scope)\n            $el.html(html)\n\n        save = $qqueue.bindAdd (client_requirement) =>\n            us = $model.$modelValue.clone()\n            us.client_requirement = client_requirement\n\n            currentLoading = $loading()\n                .target($el.find(\"label\"))\n                .start()\n\n            promise = $tgrepo.save(us)\n            promise.then =>\n                $model.$setViewValue(us)\n                currentLoading.finish()\n                $rootscope.$broadcast(\"object:updated\")\n\n            promise.then null, ->\n                $confirm.notify(\"error\")\n\n        $el.on \"click\", \".client-requirement\", (event) ->\n            return if not canEdit()\n\n            client_requirement = not $model.$modelValue.client_requirement\n            save(client_requirement)\n\n        $scope.$watch $attrs.ngModel, (us) ->\n            render(us) if us\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgUsClientRequirementButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\", \"$tgTemplate\", \"$compile\",\n                                                 UsClientRequirementButtonDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/tasks/detail.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ngroupBy = @.taiga.groupBy\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaTasks\")\n\n\n#############################################################################\n## Task Detail Controller\n#############################################################################\n\nclass TaskDetailController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$log\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location,\n                  @log, @appMetaService, @navUrls, @analytics, @translate) ->\n        bindMethods(@)\n\n        @scope.taskRef = @params.taskref\n        @scope.sectionName = @translate.instant(\"TASK.SECTION_NAME\")\n        @.initializeEventHandlers()\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            @._setMeta()\n            @.initializeOnDeleteGoToUrl()\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n    _setMeta: ->\n        title = @translate.instant(\"TASK.PAGE_TITLE\", {\n            taskRef: \"##{@scope.task.ref}\"\n            taskSubject: @scope.task.subject\n            projectName: @scope.project.name\n        })\n        description = @translate.instant(\"TASK.PAGE_DESCRIPTION\", {\n            taskStatus: @scope.statusById[@scope.task.status]?.name or \"--\"\n            taskDescription: angular.element(@scope.task.description_html or \"\").text()\n        })\n        @appMetaService.setAll(title, description)\n\n    initializeEventHandlers: ->\n        @scope.$on \"attachment:create\", =>\n            @analytics.trackEvent(\"attachment\", \"create\", \"create attachment on task\", 1)\n        @scope.$on \"custom-attributes-values:edit\", =>\n            @rootscope.$broadcast(\"object:updated\")\n        @scope.$on \"comment:new\", =>\n            @.loadTask()\n\n    initializeOnDeleteGoToUrl: ->\n        ctx = {project: @scope.project.slug}\n        @scope.onDeleteGoToUrl = @navUrls.resolve(\"project\", ctx)\n        if @scope.project.is_backlog_activated\n            if @scope.task.milestone\n                ctx.sprint = @scope.sprint.slug\n                @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-taskboard\", ctx)\n            else if @scope.task.us\n                ctx.ref = @scope.us.ref\n                @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-userstories-detail\", ctx)\n        else if @scope.project.is_kanban_activated\n            if @scope.us\n                ctx.ref = @scope.us.ref\n                @scope.onDeleteGoToUrl = @navUrls.resolve(\"project-userstories-detail\", ctx)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            @scope.statusList = project.task_statuses\n            @scope.statusById = groupBy(project.task_statuses, (x) -> x.id)\n            return project\n\n    loadTask: ->\n        return @rs.tasks.getByRef(@scope.projectId, @params.taskref).then (task) =>\n            @scope.task = task\n            @scope.taskId = task.id\n            @scope.commentModel = task\n\n            if @scope.task.neighbors.previous.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.task.neighbors.previous.ref\n                }\n                @scope.previousUrl = @navUrls.resolve(\"project-tasks-detail\", ctx)\n\n            if @scope.task.neighbors.next.ref?\n                ctx = {\n                    project: @scope.project.slug\n                    ref: @scope.task.neighbors.next.ref\n                }\n                @scope.nextUrl = @navUrls.resolve(\"project-tasks-detail\", ctx)\n            return task\n\n    loadSprint: ->\n        if @scope.task.milestone\n            return @rs.sprints.get(@scope.task.project, @scope.task.milestone).then (sprint) =>\n                @scope.sprint = sprint\n                return sprint\n\n    loadUserStory: ->\n        if @scope.task.user_story\n            return @rs.userstories.get(@scope.task.project, @scope.task.user_story).then (us) =>\n                @scope.us = us\n                return us\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.loadTask().then(=> @q.all([@.loadSprint(), @.loadUserStory()]))\n\n    ###\n    # Note: This methods (onUpvote() and onDownvote()) are related to tg-vote-button.\n    #       See app/modules/components/vote-button for more info\n    ###\n    onUpvote: ->\n        onSuccess = =>\n            @.loadTask()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.tasks.upvote(@scope.taskId).then(onSuccess, onError)\n\n    onDownvote: ->\n        onSuccess = =>\n            @.loadTask()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.tasks.downvote(@scope.taskId).then(onSuccess, onError)\n\n    ###\n    # Note: This methods (onWatch() and onUnwatch()) are related to tg-watch-button.\n    #       See app/modules/components/watch-button for more info\n    ###\n    onWatch: ->\n        onSuccess = =>\n            @.loadTask()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.tasks.watch(@scope.taskId).then(onSuccess, onError)\n\n    onUnwatch: ->\n        onSuccess = =>\n            @.loadTask()\n            @rootscope.$broadcast(\"object:updated\")\n        onError = =>\n            @confirm.notify(\"error\")\n\n        return @rs.tasks.unwatch(@scope.taskId).then(onSuccess, onError)\n\nmodule.controller(\"TaskDetailController\", TaskDetailController)\n\n\n#############################################################################\n## Task status display directive\n#############################################################################\n\nTaskStatusDisplayDirective = ($template, $compile) ->\n    # Display if a Task is open or closed and its taskboard status.\n    #\n    # Example:\n    #     tg-task-status-display(ng-model=\"task\")\n    #\n    # Requirements:\n    #   - Task object (ng-model)\n    #   - scope.statusById object\n\n    template = $template.get(\"common/components/status-display.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        render = (task) ->\n            status =  $scope.statusById[task.status]\n\n            html = template({\n                is_closed: status.is_closed\n                status: status\n            })\n\n            html = $compile(html)($scope)\n            $el.html(html)\n\n        $scope.$watch $attrs.ngModel, (task) ->\n            render(task) if task?\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgTaskStatusDisplay\", [\"$tgTemplate\", \"$compile\", TaskStatusDisplayDirective])\n\n\n#############################################################################\n## Task status button directive\n#############################################################################\n\nTaskStatusButtonDirective = ($rootScope, $repo, $confirm, $loading, $qqueue, $compile, $translate, $template) ->\n    # Display the status of Task and you can edit it.\n    #\n    # Example:\n    #     tg-task-status-button(ng-model=\"task\")\n    #\n    # Requirements:\n    #   - Task object (ng-model)\n    #   - scope.statusById object\n    #   - $scope.project.my_permissions\n\n    template = $template.get(\"us/us-status-button.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_task\") != -1\n\n        render = (task) =>\n            status = $scope.statusById[task.status]\n\n            html = $compile(template({\n                status: status\n                statuses: $scope.statusList\n                editable: isEditable()\n            }))($scope)\n\n            $el.html(html)\n\n        save = $qqueue.bindAdd (status) =>\n            task = $model.$modelValue.clone()\n            task.status = status\n\n            currentLoading = $loading()\n                .target($el.find(\".level-name\"))\n                .start()\n\n            onSuccess = ->\n                $model.$setViewValue(task)\n                $confirm.notify(\"success\")\n                $rootScope.$broadcast(\"object:updated\")\n                currentLoading.finish()\n\n            onError = ->\n                $confirm.notify(\"error\")\n                currentLoading.finish()\n\n            $repo.save(task).then(onSuccess, onError)\n\n        $el.on \"click\", \".status-data\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            $el.find(\".pop-status\").popover().open()\n\n        $el.on \"click\", \".status\", (event) ->\n            event.preventDefault()\n            event.stopPropagation()\n            return if not isEditable()\n\n            target = angular.element(event.currentTarget)\n\n            $.fn.popover().closeAll()\n\n            save(target.data(\"status-id\"))\n\n        $scope.$watch $attrs.ngModel, (task) ->\n            render(task) if task\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgTaskStatusButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\",\n                                        \"$compile\", \"$translate\", \"$tgTemplate\", TaskStatusButtonDirective])\n\n\nTaskIsIocaineButtonDirective = ($rootscope, $tgrepo, $confirm, $loading, $qqueue, $compile) ->\n    template = _.template(\"\"\"\n      <fieldset title=\"{{ 'TASK.TITLE_ACTION_IOCAINE' | translate }}\">\n        <label for=\"is-iocaine\"\n               translate=\"TASK.ACTION_IOCAINE\"\n               class=\"button button-gray is-iocaine <% if(isEditable){ %>editable<% }; %> <% if(isIocaine){ %>active<% }; %>\">\n              Iocaine\n        </label>\n        <input type=\"checkbox\" id=\"is-iocaine\" name=\"is-iocaine\"/>\n      </fieldset>\n    \"\"\")\n\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_task\") != -1\n\n        render = (task) ->\n            if not isEditable() and not task.is_iocaine\n                $el.html(\"\")\n                return\n\n            ctx = {\n                isIocaine: task.is_iocaine\n                isEditable: isEditable()\n            }\n            html = $compile(template(ctx))($scope)\n            $el.html(html)\n\n        save = $qqueue.bindAdd (is_iocaine) =>\n            task = $model.$modelValue.clone()\n            task.is_iocaine = is_iocaine\n\n            currentLoading = $loading()\n                .target($el.find('label'))\n                .start()\n\n            promise = $tgrepo.save(task)\n\n            promise.then ->\n                $model.$setViewValue(task)\n                $confirm.notify(\"success\")\n                $rootscope.$broadcast(\"object:updated\")\n\n            promise.then null, ->\n                $confirm.notify(\"error\")\n\n            promise.finally ->\n                currentLoading.finish()\n\n        $el.on \"click\", \".is-iocaine\", (event) ->\n            return if not isEditable()\n\n            is_iocaine = not $model.$modelValue.is_iocaine\n            save(is_iocaine)\n\n        $scope.$watch $attrs.ngModel, (task) ->\n            render(task) if task\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgTaskIsIocaineButton\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgQqueue\",\n                                           \"$compile\", TaskIsIocaineButtonDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/team/main.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\n\nmodule = angular.module(\"taigaTeam\")\n\n#############################################################################\n## Team Controller\n#############################################################################\n\nclass TeamController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$location\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$tgAuth\",\n        \"$translate\",\n        \"tgProjectService\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @rs, @params, @q, @location, @navUrls, @appMetaService, @auth,\n                  @translate, @projectService) ->\n        @scope.sectionName = \"TEAM.SECTION_NAME\"\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then =>\n            title = @translate.instant(\"TEAM.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @translate.instant(\"TEAM.PAGE_DESCRIPTION\", {\n                projectName: @scope.project.name,\n                projectDescription: @scope.project.description\n            })\n            @appMetaService.setAll(title, description)\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    setRole: (role) ->\n        if role\n            @scope.filtersRole = role\n        else\n            @scope.filtersRole = null\n\n    loadMembers: ->\n        user = @auth.getUser()\n\n        # Calculate totals\n        @scope.totals = {}\n        for member in @scope.activeUsers\n            @scope.totals[member.id] = 0\n\n        # Get current user\n        @scope.currentUser = _.find(@scope.activeUsers, {id: user?.id})\n\n        # Get member list without current user\n        @scope.memberships = _.reject(@scope.activeUsers, {id: user?.id})\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n\n            @scope.issuesEnabled = project.is_issues_activated\n            @scope.tasksEnabled = project.is_kanban_activated or project.is_backlog_activated\n            @scope.wikiEnabled = project.is_wiki_activated\n\n            return project\n\n    loadMemberStats: ->\n        return @rs.projects.memberStats(@scope.projectId).then (stats) =>\n          totals = {}\n          _.forEach @scope.totals, (total, userId) =>\n              vals = _.map(stats, (memberStats, statsKey) -> memberStats[userId])\n              total = _.reduce(vals, (sum, el) -> sum + el)\n              @scope.totals[userId] = total\n\n          @scope.stats = @._processStats(stats)\n          @scope.stats.totals = @scope.totals\n\n    _processStat: (stat) ->\n        max = _.max(stat)\n        min = _.min(stat)\n        singleStat = _.map stat, (value, key) ->\n            if value == min\n                return [key, 0.1]\n            if value == max\n                return [key, 1]\n            return [key, (value * 0.5) / max]\n        singleStat = _.object(singleStat)\n        return singleStat\n\n    _processStats: (stats) ->\n        for key,value of stats\n            stats[key] = @._processStat(value)\n        return stats\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @.loadMembers()\n            return @.loadMemberStats()\n\nmodule.controller(\"TeamController\", TeamController)\n\n\n#############################################################################\n## Team Filters Directive\n#############################################################################\n\nTeamFiltersDirective = () ->\n    return {\n        templateUrl: \"team/team-filter.html\"\n    }\n\nmodule.directive(\"tgTeamFilters\", [TeamFiltersDirective])\n\n\n#############################################################################\n## Team Member Stats Directive\n#############################################################################\n\nTeamMemberStatsDirective = () ->\n    return {\n        templateUrl: \"team/team-member-stats.html\",\n        scope: {\n            stats: \"=\",\n            userId: \"=user\"\n            issuesEnabled: \"=issuesenabled\"\n            tasksEnabled: \"=tasksenabled\"\n            wikiEnabled: \"=wikienabled\"\n        }\n    }\n\nmodule.directive(\"tgTeamMemberStats\", TeamMemberStatsDirective)\n\n\n#############################################################################\n## Team Current User Directive\n#############################################################################\n\nTeamMemberCurrentUserDirective = () ->\n    return {\n        templateUrl: \"team/team-member-current-user.html\"\n        scope: {\n            projectId: \"=projectid\",\n            currentUser: \"=currentuser\",\n            stats: \"=\"\n            issuesEnabled: \"=issuesenabled\"\n            tasksEnabled: \"=tasksenabled\"\n            wikiEnabled: \"=wikienabled\"\n        }\n    }\n\nmodule.directive(\"tgTeamCurrentUser\", TeamMemberCurrentUserDirective)\n\n\n#############################################################################\n## Team Members Directive\n#############################################################################\n\nTeamMembersDirective = () ->\n    template = \"team/team-members.html\"\n\n    return {\n        templateUrl: template\n        scope: {\n            memberships: \"=\",\n            filtersQ: \"=filtersq\",\n            filtersRole: \"=filtersrole\",\n            stats: \"=\"\n            issuesEnabled: \"=issuesenabled\"\n            tasksEnabled: \"=tasksenabled\"\n            wikiEnabled: \"=wikienabled\"\n        }\n    }\n\nmodule.directive(\"tgTeamMembers\", TeamMembersDirective)\n\n\n#############################################################################\n## Leave project Directive\n#############################################################################\n\nLeaveProjectDirective = ($repo, $confirm, $location, $rs, $navurls, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.leave = () ->\n            leave_project_text = $translate.instant(\"TEAM.ACTION_LEAVE_PROJECT\")\n            confirm_leave_project_text = $translate.instant(\"TEAM.CONFIRM_LEAVE_PROJECT\")\n\n            $confirm.ask(leave_project_text, confirm_leave_project_text).then (response) =>\n                promise = $rs.projects.leave($attrs.projectid)\n\n                promise.then =>\n                    response.finish()\n                    $confirm.notify(\"success\")\n                    $location.path($navurls.resolve(\"home\"))\n\n                promise.then null, (response) ->\n                    response.finish()\n                    $confirm.notify('error', response.data._error_message)\n\n    return {\n        scope: {},\n        templateUrl: \"team/leave-project.html\",\n        link: link\n    }\n\nmodule.directive(\"tgLeaveProject\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLocation\", \"$tgResources\", \"$tgNavUrls\", \"$translate\",\n                                    LeaveProjectDirective])\n\n\n#############################################################################\n## Team Filters\n#############################################################################\n\nmembersFilter = ->\n    return (members, filtersQ, filtersRole) ->\n        return _.filter members, (m) -> (not filtersRole or m.role == filtersRole.id) and\n                                        (not filtersQ or m.full_name.search(new RegExp(filtersQ, \"i\")) >= 0)\n\nmodule.filter('membersFilter', membersFilter)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/wiki/detail.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaWiki\")\n\n#############################################################################\n## Wiki Detail Controller\n#############################################################################\n\nclass WikiDetailController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgModel\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$filter\",\n        \"$log\",\n        \"tgAppMetaService\",\n        \"$tgNavUrls\",\n        \"$tgAnalytics\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @model, @confirm, @rs, @params, @q, @location,\n                  @filter, @log, @appMetaService, @navUrls, @analytics, @translate) ->\n        @scope.projectSlug = @params.pslug\n        @scope.wikiSlug = @params.slug\n        @scope.wikiTitle = @scope.wikiSlug\n        @scope.sectionName = \"Wiki\"\n\n        promise = @.loadInitialData()\n\n        # On Success\n        promise.then () => @._setMeta()\n\n        # On Error\n        promise.then null, @.onInitialDataError.bind(@)\n\n    _setMeta: ->\n        title =  @translate.instant(\"WIKI.PAGE_TITLE\", {\n            wikiPageName: @scope.wikiTitle\n            projectName: @scope.project.name\n        })\n        description =  @translate.instant(\"WIKI.PAGE_DESCRIPTION\", {\n            wikiPageContent: angular.element(@scope.wiki.html or \"\").text()\n            totalEditions: @scope.wiki.editions or 0\n            lastModifiedDate: moment(@scope.wiki.modified_date).format(@translate.instant(\"WIKI.DATETIME\"))\n        })\n        @appMetaService.setAll(title, description)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.is_wiki_activated\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadWiki: ->\n        promise = @rs.wiki.getBySlug(@scope.projectId, @params.slug)\n        promise.then (wiki) =>\n            @scope.wiki = wiki\n            @scope.wikiId = wiki.id\n            return @scope.wiki\n\n        promise.then null, (xhr) =>\n            @scope.wikiId = null\n\n            if @scope.project.my_permissions.indexOf(\"add_wiki_page\") == -1\n                return null\n\n            data = {\n                project: @scope.projectId\n                slug: @scope.wikiSlug\n                content: \"\"\n            }\n            @scope.wiki = @model.make_model(\"wiki\", data)\n            return @scope.wiki\n\n    loadWikiLinks: ->\n        return @rs.wiki.listLinks(@scope.projectId).then (wikiLinks) =>\n            @scope.wikiLinks = wikiLinks\n            selectedWikiLink = _.find(wikiLinks, {href: @scope.wikiSlug})\n            @scope.wikiTitle = selectedWikiLink.title if selectedWikiLink?\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise.then (project) =>\n            @.fillUsersAndRoles(project.members, project.roles)\n            @q.all([@.loadWikiLinks(), @.loadWiki()]).then () =>\n\n\n    delete: ->\n        title = @translate.instant(\"WIKI.DELETE_LIGHTBOX_TITLE\")\n        message = @scope.wikiTitle\n\n        @confirm.askOnDelete(title, message).then (askResponse) =>\n            onSuccess = =>\n                askResponse.finish()\n                ctx = {project: @scope.projectSlug}\n                @location.path(@navUrls.resolve(\"project-wiki\", ctx))\n                @confirm.notify(\"success\")\n\n            onError = =>\n                askResponse.finish(false)\n                @confirm.notify(\"error\")\n\n            @repo.remove(@scope.wiki).then onSuccess, onError\n\nmodule.controller(\"WikiDetailController\", WikiDetailController)\n\n\n#############################################################################\n## Wiki Summary Directive\n#############################################################################\n\nWikiSummaryDirective = ($log, $template, $compile, $translate) ->\n    template = $template.get(\"wiki/wiki-summary.html\", true)\n\n    link = ($scope, $el, $attrs, $model) ->\n        render = (wiki) ->\n            if not $scope.usersById?\n                $log.error \"WikiSummaryDirective requires userById set in scope.\"\n            else\n                user = $scope.usersById[wiki.last_modifier]\n\n            if user is undefined\n                user = {name: \"unknown\", imgUrl: \"/images/user-noimage.png\"}\n            else\n                user = {name: user.full_name_display, imgUrl: user.photo}\n\n            ctx = {\n                totalEditions: wiki.editions\n                lastModifiedDate: moment(wiki.modified_date).format($translate.instant(\"WIKI.DATETIME\"))\n                user: user\n            }\n            html = template(ctx)\n            html = $compile(html)($scope)\n            $el.html(html)\n\n        $scope.$watch $attrs.ngModel, (wikiPage) ->\n            return if not wikiPage\n            render(wikiPage)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgWikiSummary\", [\"$log\", \"$tgTemplate\", \"$compile\", \"$translate\",  WikiSummaryDirective])\n\n\n#############################################################################\n## Editable Wiki Content Directive\n#############################################################################\n\nEditableWikiContentDirective = ($window, $document, $repo, $confirm, $loading, $analytics, $qqueue) ->\n    link = ($scope, $el, $attrs, $model) ->\n        isEditable = ->\n            return $scope.project.my_permissions.indexOf(\"modify_wiki_page\") != -1\n\n        switchToEditMode = ->\n            $el.find('.edit-wiki-content').show()\n            $el.find('.view-wiki-content').hide()\n            $el.find('textarea').focus()\n\n        switchToReadMode = ->\n            $el.find('.edit-wiki-content').hide()\n            $el.find('.view-wiki-content').show()\n\n        disableEdition = ->\n            $el.find(\".view-wiki-content .edit\").remove()\n            $el.find(\".edit-wiki-content\").remove()\n\n        cancelEdition = ->\n            return if not $model.$modelValue.id\n\n            $scope.$apply () =>\n                $model.$modelValue.revert()\n            switchToReadMode()\n\n        getSelectedText = ->\n            if $window.getSelection\n                return $window.getSelection().toString()\n            else if $document.selection\n                return $document.selection.createRange().text\n            return null\n\n        save = $qqueue.bindAdd (wiki) ->\n            onSuccess = (wikiPage) ->\n                if not wiki.id?\n                    $analytics.trackEvent(\"wikipage\", \"create\", \"create wiki page\", 1)\n\n                $model.$setViewValue wikiPage.clone()\n\n                $confirm.notify(\"success\")\n                switchToReadMode()\n\n            onError = ->\n                $confirm.notify(\"error\")\n\n            currentLoading = $loading()\n                .removeClasses(\"icon-floppy\")\n                .target($el.find('.icon-floppy'))\n                .start()\n\n            if wiki.id?\n                promise = $repo.save(wiki).then(onSuccess, onError)\n            else\n                promise = $repo.create(\"wiki\", wiki).then(onSuccess, onError)\n\n            promise.finally ->\n                currentLoading.finish()\n\n        $el.on \"click\", \"a\", (event) ->\n            target = angular.element(event.target)\n            href = target.attr('href')\n            if href.indexOf(\"#\") == 0\n                event.preventDefault()\n                $('body').scrollTop($(href).offset().top)\n\n        $el.on \"mousedown\", \".view-wiki-content\", (event) ->\n            target = angular.element(event.target)\n            return if not isEditable()\n            return if event.button == 2\n\n        $el.on \"mouseup\", \".view-wiki-content\", (event) ->\n            target = angular.element(event.target)\n            return if getSelectedText()\n            return if not isEditable()\n            return if target.is('a')\n            return if target.is('pre')\n\n            switchToEditMode()\n\n        $el.on \"click\", \".save\", debounce 2000, ->\n            save($scope.wiki)\n\n        $el.on \"click\", \".cancel\", ->\n            cancelEdition()\n\n        $el.on \"keydown\", \"textarea\", (event) ->\n            if event.keyCode == 27\n                cancelEdition()\n\n        $scope.$watch $attrs.ngModel, (wikiPage) ->\n            return if not wikiPage\n\n            if isEditable()\n                $el.addClass('editable')\n                if not wikiPage.id? or $.trim(wikiPage.content).length == 0\n                    switchToEditMode()\n            else\n                disableEdition()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n        templateUrl: \"wiki/editable-wiki-content.html\"\n    }\n\nmodule.directive(\"tgEditableWikiContent\", [\"$window\", \"$document\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\",\n                                           \"$tgAnalytics\", \"$tgQqueue\", EditableWikiContentDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/wiki/detail.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaWiki\")\n\n\n#############################################################################\n## Wiki Main Directive\n#############################################################################\n\nWikiNavDirective = ($tgrepo, $log, $location, $confirm, $navUrls, $analytics, $loading, $template, $compile, $translate) ->\n    template = $template.get(\"wiki/wiki-nav.html\", true)\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        if not $attrs.ngModel?\n            return $log.error \"WikiNavDirective: no ng-model attr is defined\"\n\n        render = (wikiLinks) ->\n            addWikiLinkPermission = $scope.project.my_permissions.indexOf(\"add_wiki_link\") > -1\n            deleteWikiLinkPermission = $scope.project.my_permissions.indexOf(\"delete_wiki_link\") > -1\n\n            html = template({\n                wikiLinks: wikiLinks,\n                projectSlug: $scope.projectSlug\n                addWikiLinkPermission: addWikiLinkPermission\n                deleteWikiLinkPermission: deleteWikiLinkPermission\n            })\n\n            html = $compile(html)($scope)\n\n            $el.off()\n            $el.html(html)\n\n            $el.on \"click\", \".wiki-link .link-title\", (event) ->\n                event.preventDefault()\n                target = angular.element(event.currentTarget)\n                linkId = target.parents('.wiki-link').data('id')\n                linkSlug = $scope.wikiLinks[linkId].href\n                $scope.$apply ->\n                    ctx = {\n                        project: $scope.projectSlug\n                        slug: linkSlug\n                    }\n                    $location.path($navUrls.resolve(\"project-wiki-page\", ctx))\n\n            $el.on \"click\", \".add-button\", (event) ->\n                event.preventDefault()\n                $el.find(\".new\").removeClass(\"hidden\")\n                $el.find(\".new input\").focus()\n                $el.find(\".add-button\").hide()\n\n            $el.on \"click\", \".wiki-link .icon-delete\", (event) ->\n                event.preventDefault()\n                event.stopPropagation()\n                target = angular.element(event.currentTarget)\n                linkId = target.parents('.wiki-link').data('id')\n\n                title = $translate.instant(\"WIKI.DELETE_LIGHTBOX_TITLE\")\n                message = $scope.wikiLinks[linkId].title\n\n                $confirm.askOnDelete(title, message).then (askResponse) =>\n                    promise = $tgrepo.remove($scope.wikiLinks[linkId])\n                    promise.then ->\n                        promise = $ctrl.loadWikiLinks()\n                        promise.then ->\n                            askResponse.finish()\n                            render($scope.wikiLinks)\n                        promise.then null, ->\n                            askResponse.finish()\n                    promise.then null, ->\n                        askResponse.finish(false)\n                        $confirm.notify(\"error\")\n\n            $el.on \"keyup\", \".new input\", (event) ->\n                event.preventDefault()\n                if event.keyCode == 13\n                    target = angular.element(event.currentTarget)\n                    newLink = target.val()\n\n                    currentLoading = $loading()\n                        .target($el.find(\".new\"))\n                        .start()\n\n                    promise = $tgrepo.create(\"wiki-links\", {project: $scope.projectId, title: newLink})\n                    promise.then ->\n                        $analytics.trackEvent(\"wikilink\", \"create\", \"create wiki link\", 1)\n                        loadPromise = $ctrl.loadWikiLinks()\n                        loadPromise.then ->\n                            currentLoading.finish()\n                            $el.find(\".new\").addClass(\"hidden\")\n                            $el.find(\".new input\").val('')\n                            $el.find(\".add-button\").show()\n                            render($scope.wikiLinks)\n                        loadPromise.then null, ->\n                            currentLoading.finish()\n                            $el.find(\".new\").addClass(\"hidden\")\n                            $el.find(\".new input\").val('')\n                            $el.find(\".add-button\").show()\n                            $confirm.notify(\"error\", \"Error loading wiki links\")\n\n                    promise.then null, (error) ->\n                        currentLoading.finish()\n                        $el.find(\".new input\").val(newLink)\n                        $el.find(\".new input\").focus().select()\n                        if error?.__all__?[0]?\n                            $confirm.notify(\"error\", \"The link already exists\")\n                        else\n                            $confirm.notify(\"error\")\n\n                else if event.keyCode == 27\n                    target = angular.element(event.currentTarget)\n                    $el.find(\".new\").addClass(\"hidden\")\n                    $el.find(\".new input\").val('')\n                    $el.find(\".add-button\").show()\n\n\n        bindOnce($scope, $attrs.ngModel, render)\n\n    return {link:link}\n\nmodule.directive(\"tgWikiNav\", [\"$tgRepo\", \"$log\", \"$tgLocation\", \"$tgConfirm\", \"$tgNavUrls\",\n                               \"$tgAnalytics\", \"$tgLoading\", \"$tgTemplate\", \"$compile\", \"$translate\", WikiNavDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/lightboxes.coffee\n###\n\ntaiga = @.taiga\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaKanban\")\n\nMAX_MEMBERSHIP_FIELDSETS = 4\n\n#############################################################################\n## Create Members Lightbox Directive\n#############################################################################\n\nCreateMembersDirective = ($rs, $rootScope, $confirm, $loading, lightboxService, $compile) ->\n    extraTextTemplate = \"\"\"\n    <fieldset class=\"extra-text\">\n        <textarea ng-attr-placeholder=\"{{'LIGHTBOX.CREATE_MEMBER.PLACEHOLDER_INVITATION_TEXT' | translate}}\"\n                  maxlength=\"255\"></textarea>\n    </fieldset>\n    \"\"\"\n\n    template = _.template(\"\"\"\n    <div class=\"add-member-wrapper\">\n        <fieldset>\n            <input tg-capslock type=\"email\" placeholder=\"{{'LIGHTBOX.CREATE_MEMBER.PLACEHOLDER_TYPE_EMAIL' | translate}}\"\n                   <% if(required) { %> data-required=\"true\" <% } %> data-type=\"email\" />\n        </fieldset>\n        <fieldset>\n            <select <% if(required) { %> data-required=\"true\" <% } %> data-required=\"true\">\n                <% _.each(roleList, function(role) { %>\n                <option value=\"<%- role.id %>\"><%- role.name %></option>\n                <% }); %>\n            </select>\n            <a class=\"icon icon-plus add-fieldset\" href=\"\"></a>\n        </fieldset>\n    </div>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        createFieldSet = (required = true)->\n            ctx = {roleList: $scope.project.roles, required: required}\n            return $compile(template(ctx))($scope)\n\n        resetForm = ->\n            $el.find(\"form textarea\").remove()\n            $el.find(\"form .add-member-wrapper\").remove()\n\n            invitations = $el.find(\".add-member-forms\")\n            invitations.html($compile(extraTextTemplate)($scope))\n\n            fieldSet = createFieldSet()\n            invitations.prepend(fieldSet)\n\n        $scope.$on \"membersform:new\",  ->\n            resetForm()\n            lightboxService.open($el)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        $el.on \"click\", \".delete-fieldset\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            fieldSet = target.closest('.add-member-wrapper')\n\n            fieldSet.remove()\n\n            lastActionButton = $el.find(\".add-member-wrapper fieldset:last > a\")\n            if lastActionButton.hasClass(\"icon-delete delete-fieldset\")\n                lastActionButton.removeClass(\"icon-delete delete-fieldset\")\n                                .addClass(\"icon-plus add-fieldset\")\n\n        $el.on \"click\", \".add-fieldset\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            fieldSet = target.closest('.add-member-wrapper')\n\n            target.removeClass(\"icon-plus add-fieldset\")\n                  .addClass(\"icon-delete delete-fieldset\")\n\n            newFieldSet = createFieldSet(false)\n            fieldSet.after(newFieldSet)\n\n            $scope.$digest() # To compile newFieldSet and translate text\n\n            if $el.find(\".add-member-wrapper\").length == MAX_MEMBERSHIP_FIELDSETS\n                $el.find(\".add-member-wrapper fieldset:last > a\").removeClass(\"icon-plus add-fieldset\")\n                                             .addClass(\"icon-delete delete-fieldset\")\n\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            onSuccess = (data) ->\n                currentLoading.finish()\n                lightboxService.close($el)\n                $confirm.notify(\"success\")\n                $rootScope.$broadcast(\"membersform:new:success\")\n\n            onError = (data) ->\n                currentLoading.finish()\n                lightboxService.close($el)\n                $confirm.notify(\"error\")\n                $rootScope.$broadcast(\"membersform:new:error\")\n\n            form = $el.find(\"form\").checksley()\n\n            #checksley find new fields\n            form.destroy()\n            form.initialize()\n            if not form.validate()\n                return\n\n            memberWrappers = $el.find(\"form .add-member-wrapper\")\n            memberWrappers = _.filter memberWrappers, (mw) ->\n                angular.element(mw).find(\"input\").hasClass('checksley-ok')\n\n            invitations = _.map memberWrappers, (mw) ->\n                memberWrapper = angular.element(mw)\n                email =  memberWrapper.find(\"input\")\n                role = memberWrapper.find(\"select\")\n\n                return {\n                    email: email.val()\n                    role_id: role.val()\n                }\n\n            if invitations.length\n                invitation_extra_text = $el.find(\"form textarea\").val()\n\n                promise = $rs.memberships.bulkCreateMemberships($scope.project.id,\n                                                      invitations, invitation_extra_text)\n                promise.then(onSuccess, onError)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n    return {link: link}\n\nmodule.directive(\"tgLbCreateMembers\", [\"$tgResources\", \"$rootScope\", \"$tgConfirm\", \"$tgLoading\",\n                                       \"lightboxService\", \"$compile\", CreateMembersDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/memberships.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaAdmin\")\n\n\n#############################################################################\n## Project Memberships Controller\n#############################################################################\n\nclass MembershipsController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"$tgAnalytics\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls, @analytics,\n                  @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.project = {}\n        @scope.filters = {}\n\n        promise = @.loadInitialData()\n\n        promise.then  =>\n           title = @translate.instant(\"ADMIN.MEMBERSHIPS.PAGE_TITLE\", {projectName:  @scope.project.name})\n           description = @scope.project.description\n           @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"membersform:new:success\", =>\n            @.loadMembers()\n            @analytics.trackEvent(\"membership\", \"create\", \"create memberships on admin\", 1)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.i_am_owner\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadMembers: ->\n        httpFilters = @.getUrlFilters()\n        return @rs.memberships.list(@scope.projectId, httpFilters).then (data) =>\n            @scope.memberships = _.filter(data.models, (membership) ->\n                                    membership.user == null or membership.is_user_active)\n\n            @scope.page = data.current\n            @scope.count = data.count\n            @scope.paginatedBy = data.paginatedBy\n            return data\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then =>\n            @.loadMembers()\n\n        return promise\n\n    getUrlFilters: ->\n        filters = _.pick(@location.search(), \"page\")\n        filters.page = 1 if not filters.page\n        return filters\n\n    addNewMembers:  ->\n        @rootscope.$broadcast(\"membersform:new\")\n\n\nmodule.controller(\"MembershipsController\", MembershipsController)\n\n\n#############################################################################\n## Member Avatar Directive\n#############################################################################\n\nMembershipsDirective = ($template, $compile) ->\n    template = $template.get(\"admin/admin-membership-paginator.html\", true)\n\n    linkPagination = ($scope, $el, $attrs, $ctrl) ->\n        # Constants\n        afterCurrent = 2\n        beforeCurrent = 4\n        atBegin = 2\n        atEnd = 2\n\n        $pagEl = $el.find(\".memberships-paginator\")\n\n        getNumPages = ->\n            numPages = $scope.count / $scope.paginatedBy\n            if parseInt(numPages, 10) < numPages\n                numPages = parseInt(numPages, 10) + 1\n            else\n                numPages = parseInt(numPages, 10)\n\n            return numPages\n\n        renderPagination = ->\n            numPages = getNumPages()\n\n            if numPages <= 1\n                $pagEl.hide()\n                return\n\n            pages = []\n            options = {}\n            options.pages = pages\n            options.showPrevious = ($scope.page > 1)\n            options.showNext = not ($scope.page == numPages)\n\n            cpage = $scope.page\n\n            for i in [1..numPages]\n                if i == (cpage + afterCurrent) and numPages > (cpage + afterCurrent + atEnd)\n                    pages.push({classes: \"dots\", type: \"dots\"})\n                else if i == (cpage - beforeCurrent) and cpage > (atBegin + beforeCurrent)\n                    pages.push({classes: \"dots\", type: \"dots\"})\n                else if i > (cpage + afterCurrent) and i <= (numPages - atEnd)\n                else if i < (cpage - beforeCurrent) and i > atBegin\n                else if i == cpage\n                    pages.push({classes: \"active\", num: i, type: \"page-active\"})\n                else\n                    pages.push({classes: \"page\", num: i, type: \"page\"})\n\n            html = template(options)\n            html = $compile(html)($scope)\n\n            $pagEl.html(html)\n            $pagEl.show()\n\n        $scope.$watch \"memberships\", (value) ->\n            # Do nothing if value is not logical true\n            return if not value\n\n            renderPagination()\n\n        $el.on \"click\", \".memberships-paginator a.next\", (event) ->\n            event.preventDefault()\n\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", $scope.page + 1)\n                $ctrl.loadMembers()\n\n        $el.on \"click\", \".memberships-paginator a.previous\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", $scope.page - 1)\n                $ctrl.loadMembers()\n\n        $el.on \"click\", \".memberships-paginator li.page > a\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            pagenum = target.data(\"pagenum\")\n\n            $scope.$apply ->\n                $ctrl.selectFilter(\"page\", pagenum)\n                $ctrl.loadMembers()\n\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        linkPagination($scope, $el, $attrs, $ctrl)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgMemberships\", [\"$tgTemplate\", \"$compile\", MembershipsDirective])\n\n\n#############################################################################\n## Member Avatar Directive\n#############################################################################\n\nMembershipsRowAvatarDirective = ($log, $template, $translate) ->\n    template = $template.get(\"admin/memberships-row-avatar.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        pending = $translate.instant(\"ADMIN.MEMBERSHIP.STATUS_PENDING\")\n        render = (member) ->\n            ctx = {\n                full_name: if member.full_name then member.full_name else \"\"\n                email: if member.user_email then member.user_email else member.email\n                imgurl: if member.photo then member.photo else \"/images/unnamed.png\"\n                pending: if !member.is_user_active then pending else \"\"\n            }\n\n            html = template(ctx)\n            $el.html(html)\n\n        if not $attrs.tgMembershipsRowAvatar?\n            return $log.error \"MembershipsRowAvatarDirective: the directive need a member\"\n\n        member = $scope.$eval($attrs.tgMembershipsRowAvatar)\n        render(member)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgMembershipsRowAvatar\", [\"$log\", \"$tgTemplate\", '$translate', MembershipsRowAvatarDirective])\n\n\n#############################################################################\n## Member IsAdminCheckbox Directive\n#############################################################################\n\nMembershipsRowAdminCheckboxDirective = ($log, $repo, $confirm, $template, $compile) ->\n    template = $template.get(\"admin/admin-memberships-row-checkbox.html\", true)\n\n    link = ($scope, $el, $attrs) ->\n        render = (member) ->\n            ctx = {inputId: \"is-admin-#{member.id}\"}\n\n            html = template(ctx)\n            html = $compile(html)($scope)\n\n            $el.html(html)\n\n        if not $attrs.tgMembershipsRowAdminCheckbox?\n            return $log.error \"MembershipsRowAdminCheckboxDirective: the directive need a member\"\n\n        member = $scope.$eval($attrs.tgMembershipsRowAdminCheckbox)\n        html = render(member)\n\n        if member.is_owner\n            $el.find(\":checkbox\").prop(\"checked\", true)\n\n        $el.on \"click\", \":checkbox\", (event) =>\n            onSuccess = ->\n                $confirm.notify(\"success\")\n\n            onError = (data) ->\n                member.revert()\n                $el.find(\":checkbox\").prop(\"checked\", member.is_owner)\n                $confirm.notify(\"error\", data.is_owner[0])\n\n            target = angular.element(event.currentTarget)\n            member.is_owner = target.prop(\"checked\")\n            $repo.save(member).then(onSuccess, onError)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgMembershipsRowAdminCheckbox\", [\"$log\", \"$tgRepo\", \"$tgConfirm\",\n    \"$tgTemplate\", \"$compile\", MembershipsRowAdminCheckboxDirective])\n\n\n#############################################################################\n## Member RoleSelector Directive\n#############################################################################\n\nMembershipsRowRoleSelectorDirective = ($log, $repo, $confirm) ->\n    template = _.template(\"\"\"\n    <select>\n        <% _.each(roleList, function(role) { %>\n        <option value=\"<%- role.id %>\" <% if(selectedRole === role.id){ %>selected=\"selected\"<% } %>>\n            <%- role.name %>\n        </option>\n        <% }); %>\n    </select>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        render = (member) ->\n            ctx = {\n                roleList: $scope.project.roles,\n                selectedRole: member.role\n            }\n\n            html = template(ctx)\n            $el.html(html)\n\n        if not $attrs.tgMembershipsRowRoleSelector?\n            return $log.error \"MembershipsRowRoleSelectorDirective: the directive need a member\"\n\n        $ctrl = $el.controller()\n        member = $scope.$eval($attrs.tgMembershipsRowRoleSelector)\n        html = render(member)\n\n        $el.on \"change\", \"select\", (event) =>\n            onSuccess = ->\n                $confirm.notify(\"success\")\n\n            onError = ->\n                $confirm.notify(\"error\")\n\n            target = angular.element(event.currentTarget)\n            newRole = parseInt(target.val(), 10)\n\n            if member.role != newRole\n                member.role = newRole\n                $repo.save(member).then(onSuccess, onError)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgMembershipsRowRoleSelector\", [\"$log\", \"$tgRepo\", \"$tgConfirm\",\n                                                  MembershipsRowRoleSelectorDirective])\n\n\n#############################################################################\n## Member Actions Directive\n#############################################################################\n\nMembershipsRowActionsDirective = ($log, $repo, $rs, $confirm, $compile, $translate) ->\n    activedTemplate = \"\"\"\n    <div class=\"active\", translate=\"ADMIN.MEMBERSHIP.STATUS_ACTIVE\">\n    </div>\n    <a class=\"delete\" href=\"\">\n        <span class=\"icon icon-delete\"></span>\n    </a>\n    \"\"\"\n\n    pendingTemplate = \"\"\"\n    <a class=\"resend\" href=\"\">\n        {{'ADMIN.MEMBERSHIP.RESEND' | translate}}\n    </a>\n    <a class=\"delete\" href=\"\">\n        <span class=\"icon icon-delete\"></span>\n    </a>\n    \"\"\"\n\n    link = ($scope, $el, $attrs) ->\n        render = (member) ->\n            if member.user\n                html = $compile(activedTemplate)($scope)\n            else\n                html = $compile(pendingTemplate)($scope)\n\n            $el.html(html)\n\n        if not $attrs.tgMembershipsRowActions?\n            return $log.error \"MembershipsRowActionsDirective: the directive need a member\"\n\n        $ctrl = $el.controller()\n        member = $scope.$eval($attrs.tgMembershipsRowActions)\n        render(member)\n\n        $el.on \"click\", \".pending\", (event) ->\n            event.preventDefault()\n            onSuccess = ->\n                text = $translate.instant(\"ADMIN.MEMBERSHIP.SUCCESS_SEND_INVITATION\", {\n                    email: $scope.member.email\n                })\n                $confirm.notify(\"success\", text)\n            onError = ->\n                text = $translate.instant(\"ADMIM.MEMBERSHIP.ERROR_SEND_INVITATION\")\n                $confirm.notify(\"error\", text)\n\n            $rs.memberships.resendInvitation($scope.member.id).then(onSuccess, onError)\n\n        $el.on \"click\", \".delete\", (event) ->\n            event.preventDefault()\n\n            title = $translate.instant(\"ADMIN.MEMBERSHIP.DELETE_MEMBER\")\n            defaultMsg = $translate.instant(\"ADMIN.MEMBERSHIP.DEFAULT_DELETE_MESSAGE\", {email: member.email})\n            message = if member.user then member.full_name else defaultMsg\n\n            $confirm.askOnDelete(title, message).then (askResponse) ->\n                onSuccess = =>\n                    askResponse.finish()\n\n                    if $scope.page > 1 && ($scope.count - 1) <= $scope.paginatedBy\n                        $ctrl.selectFilter(\"page\", $scope.page - 1)\n\n                    $ctrl.loadMembers()\n\n                    text = $translate.instant(\"ADMIN.MEMBERSHIP.SUCCESS_DELETE\")\n                    $confirm.notify(\"success\", null, text)\n\n                onError = =>\n                    askResponse.finish(false)\n\n                    text = $translate.instant(\"ADMIN.MEMBERSHIP.ERROR_DELETE\", {message: message})\n                    $confirm.notify(\"error\", null, text)\n\n                $repo.remove(member).then(onSuccess, onError)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\n\nmodule.directive(\"tgMembershipsRowActions\", [\"$log\", \"$tgRepo\", \"$tgResources\", \"$tgConfirm\", \"$compile\",\n                                             \"$translate\", MembershipsRowActionsDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/nav.coffee\n###\n\nAdminNavigationDirective = ->\n    link = ($scope, $el, $attrs) ->\n        section = $attrs.tgAdminNavigation\n        $el.find(\".active\").removeClass(\"active\")\n        $el.find(\"#adminmenu-#{section} a\").addClass(\"active\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule = angular.module(\"taigaAdmin\")\nmodule.directive(\"tgAdminNavigation\", AdminNavigationDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/project-profile.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntrim = @.taiga.trim\ntoString = @.taiga.toString\njoinStr = @.taiga.joinStr\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaAdmin\")\n\n\n#############################################################################\n## Project Profile Controller\n#############################################################################\n\nclass ProjectProfileController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls,\n                  @appMetaService, @translate) ->\n        @scope.project = {}\n\n        promise = @.loadInitialData()\n\n        promise.then =>\n            sectionName = @translate.instant( @scope.sectionName)\n            title = @translate.instant(\"ADMIN.PROJECT_PROFILE.PAGE_TITLE\", {\n                     sectionName: sectionName, projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"project:loaded\", =>\n            sectionName = @translate.instant(@scope.sectionName)\n            title = @translate.instant(\"ADMIN.PROJECT_PROFILE.PAGE_TITLE\", {\n                     sectionName: sectionName, projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.i_am_owner\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.pointsList = _.sortBy(project.points, \"order\")\n            @scope.usStatusList = _.sortBy(project.us_statuses, \"order\")\n            @scope.taskStatusList = _.sortBy(project.task_statuses, \"order\")\n            @scope.prioritiesList = _.sortBy(project.priorities, \"order\")\n            @scope.severitiesList = _.sortBy(project.severities, \"order\")\n            @scope.issueTypesList = _.sortBy(project.issue_types, \"order\")\n            @scope.issueStatusList = _.sortBy(project.issue_statuses, \"order\")\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise\n\n    openDeleteLightbox: ->\n        @rootscope.$broadcast(\"deletelightbox:new\", @scope.project)\n\nmodule.controller(\"ProjectProfileController\", ProjectProfileController)\n\n\n#############################################################################\n## Project Profile Directive\n#############################################################################\n\nProjectProfileDirective = ($repo, $confirm, $loading, $navurls, $location, projectService, currentUserService) ->\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            return if not form.validate()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.save($scope.project)\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                newUrl = $navurls.resolve(\"project-admin-project-profile-details\", {\n                    project: $scope.project.slug\n                })\n                $location.path(newUrl)\n\n                $ctrl.loadInitialData()\n\n                projectService.fetchProject()\n                currentUserService.loadProjects()\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n    return {link:link}\n\nmodule.directive(\"tgProjectProfile\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$tgNavUrls\", \"$tgLocation\",\n                                      \"tgProjectService\", \"tgCurrentUserService\", ProjectProfileDirective])\n\n\n#############################################################################\n## Project Default Values Directive\n#############################################################################\n\nProjectDefaultValuesDirective = ($repo, $confirm, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            return if not form.validate()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.save($scope.project)\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgProjectDefaultValues\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\",\n                                            ProjectDefaultValuesDirective])\n\n#############################################################################\n## Project Modules Directive\n#############################################################################\n\nProjectModulesDirective = ($repo, $confirm, $loading, projectService) ->\n    link = ($scope, $el, $attrs) ->\n        submit = =>\n            form = $el.find(\"form\").checksley()\n            return if not form.validate()\n\n            target = angular.element(\".admin-functionalities .submit-button\")\n            currentLoading = $loading()\n                .target(target)\n                .start()\n\n            promise = $repo.save($scope.project)\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                $scope.$emit(\"project:loaded\", $scope.project)\n\n                projectService.fetchProject()\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                $confirm.notify(\"error\", data._error_message)\n\n        $el.on \"submit\", \"form\", (event) ->\n            event.preventDefault()\n            submit()\n\n        $el.on \"click\", \".admin-functionalities a.button-green\", (event) ->\n            event.preventDefault()\n            submit()\n\n        $scope.$watch \"isVideoconferenceActivated\", (isVideoconferenceActivated) ->\n            if isVideoconferenceActivated\n                $el.find(\".videoconference-attributes\").removeClass(\"hidden\")\n            else\n                $el.find(\".videoconference-attributes\").addClass(\"hidden\")\n                $scope.project.videoconferences = null\n                $scope.project.videoconferences_extra_data = \"\"\n\n        $scope.$watch \"project\", (project) ->\n            if project.videoconferences?\n                $scope.isVideoconferenceActivated = true\n            else\n                $scope.isVideoconferenceActivated = false\n\n    return {link:link}\n\nmodule.directive(\"tgProjectModules\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"tgProjectService\",\n                                      ProjectModulesDirective])\n\n\n#############################################################################\n## Project Export Directive\n#############################################################################\n\nProjectExportDirective = ($window, $rs, $confirm, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        buttonsEl = $el.find(\".admin-project-export-buttons\")\n        showButtons = -> buttonsEl.removeClass(\"hidden\")\n        hideButtons = -> buttonsEl.addClass(\"hidden\")\n\n        resultEl = $el.find(\".admin-project-export-result\")\n        showResult = -> resultEl.removeClass(\"hidden\")\n        hideResult = -> resultEl.addClass(\"hidden\")\n\n        spinnerEl = $el.find(\".spin\")\n        showSpinner = -> spinnerEl.removeClass(\"hidden\")\n        hideSpinner = -> spinnerEl.addClass(\"hidden\")\n\n        resultTitleEl = $el.find(\".result-title\")\n\n\n        loading_title = $translate.instant(\"ADMIN.PROJECT_EXPORT.LOADING_TITLE\")\n        loading_msg = $translate.instant(\"ADMIN.PROJECT_EXPORT.LOADING_MESSAGE\")\n        dump_ready_text = -> resultTitleEl.html($translate.instant(\"ADMIN.PROJECT_EXPORT.DUMP_READY\"))\n        asyn_message = -> resultTitleEl.html($translate.instant(\"ADMIN.PROJECT_EXPORT.ASYNC_MESSAGE\"))\n        syn_message = (url) -> resultTitleEl.html($translate.instant(\"ADMIN.PROJECT_EXPORT.SYNC_MESSAGE\", {\n                                                                                                   url: url}))\n\n        setLoadingTitle = -> resultTitleEl.html(loading_title)\n        setAsyncTitle = -> resultTitleEl.html(loading_msg)\n        setSyncTitle = -> resultTitleEl.html(dump_ready_text)\n\n        resultMessageEl = $el.find(\".result-message \")\n        setLoadingMessage = -> resultMessageEl.html(loading_msg)\n        setAsyncMessage = -> resultMessageEl.html(asyn_message)\n        setSyncMessage = (url) -> resultMessageEl.html(syn_message(url))\n\n        showLoadingMode = ->\n            showSpinner()\n            setLoadingTitle()\n            setLoadingMessage()\n            hideButtons()\n            showResult()\n\n        showExportResultAsyncMode = ->\n            hideSpinner()\n            setAsyncTitle()\n            setAsyncMessage()\n\n        showExportResultSyncMode = (url) ->\n            hideSpinner()\n            setSyncTitle()\n            setSyncMessage(url)\n\n        showErrorMode = ->\n            hideSpinner()\n            hideResult()\n            showButtons()\n\n        $el.on \"click\", \"a.button-export\", debounce 2000, (event) =>\n            event.preventDefault()\n\n            onSuccess = (result) =>\n                if result.status == 202 # Async mode\n                    showExportResultAsyncMode()\n                else #result.status == 200 # Sync mode\n                    dumpUrl = result.data.url\n                    showExportResultSyncMode(dumpUrl)\n                    $window.open(dumpUrl, \"_blank\")\n\n            onError = (result) =>\n                showErrorMode()\n\n                errorMsg = $translate.instant(\"ADMIN.PROJECT_EXPORT.ERROR\")\n\n                if result.status == 429  # TOO MANY REQUESTS\n                    errorMsg = $translate.instant(\"ADMIN.PROJECT_EXPORT.ERROR_BUSY\")\n                else if result.data?._error_message\n                    errorMsg = $translate.instant(\"ADMIN.PROJECT_EXPORT.ERROR_BUSY\", {\n                                                   message: result.data._error_message})\n\n                $confirm.notify(\"error\", errorMsg)\n\n            showLoadingMode()\n            $rs.projects.export($scope.projectId).then(onSuccess, onError)\n\n    return {link:link}\n\nmodule.directive(\"tgProjectExport\", [\"$window\", \"$tgResources\", \"$tgConfirm\", \"$translate\",\n                                     ProjectExportDirective])\n\n\n#############################################################################\n## CSV Export Controllers\n#############################################################################\n\nclass CsvExporterController extends taiga.Controller\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgUrls\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @urls, @confirm, @rs, @translate) ->\n        @rootscope.$on(\"project:loaded\", @.setCsvUuid)\n        @scope.$watch \"csvUuid\", (value) =>\n            if value\n                @scope.csvUrl = @urls.resolveAbsolute(\"#{@.type}-csv\", value)\n            else\n                @scope.csvUrl = \"\"\n\n    setCsvUuid: =>\n        @scope.csvUuid = @scope.project[\"#{@.type}_csv_uuid\"]\n\n    _generateUuid: (response=null) =>\n        promise = @rs.projects[\"regenerate_#{@.type}_csv_uuid\"](@scope.projectId)\n\n        promise.then (data) =>\n            @scope.csvUuid = data.data?.uuid\n\n        promise.then null, =>\n            @confirm.notify(\"error\")\n\n        promise.finally ->\n            response.finish() if response\n        return promise\n\n    regenerateUuid: ->\n        if @scope.csvUuid\n            title = @translate.instant(\"ADMIN.REPORTS.REGENERATE_TITLE\")\n            subtitle = @translate.instant(\"ADMIN.REPORTS.REGENERATE_SUBTITLE\")\n\n            @confirm.ask(title, subtitle).then @._generateUuid\n        else\n            @._generateUuid()\n\n\nclass CsvExporterUserstoriesController extends CsvExporterController\n    type: \"userstories\"\n\n\nclass CsvExporterTasksController extends CsvExporterController\n    type: \"tasks\"\n\n\nclass CsvExporterIssuesController extends CsvExporterController\n    type: \"issues\"\n\n\nmodule.controller(\"CsvExporterUserstoriesController\", CsvExporterUserstoriesController)\nmodule.controller(\"CsvExporterTasksController\", CsvExporterTasksController)\nmodule.controller(\"CsvExporterIssuesController\", CsvExporterIssuesController)\n\n\n#############################################################################\n## CSV Directive\n#############################################################################\n\nCsvUsDirective = ($translate) ->\n    link = ($scope) ->\n        $scope.sectionTitle = \"ADMIN.CSV.SECTION_TITLE_US\"\n\n    return {\n        controller: \"CsvExporterUserstoriesController\",\n        controllerAs: \"ctrl\",\n        templateUrl: \"admin/project-csv.html\",\n        link: link,\n        scope: true\n    }\n\nmodule.directive(\"tgCsvUs\", [\"$translate\", CsvUsDirective])\n\n\nCsvTaskDirective = ($translate) ->\n    link = ($scope) ->\n        $scope.sectionTitle = \"ADMIN.CSV.SECTION_TITLE_TASK\"\n\n    return {\n        controller: \"CsvExporterTasksController\",\n        controllerAs: \"ctrl\",\n        templateUrl: \"admin/project-csv.html\",\n        link: link,\n        scope: true\n    }\n\nmodule.directive(\"tgCsvTask\", [\"$translate\", CsvTaskDirective])\n\n\nCsvIssueDirective = ($translate) ->\n    link = ($scope) ->\n        $scope.sectionTitle = \"ADMIN.CSV.SECTION_TITLE_ISSUE\"\n\n    return {\n        controller: \"CsvExporterIssuesController\",\n        controllerAs: \"ctrl\",\n        templateUrl: \"admin/project-csv.html\",\n        link: link,\n        scope: true\n    }\n\nmodule.directive(\"tgCsvIssue\", [\"$translate\", CsvIssueDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/project-profile.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ntrim = @.taiga.trim\ntoString = @.taiga.toString\njoinStr = @.taiga.joinStr\ngroupBy = @.taiga.groupBy\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaAdmin\")\n\n#############################################################################\n## Project values section Controller\n#############################################################################\n\nclass ProjectValuesSectionController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls,\n                  @appMetaService, @translate) ->\n        @scope.project = {}\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            sectionName = @translate.instant(@scope.sectionName)\n\n            title = @translate.instant(\"ADMIN.PROJECT_VALUES.PAGE_TITLE\", {\n                \"sectionName\": sectionName,\n                \"projectName\": @scope.project.name\n            })\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.i_am_owner\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        return promise\n\n\nmodule.controller(\"ProjectValuesSectionController\", ProjectValuesSectionController)\n\n#############################################################################\n## Project values Controller\n#############################################################################\n\nclass ProjectValuesController extends taiga.Controller\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs) ->\n        @scope.$on(\"admin:project-values:move\", @.moveValue)\n        @rootscope.$on(\"project:loaded\", @.loadValues)\n\n    loadValues: =>\n        return @rs[@scope.resource].listValues(@scope.projectId, @scope.type).then (values) =>\n            @scope.values = values\n            @scope.maxValueOrder = _.max(values, \"order\").order\n            return values\n\n    moveValue: (ctx, itemValue, itemIndex) =>\n        values = @scope.values\n        r = values.indexOf(itemValue)\n        values.splice(r, 1)\n        values.splice(itemIndex, 0, itemValue)\n        _.each values, (value, index) ->\n            value.order = index\n\n        @repo.saveAll(values)\n\nmodule.controller(\"ProjectValuesController\", ProjectValuesController)\n\n\n#############################################################################\n## Project values directive\n#############################################################################\n\nProjectValuesDirective = ($log, $repo, $confirm, $location, animationFrame, $translate, $rootscope) ->\n    ## Drag & Drop Link\n\n    linkDragAndDrop = ($scope, $el, $attrs) ->\n        oldParentScope = null\n        newParentScope = null\n        itemEl = null\n        tdom = $el.find(\".sortable\")\n\n        tdom.sortable({\n            handle: \".row.table-main.visualization\",\n            dropOnEmpty: true\n            connectWith: \".project-values-body\"\n            revert: 400\n            axis: \"y\"\n        })\n\n        tdom.on \"sortstop\", (event, ui) ->\n            itemEl = ui.item\n            itemValue = itemEl.scope().value\n            itemIndex = itemEl.index()\n            $scope.$broadcast(\"admin:project-values:move\", itemValue, itemIndex)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    ## Value Link\n\n    linkValue = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n        valueType = $attrs.type\n        objName = $attrs.objname\n\n        initializeNewValue = ->\n            $scope.newValue = {\n                \"name\": \"\"\n                \"is_closed\": false\n                \"is_archived\": false\n            }\n\n        initializeTextTranslations = ->\n            $scope.addNewElementText = $translate.instant(\"ADMIN.PROJECT_VALUES_#{objName.toUpperCase()}.ACTION_ADD\")\n\n        initializeNewValue()\n        initializeTextTranslations()\n\n        $rootscope.$on \"$translateChangeEnd\", ->\n            $scope.$evalAsync(initializeTextTranslations)\n\n        goToBottomList = (focus = false) =>\n            table = $el.find(\".table-main\")\n\n            $(document.body).scrollTop(table.offset().top + table.height())\n\n            if focus\n                $el.find(\".new-value input:visible\").first().focus()\n\n        saveValue = (target) ->\n            formEl = target.parents(\"form\")\n            form = formEl.checksley()\n            return if not form.validate()\n\n            value = formEl.scope().value\n            promise = $repo.save(value)\n            promise.then =>\n                row = target.parents(\".row.table-main\")\n                row.addClass(\"hidden\")\n                row.siblings(\".visualization\").removeClass('hidden')\n\n            promise.then null, (data) ->\n                form.setErrors(data)\n\n        saveNewValue = (target) ->\n            formEl = target.parents(\"form\")\n            form = formEl.checksley()\n            return if not form.validate()\n\n            $scope.newValue.project = $scope.project.id\n\n            $scope.newValue.order = if $scope.maxValueOrder then $scope.maxValueOrder + 1 else 1\n\n            promise = $repo.create(valueType, $scope.newValue)\n            promise.then (data) =>\n                target.addClass(\"hidden\")\n\n                $scope.values.push(data)\n                $scope.maxValueOrder = data.order\n                initializeNewValue()\n\n            promise.then null, (data) ->\n                form.setErrors(data)\n\n        cancel = (target) ->\n            row = target.parents(\".row.table-main\")\n            formEl = target.parents(\"form\")\n            value = formEl.scope().value\n            $scope.$apply ->\n                row.addClass(\"hidden\")\n                value.revert()\n                row.siblings(\".visualization\").removeClass('hidden')\n\n        $el.on \"click\", \".show-add-new\", (event) ->\n            event.preventDefault()\n            $el.find(\".new-value\").removeClass('hidden')\n\n            goToBottomList(true)\n\n        $el.on \"click\", \".add-new\", debounce 2000, (event) ->\n            event.preventDefault()\n            target = $el.find(\".new-value\")\n            saveNewValue(target)\n\n        $el.on \"click\", \".delete-new\", (event) ->\n            event.preventDefault()\n            $el.find(\".new-value\").addClass(\"hidden\")\n            initializeNewValue()\n\n        $el.on \"click\", \".edit-value\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n\n            row = target.parents(\".row.table-main\")\n            row.addClass(\"hidden\")\n\n            editionRow = row.siblings(\".edition\")\n            editionRow.removeClass('hidden')\n            editionRow.find('input:visible').first().focus().select()\n\n        $el.on \"keyup\", \".edition input\", (event) ->\n            if event.keyCode == 13\n                target = angular.element(event.currentTarget)\n                saveValue(target)\n            else if event.keyCode == 27\n                target = angular.element(event.currentTarget)\n                cancel(target)\n\n        $el.on \"keyup\", \".new-value input\", (event) ->\n            if event.keyCode == 13\n                target = $el.find(\".new-value\")\n                saveNewValue(target)\n            else if event.keyCode == 27\n                $el.find(\".new-value\").addClass(\"hidden\")\n                initializeNewValue()\n\n        $el.on \"click\", \".save\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            saveValue(target)\n\n        $el.on \"click\", \".cancel\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            cancel(target)\n\n        $el.on \"click\", \".delete-value\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.parents(\"form\")\n            value = formEl.scope().value\n\n            choices = {}\n            _.each $scope.values, (option) ->\n                if value.id != option.id\n                    choices[option.id] = option.name\n\n            subtitle = value.name\n\n            if _.keys(choices).length == 0\n                return $confirm.error($translate.instant(\"ADMIN.PROJECT_VALUES.ERROR_DELETE_ALL\"))\n\n            title = $translate.instant(\"ADMIN.COMMON.TITLE_ACTION_DELETE_VALUE\")\n            text = $translate.instant(\"ADMIN.PROJECT_VALUES.REPLACEMENT\")\n\n            $confirm.askChoice(title, subtitle, choices, text).then (response) ->\n                onSucces = ->\n                    $ctrl.loadValues().finally ->\n                        response.finish()\n                onError = ->\n                    $confirm.notify(\"error\")\n                $repo.remove(value, {\"moveTo\": response.selected}).then(onSucces, onError)\n\n    link = ($scope, $el, $attrs) ->\n        linkDragAndDrop($scope, $el, $attrs)\n        linkValue($scope, $el, $attrs)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgProjectValues\", [\"$log\", \"$tgRepo\", \"$tgConfirm\", \"$tgLocation\", \"animationFrame\", \"$translate\", \"$rootScope\", ProjectValuesDirective])\n\n\n#############################################################################\n## Color selection directive\n#############################################################################\n\nColorSelectionDirective = () ->\n    ## Color selection Link\n\n    link = ($scope, $el, $attrs, $model) ->\n        $ctrl = $el.controller()\n\n        $scope.$watch $attrs.ngModel, (element) ->\n            $scope.color = element.color\n\n        $el.on \"click\", \".current-color\", (event) ->\n            # Showing the color selector\n            event.preventDefault()\n            event.stopPropagation()\n            target = angular.element(event.currentTarget)\n            $el.find(\".select-color\").hide()\n            target.siblings(\".select-color\").show()\n            # Hide when click outside\n            body = angular.element(\"body\")\n            body.on \"click\", (event) =>\n                if angular.element(event.target).parent(\".select-color\").length == 0\n                    $el.find(\".select-color\").hide()\n                    body.unbind(\"click\")\n\n        $el.on \"click\", \".select-color .color\", (event) ->\n            # Selecting one color on color selector\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            $scope.$apply ->\n                $model.$modelValue.color = target.data(\"color\")\n            $el.find(\".select-color\").hide()\n\n        $el.on \"click\", \".select-color .selected-color\", (event) ->\n            event.preventDefault()\n            $scope.$apply ->\n                $model.$modelValue.color = $scope.color\n            $el.find(\".select-color\").hide()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n      return {\n          link: link\n          require:\"ngModel\"\n      }\n\nmodule.directive(\"tgColorSelection\", ColorSelectionDirective)\n\n\n#############################################################################\n## Custom Attributes Controller\n#############################################################################\n\n# Custom attributes types (see taiga-back/taiga/projects/custom_attributes/choices.py)\nTEXT_TYPE = \"text\"\nMULTILINE_TYPE = \"multiline\"\nDATE_TYPE = \"date\"\n\n\nTYPE_CHOICES = [\n    {\n        key: TEXT_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_TEXT\"\n    },\n    {\n        key: MULTILINE_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_MULTI\"\n    },\n    {\n        key: DATE_TYPE,\n        name: \"ADMIN.CUSTOM_FIELDS.FIELD_TYPE_DATE\"\n    }\n]\n\nclass ProjectCustomAttributesController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @rs, @params, @q, @location, @navUrls, @appMetaService,\n                  @translate) ->\n        @scope.TYPE_CHOICES = TYPE_CHOICES\n\n        @scope.project = {}\n\n        @rootscope.$on \"project:loaded\", =>\n            @.loadCustomAttributes()\n\n            sectionName = @translate.instant(@scope.sectionName)\n            title = @translate.instant(\"ADMIN.CUSTOM_ATTRIBUTES.PAGE_TITLE\", {\n                \"sectionName\": sectionName,\n                \"projectName\": @scope.project.name\n            })\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n    #########################\n    # Custom Attribute\n    #########################\n\n    loadCustomAttributes: =>\n        return @rs.customAttributes[@scope.type].list(@scope.projectId).then (customAttributes) =>\n            @scope.customAttributes = customAttributes\n            @scope.maxOrder = _.max(customAttributes, \"order\").order\n            return customAttributes\n\n    createCustomAttribute: (attrValues) =>\n        return @repo.create(\"custom-attributes/#{@scope.type}\", attrValues)\n\n    saveCustomAttribute: (attrModel) =>\n        return @repo.save(attrModel)\n\n    deleteCustomAttribute: (attrModel) =>\n        return @repo.remove(attrModel)\n\n    moveCustomAttributes: (attrModel, newIndex) =>\n        customAttributes = @scope.customAttributes\n        r = customAttributes.indexOf(attrModel)\n        customAttributes.splice(r, 1)\n        customAttributes.splice(newIndex, 0, attrModel)\n\n        _.each customAttributes, (val, idx) ->\n            val.order = idx\n\n        @repo.saveAll(customAttributes)\n\n\nmodule.controller(\"ProjectCustomAttributesController\", ProjectCustomAttributesController)\n\n\n#############################################################################\n## Custom Attributes Directive\n#############################################################################\n\nProjectCustomAttributesDirective = ($log, $confirm, animationFrame, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        ##################################\n        # Drag & Drop\n        ##################################\n        sortableEl = $el.find(\".js-sortable\")\n\n        sortableEl.sortable({\n            handle: \".js-view-custom-field\",\n            dropOnEmpty: true\n            revert: 400\n            axis: \"y\"\n        })\n\n        sortableEl.on \"sortstop\", (event, ui) ->\n            itemEl = ui.item\n            itemAttr = itemEl.scope().attr\n            itemIndex = itemEl.index()\n            $ctrl.moveCustomAttributes(itemAttr, itemIndex)\n\n        ##################################\n        # New custom attribute\n        ##################################\n\n        showCreateForm = ->\n            $el.find(\".js-new-custom-field\").removeClass(\"hidden\")\n            $el.find(\".js-new-custom-field input:visible\").first().focus()\n\n        hideCreateForm = ->\n            $el.find(\".js-new-custom-field\").addClass(\"hidden\")\n\n        showAddButton = ->\n            $el.find(\".js-add-custom-field-button\").removeClass(\"hidden\")\n\n        hideAddButton = ->\n            $el.find(\".js-add-custom-field-button\").addClass(\"hidden\")\n\n        showCancelButton = ->\n            $el.find(\".js-cancel-new-custom-field-button\").removeClass(\"hidden\")\n\n        hideCancelButton = ->\n            $el.find(\".js-cancel-new-custom-field-button\").addClass(\"hidden\")\n\n        resetNewAttr = ->\n            $scope.newAttr = {}\n\n        create = (formEl) ->\n            form = formEl.checksley()\n            return if not form.validate()\n\n            onSucces = =>\n                $ctrl.loadCustomAttributes()\n                hideCreateForm()\n                resetNewAttr()\n                $confirm.notify(\"success\")\n\n            onError = (data) =>\n                form.setErrors(data)\n\n            attr = $scope.newAttr\n            attr.project = $scope.projectId\n            attr.order = if $scope.maxOrder then $scope.maxOrder + 1 else 1\n\n            $ctrl.createCustomAttribute(attr).then(onSucces, onError)\n\n        cancelCreate = ->\n            hideCreateForm()\n            resetNewAttr()\n\n        $scope.$watch \"customAttributes\", (customAttributes) ->\n            return if not customAttributes\n\n            if customAttributes.length == 0\n                hideCancelButton()\n                hideAddButton()\n                showCreateForm()\n            else\n                hideCreateForm()\n                showAddButton()\n                showCancelButton()\n\n        $el.on \"click\", \".js-add-custom-field-button\", (event) ->\n            event.preventDefault()\n\n            showCreateForm()\n\n        $el.on \"click\", \".js-create-custom-field-button\", debounce 2000, (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.closest(\"form\")\n\n            create(formEl)\n\n        $el.on \"click\", \".js-cancel-new-custom-field-button\", (event) ->\n            event.preventDefault()\n\n            cancelCreate()\n\n        $el.on \"keyup\", \".js-new-custom-field input\", (event) ->\n            if event.keyCode == 13 # Enter\n                target = angular.element(event.currentTarget)\n                formEl = target.closest(\"form\")\n                create(formEl)\n            else if event.keyCode == 27 # Esc\n                cancelCreate()\n\n        ##################################\n        # Edit custom attribute\n        ##################################\n\n        showEditForm = (formEl) ->\n            formEl.find(\".js-view-custom-field\").addClass(\"hidden\")\n            formEl.find(\".js-edit-custom-field\").removeClass(\"hidden\")\n            formEl.find(\".js-edit-custom-field input:visible\").first().focus().select()\n\n        hideEditForm = (formEl) ->\n            formEl.find(\".js-edit-custom-field\").addClass(\"hidden\")\n            formEl.find(\".js-view-custom-field\").removeClass(\"hidden\")\n\n        revertChangesInCustomAttribute = (formEl) ->\n            $scope.$apply ->\n                formEl.scope().attr.revert()\n\n        update = (formEl) ->\n            form = formEl.checksley()\n            return if not form.validate()\n\n            onSucces = =>\n                $ctrl.loadCustomAttributes()\n                hideEditForm(formEl)\n                $confirm.notify(\"success\")\n\n            onError = (data) =>\n                form.setErrors(data)\n\n            attr = formEl.scope().attr\n            $ctrl.saveCustomAttribute(attr).then(onSucces, onError)\n\n        cancelUpdate = (formEl) ->\n            hideEditForm(formEl)\n            revertChangesInCustomAttribute(formEl)\n\n        $el.on \"click\", \".js-edit-custom-field-button\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.closest(\"form\")\n\n            showEditForm(formEl)\n\n        $el.on \"click\", \".js-update-custom-field-button\", debounce 2000, (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.closest(\"form\")\n\n            update(formEl)\n\n        $el.on \"click\", \".js-cancel-edit-custom-field-button\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.closest(\"form\")\n\n            cancelUpdate(formEl)\n\n        $el.on \"keyup\", \".js-edit-custom-field input\", (event) ->\n            if event.keyCode == 13 # Enter\n                target = angular.element(event.currentTarget)\n                formEl = target.closest(\"form\")\n                update(formEl)\n            else if event.keyCode == 27 # Esc\n                target = angular.element(event.currentTarget)\n                formEl = target.closest(\"form\")\n                cancelUpdate(formEl)\n\n        ##################################\n        # Delete custom attribute\n        ##################################\n\n        deleteCustomAttribute = (formEl) ->\n            attr = formEl.scope().attr\n            message = attr.name\n\n            title = $translate.instant(\"COMMON.CUSTOM_ATTRIBUTES.DELETE\")\n            text = $translate.instant(\"COMMON.CUSTOM_ATTRIBUTES.CONFIRM_DELETE\")\n\n            $confirm.ask(title, text, message).then (response) ->\n                onSucces = ->\n                    $ctrl.loadCustomAttributes().finally -> response.finish()\n\n                onError = ->\n                    $confirm.notify(\"error\", null, \"We have not been able to delete '#{message}'.\")\n\n                $ctrl.deleteCustomAttribute(attr).then(onSucces, onError)\n\n        $el.on \"click\", \".js-delete-custom-field-button\", debounce 2000, (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            formEl = target.closest(\"form\")\n\n            deleteCustomAttribute(formEl)\n\n    return {link: link}\n\nmodule.directive(\"tgProjectCustomAttributes\", [\"$log\", \"$tgConfirm\", \"animationFrame\", \"$translate\",\n                                               ProjectCustomAttributesDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/memberships.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\nbindMethods = @.taiga.bindMethods\n\nmodule = angular.module(\"taigaAdmin\")\n\n\n#############################################################################\n## Project Roles Controller\n#############################################################################\n\nclass RolesController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls,\n                  @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = \"ADMIN.MENU.PERMISSIONS\"\n        @scope.project = {}\n        @scope.anyComputableRole = true\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"ADMIN.ROLES.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.i_am_owner\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n\n            @scope.$emit('project:loaded', project)\n            @scope.anyComputableRole = _.some(_.map(project.roles, (point) -> point.computable))\n\n            return project\n\n    loadRoles: ->\n        return @rs.roles.list(@scope.projectId).then (roles) =>\n            roles = roles.map (role) ->\n                role.external_user = false\n\n                return role\n\n            public_permission = {\n                \"name\": @translate.instant(\"ADMIN.ROLES.EXTERNAL_USER\"),\n                \"permissions\": @scope.project.public_permissions,\n                \"external_user\": true\n            }\n\n            roles.push(public_permission)\n\n            @scope.roles = roles\n            @scope.role = @scope.roles[0]\n            return roles\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then(=> @.loadRoles())\n        return promise\n\n    setRole: (role) ->\n        @scope.role = role\n        @scope.$broadcast(\"role:changed\", @scope.role)\n\n    delete: ->\n        choices = {}\n        for role in @scope.roles\n            if role.id != @scope.role.id\n                choices[role.id] = role.name\n\n        if _.keys(choices).length == 0\n            return @confirm.error(@translate.instant(\"ADMIN.ROLES.ERROR_DELETE_ALL\"))\n\n        title = @translate.instant(\"ADMIN.ROLES.TITLE_DELETE_ROLE\")\n        subtitle = @scope.role.name\n        replacement = @translate.instant(\"ADMIN.ROLES.REPLACEMENT_ROLE\")\n        warning = @translate.instant(\"ADMIN.ROLES.WARNING_DELETE_ROLE\")\n        return @confirm.askChoice(title, subtitle, choices, replacement, warning).then (response) =>\n            onSuccess = =>\n                @.loadProject()\n                @.loadRoles().finally =>\n                    response.finish()\n            onError = =>\n                @confirm.notify('error')\n\n            return @repo.remove(@scope.role, {moveTo: response.selected}).then onSuccess, onError\n\n    _enableComputable: =>\n        onSuccess = =>\n            @confirm.notify(\"success\")\n            @.loadProject()\n\n        onError = =>\n            @confirm.notify(\"error\")\n            @scope.role.revert()\n\n        @repo.save(@scope.role).then onSuccess, onError\n\n    _disableComputable: =>\n        askOnSuccess = (response) =>\n            onSuccess = =>\n                response.finish()\n                @confirm.notify(\"success\")\n                @.loadProject()\n            onError = =>\n                response.finish()\n                @confirm.notify(\"error\")\n                @scope.role.revert()\n            @repo.save(@scope.role).then onSuccess, onError\n\n        askOnError = (response) =>\n            @scope.role.revert()\n\n        title = @translate.instant(\"ADMIN.ROLES.DISABLE_COMPUTABLE_ALERT_TITLE\")\n        subtitle = @translate.instant(\"ADMIN.ROLES.DISABLE_COMPUTABLE_ALERT_SUBTITLE\", {\n            roleName: @scope.role.name\n        })\n        message =  @translate.instant(\"ADMIN.ROLES.DISABLE_COMPUTABLE_ALERT_MESSAGE\")\n        return @confirm.ask(title, subtitle, message).then askOnSuccess, askOnError\n\n    toggleComputable: debounce 2000, ->\n        if not @scope.role.computable\n            @._disableComputable()\n        else\n            @._enableComputable()\n\nmodule.controller(\"RolesController\", RolesController)\n\n\nEditRoleDirective = ($repo, $confirm) ->\n    link = ($scope, $el, $attrs) ->\n        toggleView = ->\n            $el.find('.total').toggle()\n            $el.find('.edit-role').toggle()\n\n        submit = () ->\n            $scope.role.name = $el.find(\"input\").val()\n\n            promise = $repo.save($scope.role)\n\n            promise.then ->\n                $confirm.notify(\"success\")\n\n            promise.then null, (data) ->\n                $confirm.notify(\"error\")\n\n            toggleView()\n\n        $el.on \"click\", \"a.icon-edit\", ->\n            toggleView()\n            $el.find(\"input\").focus()\n            $el.find(\"input\").val($scope.role.name)\n\n        $el.on \"click\", \"a.save\", submit\n\n        $el.on \"keyup\", \"input\", (event) ->\n            if event.keyCode == 13  # Enter key\n                submit()\n            else if event.keyCode == 27  # ESC key\n                toggleView()\n\n        $scope.$on \"role:changed\", ->\n            if $el.find('.edit-role').is(\":visible\")\n                toggleView()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgEditRole\", [\"$tgRepo\", \"$tgConfirm\", EditRoleDirective])\n\nRolesDirective =  ->\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgRoles\", RolesDirective)\n\nNewRoleDirective = ($tgrepo, $confirm) ->\n    DEFAULT_PERMISSIONS = [\"view_project\", \"view_milestones\", \"view_us\", \"view_tasks\", \"view_issues\"]\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        $el.on \"click\", \"a.add-button\", (event) ->\n            event.preventDefault()\n            $el.find(\".new\").removeClass(\"hidden\")\n            $el.find(\".new\").focus()\n            $el.find(\".add-button\").hide()\n\n        $el.on \"keyup\", \".new\", (event) ->\n            event.preventDefault()\n            if event.keyCode == 13  # Enter key\n                target = angular.element(event.currentTarget)\n                newRole = {\n                    project: $scope.projectId\n                    name: target.val()\n                    permissions: DEFAULT_PERMISSIONS\n                    order: _.max($scope.roles, (r) -> r.order).order + 1\n                    computable: false\n                }\n\n                $el.find(\".new\").addClass(\"hidden\")\n                $el.find(\".new\").val('')\n\n                onSuccess = (role) ->\n                    insertPosition = $scope.roles.length - 1\n                    $scope.roles.splice(insertPosition, 0, role)\n                    $ctrl.setRole(role)\n                    $el.find(\".add-button\").show()\n                    $ctrl.loadProject()\n\n                onError = ->\n                    $confirm.notify(\"error\")\n\n                $tgrepo.create(\"roles\", newRole).then(onSuccess, onError)\n\n            else if event.keyCode == 27  # ESC key\n                target = angular.element(event.currentTarget)\n                $el.find(\".new\").addClass(\"hidden\")\n                $el.find(\".new\").val('')\n                $el.find(\".add-button\").show()\n\n    return {link:link}\n\nmodule.directive(\"tgNewRole\", [\"$tgRepo\", \"$tgConfirm\", NewRoleDirective])\n\n\n# Use category-config.scss styles\nRolePermissionsDirective = ($rootscope, $repo, $confirm, $compile) ->\n    resumeTemplate = _.template(\"\"\"\n    <div class=\"resume-title\" translate=\"<%- category.name %>\"></div>\n    <div class=\"summary-role\">\n        <div class=\"count\"><%- category.activePermissions %>/<%- category.permissions.length %></div>\n        <% _.each(category.permissions, function(permission) { %>\n            <div class=\"role-summary-single <% if(permission.active) { %>active<% } %>\"\n                 title=\"{{ '<%- permission.name %>' | translate }}\"></div>\n        <% }) %>\n    </div>\n    <div class=\"icon icon-arrow-bottom\"></div>\n    \"\"\")\n\n    categoryTemplate = _.template(\"\"\"\n    <div class=\"category-config\" data-id=\"<%- index %>\">\n        <div class=\"resume\">\n        </div>\n        <div class=\"category-items\">\n            <div class=\"items-container\">\n            <% _.each(category.permissions, function(permission) { %>\n                <div class=\"category-item\" data-id=\"<%- permission.key %>\">\n                    <span translate=\"<%- permission.name %>\"></span>\n                    <div class=\"check\">\n                        <input type=\"checkbox\"\n                               <% if(!permission.editable) { %> disabled=\"disabled\" <% } %>\n                               <% if(permission.active) { %> checked=\"checked\" <% } %>/>\n                        <div></div>\n                        <span class=\"check-text check-yes\" translate=\"COMMON.YES\"></span>\n                        <span class=\"check-text check-no\" translate=\"COMMON.NO\"></span>\n                    </div>\n                </div>\n            <% }) %>\n            </div>\n        </div>\n    </div>\n    \"\"\")\n\n    baseTemplate = _.template(\"\"\"\n    <div class=\"category-config-list\"></div>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        $ctrl = $el.controller()\n\n        generateCategoriesFromRole = (role) ->\n            setActivePermissions = (permissions) ->\n                return _.map(permissions, (x) -> _.extend({}, x, {active: x[\"key\"] in role.permissions}))\n\n            isPermissionEditable = (permission, role, project) ->\n                if role.external_user &&\n                   !project.is_private &&\n                   permission.key.indexOf(\"view_\") == 0\n                    return false\n                else\n                    return true\n\n            setActivePermissionsPerCategory = (category) ->\n                return _.map(category, (cat) ->\n                    cat.permissions = cat.permissions.map (permission) ->\n                        permission.editable = isPermissionEditable(permission, role, $scope.project)\n\n                        return permission\n\n                    _.extend({}, cat, {\n                        activePermissions: _.filter(cat[\"permissions\"], \"active\").length\n                    })\n                )\n\n            categories = []\n\n            milestonePermissions = [\n                { key: \"view_milestones\", name: \"COMMON.PERMISIONS_CATEGORIES.SPRINTS.VIEW_SPRINTS\"}\n                { key: \"add_milestone\", name: \"COMMON.PERMISIONS_CATEGORIES.SPRINTS.ADD_SPRINTS\"}\n                { key: \"modify_milestone\", name: \"COMMON.PERMISIONS_CATEGORIES.SPRINTS.MODIFY_SPRINTS\"}\n                { key: \"delete_milestone\", name: \"COMMON.PERMISIONS_CATEGORIES.SPRINTS.DELETE_SPRINTS\"}\n            ]\n            categories.push({\n                name: \"COMMON.PERMISIONS_CATEGORIES.SPRINTS.NAME\",\n                permissions: setActivePermissions(milestonePermissions)\n            })\n\n            userStoryPermissions = [\n                { key: \"view_us\", name: \"COMMON.PERMISIONS_CATEGORIES.USER_STORIES.VIEW_USER_STORIES\"}\n                { key: \"add_us\", name: \"COMMON.PERMISIONS_CATEGORIES.USER_STORIES.ADD_USER_STORIES\"}\n                { key: \"modify_us\", name: \"COMMON.PERMISIONS_CATEGORIES.USER_STORIES.MODIFY_USER_STORIES\"}\n                { key: \"delete_us\", name: \"COMMON.PERMISIONS_CATEGORIES.USER_STORIES.DELETE_USER_STORIES\"}\n            ]\n            categories.push({\n                name: \"COMMON.PERMISIONS_CATEGORIES.USER_STORIES.NAME\",\n                permissions: setActivePermissions(userStoryPermissions)\n            })\n\n            taskPermissions = [\n                { key: \"view_tasks\", name: \"COMMON.PERMISIONS_CATEGORIES.TASKS.VIEW_TASKS\"}\n                { key: \"add_task\", name: \"COMMON.PERMISIONS_CATEGORIES.TASKS.ADD_TASKS\"}\n                { key: \"modify_task\", name: \"COMMON.PERMISIONS_CATEGORIES.TASKS.MODIFY_TASKS\"}\n                { key: \"delete_task\", name: \"COMMON.PERMISIONS_CATEGORIES.TASKS.DELETE_TASKS\"}\n            ]\n            categories.push({\n                name: \"COMMON.PERMISIONS_CATEGORIES.TASKS.NAME\" ,\n                permissions: setActivePermissions(taskPermissions)\n            })\n\n            issuePermissions = [\n                { key: \"view_issues\", name: \"COMMON.PERMISIONS_CATEGORIES.ISSUES.VIEW_ISSUES\"}\n                { key: \"add_issue\", name: \"COMMON.PERMISIONS_CATEGORIES.ISSUES.ADD_ISSUES\"}\n                { key: \"modify_issue\", name: \"COMMON.PERMISIONS_CATEGORIES.ISSUES.MODIFY_ISSUES\"}\n                { key: \"delete_issue\", name: \"COMMON.PERMISIONS_CATEGORIES.ISSUES.DELETE_ISSUES\"}\n            ]\n            categories.push({\n                name: \"COMMON.PERMISIONS_CATEGORIES.ISSUES.NAME\",\n                permissions: setActivePermissions(issuePermissions)\n            })\n\n            wikiPermissions = [\n                { key: \"view_wiki_pages\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.VIEW_WIKI_PAGES\"}\n                { key: \"add_wiki_page\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.ADD_WIKI_PAGES\"}\n                { key: \"modify_wiki_page\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.MODIFY_WIKI_PAGES\"}\n                { key: \"delete_wiki_page\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.DELETE_WIKI_PAGES\"}\n                { key: \"view_wiki_links\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.VIEW_WIKI_LINKS\"}\n                { key: \"add_wiki_link\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.ADD_WIKI_LINKS\"}\n                { key: \"delete_wiki_link\", name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.DELETE_WIKI_LINKS\"}\n            ]\n            categories.push({\n                name: \"COMMON.PERMISIONS_CATEGORIES.WIKI.NAME\",\n                permissions: setActivePermissions(wikiPermissions)\n            })\n\n            return setActivePermissionsPerCategory(categories)\n\n        renderResume = (element, category) ->\n            element.find(\".resume\").html($compile(resumeTemplate({category: category}))($scope))\n\n        renderCategory = (category, index) ->\n            html = categoryTemplate({category: category, index: index})\n            html = angular.element(html)\n            renderResume(html, category)\n            return $compile(html)($scope)\n\n        renderPermissions = () ->\n            $el.off()\n            html = baseTemplate()\n            _.each generateCategoriesFromRole($scope.role), (category, index) ->\n                html = angular.element(html).append(renderCategory(category, index))\n\n            $el.html(html)\n            $el.on \"click\", \".resume\", (event) ->\n                event.preventDefault()\n                target = angular.element(event.currentTarget)\n                target.next().toggleClass(\"open\")\n\n            $el.on \"change\", \".category-item input\", (event) ->\n                getActivePermissions = ->\n                    activePermissions = _.filter($el.find(\".category-item input\"), (t) ->\n                        angular.element(t).is(\":checked\")\n                    )\n                    activePermissions = _.sortBy(_.map(activePermissions, (t) ->\n                        permission = angular.element(t).parents(\".category-item\").data(\"id\")\n                    ))\n\n                    if activePermissions.length\n                        activePermissions.push(\"view_project\")\n\n                    return activePermissions\n\n                target = angular.element(event.currentTarget)\n\n                $scope.role.permissions = getActivePermissions()\n\n                onSuccess = () ->\n                    categories = generateCategoriesFromRole($scope.role)\n                    categoryId = target.parents(\".category-config\").data(\"id\")\n                    renderResume(target.parents(\".category-config\"), categories[categoryId])\n                    $rootscope.$broadcast(\"projects:reload\")\n                    $confirm.notify(\"success\")\n                    $ctrl.loadProject()\n\n                onError = ->\n                    $confirm.notify(\"error\")\n                    target.prop \"checked\", !target.prop(\"checked\")\n                    $scope.role.permissions = getActivePermissions()\n\n                if $scope.role.external_user\n                    $scope.project.public_permissions = $scope.role.permissions\n                    $scope.project.anon_permissions = $scope.role.permissions.filter (permission) ->\n                        return permission.indexOf(\"view_\") == 0\n\n                    $repo.save($scope.project).then onSuccess, onError\n                else\n                    $repo.save($scope.role).then onSuccess, onError\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        $scope.$on \"role:changed\", ->\n            renderPermissions()\n\n        bindOnce($scope, $attrs.ngModel, renderPermissions)\n\n    return {link:link}\n\nmodule.directive(\"tgRolePermissions\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\", \"$compile\",\n                                       RolePermissionsDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/admin/third-parties.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\nbindMethods = @.taiga.bindMethods\ndebounce = @.taiga.debounce\ntimeout = @.taiga.timeout\n\nmodule = angular.module(\"taigaAdmin\")\n\n\n#############################################################################\n## Webhooks\n#############################################################################\n\nclass WebhooksController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @repo, @rs, @params, @location, @navUrls, @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = \"ADMIN.WEBHOOKS.SECTION_NAME\"\n        @scope.project = {}\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"ADMIN.WEBHOOKS.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"webhooks:reload\", @.loadWebhooks\n\n    loadWebhooks: ->\n        return @rs.webhooks.list(@scope.projectId).then (webhooks) =>\n            @scope.webhooks = webhooks\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            if not project.i_am_owner\n                @location.path(@navUrls.resolve(\"permission-denied\"))\n\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then =>\n            @.loadWebhooks()\n\n        return promise\n\nmodule.controller(\"WebhooksController\", WebhooksController)\n\n\n#############################################################################\n## Webhook Directive\n#############################################################################\n\nWebhookDirective = ($rs, $repo, $confirm, $loading, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        webhook = $scope.$eval($attrs.tgWebhook)\n\n        updateLogs = () ->\n            prettyDate = $translate.instant(\"ADMIN.WEBHOOKS.DATE\")\n\n            $rs.webhooklogs.list(webhook.id).then (webhooklogs) =>\n                for log in webhooklogs\n                    log.validStatus = 200 <= log.status < 300\n                    log.prettySentHeaders = _.map(_.pairs(log.request_headers), ([header, value]) -> \"#{header}: #{value}\").join(\"\\n\")\n                    log.prettySentData = JSON.stringify(log.request_data)\n                    log.prettyDate = moment(log.created).format(prettyDate)\n\n                webhook.logs_counter = webhooklogs.length\n                webhook.logs = webhooklogs\n                updateShowHideHistoryText()\n\n        updateShowHideHistoryText = () ->\n            textElement = $el.find(\".toggle-history\")\n            historyElement = textElement.parents(\".single-webhook-wrapper\").find(\".webhooks-history\")\n\n            if historyElement.hasClass(\"open\")\n                text = $translate.instant(\"ADMIN.WEBHOOKS.ACTION_HIDE_HISTORY\")\n                title = $translate.instant(\"ADMIN.WEBHOOKS.ACTION_HIDE_HISTORY_TITLE\")\n            else\n                text = $translate.instant(\"ADMIN.WEBHOOKS.ACTION_SHOW_HISTORY\")\n                title = $translate.instant(\"ADMIN.WEBHOOKS.ACTION_SHOW_HISTORY_TITLE\")\n\n            textElement.text(text)\n            textElement.prop(\"title\", title)\n\n        showVisualizationMode = () ->\n            $el.find(\".edition-mode\").addClass(\"hidden\")\n            $el.find(\".visualization-mode\").removeClass(\"hidden\")\n\n        showEditMode = () ->\n            $el.find(\".visualization-mode\").addClass(\"hidden\")\n            $el.find(\".edition-mode\").removeClass(\"hidden\")\n\n        openHistory = () ->\n            $el.find(\".webhooks-history\").addClass(\"open\")\n\n        cancel = () ->\n            showVisualizationMode()\n            $scope.$apply ->\n                webhook.revert()\n\n        save = debounce 2000, (target) ->\n            form = target.parents(\"form\").checksley()\n            return if not form.validate()\n            promise = $repo.save(webhook)\n            promise.then =>\n                showVisualizationMode()\n\n            promise.then null, (data) ->\n                $confirm.notify(\"error\")\n                form.setErrors(data)\n\n        $el.on \"click\", \".test-webhook\", () ->\n            openHistory()\n            $rs.webhooks.test(webhook.id).then =>\n                updateLogs()\n\n        $el.on \"click\", \".edit-webhook\", () ->\n            showEditMode()\n\n        $el.on \"click\", \".cancel-existing\", () ->\n            cancel()\n\n        $el.on \"click\", \".edit-existing\", (event) ->\n            event.preventDefault()\n            target = angular.element(event.currentTarget)\n            save(target)\n\n        $el.on \"keyup\", \".edition-mode input\", (event) ->\n            if event.keyCode == 13\n                target = angular.element(event.currentTarget)\n                save(target)\n            else if event.keyCode == 27\n                target = angular.element(event.currentTarget)\n                cancel(target)\n\n        $el.on \"click\", \".delete-webhook\", () ->\n            title = $translate.instant(\"ADMIN.WEBHOOKS.DELETE\")\n            message = $translate.instant(\"ADMIN.WEBHOOKS.WEBHOOK_NAME\", {name: webhook.name})\n\n            $confirm.askOnDelete(title, message).then (askResponse) =>\n                onSucces = ->\n                    askResponse.finish()\n                    $scope.$emit(\"webhooks:reload\")\n\n                onError = ->\n                    askResponse.finish(false)\n                    $confirm.notify(\"error\")\n\n                $repo.remove(webhook).then(onSucces, onError)\n\n        $el.on \"click\", \".toggle-history\", (event) ->\n            target = angular.element(event.currentTarget)\n            if not webhook.logs? or webhook.logs.length == 0\n                updateLogs().then ->\n                    #Waiting for ng-repeat to finish\n                    timeout 0, ->\n                        $el.find(\".webhooks-history\").toggleClass(\"open\")\n                        updateShowHideHistoryText()\n\n            else\n                $el.find(\".webhooks-history\").toggleClass(\"open\")\n                $scope.$apply () ->\n                    updateShowHideHistoryText()\n\n\n        $el.on \"click\", \".history-single\", (event) ->\n            target = angular.element(event.currentTarget)\n            target.toggleClass(\"history-single-open\")\n            target.siblings(\".history-single-response\").toggleClass(\"open\")\n\n        $el.on \"click\", \".resend-request\", (event) ->\n            target = angular.element(event.currentTarget)\n            log = target.data(\"log\")\n            $rs.webhooklogs.resend(log).then () =>\n                updateLogs()\n\n    return {link:link}\n\nmodule.directive(\"tgWebhook\", [\"$tgResources\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", \"$translate\",\n                               WebhookDirective])\n\n\n#############################################################################\n## New webhook Directive\n#############################################################################\n\nNewWebhookDirective = ($rs, $repo, $confirm, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        webhook = $scope.$eval($attrs.tgWebhook)\n        formDOMNode = $el.find(\".new-webhook-form\")\n        addWebhookDOMNode = $el.find(\".add-webhook\")\n        initializeNewValue = ->\n            $scope.newValue = {\n                \"name\": \"\"\n                \"url\": \"\"\n                \"key\": \"\"\n            }\n\n        initializeNewValue()\n\n        $scope.$watch \"webhooks\", (webhooks) ->\n            if webhooks?\n                if webhooks.length == 0\n                    formDOMNode.removeClass(\"hidden\")\n                    addWebhookDOMNode.addClass(\"hidden\")\n                    formDOMNode.find(\"input\")[0].focus()\n                else\n                    formDOMNode.addClass(\"hidden\")\n                    addWebhookDOMNode.removeClass(\"hidden\")\n\n        save = debounce 2000, () ->\n            form = formDOMNode.checksley()\n            return if not form.validate()\n\n            $scope.newValue.project = $scope.project.id\n            promise = $repo.create(\"webhooks\", $scope.newValue)\n            promise.then =>\n                $scope.$emit(\"webhooks:reload\")\n                initializeNewValue()\n\n            promise.then null, (data) ->\n                $confirm.notify(\"error\")\n                form.setErrors(data)\n\n        formDOMNode.on \"click\", \".add-new\", (event) ->\n            event.preventDefault()\n            save()\n\n        formDOMNode.on \"keyup\", \"input\", (event) ->\n            if event.keyCode == 13\n                save()\n\n        formDOMNode.on \"click\", \".cancel-new\", (event) ->\n            $scope.$apply ->\n                initializeNewValue()\n\n        addWebhookDOMNode.on \"click\", (event) ->\n            formDOMNode.removeClass(\"hidden\")\n            formDOMNode.find(\"input\")[0].focus()\n\n    return {link:link}\n\nmodule.directive(\"tgNewWebhook\", [\"$tgResources\", \"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", NewWebhookDirective])\n\n\n#############################################################################\n## Github Controller\n#############################################################################\n\nclass GithubController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @repo, @rs, @params, @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"ADMIN.GITHUB.SECTION_NAME\")\n        @scope.project = {}\n\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"ADMIN.GITHUB.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n    loadModules: ->\n        return @rs.modules.list(@scope.projectId, \"github\").then (github) =>\n            @scope.github = github\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then(=> @.loadModules())\n        return promise\n\nmodule.controller(\"GithubController\", GithubController)\n\n\n#############################################################################\n## Gitlab Controller\n#############################################################################\n\nclass GitlabController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @repo, @rs, @params, @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"ADMIN.GITLAB.SECTION_NAME\")\n        @scope.project = {}\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"ADMIN.GITLAB.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"project:modules:reload\", =>\n            @.loadModules()\n\n    loadModules: ->\n        return @rs.modules.list(@scope.projectId, \"gitlab\").then (gitlab) =>\n            @scope.gitlab = gitlab\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then(=> @.loadModules())\n        return promise\n\nmodule.controller(\"GitlabController\", GitlabController)\n\n\n#############################################################################\n## Bitbucket Controller\n#############################################################################\n\nclass BitbucketController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"tgAppMetaService\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @repo, @rs, @params, @appMetaService, @translate) ->\n        bindMethods(@)\n\n        @scope.sectionName = @translate.instant(\"ADMIN.BITBUCKET.SECTION_NAME\")\n        @scope.project = {}\n        promise = @.loadInitialData()\n\n        promise.then () =>\n            title = @translate.instant(\"ADMIN.BITBUCKET.PAGE_TITLE\", {projectName: @scope.project.name})\n            description = @scope.project.description\n            @appMetaService.setAll(title, description)\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n        @scope.$on \"project:modules:reload\", =>\n            @.loadModules()\n\n    loadModules: ->\n        return @rs.modules.list(@scope.projectId, \"bitbucket\").then (bitbucket) =>\n            @scope.bitbucket = bitbucket\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        promise = @.loadProject()\n        promise.then(=> @.loadModules())\n        return promise\n\nmodule.controller(\"BitbucketController\", BitbucketController)\n\n\nSelectInputText =  ->\n    link = ($scope, $el, $attrs) ->\n        $el.on \"click\", \".select-input-content\", () ->\n            $el.find(\"input\").select()\n            $el.find(\".help-copy\").addClass(\"visible\")\n\n    return {link:link}\n\nmodule.directive(\"tgSelectInputText\", SelectInputText)\n\n\n#############################################################################\n## GithubWebhooks Directive\n#############################################################################\n\nGithubWebhooksDirective = ($repo, $confirm, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            return if not form.validate()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.saveAttribute($scope.github, \"github\")\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n    return {link:link}\n\nmodule.directive(\"tgGithubWebhooks\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", GithubWebhooksDirective])\n\n\n#############################################################################\n## GitlabWebhooks Directive\n#############################################################################\n\nGitlabWebhooksDirective = ($repo, $confirm, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            return if not form.validate()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.saveAttribute($scope.gitlab, \"gitlab\")\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                $scope.$emit(\"project:modules:reload\")\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n    return {link:link}\n\nmodule.directive(\"tgGitlabWebhooks\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", GitlabWebhooksDirective])\n\n\n#############################################################################\n## BitbucketWebhooks Directive\n#############################################################################\n\nBitbucketWebhooksDirective = ($repo, $confirm, $loading) ->\n    link = ($scope, $el, $attrs) ->\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            return if not form.validate()\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.saveAttribute($scope.bitbucket, \"bitbucket\")\n            promise.then ->\n                currentLoading.finish()\n                $confirm.notify(\"success\")\n                $scope.$emit(\"project:modules:reload\")\n\n            promise.then null, (data) ->\n                currentLoading.finish()\n                form.setErrors(data)\n                if data._error_message\n                    $confirm.notify(\"error\", data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n    return {link:link}\n\nmodule.directive(\"tgBitbucketWebhooks\", [\"$tgRepo\", \"$tgConfirm\", \"$tgLoading\", BitbucketWebhooksDirective])\n\n\n#############################################################################\n## Valid Origin IP's Directive\n#############################################################################\nValidOriginIpsDirective = ->\n    link = ($scope, $el, $attrs, $ngModel) ->\n        $ngModel.$parsers.push (value) ->\n            value = $.trim(value)\n            if value == \"\"\n                return []\n\n            return value.split(\",\")\n\n    return {\n        link: link\n        restrict: \"EA\"\n        require: \"ngModel\"\n    }\n\nmodule.directive(\"tgValidOriginIps\", ValidOriginIpsDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/common/attachments.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ntimeout = @.taiga.timeout\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaProject\")\n\nCreateProject = ($rootscope, $repo, $confirm, $location, $navurls, $rs, $projectUrl, $loading, lightboxService, $cacheFactory, $translate, currentUserService) ->\n    link = ($scope, $el, attrs) ->\n        $scope.data = {}\n        $scope.templates = []\n        currentLoading = null\n\n        form = $el.find(\"form\").checksley({\"onlyOneErrorElement\": true})\n\n        onSuccessSubmit = (response) ->\n            # remove all $http cache\n            # This is necessary when a project is created with the same name\n            # than another deleted in the same session\n            $cacheFactory.get('$http').removeAll()\n\n            currentLoading.finish()\n            $rootscope.$broadcast(\"projects:reload\")\n\n            $confirm.notify(\"success\", $translate.instant(\"COMMON.SAVE\"))\n\n            $location.url($projectUrl.get(response))\n            lightboxService.close($el)\n            currentUserService.loadProjects()\n\n        onErrorSubmit = (response) ->\n            currentLoading.finish()\n            form.setErrors(response)\n            selectors = []\n            for error_field in _.keys(response)\n                selectors.push(\"[name=#{error_field}]\")\n            $el.find(\".active\").removeClass(\"active\")\n            error_step = $el.find(selectors.join(\",\")).first().parents(\".wizard-step\")\n            error_step.addClass(\"active\")\n            $el.find('.progress-bar').removeClass().addClass('progress-bar').addClass(error_step.data(\"step\"))\n\n        submit = (event) =>\n            event.preventDefault()\n\n            if not form.validate()\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $repo.create(\"projects\", $scope.data)\n            promise.then(onSuccessSubmit, onErrorSubmit)\n\n        openLightbox = ->\n            $scope.data = {}\n\n            if !$scope.templates.length\n                $rs.projects.templates().then (result) =>\n                    $scope.templates = result\n                    $scope.data.creation_template = _.head(_.filter($scope.templates, (x) -> x.slug == \"scrum\")).id\n            else\n                $scope.data.creation_template = _.head(_.filter($scope.templates, (x) -> x.slug == \"scrum\")).id\n\n            $el.find(\".active\").removeClass(\"active\")\n            $el.find(\".create-step1\").addClass(\"active\")\n\n            lightboxService.open($el)\n            timeout 600, ->\n                $el.find(\".progress-bar\").addClass('step1')\n\n        $el.on \"click\", \".button-next\", (event) ->\n            event.preventDefault()\n\n            current = $el.find(\".active\")\n\n            valid = true\n            for field in form.fields\n                if current.find(\"[name=#{field.element.attr('name')}]\").length\n                    valid = field.validate() != false and valid\n\n            if not valid\n                return\n\n            next = current.next()\n            current.toggleClass('active')\n            next.toggleClass('active')\n            step = next.data('step')\n            $el.find('.progress-bar').removeClass().addClass('progress-bar').addClass(step)\n\n        $el.on \"click\", \".button-prev\", (event) ->\n            event.preventDefault()\n            current = $el.find(\".active\")\n            prev = current.prev()\n            current.toggleClass('active')\n            prev.toggleClass('active')\n            step = prev.data('step')\n            $el.find('.progress-bar').removeClass().addClass('progress-bar').addClass(step)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $el.on \"click\", \".close\", (event) ->\n            event.preventDefault()\n            lightboxService.close($el)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        openLightbox()\n\n    directive = {\n        link: link,\n        templateUrl: \"project/wizard-create-project.html\"\n        scope: {}\n    }\n\n    return directive\n\n\nmodule.directive(\"tgLbCreateProject\", [\"$rootScope\", \"$tgRepo\", \"$tgConfirm\",\n    \"$location\", \"$tgNavUrls\", \"$tgResources\", \"$projectUrl\", \"$tgLoading\",\n    \"lightboxService\", \"$cacheFactory\", \"$translate\", \"tgCurrentUserService\", CreateProject])\n\n\n#############################################################################\n## Delete Project Lightbox Directive\n#############################################################################\n\nDeleteProjectDirective = ($repo, $rootscope, $auth, $location, $navUrls, $confirm, lightboxService, tgLoader, currentUserService) ->\n    link = ($scope, $el, $attrs) ->\n        projectToDelete = null\n        $scope.$on \"deletelightbox:new\", (ctx, project)->\n            lightboxService.open($el)\n            projectToDelete = project\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        submit = ->\n            tgLoader.start()\n            lightboxService.close($el)\n\n            promise = $repo.remove(projectToDelete)\n\n            promise.then (data) ->\n                tgLoader.pageLoaded()\n                $rootscope.$broadcast(\"projects:reload\")\n                $location.path($navUrls.resolve(\"home\"))\n                $confirm.notify(\"success\")\n                currentUserService.loadProjects()\n\n            # FIXME: error handling?\n            promise.then null, ->\n                $confirm.notify(\"error\")\n                lightboxService.close($el)\n\n        $el.on \"click\", \".button-red\", (event) ->\n            event.preventDefault()\n            lightboxService.close($el)\n\n        $el.on \"click\", \".button-green\", (event) ->\n            event.preventDefault()\n            submit()\n\n    return {link:link}\n\nmodule.directive(\"tgLbDeleteProject\", [\"$tgRepo\", \"$rootScope\", \"$tgAuth\", \"$tgLocation\", \"$tgNavUrls\",\n                                       \"$tgConfirm\", \"lightboxService\", \"tgLoader\", \"tgCurrentUserService\", DeleteProjectDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/bind.coffee\n###\n\nbindOnce = @.taiga.bindOnce\n\n# Escape Html bind once directive\nBindOnceBindDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoBind, (val) ->\n            $el.text(val)\n\n    return {link:link}\n\n# Html bind once directive\nBindOnceHtmlDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoHtml, (val) ->\n            $el.html(val)\n\n    return {link:link}\n\n# Object reference bind once helper.\nBindOnceRefDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoRef, (val) ->\n            $el.html(\"##{val} \")\n    return {link:link}\n\n# Object src bind once helper.\nBindOnceSrcDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoSrc, (val) ->\n            $el.attr(\"src\", val)\n    return {link:link}\n\n# Object href bind once helper.\nBindOnceHrefDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoHref, (val) ->\n            $el.attr(\"href\", val)\n    return {link:link}\n\n# Object alt bind once helper.\nBindOnceAltDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoAlt, (val) ->\n            $el.attr(\"alt\", val)\n    return {link:link}\n\n# Object title bind once helper.\nBindOnceTitleDirective = ->\n    link = ($scope, $el, $attrs) ->\n        bindOnce $scope, $attrs.tgBoTitle, (val) ->\n            $el.attr(\"title\", val)\n    return {link:link}\n\nBindTitleDirective = ->\n    link = ($scope, $el, $attrs) ->\n        $scope.$watch $attrs.tgTitleHtml, (val) ->\n            $el.attr(\"title\", val) if val?\n\n    return {link:link}\n\nBindHtmlDirective = ->\n    link = ($scope, $el, $attrs) ->\n        $scope.$watch $attrs.tgBindHtml, (val) ->\n            $el.html(val) if val?\n\n    return {link:link}\n\nmodule = angular.module(\"taigaBase\")\nmodule.directive(\"tgBoBind\", BindOnceBindDirective)\nmodule.directive(\"tgBoHtml\", BindOnceHtmlDirective)\nmodule.directive(\"tgBoRef\", BindOnceRefDirective)\nmodule.directive(\"tgBoSrc\", BindOnceSrcDirective)\nmodule.directive(\"tgBoHref\", BindOnceHrefDirective)\nmodule.directive(\"tgBoAlt\", BindOnceAltDirective)\nmodule.directive(\"tgBoTitle\", BindOnceTitleDirective)\nmodule.directive(\"tgBindTitle\", BindTitleDirective)\nmodule.directive(\"tgBindHtml\", BindHtmlDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/conf.coffee\n###\n\nclass ConfigurationService\n    constructor: () ->\n        @.config = window.taigaConfig\n\n    get: (key, defaultValue=null) ->\n        if _.has(@.config, key)\n            return @.config[key]\n        return defaultValue\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.service(\"$tgConfig\", ConfigurationService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/contrib.coffee\n###\n\ntaigaContribPlugins = @.taigaContribPlugins = @.taigaContribPlugins or []\n\nclass ContribController extends taiga.Controller\n    @.$inject = [\n        \"$rootScope\",\n        \"$scope\",\n        \"$routeParams\",\n        \"$tgRepo\",\n        \"$tgResources\",\n        \"$tgConfirm\"\n    ]\n\n    constructor: (@rootScope, @scope, @params, @repo, @rs, @confirm) ->\n        @scope.adminPlugins = _.where(@rootScope.contribPlugins, {\"type\": \"admin\"})\n        @scope.currentPlugin = _.first(_.where(@scope.adminPlugins, {\"slug\": @params.plugin}))\n        @scope.pluginTemplate = \"contrib/#{@scope.currentPlugin.slug}\"\n        @scope.projectSlug = @params.pslug\n\n        promise = @.loadInitialData()\n\n        promise.then null, =>\n            @confirm.notify(\"error\")\n\n    loadProject: ->\n        return @rs.projects.getBySlug(@params.pslug).then (project) =>\n            @scope.projectId = project.id\n            @scope.project = project\n            @scope.$emit('project:loaded', project)\n            @scope.$broadcast('project:loaded', project)\n            return project\n\n    loadInitialData: ->\n        return @.loadProject()\n\nmodule = angular.module(\"taigaBase\")\nmodule.controller(\"ContribController\", ContribController)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/filters.coffee\n###\n\n\ntaiga = @.taiga\n\nclass FiltersStorageService extends taiga.Service\n    @.$inject = [\"$tgStorage\", \"$routeParams\"]\n\n    constructor: (@storage, @params) ->\n\n    generateHash: (components=[]) ->\n        components = _.map(components, (x) -> JSON.stringify(x))\n        return hex_sha1(components.join(\":\"))\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/http.coffee\n###\n\ntaiga = @.taiga\n\nclass HttpService extends taiga.Service\n    @.$inject = [\"$http\", \"$q\", \"$tgStorage\", \"$rootScope\", \"$cacheFactory\", \"$translate\"]\n\n    constructor: (@http, @q, @storage, @rootScope, @cacheFactory, @translate) ->\n        super()\n\n        @.cache = @cacheFactory(\"httpget\");\n    headers: ->\n        headers = {}\n\n        # Authorization\n        token = @storage.get('token')\n        if token\n            headers[\"Authorization\"] = \"Bearer #{token}\"\n\n        # Accept-Language\n        lang = @translate.preferredLanguage()\n        if lang\n            headers[\"Accept-Language\"] = lang\n\n        return headers\n\n    request: (options) ->\n        options.headers = _.merge({}, options.headers or {}, @.headers())\n        if _.isPlainObject(options.data)\n            options.data = JSON.stringify(options.data)\n\n        return @http(options)\n\n    get: (url, params, options) ->\n        options = _.merge({method: \"GET\", url: url}, options)\n        options.params = params if params\n\n        # prevent duplicated http request\n        options.cache = @.cache\n\n        return @.request(options).finally (data) =>\n            @.cache.removeAll()\n\n    post: (url, data, params, options) ->\n        options = _.merge({method: \"POST\", url: url}, options)\n        options.data = data if data\n        options.params = params if params\n        return @.request(options)\n\n    put: (url, data, params, options) ->\n        options = _.merge({method: \"PUT\", url: url}, options)\n        options.data = data if data\n        options.params = params if params\n        return @.request(options)\n\n    patch: (url, data, params, options) ->\n        options = _.merge({method: \"PATCH\", url: url}, options)\n        options.data = data if data\n        options.params = params if params\n        return @.request(options)\n\n    delete: (url, data, params, options) ->\n        options = _.merge({method: \"DELETE\", url: url}, options)\n        options.data = data if data\n        options.params = params if params\n        return @.request(options)\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.service(\"$tgHttp\", HttpService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/location.coffee\n###\n\n\nlocationFactory = ($location, $route, $rootscope) ->\n    $location.noreload =  (scope) ->\n        lastRoute = $route.current\n        un = scope.$on \"$locationChangeSuccess\", ->\n            $route.current = lastRoute\n            un()\n\n        return $location\n\n    $location.isInCurrentRouteParams = (name, value) ->\n        params = $location.search() || {}\n\n        return params[name] == value\n\n    return $location\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.factory(\"$tgLocation\", [\"$location\", \"$route\", \"$rootScope\", locationFactory])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/model.coffee\n###\n\nclass Model\n    constructor: (name, data, dataTypes) ->\n        @._attrs = data\n        @._name = name\n        @._dataTypes = dataTypes\n\n        @.setAttrs(data)\n        @.initialize()\n\n    clone: ->\n        instance = new Model(@._name, @._attrs, @._dataTypes)\n        instance._modifiedAttrs = @._modifiedAttrs\n        instance._isModified = @._isModified\n        return instance\n\n    applyCasts: ->\n        for attrName, castName of @._dataTypes\n            castMethod = service.casts[castName]\n            if not castMethod\n                continue\n\n            @._attrs[attrName] = castMethod(@._attrs[attrName])\n\n    getIdAttrName: ->\n        return \"id\"\n\n    getName: ->\n        return @._name\n\n    getAttrs: (patch=false) ->\n        if @._attrs.version?\n            @._modifiedAttrs.version = @._attrs.version\n\n        if patch\n            return _.extend({}, @._modifiedAttrs)\n        return _.extend({}, @._attrs, @._modifiedAttrs)\n\n    setAttrs: (attrs) ->\n        @._attrs = attrs\n        @._modifiedAttrs = {}\n\n        @.applyCasts()\n        @._isModified = false\n\n    setAttr: (name, value) ->\n        @._modifiedAttrs[name] = value\n        @._isModified = true\n\n    initialize: () ->\n        self = @\n\n        getter = (name) ->\n            return ->\n                if typeof(name) == 'string' and name.substr(0,2) == \"__\"\n                    return self[name]\n\n                if name not in _.keys(self._modifiedAttrs)\n                    return self._attrs[name]\n\n                return self._modifiedAttrs[name]\n\n        setter = (name) ->\n            return (value) ->\n                if typeof(name) == 'string' and name.substr(0,2) == \"__\"\n                    self[name] = value\n                    return\n\n                if self._attrs[name] != value\n                    self._modifiedAttrs[name] = value\n                    self._isModified = true\n                else\n                    delete self._modifiedAttrs[name]\n\n                return\n\n        _.each @_attrs, (value, name) ->\n            options =\n                get: getter(name)\n                set: setter(name)\n                enumerable: true\n                configurable: true\n\n            Object.defineProperty(self, name, options)\n\n    serialize: () ->\n        data =\n            \"data\": _.clone(@_attrs)\n            \"name\": @_name\n\n        return JSON.stringify(data)\n\n    isModified: ->\n        return this._isModified\n\n    isAttributeModified: (attribute) ->\n        return @._modifiedAttrs[attribute]?\n\n    markSaved: () ->\n        @._isModified = false\n        @._attrs = @.getAttrs()\n        @._modifiedAttrs = {}\n\n    revert: () ->\n        @_modifiedAttrs = {}\n        @_isModified = false\n\n    @desSerialize = (sdata) ->\n        ddata = JSON.parse(sdata)\n        model = new Model(ddata.url, ddata.data)\n        return model\n\n\ntaiga = @.taiga\n\nclass ModelService extends taiga.Service\n    @.$inject = [\"$q\", \"$tgUrls\", \"$tgStorage\", \"$tgHttp\"]\n\n    constructor: (@q, @urls, @storage, @http) ->\n        super()\n\nprovider = ($q, $http, $gmUrls, $gmStorage) ->\n    service = {}\n    service.make_model = (name, data, cls=Model, dataTypes={}) ->\n        return new cls(name, data, dataTypes)\n\n    service.cls = Model\n    service.casts = {\n        int: (value) ->\n            return parseInt(value, 10)\n\n        float: (value) ->\n            return parseFloat(value, 10)\n    }\n\n    return service\n\nmodule = angular.module(\"taigaBase\")\nmodule.factory(\"$tgModel\", [\"$q\", \"$http\", \"$tgUrls\", \"$tgStorage\", provider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/navurl.coffee\n###\n\ntaiga = @.taiga\ntrim = @.taiga.trim\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaBase\")\n\n\n#############################################################################\n## Navigation Urls Service\n#############################################################################\n\nclass NavigationUrlsService extends taiga.Service\n    constructor: ->\n        @.urls = {}\n\n    update: (urls) ->\n        @.urls = _.merge({}, @.urls, urls or {})\n\n    formatUrl: (url, ctx={}) ->\n        replacer = (match) ->\n            match = trim(match, \":\")\n            return ctx[match] or \"undefined\"\n        return url.replace(/(:\\w+)/g, replacer)\n\n    resolve: (name, ctx) ->\n        url = @.urls[name]\n        return \"\" if not url\n        return @.formatUrl(url, ctx) if ctx\n        return url\n\nmodule.service(\"$tgNavUrls\", NavigationUrlsService)\n\n\n#############################################################################\n## Navigation Urls Directive\n#############################################################################\n\nNavigationUrlsDirective = ($navurls, $auth, $q, $location) ->\n    # Example:\n    # link(tg-nav=\"project-backlog:project='sss',\")\n\n    # bindOnce version that uses $q for offer\n    # promise based api\n    bindOnceP = ($scope, attr) ->\n        defered = $q.defer()\n        bindOnce $scope, attr, (v) ->\n            defered.resolve(v)\n        return defered.promise\n\n    parseNav = (data, $scope) ->\n        [name, params] = _.map(data.split(\":\"), trim)\n        if params\n            # split by 'xxx='\n            # example\n            # project=vm.timeline.getIn(['data', 'project', 'slug']), ref=vm.timeline.getIn(['obj', 'ref'])\n            # [\"\", \"project\", \"vm.timeline.getIn(['data', 'project', 'slug']), \", \"ref\", \"vm.timeline.getIn(['obj', 'ref'])\"]\n            result = params.split(/(\\w+)=/)\n\n            # remove empty string\n            result = _.filter result, (str) -> return str.length\n\n            # remove , at the end of the string\n            result = _.map result, (str) -> return trim(str.replace(/,$/g, ''))\n\n            params = []\n            index = 0\n\n            # ['param1', 'value'] => [{'param1': 'value'}]\n            while index < result.length\n                obj = {}\n                obj[result[index]] = result[index + 1]\n                params.push obj\n                index = index + 2\n        else\n            params = []\n\n        values = _.map params, (param) -> _.values(param)[0]\n        promises = _.map(values, (x) -> bindOnceP($scope, x))\n\n        return $q.all(promises).then ->\n            options = {}\n            for param in params\n                key = Object.keys(param)[0]\n                value = param[key]\n\n                options[key] = $scope.$eval(value)\n            return [name, options]\n\n    link = ($scope, $el, $attrs) ->\n        if $el.is(\"a\")\n            $el.attr(\"href\", \"#\")\n\n        $el.on \"mouseenter\", (event) ->\n            target = $(event.currentTarget)\n\n            if !target.data(\"fullUrl\")\n                parseNav($attrs.tgNav, $scope).then (result) ->\n                    [name, options] = result\n                    user = $auth.getUser()\n                    options.user = user.username if user\n\n                    url = $navurls.resolve(name)\n                    fullUrl = $navurls.formatUrl(url, options)\n\n                    if $attrs.tgNavGetParams\n                        getURLParams = JSON.parse($attrs.tgNavGetParams)\n                        getURLParamsStr = $.param(getURLParams)\n                        fullUrl = \"#{fullUrl}?#{getURLParamsStr}\"\n\n                    target.data(\"fullUrl\", fullUrl)\n\n                    if target.is(\"a\")\n                        target.attr(\"href\", fullUrl)\n\n                    $el.on \"click\", (event) ->\n                        if event.metaKey || event.ctrlKey\n                            return\n\n                        event.preventDefault()\n                        target = $(event.currentTarget)\n\n                        if target.hasClass('noclick')\n                            return\n\n                        fullUrl = target.data(\"fullUrl\")\n\n                        switch event.which\n                            when 1\n                                $location.url(fullUrl)\n                                $scope.$apply()\n                            when 2\n                                window.open fullUrl\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link: link}\n\nmodule.directive(\"tgNav\", [\"$tgNavUrls\", \"$tgAuth\", \"$q\", \"$tgLocation\", NavigationUrlsDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/repository.coffee\n###\n\ntaiga = @.taiga\n\nclass RepositoryService extends taiga.Service\n    @.$inject = [\"$q\", \"$tgModel\", \"$tgStorage\", \"$tgHttp\", \"$tgUrls\"]\n\n    constructor: (@q, @model, @storage, @http, @urls) ->\n        super()\n\n    resolveUrlForModel: (model) ->\n        idAttrName = model.getIdAttrName()\n        return \"#{@urls.resolve(model.getName())}/#{model[idAttrName]}\"\n\n    resolveUrlForAttributeModel: (model) ->\n        return @urls.resolve(model.getName(), model.parent)\n\n    create: (name, data, dataTypes={}, extraParams={}) ->\n        defered = @q.defer()\n        url = @urls.resolve(name)\n\n        promise = @http.post(url, JSON.stringify(data))\n        promise.success (_data, _status) =>\n            defered.resolve(@model.make_model(name, _data, null, dataTypes))\n\n        promise.error (data, status) =>\n            defered.reject(data)\n\n        return defered.promise\n\n    remove: (model, params={}) ->\n        defered = @q.defer()\n        url = @.resolveUrlForModel(model)\n\n        promise = @http.delete(url, {}, params)\n        promise.success (data, status) ->\n            defered.resolve(model)\n\n        promise.error (data, status) ->\n            defered.reject(model)\n\n        return defered.promise\n\n    saveAll: (models, patch=true) ->\n        promises = _.map(models, (x) => @.save(x, true))\n        return @q.all(promises)\n\n    save: (model, patch=true) ->\n        defered = @q.defer()\n\n        if not model.isModified() and patch\n            defered.resolve(model)\n            return defered.promise\n\n        url = @.resolveUrlForModel(model)\n        data = JSON.stringify(model.getAttrs(patch))\n\n        if patch\n            promise = @http.patch(url, data)\n        else\n            promise = @http.put(url, data)\n\n        promise.success (data, status) =>\n            model._isModified = false\n            model._attrs = _.extend(model.getAttrs(), data)\n            model._modifiedAttrs = {}\n\n            model.applyCasts()\n            defered.resolve(model)\n\n        promise.error (data, status) ->\n            defered.reject(data)\n\n        return defered.promise\n\n    saveAttribute: (model, attribute, patch=true) ->\n        defered = @q.defer()\n\n        if not model.isModified() and patch\n            defered.resolve(model)\n            return defered.promise\n\n        url = @.resolveUrlForAttributeModel(model)\n\n        data = {}\n\n        data[attribute] = model.getAttrs()\n\n        if patch\n            promise = @http.patch(url, data)\n        else\n            promise = @http.put(url, data)\n\n        promise.success (data, status) =>\n            model._isModified = false\n            model._attrs = _.extend(model.getAttrs(), data)\n            model._modifiedAttrs = {}\n\n            model.applyCasts()\n            defered.resolve(model)\n\n        promise.error (data, status) ->\n            defered.reject(data)\n\n        return defered.promise\n\n    refresh: (model) ->\n        defered = @q.defer()\n\n        url = @.resolveUrlForModel(model)\n        promise = @http.get(url)\n        promise.success (data, status) ->\n            model._modifiedAttrs = {}\n            model._attrs = data\n            model._isModified = false\n            model.applyCasts()\n            defered.resolve(model)\n\n        promise.error (data, status) ->\n            defered.reject(data)\n\n        return defered.promise\n\n    queryMany: (name, params, options={}, headers=false) ->\n        url = @urls.resolve(name)\n        httpOptions = {headers: {}}\n\n        if not options.enablePagination\n            httpOptions.headers[\"x-disable-pagination\"] =  \"1\"\n\n        return @http.get(url, params, httpOptions).then (data) =>\n            result =  _.map(data.data, (x) => @model.make_model(name, x))\n\n            if headers\n                return [result, data.headers]\n\n            return result\n\n    queryOneAttribute: (name, id, attribute, params, options={}) ->\n        url = @urls.resolve(name, id)\n        httpOptions = {headers: {}}\n\n        if not options.enablePagination\n            httpOptions.headers[\"x-disable-pagination\"] =  \"1\"\n\n        return @http.get(url, params, httpOptions).then (data) =>\n            model = @model.make_model(name, data.data[attribute])\n            model.parent = id\n\n            return model\n\n    queryOne: (name, id, params, options={}) ->\n        url = @urls.resolve(name)\n        url = \"#{url}/#{id}\" if id\n        httpOptions = {headers: {}}\n        if not options.enablePagination\n            httpOptions.headers[\"x-disable-pagination\"] =  \"1\"\n\n        return @http.get(url, params, httpOptions).then (data) =>\n            return @model.make_model(name, data.data)\n\n    queryOneRaw: (name, id, params, options={}) ->\n        url = @urls.resolve(name)\n        url = \"#{url}/#{id}\" if id\n        httpOptions = _.merge({headers: {}}, options)\n        if not options.enablePagination\n            httpOptions.headers[\"x-disable-pagination\"] =  \"1\"\n        return @http.get(url, params, httpOptions).then (data) =>\n            return data.data\n\n    queryPaginated: (name, params, options={}) ->\n        url = @urls.resolve(name)\n        httpOptions = _.merge({headers: {}}, options)\n        return @http.get(url, params, httpOptions).then (data) =>\n            headers = data.headers()\n            result = {}\n            result.models = _.map(data.data, (x) => @model.make_model(name, x))\n            result.count = parseInt(headers[\"x-pagination-count\"], 10)\n            result.current = parseInt(headers[\"x-pagination-current\"] or 1, 10)\n            result.paginatedBy = parseInt(headers[\"x-paginated-by\"], 10)\n            return result\n\n    queryOnePaginatedRaw: (name, id, params, options={}) ->\n        url = @urls.resolve(name)\n        url = \"#{url}/#{id}\" if id\n        httpOptions = _.merge({headers: {}}, options)\n\n        return @http.get(url, params, httpOptions).then (data) =>\n            headers = data.headers()\n            result = {}\n            result.data = data.data\n            result.count = parseInt(headers[\"x-pagination-count\"], 10)\n            result.current = parseInt(headers[\"x-pagination-current\"] or 1, 10)\n            result.paginatedBy = parseInt(headers[\"x-paginated-by\"], 10)\n\n            return result\n\n    resolve: (options) ->\n        params = {}\n        params.project = options.pslug if options.pslug?\n        params.us = options.usref if options.usref?\n        params.task = options.taskref if options.taskref?\n        params.issue = options.issueref if options.issueref?\n        params.milestone = options.sslug if options.sslug?\n        params.wikipage = options.wikipage if options.wikipage?\n\n        cache = not (options.wikipage or options.sslug)\n        return @.queryOneRaw(\"resolver\", null, params, {cache: cache})\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.service(\"$tgRepo\", RepositoryService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/storage.coffee\n###\n\ntaiga = @.taiga\n\nclass StorageService extends taiga.Service\n    @.$inject = [\"$rootScope\"]\n\n    constructor: ($rootScope) ->\n        super()\n\n    get: (key, _default) ->\n        serializedValue = localStorage.getItem(key)\n        if serializedValue == null\n            return _default or null\n\n        return JSON.parse(serializedValue)\n\n    set: (key, val) ->\n        if _.isObject(key)\n            _.each key, (val, key) =>\n                @set(key, val)\n        else\n            localStorage.setItem(key, JSON.stringify(val))\n\n    contains: (key) ->\n        value = @.get(key)\n        return (value != null)\n\n    remove: (key) ->\n        localStorage.removeItem(key)\n\n    clear: ->\n        localStorage.clear()\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.service(\"$tgStorage\", StorageService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/base/http.coffee\n###\n\nformat = (fmt, obj) ->\n    obj = _.clone(obj)\n    return fmt.replace /%s/g, (match) -> String(obj.shift())\n\ntaiga = @.taiga\n\nclass UrlsService extends taiga.Service\n    @.$inject = [\"$tgConfig\"]\n\n    constructor: (@config) ->\n        @.urls = {}\n        @.mainUrl = @config.get(\"api\")\n\n    update: (urls) ->\n        @.urls = _.merge(@.urls, urls)\n\n    resolve: ->\n        args = _.toArray(arguments)\n\n        if args.length == 0\n            throw Error(\"wrong arguments to setUrls\")\n\n        name = args.slice(0, 1)[0]\n        url = format(@.urls[name], args.slice(1))\n\n        return format(\"%s/%s\", [\n            _.str.rtrim(@.mainUrl, \"/\"),\n            _.str.ltrim(url, \"/\")\n        ])\n\n    resolveAbsolute: ->\n        url = @.resolve.apply(@, arguments)\n        if (/^https?:\\/\\//i).test(url)\n            return url\n        if (/^\\//).test(url)\n            return \"#{window.location.protocol}//#{window.location.host}#{url}\"\n        return \"#{window.location.protocol}//#{window.location.host}/#{url}\"\n\n\nmodule = angular.module(\"taigaBase\")\nmodule.service('$tgUrls', UrlsService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/attachments.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($rootScope, $config, $urls, $model, $repo, $auth, $q) ->\n    service = {}\n\n    service.list = (urlName, objectId, projectId) ->\n        params = {object_id: objectId, project: projectId}\n        return $repo.queryMany(urlName, params)\n\n    service.create = (urlName, projectId, objectId, file) ->\n        defered = $q.defer()\n\n        if file is undefined\n            defered.reject(null)\n            return defered.promise\n\n        maxFileSize = $config.get(\"maxUploadFileSize\", null)\n        if maxFileSize and file.size > maxFileSize\n            response = {\n                status: 413,\n                data: _error_message: \"'#{file.name}' (#{sizeFormat(file.size)}) is too heavy for our oompa\n                                       loompas, try it with a smaller than (#{sizeFormat(maxFileSize)})\"\n            }\n            defered.reject(response)\n            return defered.promise\n\n        uploadProgress = (evt) =>\n            $rootScope.$apply =>\n                file.status = \"in-progress\"\n                file.size = sizeFormat(evt.total)\n                file.progressMessage = \"upload #{sizeFormat(evt.loaded)} of #{sizeFormat(evt.total)}\"\n                file.progressPercent = \"#{Math.round((evt.loaded / evt.total) * 100)}%\"\n\n        uploadComplete = (evt) =>\n            $rootScope.$apply ->\n                file.status = \"done\"\n\n                status = evt.target.status\n                try\n                    data = JSON.parse(evt.target.responseText)\n                catch\n                    data = {}\n\n                if status >= 200 and status < 400\n                    model = $model.make_model(urlName, data)\n                    defered.resolve(model)\n                else\n                    response = {\n                        status: status,\n                        data: {_error_message: data['attached_file']?[0]}\n                    }\n                    defered.reject(response)\n\n        uploadFailed = (evt) =>\n            $rootScope.$apply ->\n                file.status = \"error\"\n                defered.reject(\"fail\")\n\n        data = new FormData()\n        data.append(\"project\", projectId)\n        data.append(\"object_id\", objectId)\n        data.append(\"attached_file\", file)\n\n        xhr = new XMLHttpRequest()\n        xhr.upload.addEventListener(\"progress\", uploadProgress, false)\n        xhr.addEventListener(\"load\", uploadComplete, false)\n        xhr.addEventListener(\"error\", uploadFailed, false)\n\n        xhr.open(\"POST\", $urls.resolve(urlName))\n        xhr.setRequestHeader(\"Authorization\", \"Bearer #{$auth.getToken()}\")\n        xhr.setRequestHeader('Accept', 'application/json')\n        xhr.send(data)\n\n        return defered.promise\n\n    return (instance) ->\n        instance.attachments = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgAttachmentsResourcesProvider\", [\"$rootScope\", \"$tgConfig\", \"$tgUrls\", \"$tgModel\", \"$tgRepo\",\n                                                   \"$tgAuth\", \"$q\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/custom-field-values.coffee\n###\n\ntaiga = @.taiga\n\nresourceProvider = ($repo) ->\n    _get = (objectId, resource) ->\n        return $repo.queryOne(resource, objectId)\n\n    service = {\n        userstory: {\n            get: (objectId) -> _get(objectId, \"custom-attributes-values/userstory\")\n        }\n        task: {\n            get: (objectId) -> _get(objectId, \"custom-attributes-values/task\")\n        }\n        issue: {\n            get: (objectId) -> _get(objectId, \"custom-attributes-values/issue\")\n        }\n    }\n\n    return (instance) ->\n        instance.customAttributesValues = service\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgCustomAttributesValuesResourcesProvider\", [\"$tgRepo\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/projects.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($repo) ->\n    _list = (projectId, resource) ->\n        return $repo.queryMany(resource, {project: projectId})\n\n    service = {\n        userstory:{\n            list: (projectId) -> _list(projectId, \"custom-attributes/userstory\")\n        }\n        task:{\n            list: (projectId) -> _list(projectId, \"custom-attributes/task\")\n        }\n        issue: {\n            list: (projectId) -> _list(projectId, \"custom-attributes/issue\")\n        }\n    }\n\n    return (instance) ->\n        instance.customAttributes = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgCustomAttributesResourcesProvider\", [\"$tgRepo\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/history.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $http, $urls) ->\n    service = {}\n\n    service.get = (type, objectId) ->\n        return $repo.queryOneRaw(\"history/#{type}\", objectId)\n\n    service.deleteComment = (type, objectId, activityId) ->\n        url = $urls.resolve(\"history/#{type}\")\n        url = \"#{url}/#{objectId}/delete_comment\"\n        params = {id: activityId}\n        return $http.post(url, null, params).then (data) =>\n            return data.data\n\n    service.undeleteComment = (type, objectId, activityId) ->\n        url = $urls.resolve(\"history/#{type}\")\n        url = \"#{url}/#{objectId}/undelete_comment\"\n        params = {id: activityId}\n        return $http.post(url, null, params).then (data) =>\n            return data.data\n\n    return (instance) ->\n        instance.history = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgHistoryResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/projects.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo) ->\n    service = {}\n\n    service.get = (token) ->\n        return $repo.queryOne(\"invitations\", token)\n\n    return (instance) ->\n        instance.invitations = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgInvitationsResourcesProvider\", [\"$tgRepo\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/issues.coffee\n###\n\n\ntaiga = @.taiga\n\ngenerateHash = taiga.generateHash\n\nresourceProvider = ($repo, $http, $urls, $storage, $q) ->\n    service = {}\n    hashSuffix = \"issues-queryparams\"\n    filtersHashSuffix = \"issues-filters\"\n    myFiltersHashSuffix = \"issues-my-filters\"\n\n    service.get = (projectId, issueId) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        return $repo.queryOne(\"issues\", issueId, params)\n\n    service.getByRef = (projectId, ref) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        params.ref = ref\n        return $repo.queryOne(\"issues\", \"by_ref\", params)\n\n    service.listInAllProjects = (filters) ->\n        return $repo.queryMany(\"issues\", filters)\n\n    service.list = (projectId, filters, options) ->\n        params = {project: projectId}\n        params = _.extend({}, params, filters or {})\n        service.storeQueryParams(projectId, params)\n        return $repo.queryPaginated(\"issues\", params, options)\n\n    service.bulkCreate = (projectId, data) ->\n        url = $urls.resolve(\"bulk-create-issues\")\n        params = {project_id: projectId, bulk_issues: data}\n        return $http.post(url, params)\n\n    service.upvote = (issueId) ->\n        url = $urls.resolve(\"issue-upvote\", issueId)\n        return $http.post(url)\n\n    service.downvote = (issueId) ->\n        url = $urls.resolve(\"issue-downvote\", issueId)\n        return $http.post(url)\n\n    service.watch = (issueId) ->\n        url = $urls.resolve(\"issue-watch\", issueId)\n        return $http.post(url)\n\n    service.unwatch = (issueId) ->\n        url = $urls.resolve(\"issue-unwatch\", issueId)\n        return $http.post(url)\n\n    service.stats = (projectId) ->\n        return $repo.queryOneRaw(\"projects\", \"#{projectId}/issues_stats\")\n\n    service.filtersData = (params) ->\n        return $repo.queryOneRaw(\"issues-filters\", null, params)\n\n    service.listValues = (projectId, type) ->\n        params = {\"project\": projectId}\n        service.storeQueryParams(projectId, params)\n        return $repo.queryMany(type, params)\n\n    service.storeQueryParams = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getQueryParams = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    service.storeFilters = (projectSlug, params) ->\n        ns = \"#{projectSlug}:#{filtersHashSuffix}\"\n        hash = generateHash([projectSlug, ns])\n        $storage.set(hash, params)\n\n    service.getFilters = (projectSlug) ->\n        ns = \"#{projectSlug}:#{filtersHashSuffix}\"\n        hash = generateHash([projectSlug, ns])\n        return $storage.get(hash) or {}\n\n    service.storeMyFilters = (projectId, myFilters) ->\n        deferred = $q.defer()\n        url = $urls.resolve(\"user-storage\")\n        ns = \"#{projectId}:#{myFiltersHashSuffix}\"\n        hash = generateHash([projectId, ns])\n        if _.isEmpty(myFilters)\n            promise = $http.delete(\"#{url}/#{hash}\", {key: hash, value:myFilters})\n            promise.then ->\n                deferred.resolve()\n            promise.then null, ->\n                deferred.reject()\n        else\n            promise = $http.put(\"#{url}/#{hash}\", {key: hash, value:myFilters})\n            promise.then (data) ->\n                deferred.resolve()\n            promise.then null, (data) ->\n                innerPromise = $http.post(\"#{url}\", {key: hash, value:myFilters})\n                innerPromise.then ->\n                    deferred.resolve()\n                innerPromise.then null, ->\n                    deferred.reject()\n        return deferred.promise\n\n    service.getMyFilters = (projectId) ->\n        deferred = $q.defer()\n        url = $urls.resolve(\"user-storage\")\n        ns = \"#{projectId}:#{myFiltersHashSuffix}\"\n        hash = generateHash([projectId, ns])\n\n        promise = $http.get(\"#{url}/#{hash}\")\n        promise.then (data) ->\n            deferred.resolve(data.data.value)\n        promise.then null, (data) ->\n            deferred.resolve({})\n\n        return deferred.promise\n\n    return (instance) ->\n        instance.issues = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgIssuesResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", \"$tgStorage\", \"$q\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/kanban.coffee\n###\n\n\ntaiga = @.taiga\n\ngenerateHash = taiga.generateHash\n\nresourceProvider = ($storage) ->\n    service = {}\n    hashSuffixStatusViewModes = \"kanban-statusviewmodels\"\n    hashSuffixStatusColumnModes = \"kanban-statuscolumnmodels\"\n\n    service.storeStatusViewModes = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffixStatusViewModes}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getStatusViewModes = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffixStatusViewModes}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    service.storeStatusColumnModes = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffixStatusColumnModes}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getStatusColumnModes = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffixStatusColumnModes}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    return (instance) ->\n        instance.kanban = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgKanbanResourcesProvider\", [\"$tgStorage\", resourceProvider])\n","###\n# Copyright (C) 2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/locales.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($repo) ->\n    service = {\n        list: -> return $repo.queryMany(\"locales\")\n    }\n\n    return (instance) ->\n        instance.locales = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgLocalesResourcesProvider\", [\"$tgRepo\", resourceProvider])\n\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/mdrender.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $urls, $http) ->\n    service = {}\n\n    service.render = (projectId, content) ->\n        # We can't use an empty content\n        content = ' ' if not content? or content == \"\"\n\n        params = {\n            project_id: projectId\n            content: content\n        }\n        url = $urls.resolve(\"wiki\")\n        return $http.post(\"#{url}/render\", params).then (data) =>\n            return data.data\n\n    return (instance) ->\n        instance.mdrender = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgMdRenderResourcesProvider\", [\"$tgRepo\", \"$tgUrls\", \"$tgHttp\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/memberships.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $http, $urls) ->\n    service = {}\n\n    service.get = (id) ->\n        return $repo.queryOne(\"memberships\", id)\n\n    service.list = (projectId, filters, enablePagination=true) ->\n        params = {project: projectId}\n        params = _.extend({}, params, filters or {})\n        if enablePagination\n            return $repo.queryPaginated(\"memberships\", params)\n\n        return $repo.queryMany(\"memberships\", params, options={enablePagination:enablePagination})\n\n    service.listByUser = (userId, filters) ->\n        params = {user: userId}\n        params = _.extend({}, params, filters or {})\n        return $repo.queryPaginated(\"memberships\", params)\n\n    service.resendInvitation = (id) ->\n        url = $urls.resolve(\"memberships\")\n        return $http.post(\"#{url}/#{id}/resend_invitation\", {})\n\n    service.bulkCreateMemberships = (projectId, data, invitation_extra_text) ->\n        url = $urls.resolve(\"bulk-create-memberships\")\n        params = {project_id: projectId, bulk_memberships: data, invitation_extra_text: invitation_extra_text}\n        return $http.post(url, params)\n\n    return (instance) ->\n        instance.memberships = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgMembershipsResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules.coffee\n###\n\nresourceProvider = ($repo) ->\n    service = {}\n\n    service.list = (projectId, module) ->\n        return $repo.queryOneAttribute(\"project-modules\", projectId, module)\n\n    return (instance) ->\n        instance.modules = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgModulesResourcesProvider\", [\"$tgRepo\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/memberships.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $http, $urls) ->\n    service = {}\n\n    service.get = (id) ->\n        return $repo.queryOne(\"notify-policies\", id)\n\n    service.list = (filters) ->\n        params = _.extend({}, params, filters or {})\n        return $repo.queryMany(\"notify-policies\", params)\n\n    return (instance) ->\n        instance.notifyPolicies = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgNotifyPoliciesResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/projects.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($config, $repo, $http, $urls, $auth, $q, $translate) ->\n    service = {}\n\n    service.get = (projectId) ->\n        return $repo.queryOne(\"projects\", projectId)\n\n    service.getBySlug = (projectSlug) ->\n        return $repo.queryOne(\"projects\", \"by_slug?slug=#{projectSlug}\")\n\n    service.list = ->\n        return $repo.queryMany(\"projects\")\n\n    service.listByMember = (memberId) ->\n        params = {\"member\": memberId, \"order_by\": \"memberships__user_order\"}\n        return $repo.queryMany(\"projects\", params)\n\n    service.templates = ->\n        return $repo.queryMany(\"project-templates\")\n\n    service.usersList = (projectId) ->\n        params = {\"project\": projectId}\n        return $repo.queryMany(\"users\", params)\n\n    service.rolesList = (projectId) ->\n        params = {\"project\": projectId}\n        return $repo.queryMany(\"roles\", params)\n\n    service.stats = (projectId) ->\n        return $repo.queryOneRaw(\"projects\", \"#{projectId}/stats\")\n\n    service.bulkUpdateOrder = (bulkData) ->\n        url = $urls.resolve(\"bulk-update-projects-order\")\n        return $http.post(url, bulkData)\n\n    service.regenerate_userstories_csv_uuid = (projectId) ->\n        url = \"#{$urls.resolve(\"projects\")}/#{projectId}/regenerate_userstories_csv_uuid\"\n        return $http.post(url)\n\n    service.regenerate_issues_csv_uuid = (projectId) ->\n        url = \"#{$urls.resolve(\"projects\")}/#{projectId}/regenerate_issues_csv_uuid\"\n        return $http.post(url)\n\n    service.regenerate_tasks_csv_uuid = (projectId) ->\n        url = \"#{$urls.resolve(\"projects\")}/#{projectId}/regenerate_tasks_csv_uuid\"\n        return $http.post(url)\n\n    service.leave = (projectId) ->\n        url = \"#{$urls.resolve(\"projects\")}/#{projectId}/leave\"\n        return $http.post(url)\n\n    service.memberStats = (projectId) ->\n        return $repo.queryOneRaw(\"projects\", \"#{projectId}/member_stats\")\n\n    service.tagsColors = (projectId) ->\n        return $repo.queryOne(\"projects\", \"#{projectId}/tags_colors\")\n\n    service.export = (projectId) ->\n        url = \"#{$urls.resolve(\"exporter\")}/#{projectId}\"\n        return $http.get(url)\n\n    service.import = (file, statusUpdater) ->\n        defered = $q.defer()\n\n        maxFileSize = $config.get(\"maxUploadFileSize\", null)\n        if maxFileSize and file.size > maxFileSize\n            errorMsg = $translate.instant(\"PROJECT.IMPORT.ERROR_MAX_SIZE_EXCEEDED\", {\n                fileName: file.name\n                fileSize: sizeFormat(file.size)\n                maxFileSize: sizeFormat(maxFileSize)\n            })\n\n            response = {\n                status: 413,\n                data: _error_message: errorMsg\n            }\n            defered.reject(response)\n            return defered.promise\n\n        uploadProgress = (evt) =>\n            percent = Math.round((evt.loaded / evt.total) * 100)\n            message = $translate.instant(\"PROJECT.IMPORT.UPLOAD_IN_PROGRESS_MESSAGE\", {\n                uploadedSize: sizeFormat(evt.loaded)\n                totalSize: sizeFormat(evt.total)\n            })\n            statusUpdater(\"in-progress\", null, message, percent)\n\n        uploadComplete = (evt) =>\n            statusUpdater(\"done\",\n                          $translate.instant(\"PROJECT.IMPORT.TITLE\"),\n                          $translate.instant(\"PROJECT.IMPORT.DESCRIPTION\"))\n\n        uploadFailed = (evt) =>\n            statusUpdater(\"error\")\n\n        complete = (evt) =>\n            response = {}\n            try\n                response.data = JSON.parse(evt.target.responseText)\n            catch\n                response.data = {}\n            response.status = evt.target.status\n\n            defered.resolve(response) if response.status in [201, 202]\n            defered.reject(response)\n\n        failed = (evt) =>\n            defered.reject(\"fail\")\n\n        data = new FormData()\n        data.append('dump', file)\n\n        xhr = new XMLHttpRequest()\n        xhr.upload.addEventListener(\"progress\", uploadProgress, false)\n        xhr.upload.addEventListener(\"load\", uploadComplete, false)\n        xhr.upload.addEventListener(\"error\", uploadFailed, false)\n        xhr.upload.addEventListener(\"abort\", uploadFailed, false)\n        xhr.addEventListener(\"load\", complete, false)\n        xhr.addEventListener(\"error\", failed, false)\n\n        xhr.open(\"POST\", $urls.resolve(\"importer\"))\n        xhr.setRequestHeader(\"Authorization\", \"Bearer #{$auth.getToken()}\")\n        xhr.setRequestHeader('Accept', 'application/json')\n        xhr.send(data)\n\n        return defered.promise\n\n    return (instance) ->\n        instance.projects = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgProjectsResourcesProvider\", [\"$tgConfig\", \"$tgRepo\", \"$tgHttp\", \"$tgUrls\", \"$tgAuth\",\n                                                \"$q\", \"$translate\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/memberships.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $http, $urls) ->\n    service = {}\n\n    service.get = (id) ->\n        return $repo.queryOne(\"roles\", id)\n\n    service.list = (projectId) ->\n        return $repo.queryMany(\"roles\", {project: projectId})\n\n    return (instance) ->\n        instance.roles = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgRolesResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/search.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $urls, $http) ->\n    service = {}\n\n    service.do = (projectId, term) ->\n        url = $urls.resolve(\"search\")\n        params = {\n            project: projectId\n            text: term,\n            get_all: false\n        }\n\n        return $http.get(url, params).then (data) ->\n            return data.data\n\n    return (instance) ->\n        instance.search = service\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgSearchResourcesProvider\", [\"$tgRepo\", \"$tgUrls\", \"$tgHttp\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/sprints.coffee\n###\n\ntaiga = @.taiga\n\ngenerateHash = taiga.generateHash\n\nresourceProvider = ($repo, $model, $storage) ->\n    service = {}\n\n    service.get = (projectId, sprintId) ->\n        return $repo.queryOne(\"milestones\", sprintId).then (sprint) ->\n            uses = sprint.user_stories\n            uses = _.map(uses, (u) -> $model.make_model(\"userstories\", u))\n            sprint._attrs.user_stories = uses\n            return sprint\n\n    service.stats = (projectId, sprintId) ->\n        return $repo.queryOneRaw(\"milestones\", \"#{sprintId}/stats\")\n\n    service.list = (projectId, filters) ->\n        params = {\"project\": projectId}\n        params = _.extend({}, params, filters or {})\n        return $repo.queryMany(\"milestones\", params, {}, true).then (result) =>\n            milestones = result[0]\n            headers = result[1]\n\n            for m in milestones\n                uses = m.user_stories\n                uses = _.map(uses, (u) => $model.make_model(\"userstories\", u))\n                m._attrs.user_stories = uses\n\n            return {\n                milestones: milestones,\n                closed: parseInt(headers(\"Taiga-Info-Total-Closed-Milestones\"), 10),\n                open: parseInt(headers(\"Taiga-Info-Total-Opened-Milestones\"), 10)\n            }\n\n\n    return (instance) ->\n        instance.sprints = service\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgSprintsResourcesProvider\", [\"$tgRepo\", \"$tgModel\", \"$tgStorage\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/tasks.coffee\n###\n\n\ntaiga = @.taiga\n\ngenerateHash = taiga.generateHash\n\nresourceProvider = ($repo, $http, $urls, $storage) ->\n    service = {}\n    hashSuffix = \"tasks-queryparams\"\n    hashSuffixStatusColumnModes = \"tasks-statuscolumnmodels\"\n    hashSuffixUsRowModes = \"tasks-usrowmodels\"\n\n    service.get = (projectId, taskId) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        return $repo.queryOne(\"tasks\", taskId, params)\n\n    service.getByRef = (projectId, ref) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        params.ref = ref\n        return $repo.queryOne(\"tasks\", \"by_ref\", params)\n\n    service.listInAllProjects = (filters) ->\n        return $repo.queryMany(\"tasks\", filters)\n\n    service.list = (projectId, sprintId=null, userStoryId=null) ->\n        params = {project: projectId}\n        params.milestone = sprintId if sprintId\n        params.user_story = userStoryId if userStoryId\n        service.storeQueryParams(projectId, params)\n        return $repo.queryMany(\"tasks\", params)\n\n    service.bulkCreate = (projectId, sprintId, usId, data) ->\n        url = $urls.resolve(\"bulk-create-tasks\")\n        params = {project_id: projectId, sprint_id: sprintId, us_id: usId, bulk_tasks: data}\n        return $http.post(url, params).then (result) ->\n            return result.data\n\n    service.upvote = (taskId) ->\n        url = $urls.resolve(\"task-upvote\", taskId)\n        return $http.post(url)\n\n    service.downvote = (taskId) ->\n        url = $urls.resolve(\"task-downvote\", taskId)\n        return $http.post(url)\n\n    service.watch = (taskId) ->\n        url = $urls.resolve(\"task-watch\", taskId)\n        return $http.post(url)\n\n    service.unwatch = (taskId) ->\n        url = $urls.resolve(\"task-unwatch\", taskId)\n        return $http.post(url)\n\n    service.bulkUpdateTaskTaskboardOrder = (projectId, data) ->\n        url = $urls.resolve(\"bulk-update-task-taskboard-order\")\n        params = {project_id: projectId, bulk_tasks: data}\n        return $http.post(url, params)\n\n    service.listValues = (projectId, type) ->\n        params = {\"project\": projectId}\n        return $repo.queryMany(type, params)\n\n    service.storeQueryParams = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getQueryParams = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    service.storeStatusColumnModes = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffixStatusColumnModes}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getStatusColumnModes = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffixStatusColumnModes}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    service.storeUsRowModes = (projectId, sprintId, params) ->\n        ns = \"#{projectId}:#{hashSuffixUsRowModes}\"\n        hash = generateHash([projectId, sprintId, ns])\n\n        $storage.set(hash, params)\n\n    service.getUsRowModes = (projectId, sprintId) ->\n        ns = \"#{projectId}:#{hashSuffixUsRowModes}\"\n        hash = generateHash([projectId, sprintId, ns])\n\n        return $storage.get(hash) or {}\n\n    return (instance) ->\n        instance.tasks = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgTasksResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", \"$tgStorage\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/memberships.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($config, $repo, $http, $urls, $q) ->\n    service = {}\n\n    service.changeAvatar = (file) ->\n        maxFileSize = $config.get(\"maxUploadFileSize\", null)\n        if maxFileSize and file.size > maxFileSize\n            response = {\n                status: 413,\n                data: _error_message: \"'#{file.name}' (#{sizeFormat(file.size)}) is too heavy for our oompa\n                                       loompas, try it with a smaller than (#{sizeFormat(maxFileSize)})\"\n            }\n            defered = $q.defer()\n            defered.reject(response)\n            return defered.promise\n\n        data = new FormData()\n        data.append('avatar', file)\n        options = {\n            transformRequest: angular.identity,\n            headers: {'Content-Type': undefined}\n        }\n        url = \"#{$urls.resolve(\"users\")}/change_avatar\"\n        return $http.post(url, data, {}, options)\n\n    service.removeAvatar = () ->\n        url = \"#{$urls.resolve(\"users\")}/remove_avatar\"\n        return $http.post(url)\n\n    service.changePassword = (currentPassword, newPassword) ->\n        url = \"#{$urls.resolve(\"users\")}/change_password\"\n        data = {\n            current_password: currentPassword\n            password: newPassword\n        }\n        return $http.post(url, data)\n\n    return (instance) ->\n        instance.userSettings = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgUserSettingsResourcesProvider\", [\"$tgConfig\", \"$tgRepo\", \"$tgHttp\", \"$tgUrls\", \"$q\",\n                                                    resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/user.coffee\n###\n\n\ntaiga = @.taiga\nsizeFormat = @.taiga.sizeFormat\n\n\nresourceProvider = ($http, $urls) ->\n    service = {}\n\n    service.contacts = (userId, options={}) ->\n        url = $urls.resolve(\"user-contacts\", userId)\n        httpOptions = {headers: {}}\n\n        if not options.enablePagination\n            httpOptions.headers[\"x-disable-pagination\"] =  \"1\"\n\n        return $http.get(url, {}, httpOptions)\n            .then (result) ->\n                return result.data\n\n    return (instance) ->\n        instance.users = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgUsersResourcesProvider\", [\"$tgHttp\", \"$tgUrls\", \"$q\",\n                                                    resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/userstories.coffee\n###\n\ntaiga = @.taiga\n\ngenerateHash = taiga.generateHash\n\nresourceProvider = ($repo, $http, $urls, $storage) ->\n    service = {}\n    hashSuffix = \"userstories-queryparams\"\n\n    service.get = (projectId, usId) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        return $repo.queryOne(\"userstories\", usId, params)\n\n    service.getByRef = (projectId, ref) ->\n        params = service.getQueryParams(projectId)\n        params.project = projectId\n        params.ref = ref\n        return $repo.queryOne(\"userstories\", \"by_ref\", params)\n\n    service.listInAllProjects = (filters) ->\n        return $repo.queryMany(\"userstories\", filters)\n\n    service.filtersData = (params) ->\n        return $repo.queryOneRaw(\"userstories-filters\", null, params)\n\n    service.listUnassigned = (projectId, filters) ->\n        params = {\"project\": projectId, \"milestone\": \"null\"}\n        params = _.extend({}, params, filters or {})\n        service.storeQueryParams(projectId, params)\n        return $repo.queryMany(\"userstories\", params)\n\n    service.listAll = (projectId, filters) ->\n        params = {\"project\": projectId}\n        params = _.extend({}, params, filters or {})\n        service.storeQueryParams(projectId, params)\n        return $repo.queryMany(\"userstories\", params)\n\n    service.bulkCreate = (projectId, status, bulk) ->\n        data = {\n            project_id: projectId\n            status_id: status\n            bulk_stories: bulk\n        }\n\n        url = $urls.resolve(\"bulk-create-us\")\n\n        return $http.post(url, data)\n\n    service.upvote = (userStoryId) ->\n        url = $urls.resolve(\"userstory-upvote\", userStoryId)\n        return $http.post(url)\n\n    service.downvote = (userStoryId) ->\n        url = $urls.resolve(\"userstory-downvote\", userStoryId)\n        return $http.post(url)\n\n    service.watch = (userStoryId) ->\n        url = $urls.resolve(\"userstory-watch\", userStoryId)\n        return $http.post(url)\n\n    service.unwatch = (userStoryId) ->\n        url = $urls.resolve(\"userstory-unwatch\", userStoryId)\n        return $http.post(url)\n\n    service.bulkUpdateBacklogOrder = (projectId, data) ->\n        url = $urls.resolve(\"bulk-update-us-backlog-order\")\n        params = {project_id: projectId, bulk_stories: data}\n        return $http.post(url, params)\n\n    service.bulkUpdateSprintOrder = (projectId, data) ->\n        url = $urls.resolve(\"bulk-update-us-sprint-order\")\n        params = {project_id: projectId, bulk_stories: data}\n        return $http.post(url, params)\n\n    service.bulkUpdateKanbanOrder = (projectId, data) ->\n        url = $urls.resolve(\"bulk-update-us-kanban-order\")\n        params = {project_id: projectId, bulk_stories: data}\n        return $http.post(url, params)\n\n    service.listValues = (projectId, type) ->\n        params = {\"project\": projectId}\n        service.storeQueryParams(projectId, params)\n        return $repo.queryMany(type, params)\n\n    service.storeQueryParams = (projectId, params) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        $storage.set(hash, params)\n\n    service.getQueryParams = (projectId) ->\n        ns = \"#{projectId}:#{hashSuffix}\"\n        hash = generateHash([projectId, ns])\n        return $storage.get(hash) or {}\n\n    service.storeShowTags = (projectId, showTags) ->\n        hash = generateHash([projectId, 'showTags'])\n        $storage.set(hash, showTags)\n\n    service.getShowTags = (projectId) ->\n        hash = generateHash([projectId, 'showTags'])\n        return $storage.get(hash) or null\n\n    return (instance) ->\n        instance.userstories = service\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgUserstoriesResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", \"$tgStorage\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: webhooklogs.coffee\n###\n\nresourceProvider = ($repo, $urls, $http) ->\n    service = {}\n\n    service.list = (webhookId) ->\n        params = {webhook: webhookId}\n        return $repo.queryMany(\"webhooklogs\", params)\n\n    service.resend = (webhooklogId) ->\n        url = $urls.resolve(\"webhooklogs-resend\", webhooklogId)\n        return $http.post(url)\n\n    return (instance) ->\n        instance.webhooklogs = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgWebhookLogsResourcesProvider\", [\"$tgRepo\", \"$tgUrls\", \"$tgHttp\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: webhooks.coffee\n###\n\nresourceProvider = ($repo, $urls, $http) ->\n    service = {}\n\n    service.list = (projectId) ->\n        params = {project: projectId}\n        return $repo.queryMany(\"webhooks\", params)\n\n    service.test = (webhookId) ->\n        url = $urls.resolve(\"webhooks-test\", webhookId)\n        return $http.post(url)\n\n    return (instance) ->\n        instance.webhooks = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgWebhooksResourcesProvider\", [\"$tgRepo\", \"$tgUrls\", \"$tgHttp\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/resources/wikis.coffee\n###\n\n\ntaiga = @.taiga\n\nresourceProvider = ($repo, $http, $urls) ->\n    service = {}\n\n    service.get = (wikiId) ->\n        return $repo.queryOne(\"wiki\", wikiId)\n\n    service.getBySlug = (projectId, slug) ->\n        return $repo.queryOne(\"wiki\", \"by_slug?project=#{projectId}&slug=#{slug}\")\n\n    service.listLinks = (projectId) ->\n        return $repo.queryMany(\"wiki-links\", {project: projectId})\n\n    return (instance) ->\n        instance.wiki = service\n\n\nmodule = angular.module(\"taigaResources\")\nmodule.factory(\"$tgWikiResourcesProvider\", [\"$tgRepo\", \"$tgHttp\", \"$tgUrls\", resourceProvider])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/user-settings/main.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaUserSettings\")\n\n\n#############################################################################\n## User ChangePassword Controller\n#############################################################################\n\nclass UserChangePasswordController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"$tgAuth\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls,\n                  @auth, @translate) ->\n        @scope.sectionName = @translate.instant(\"CHANGE_PASSWORD.SECTION_NAME\")\n        @scope.user = @auth.getUser()\n\nmodule.controller(\"UserChangePasswordController\", UserChangePasswordController)\n\n\n#############################################################################\n## User ChangePassword Directive\n#############################################################################\n\nUserChangePasswordDirective = ($rs, $confirm, $loading, $translate) ->\n    link = ($scope, $el, $attrs, ctrl) ->\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            if $scope.newPassword1 != $scope.newPassword2\n                $confirm.notify('error', $translate.instant(\"CHANGE_PASSWORD.ERROR_PASSWORD_MATCH\"))\n                return\n\n            currentLoading = $loading()\n                .target(submitButton)\n                .start()\n\n            promise = $rs.userSettings.changePassword($scope.currentPassword, $scope.newPassword1)\n            promise.then =>\n                currentLoading.finish()\n                $confirm.notify('success')\n\n            promise.then null, (response) =>\n                currentLoading.finish()\n                $confirm.notify('error', response.data._error_message)\n\n        submitButton = $el.find(\".submit-button\")\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {\n        link:link\n    }\n\nmodule.directive(\"tgUserChangePassword\", [\"$tgResources\", \"$tgConfirm\", \"$tgLoading\", \"$translate\", UserChangePasswordDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/issues/lightboxes.coffee\n###\n\ntaiga = @.taiga\nbindOnce = @.taiga.bindOnce\ndebounce = @.taiga.debounce\n\nmodule = angular.module(\"taigaUserSettings\")\n\n\n#############################################################################\n## Delete User Lightbox Directive\n#############################################################################\n\nDeleteUserDirective = ($repo, $rootscope, $auth, $location, $navUrls, lightboxService) ->\n    link = ($scope, $el, $attrs) ->\n        $scope.$on \"deletelightbox:new\", (ctx, user)->\n            lightboxService.open($el)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        submit = ->\n            promise = $repo.remove($scope.user)\n\n            promise.then (data) ->\n                lightboxService.close($el)\n                $auth.logout()\n                $location.path($navUrls.resolve(\"login\"))\n\n            # FIXME: error handling?\n            promise.then null, ->\n                console.log \"FAIL\"\n\n        $el.on \"click\", \".button-red\", (event) ->\n            event.preventDefault()\n            lightboxService.close($el)\n\n        $el.on \"click\", \".button-green\", debounce 2000, (event) ->\n            event.preventDefault()\n            submit()\n\n    return {\n        link: link,\n        templateUrl: \"user/lightbox/lightbox-delete-account.html\"\n    }\n\nmodule.directive(\"tgLbDeleteUser\", [\"$tgRepo\", \"$rootScope\", \"$tgAuth\", \"$tgLocation\", \"$tgNavUrls\",\n                                    \"lightboxService\", DeleteUserDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/user-settings/main.coffee\n###\n\ntaiga = @.taiga\nmixOf = @.taiga.mixOf\nsizeFormat = @.taiga.sizeFormat\nmodule = angular.module(\"taigaUserSettings\")\ndebounce = @.taiga.debounce\n\n#############################################################################\n## User settings Controller\n#############################################################################\n\nclass UserSettingsController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgConfig\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"$tgAuth\",\n        \"$translate\"\n    ]\n\n    constructor: (@scope, @rootscope, @config, @repo, @confirm, @rs, @params, @q, @location, @navUrls,\n                  @auth, @translate) ->\n        @scope.sectionName = \"USER_SETTINGS.MENU.SECTION_TITLE\"\n\n        @scope.project = {}\n        @scope.user = @auth.getUser()\n\n        if !@scope.user\n            @location.path(@navUrls.resolve(\"permission-denied\"))\n            @location.replace()\n\n        @scope.lang = @getLan()\n        @scope.theme = @getTheme()\n\n        maxFileSize = @config.get(\"maxUploadFileSize\", null)\n        if maxFileSize\n            text = @translate.instant(\"USER_SETTINGS.AVATAR_MAX_SIZE\", {\"maxFileSize\": sizeFormat(maxFileSize)})\n            @scope.maxFileSizeMsg = text\n\n        promise = @.loadInitialData()\n\n        promise.then null, @.onInitialDataError.bind(@)\n\n    loadInitialData: ->\n        @scope.availableThemes = @config.get(\"themes\", [])\n\n        return @rs.locales.list().then (locales) =>\n            @scope.locales = locales\n            return locales\n\n    openDeleteLightbox: ->\n        @rootscope.$broadcast(\"deletelightbox:new\", @scope.user)\n\n    getLan: ->\n        return @scope.user.lang ||\n               @translate.preferredLanguage()\n\n    getTheme: ->\n        return @scope.user.theme ||\n               @config.get(\"defaultTheme\") ||\n               \"taiga\"\n\nmodule.controller(\"UserSettingsController\", UserSettingsController)\n\n\n#############################################################################\n## User Profile Directive\n#############################################################################\n\nUserProfileDirective = ($confirm, $auth, $repo, $translate) ->\n    link = ($scope, $el, $attrs) ->\n        submit = debounce 2000, (event) =>\n            event.preventDefault()\n\n            form = $el.find(\"form\").checksley()\n            return if not form.validate()\n\n            changeEmail = $scope.user.isAttributeModified(\"email\")\n            $scope.user.lang = $scope.lang\n            $scope.user.theme = $scope.theme\n\n            onSuccess = (data) =>\n                $auth.setUser(data)\n\n                if changeEmail\n                    text = $translate.instant(\"USER_PROFILE.CHANGE_EMAIL_SUCCESS\")\n                    $confirm.success(text)\n                else\n                    $confirm.notify('success')\n\n            onError = (data) =>\n                form.setErrors(data)\n                $confirm.notify('error', data._error_message)\n\n            $repo.save($scope.user).then(onSuccess, onError)\n\n        $el.on \"submit\", \"form\", submit\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgUserProfile\", [\"$tgConfirm\", \"$tgAuth\", \"$tgRepo\", \"$translate\", UserProfileDirective])\n\n\n#############################################################################\n## User Avatar Directive\n#############################################################################\n\nUserAvatarDirective = ($auth, $model, $rs, $confirm) ->\n    link = ($scope, $el, $attrs) ->\n        showSizeInfo = ->\n            $el.find(\".size-info\").removeClass(\"hidden\")\n\n        onSuccess = (response) ->\n            user = $model.make_model(\"users\", response.data)\n            $auth.setUser(user)\n            $scope.user = user\n\n            $el.find('.overlay').addClass('hidden')\n            $confirm.notify('success')\n\n        onError = (response) ->\n            showSizeInfo() if response.status == 413\n            $el.find('.overlay').addClass('hidden')\n            $confirm.notify('error', response.data._error_message)\n\n        # Change photo\n        $el.on \"click\", \".js-change-avatar\", ->\n            $el.find(\"#avatar-field\").click()\n\n        $el.on \"change\", \"#avatar-field\", (event) ->\n            if $scope.avatarAttachment\n                $el.find('.overlay').removeClass('hidden')\n                $rs.userSettings.changeAvatar($scope.avatarAttachment).then(onSuccess, onError)\n\n        # Use gravatar photo\n        $el.on \"click\", \"a.use-gravatar\", (event) ->\n            $el.find('.overlay').removeClass('hidden')\n            $rs.userSettings.removeAvatar().then(onSuccess, onError)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgUserAvatar\", [\"$tgAuth\", \"$tgModel\", \"$tgResources\", \"$tgConfirm\", UserAvatarDirective])\n\n\n#############################################################################\n## User Avatar Model Directive\n#############################################################################\n\nTaigaAvatarModelDirective = ($parse) ->\n    link = ($scope, $el, $attrs) ->\n        model = $parse($attrs.tgAvatarModel)\n        modelSetter = model.assign\n\n        $el.bind 'change', ->\n            $scope.$apply ->\n                modelSetter($scope, $el[0].files[0])\n\n    return {link:link}\n\nmodule.directive('tgAvatarModel', ['$parse', TaigaAvatarModelDirective])\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/user-settings/nav.coffee\n###\n\nUserSettingsNavigationDirective = ->\n    link = ($scope, $el, $attrs) ->\n        section = $attrs.tgUserSettingsNavigation\n        $el.find(\".active\").removeClass(\"active\")\n        $el.find(\"#usersettingsmenu-#{section} a\").addClass(\"active\")\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule = angular.module(\"taigaUserSettings\")\nmodule.directive(\"tgUserSettingsNavigation\", UserSettingsNavigationDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/user-settings/notifications.coffee\n###\n\ntaiga = @.taiga\nmixOf = @.taiga.mixOf\nbindOnce = @.taiga.bindOnce\n\nmodule = angular.module(\"taigaUserSettings\")\n\n\n#############################################################################\n## User settings Controller\n#############################################################################\n\nclass UserNotificationsController extends mixOf(taiga.Controller, taiga.PageMixin)\n    @.$inject = [\n        \"$scope\",\n        \"$rootScope\",\n        \"$tgRepo\",\n        \"$tgConfirm\",\n        \"$tgResources\",\n        \"$routeParams\",\n        \"$q\",\n        \"$tgLocation\",\n        \"$tgNavUrls\",\n        \"$tgAuth\"\n    ]\n\n    constructor: (@scope, @rootscope, @repo, @confirm, @rs, @params, @q, @location, @navUrls, @auth) ->\n        @scope.sectionName = \"USER_SETTINGS.NOTIFICATIONS.SECTION_NAME\"\n        @scope.user = @auth.getUser()\n        promise = @.loadInitialData()\n        promise.then null, @.onInitialDataError.bind(@)\n\n    loadInitialData: ->\n        return @rs.notifyPolicies.list().then (notifyPolicies) =>\n            @scope.notifyPolicies = notifyPolicies\n            return notifyPolicies\n\nmodule.controller(\"UserNotificationsController\", UserNotificationsController)\n\n\n#############################################################################\n## User Notifications Directive\n#############################################################################\n\nUserNotificationsDirective = () ->\n    link = ($scope, $el, $attrs) ->\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n    return {link:link}\n\nmodule.directive(\"tgUserNotifications\", UserNotificationsDirective)\n\n\n#############################################################################\n## User Notifications List Directive\n#############################################################################\n\nUserNotificationsListDirective = ($repo, $confirm, $compile) ->\n    template = _.template(\"\"\"\n        <% _.each(notifyPolicies, function (notifyPolicy, index) { %>\n        <div class=\"policy-table-row\" data-index=\"<%- index %>\">\n          <div class=\"policy-table-project\"><span><%- notifyPolicy.project_name %></span></div>\n          <div class=\"policy-table-all\">\n            <fieldset>\n              <input type=\"radio\"\n                     name=\"policy-<%- notifyPolicy.id %>\" id=\"policy-all-<%- notifyPolicy.id %>\"\n                     value=\"2\" <% if (notifyPolicy.notify_level == 2) { %>checked=\"checked\"<% } %>/>\n              <label for=\"policy-all-<%- notifyPolicy.id %>\"\n                     translate=\"USER_SETTINGS.NOTIFICATIONS.OPTION_ALL\"></label>\n            </fieldset>\n          </div>\n          <div class=\"policy-table-involved\">\n            <fieldset>\n              <input type=\"radio\"\n                     name=\"policy-<%- notifyPolicy.id %>\" id=\"policy-involved-<%- notifyPolicy.id %>\"\n                     value=\"1\" <% if (notifyPolicy.notify_level == 1) { %>checked=\"checked\"<% } %> />\n              <label for=\"policy-involved-<%- notifyPolicy.id %>\"\n                     translate=\"USER_SETTINGS.NOTIFICATIONS.OPTION_INVOLVED\"></label>\n            </fieldset>\n          </div>\n          <div class=\"policy-table-none\">\n            <fieldset>\n              <input type=\"radio\"\n                     name=\"policy-<%- notifyPolicy.id %>\" id=\"policy-none-<%- notifyPolicy.id %>\"\n                     value=\"3\" <% if (notifyPolicy.notify_level == 3) { %>checked=\"checked\"<% } %> />\n              <label for=\"policy-none-<%- notifyPolicy.id %>\"\n                     translate=\"USER_SETTINGS.NOTIFICATIONS.OPTION_NONE\"></label>\n            </fieldset>\n          </div>\n        </div>\n        <% }) %>\n    \"\"\")\n\n    link = ($scope, $el, $attrs) ->\n        render = ->\n            $el.off()\n\n            ctx = {notifyPolicies: $scope.notifyPolicies}\n            html = template(ctx)\n\n            $el.html($compile(html)($scope))\n\n            $el.on \"change\", \"input[type=radio]\", (event) ->\n                target = angular.element(event.currentTarget)\n\n                policyIndex = target.parents(\".policy-table-row\").data('index')\n                policy = $scope.notifyPolicies[policyIndex]\n                prev_level = policy.notify_level\n                policy.notify_level = parseInt(target.val(), 10)\n\n                onSuccess = ->\n                    $confirm.notify(\"success\")\n\n                onError = ->\n                    $confirm.notify(\"error\")\n                    target.parents(\".policy-table-row\")\n                          .find(\"input[value=#{prev_level}]\")\n                          .prop(\"checked\", true)\n\n                $repo.save(policy).then(onSuccess, onError)\n\n        $scope.$on \"$destroy\", ->\n            $el.off()\n\n        bindOnce($scope, $attrs.ngModel, render)\n\n    return {link:link}\n\nmodule.directive(\"tgUserNotificationsList\", [\"$tgRepo\", \"$tgConfirm\", \"$compile\",\n                                             UserNotificationsListDirective])\n","###\n# Copyright (C) 2015 Taiga Agile LLC\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: components.module.coffee\n###\n\nangular.module(\"taigaComponents\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: external-apps.module.coffee\n###\n\nmodule = angular.module(\"taigaExternalApps\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: home.module.coffee\n###\n\nmodule = angular.module(\"taigaHome\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: navigation-bar.module.coffee\n###\n\nangular.module(\"taigaNavigationBar\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile.module.coffee\n###\n\nmodule = angular.module(\"taigaProfile\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: projects.module.coffee\n###\n\nangular.module(\"taigaProjects\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: resources.module.coffee\n###\n\nangular.module(\"taigaResources2\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline.module.coffee\n###\n\nangular.module(\"taigaUserTimeline\", [])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: joy-ride.directive.coffee\n###\n\ntaiga = @.taiga\n\nJoyRideDirective = ($rootScope, currentUserService, joyRideService, $location) ->\n    link = (scope, el, attrs, ctrl) ->\n        unsuscribe = null\n        intro = introJs()\n\n        #Todo: translate\n        intro.setOptions({\n            exitOnEsc: false,\n            exitOnOverlayClick: false,\n            showStepNumbers: false,\n            nextLabel: 'Next &rarr;',\n            prevLabel: '&larr; Back',\n            skipLabel: 'Skip',\n            doneLabel: 'Done',\n            disableInteraction: true\n        })\n\n        intro.oncomplete () ->\n            $('html,body').scrollTop(0)\n\n        intro.onexit () ->\n            currentUserService.disableJoyRide()\n\n        initJoyrRide = (next, config) ->\n            if !config[next.joyride]\n                return\n\n            intro.setOption('steps', joyRideService.get(next.joyride))\n            intro.start()\n\n        $rootScope.$on '$routeChangeSuccess',  (event, next) ->\n            if !next.joyride || !currentUserService.isAuthenticated()\n                intro.exit()\n                unsuscribe() if unsuscribe\n                return\n\n\n            intro.oncomplete () ->\n                currentUserService.disableJoyRide(next.joyride)\n\n            if next.loader\n                unsuscribe = $rootScope.$on 'loader:end',  () ->\n                    currentUserService.loadJoyRideConfig()\n                        .then (config) -> initJoyrRide(next, config)\n\n                    unsuscribe()\n            else\n                currentUserService.loadJoyRideConfig()\n                    .then (config) -> initJoyrRide(next, config)\n\n    return {\n        scope: {},\n        link: link\n    }\n\nJoyRideDirective.$inject = [\n    \"$rootScope\",\n    \"tgCurrentUserService\",\n    \"tgJoyRideService\",\n    \"$location\"\n]\n\nangular.module(\"taigaComponents\").directive(\"tgJoyRide\", JoyRideDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: joy-ride.service.coffee\n###\n\nclass JoyRideService extends taiga.Service\n    @.$inject = [\n        '$translate',\n        'tgCheckPermissionsService'\n    ]\n\n    constructor: (@translate, @checkPermissionsService) ->\n\n    getConfig: () ->\n      return {\n          dashboard: () =>\n              steps = [\n                  {\n                      element: '.project-list > section:not(.ng-hide)',\n                      position: 'left',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.DASHBOARD.STEP1.TITLE'),\n                          text: @translate.instant('JOYRIDE.DASHBOARD.STEP1.TEXT')\n                      }\n                  },\n                  {\n                      element: '.working-on-container',\n                      position: 'right',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.DASHBOARD.STEP2.TITLE'),\n                          text: @translate.instant('JOYRIDE.DASHBOARD.STEP2.TEXT')\n                      }\n                  },\n                  {\n                      element: '.watching-container',\n                      position: 'right',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.DASHBOARD.STEP3.TITLE')\n                          text: [\n                              @translate.instant('JOYRIDE.DASHBOARD.STEP3.TEXT1'),\n                              @translate.instant('JOYRIDE.DASHBOARD.STEP3.TEXT2')\n                          ]\n                      }\n                  }\n              ]\n\n              if !$('.project-list .create-project-button').is(':hidden')\n                  steps.push({\n                      element: '.project-list .create-project-button',\n                      position: 'bottom',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.DASHBOARD.STEP4.TITLE')\n                          text: [\n                              @translate.instant('JOYRIDE.DASHBOARD.STEP4.TEXT1'),\n                              @translate.instant('JOYRIDE.DASHBOARD.STEP4.TEXT2')\n                          ]\n                      }\n                  })\n\n              return steps\n\n          backlog: () =>\n              steps = [\n                  {\n                      element: '.summary',\n                      position: 'bottom',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.BACKLOG.STEP1.TITLE')\n                          text: [\n                              @translate.instant('JOYRIDE.BACKLOG.STEP1.TEXT1'),\n                              @translate.instant('JOYRIDE.BACKLOG.STEP1.TEXT2')\n                          ]\n                      }\n                  },\n                  {\n                      element: '.backlog-table-empty',\n                      position: 'bottom',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.BACKLOG.STEP2.TITLE')\n                          text: @translate.instant('JOYRIDE.BACKLOG.STEP2.TEXT')\n                      }\n                  },\n                  {\n                      element: '.sprints',\n                      position: 'left',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.BACKLOG.STEP3.TITLE')\n                          text: @translate.instant('JOYRIDE.BACKLOG.STEP3.TEXT')\n                      }\n                  }\n              ]\n\n              if @checkPermissionsService.check('add_us')\n                  steps.push({\n                      element: '.new-us',\n                      position: 'rigth',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.BACKLOG.STEP4.TITLE')\n                          text: @translate.instant('JOYRIDE.BACKLOG.STEP4.TEXT')\n                      }\n                  })\n\n              return steps\n\n           kanban: () =>\n              steps = [\n                  {\n                      element: '.kanban-table-inner',\n                      position: 'bottom',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.KANBAN.STEP1.TITLE')\n                          text: @translate.instant('JOYRIDE.KANBAN.STEP1.TEXT')\n                      }\n                  },\n                  {\n                      element: '.card-placeholder',\n                      position: 'right',\n                      joyride: {\n                          title: @translate.instant('JOYRIDE.KANBAN.STEP2.TITLE')\n                          text: @translate.instant('JOYRIDE.KANBAN.STEP2.TEXT')\n                      }\n                  }\n              ]\n\n              if @checkPermissionsService.check('add_us')\n                  steps.push({\n                        element: '.icon-plus',\n                        position: 'bottom',\n                        joyride: {\n                            title: @translate.instant('JOYRIDE.KANBAN.STEP3.TITLE')\n                            text: [\n                                @translate.instant('JOYRIDE.KANBAN.STEP3.TEXT1'),\n                                @translate.instant('JOYRIDE.KANBAN.STEP3.TEXT2'),\n                            ]\n                        }\n                    })\n\n              return steps\n      }\n\n    get: (name) ->\n        joyRides = @.getConfig()\n        joyRide = joyRides[name].call(this)\n\n        return _.map joyRide, (item) ->\n            html = \"\"\n\n            if item.joyride.title\n                html += \"<h3>#{item.joyride.title}</h3>\"\n\n            if _.isArray(item.joyride.text)\n                _.forEach item.joyride.text, (text) ->\n                    html += \"<p>#{text}</p>\"\n            else\n                html += \"<p>#{item.joyride.text}</p>\"\n\n            item.intro = html\n\n            return item\n\nangular.module(\"taigaComponents\").service(\"tgJoyRideService\", JoyRideService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: project-menu.controller.coffee\n###\n\nclass ProjectMenuController\n    @.$inject = [\n        \"tgProjectService\",\n        \"tgLightboxFactory\"\n    ]\n\n    constructor: (@projectService, @lightboxFactory) ->\n        @.project = null\n        @.menu = Immutable.Map()\n\n    show: () ->\n        @.project = @projectService.project\n\n        @.active = @._getActiveSection()\n\n        @._setVideoConference()\n        @._setMenuPermissions()\n\n    hide: () ->\n        @.project = null\n        @.menu = {}\n\n    search: () ->\n        @lightboxFactory.create(\"tg-search-box\", {\n            \"class\": \"lightbox lightbox-search\"\n        })\n\n    _setVideoConference: () ->\n        videoconferenceUrl = @._videoConferenceUrl()\n\n        if videoconferenceUrl\n            @.project = @.project.set(\"videoconferenceUrl\", videoconferenceUrl)\n\n    _setMenuPermissions: () ->\n        @.menu = Immutable.Map({\n            backlog: false,\n            kanban: false,\n            issues: false,\n            wiki: false\n        })\n\n        if @.project.get(\"is_backlog_activated\") && @.project.get(\"my_permissions\").indexOf(\"view_us\") != -1\n            @.menu = @.menu.set(\"backlog\", true)\n\n        if @.project.get(\"is_kanban_activated\") && @.project.get(\"my_permissions\").indexOf(\"view_us\") != -1\n            @.menu = @.menu.set(\"kanban\", true)\n\n        if @.project.get(\"is_issues_activated\") && @.project.get(\"my_permissions\").indexOf(\"view_issues\") != -1\n            @.menu = @.menu.set(\"issues\", true)\n\n        if @.project.get(\"is_wiki_activated\") && @.project.get(\"my_permissions\").indexOf(\"view_wiki_pages\") != -1\n            @.menu = @.menu.set(\"wiki\", true)\n\n    _getActiveSection: () ->\n        sectionName = @projectService.section\n        sectionsBreadcrumb = @projectService.sectionsBreadcrumb\n\n        indexBacklog = sectionsBreadcrumb.lastIndexOf(\"backlog\")\n        indexKanban = sectionsBreadcrumb.lastIndexOf(\"kanban\")\n\n        if indexBacklog != -1 || indexKanban != -1\n            if indexKanban == -1 || indexBacklog < indexKanban\n                oldSectionName = \"backlog\"\n            else\n                oldSectionName = \"kanban\"\n\n        if  sectionName  == \"backlog-kanban\"\n            if oldSectionName in [\"backlog\", \"kanban\"]\n                sectionName = oldSectionName\n            else if @.project.get(\"is_backlog_activated\") && !@.project.get(\"is_kanban_activated\")\n                sectionName = \"backlog\"\n            else if !@.project.get(\"is_backlog_activated\") && @.project.get(\"is_kanban_activated\")\n                sectionName = \"kanban\"\n\n        return sectionName\n\n    _videoConferenceUrl: () ->\n        if @.project.get(\"videoconferences\") == \"appear-in\"\n            baseUrl = \"https://appear.in/\"\n        else if @.project.get(\"videoconferences\") == \"talky\"\n            baseUrl = \"https://talky.io/\"\n        else if @.project.get(\"videoconferences\") == \"jitsi\"\n            baseUrl = \"https://meet.jit.si/\"\n            url = @.project.get(\"slug\") + \"-\" + taiga.slugify(@.project.get(\"videoconferences_extra_data\"))\n            url = url.replace(/-/g, \"\")\n            return baseUrl + url\n        else if @.project.get(\"videoconferences\") == \"custom\"\n            return @.project.get(\"videoconferences_extra_data\")\n        else\n            return \"\"\n\n        if @.project.get(\"videoconferences_extra_data\")\n            url = @.project.get(\"slug\") + \"-\" + @.project.get(\"videoconferences_extra_data\")\n        else\n            url = @.project.get(\"slug\")\n\n        return baseUrl + url\n\nangular.module(\"taigaComponents\").controller(\"ProjectMenu\", ProjectMenuController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: project-menu.directive.coffee\n###\n\ntaiga = @.taiga\n\nProjectMenuDirective = (projectService, lightboxFactory) ->\n    link = (scope, el, attrs, ctrl) ->\n        projectChange = () ->\n            if projectService.project\n                ctrl.show()\n            else\n                ctrl.hide()\n\n        scope.$watch ( () ->\n            return projectService.project\n        ), projectChange\n\n    return {\n        scope: {},\n        controller: \"ProjectMenu\",\n        controllerAs: \"vm\",\n        templateUrl: \"components/project-menu/project-menu.html\",\n        link: link\n    }\n\nProjectMenuDirective.$inject = [\n    \"tgProjectService\",\n    \"tgLightboxFactory\"\n]\n\nangular.module(\"taigaComponents\").directive(\"tgProjectMenu\", ProjectMenuDirective)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/components/terms-of-service-and-privacy-policy-notice/terms-of-service-and-privacy-policy-notice.directive.coffee\n###\n\n\nTermsOfServiceAndPrivacyPolicyNoticeDirective = ($config) ->\n    link = (scope, el, attrs) ->\n        scope.privacyPolicyUrl = $config.get(\"privacyPolicyUrl\")\n        scope.termsOfServiceUrl = $config.get(\"termsOfServiceUrl\")\n\n    return {\n        restrict: \"AE\",\n        scope: {},\n        link: link,\n        templateUrl: \"components/terms-of-service-and-privacy-policy-notice/terms-of-service-and-privacy-policy-notice.html\"\n    }\n\nangular.module(\"taigaComponents\")\n    .directive(\"tgTermsOfServiceAndPrivacyPolicyNotice\", [\n        \"$tgConfig\",\n        TermsOfServiceAndPrivacyPolicyNoticeDirective\n    ])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: vote-button.controller.coffee\n###\n\nclass VoteButtonController\n    @.$inject = [\n        \"tgCurrentUserService\",\n    ]\n\n    constructor: (@currentUserService) ->\n        @.user = @currentUserService.getUser()\n        @.isMouseOver = false\n        @.loading = false\n\n    showTextWhenMouseIsOver: ->\n        @.isMouseOver = true\n\n    showTextWhenMouseIsLeave: ->\n        @.isMouseOver = false\n\n    toggleVote: ->\n        @.loading = true\n\n        if not @.item.is_voter\n            promise = @._upvote()\n        else\n            promise = @._downvote()\n\n        promise.finally () => @.loading = false\n\n        return promise\n\n    _upvote: ->\n        @.onUpvote().then =>\n            @.showTextWhenMouseIsLeave()\n\n    _downvote: ->\n        @.onDownvote()\n\nangular.module(\"taigaComponents\").controller(\"VoteButton\", VoteButtonController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: vote-button.directive.coffee\n###\n\nVoteButtonDirective = ->\n    return {\n        scope: {}\n        controller: \"VoteButton\",\n        bindToController: {\n            item: \"=\",\n            onUpvote: \"=\",\n            onDownvote: \"=\"\n        }\n        controllerAs: \"vm\",\n        templateUrl: \"components/vote-button/vote-button.html\",\n    }\n\nangular.module(\"taigaComponents\").directive(\"tgVoteButton\", VoteButtonDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: watch-button.controller.coffee\n###\n\nclass WatchButtonController\n    @.$inject = [\n        \"tgCurrentUserService\",\n    ]\n\n    constructor: (@currentUserService) ->\n        @.user = @currentUserService.getUser()\n        @.isMouseOver = false\n        @.loading = false\n\n    showTextWhenMouseIsOver: ->\n        @.isMouseOver = true\n\n    showTextWhenMouseIsLeave: ->\n        @.isMouseOver = false\n\n    toggleWatch: ->\n        @.loading = true\n\n        if not @.item.is_watcher\n            promise = @._watch()\n        else\n            promise = @._unwatch()\n\n        promise.finally () => @.loading = false\n\n        return promise\n\n    _watch: ->\n        @.onWatch().then =>\n            @.showTextWhenMouseIsLeave()\n\n    _unwatch: ->\n        @.onUnwatch()\n\nangular.module(\"taigaComponents\").controller(\"WatchButton\", WatchButtonController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: watch-button.directive.coffee\n###\n\nWatchButtonDirective = ->\n    return {\n        scope: {}\n        controller: \"WatchButton\",\n        bindToController: {\n            item: \"=\",\n            onWatch: \"=\",\n            onUnwatch: \"=\"\n        }\n        controllerAs: \"vm\",\n        templateUrl: \"components/watch-button/watch-button.html\",\n    }\n\nangular.module(\"taigaComponents\").directive(\"tgWatchButton\", WatchButtonDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: external-app.controller.coffee\n###\n\ntaiga = @.taiga\n\nclass ExternalAppController extends taiga.Controller\n    @.$inject = [\n        \"$routeParams\",\n        \"tgExternalAppsService\",\n        \"$window\",\n        \"tgCurrentUserService\",\n        \"$location\",\n        \"$tgNavUrls\",\n        \"tgXhrErrorService\",\n        \"tgLoader\"\n    ]\n\n    constructor: (@routeParams, @externalAppsService, @window, @currentUserService, @location,\n    @navUrls, @xhrError, @loader) ->\n        @loader.start(false)\n        @._applicationId = @routeParams.application\n        @._state = @routeParams.state\n        @._getApplicationToken()\n        @._user = @currentUserService.getUser()\n        @._application = null\n        nextUrl = encodeURIComponent(@location.url())\n        loginUrl = @navUrls.resolve(\"login\")\n        @.loginWithAnotherUserUrl = \"#{loginUrl}?next=#{nextUrl}\"\n\n        taiga.defineImmutableProperty @, \"user\", () => @._user\n        taiga.defineImmutableProperty @, \"application\", () => @._application\n\n    _redirect: (applicationToken) =>\n        nextUrl = applicationToken.get(\"next_url\")\n        @window.open(nextUrl, \"_self\")\n\n    _getApplicationToken: =>\n        return @externalAppsService.getApplicationToken(@._applicationId, @._state)\n            .then (data) =>\n                @._application = data.get(\"application\")\n                if data.get(\"auth_code\")\n                    @._redirect(data)\n                else\n                    @loader.pageLoaded()\n\n            .catch (xhr) =>\n                @loader.pageLoaded()\n                return @xhrError.response(xhr)\n\n    cancel: () ->\n        @window.history.back()\n\n    createApplicationToken:  =>\n        return @externalAppsService.authorizeApplicationToken(@._applicationId, @._state)\n            .then (data) =>\n                @._redirect(data)\n            .catch (xhr) =>\n                return @xhrError.response(xhr)\n\n\nangular.module(\"taigaExternalApps\").controller(\"ExternalApp\", ExternalAppController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: external-app.service.coffee\n###\n\nclass ExternalAppsService extends taiga.Service\n    @.$inject = [\n        \"tgResources\"\n    ]\n\n    constructor: (@rs) ->\n\n    getApplicationToken: (applicationId, state) ->\n        return @rs.externalapps.getApplicationToken(applicationId, state)\n\n    authorizeApplicationToken: (applicationId, state) ->\n        return @rs.externalapps.authorizeApplicationToken(applicationId, state)\n\nangular.module(\"taigaExternalApps\").service(\"tgExternalAppsService\", ExternalAppsService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: feedback.service.coffee\n###\n\nclass FeedbackService extends taiga.Service\n    @.$inject = [\"tgLightboxFactory\"]\n\n    constructor: (@lightboxFactory) ->\n\n    sendFeedback: ->\n        @lightboxFactory.create(\"tg-lb-feedback\", {\n            \"class\": \"lightbox lightbox-feedback lightbox-generic-form\"\n        })\n\nangular.module(\"taigaFeedback\").service(\"tgFeedbackService\", FeedbackService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: duty.directive.coffee\n###\n\nDutyDirective = (navurls, $translate) ->\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {}\n        scope.vm.duty = scope.duty\n\n        scope.vm.getDutyType = () ->\n            if scope.vm.duty\n                if scope.vm.duty.get('_name') == \"userstories\"\n                    return $translate.instant(\"COMMON.USER_STORY\")\n                if scope.vm.duty.get('_name') == \"tasks\"\n                    return $translate.instant(\"COMMON.TASK\")\n                if scope.vm.duty.get('_name') == \"issues\"\n                    return $translate.instant(\"COMMON.ISSUE\")\n\n    return {\n        templateUrl: \"home/duties/duty.html\"\n        scope: {\n            \"duty\": \"=tgDuty\"\n        }\n        link: link\n    }\n\nDutyDirective.$inject = [\n    \"$tgNavUrls\",\n    \"$translate\"\n]\n\nangular.module(\"taigaHome\").directive(\"tgDuty\", DutyDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: home.service.coffee\n###\n\ngroupBy = @.taiga.groupBy\n\nclass HomeService extends taiga.Service\n    @.$inject = [\n        \"$tgNavUrls\",\n        \"tgResources\",\n        \"tgProjectsService\"\n    ]\n\n    constructor: (@navurls, @rs, @projectsService) ->\n\n    _attachProjectInfoToWorkInProgress: (workInProgress, projectsById) ->\n        _attachProjectInfoToDuty = (duty, objType) =>\n            project = projectsById.get(String(duty.get('project')))\n\n            ctx = {\n                project: project.get('slug')\n                ref: duty.get('ref')\n            }\n\n            url = @navurls.resolve(\"project-#{objType}-detail\", ctx)\n\n            duty = duty.set('url', url)\n            duty = duty.set('projectName', project.get('name'))\n            duty = duty.set(\"_name\", objType)\n\n            return duty\n\n        assignedTo = workInProgress.get(\"assignedTo\")\n\n        if assignedTo.get(\"userStories\")\n            _duties = assignedTo.get(\"userStories\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"userstories\")\n\n            assignedTo = assignedTo.set(\"userStories\", _duties)\n\n        if assignedTo.get(\"tasks\")\n            _duties = assignedTo.get(\"tasks\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"tasks\")\n\n            assignedTo = assignedTo.set(\"tasks\", _duties)\n\n        if assignedTo.get(\"issues\")\n            _duties = assignedTo.get(\"issues\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"issues\")\n\n            assignedTo = assignedTo.set(\"issues\", _duties)\n\n        watching = workInProgress.get(\"watching\")\n\n        if watching.get(\"userStories\")\n            _duties = watching.get(\"userStories\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"userstories\")\n\n            watching = watching.set(\"userStories\", _duties)\n\n        if watching.get(\"tasks\")\n            _duties = watching.get(\"tasks\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"tasks\")\n\n            watching = watching.set(\"tasks\", _duties)\n\n        if watching.get(\"issues\")\n            _duties = watching.get(\"issues\").map (duty) ->\n                return _attachProjectInfoToDuty(duty, \"issues\")\n\n            watching = watching.set(\"issues\", _duties)\n\n\n        workInProgress = workInProgress.set(\"assignedTo\", assignedTo)\n        workInProgress = workInProgress.set(\"watching\", watching)\n\n\n    getWorkInProgress: (userId) ->\n        projectsById = Immutable.Map()\n\n        projectsPromise = @projectsService.getProjectsByUserId(userId).then (projects) ->\n            projectsById = Immutable.fromJS(groupBy(projects.toJS(), (p) -> p.id))\n\n        assignedTo = Immutable.Map()\n\n        params = {\n            status__is_closed: false\n            assigned_to: userId\n        }\n\n        params_us = {\n            is_closed: false\n            assigned_to: userId\n        }\n\n        assignedUserStoriesPromise = @rs.userstories.listInAllProjects(params_us).then (userstories) ->\n            assignedTo = assignedTo.set(\"userStories\", userstories)\n\n        assignedTasksPromise = @rs.tasks.listInAllProjects(params).then (tasks) ->\n            assignedTo = assignedTo.set(\"tasks\", tasks)\n\n        assignedIssuesPromise = @rs.issues.listInAllProjects(params).then (issues) ->\n            assignedTo = assignedTo.set(\"issues\", issues)\n\n        params = {\n            status__is_closed: false\n            watchers: userId\n        }\n\n        params_us = {\n            is_closed: false\n            watchers: userId\n        }\n\n        watching = Immutable.Map()\n\n        watchingUserStoriesPromise = @rs.userstories.listInAllProjects(params_us).then (userstories) ->\n            watching = watching.set(\"userStories\", userstories)\n\n        watchingTasksPromise = @rs.tasks.listInAllProjects(params).then (tasks) ->\n            watching = watching.set(\"tasks\", tasks)\n\n        watchingIssuesPromise = @rs.issues.listInAllProjects(params).then (issues) ->\n            watching = watching.set(\"issues\", issues)\n\n        workInProgress = Immutable.Map()\n\n        Promise.all([\n            projectsPromise\n            assignedUserStoriesPromise,\n            assignedTasksPromise,\n            assignedIssuesPromise,\n            watchingUserStoriesPromise,\n            watchingTasksPromise,\n            watchingIssuesPromise\n        ]).then =>\n            workInProgress = workInProgress.set(\"assignedTo\", assignedTo)\n            workInProgress = workInProgress.set(\"watching\", watching)\n\n            workInProgress = @._attachProjectInfoToWorkInProgress(workInProgress, projectsById)\n\n            return workInProgress\n\nangular.module(\"taigaHome\").service(\"tgHomeService\", HomeService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: home-project-list.directive.coffee\n###\n\nHomeProjectListDirective = (currentUserService, projectsService) ->\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {}\n\n        taiga.defineImmutableProperty(scope.vm, \"projects\", () -> currentUserService.projects.get(\"recents\"))\n\n        scope.vm.newProject = ->\n            projectsService.newProject()\n\n    directive = {\n        templateUrl: \"home/projects/home-project-list.html\"\n        scope: {}\n        link: link\n    }\n\n    return directive\n\nHomeProjectListDirective.$inject = [\n    \"tgCurrentUserService\",\n    \"tgProjectsService\"\n]\n\nangular.module(\"taigaHome\").directive(\"tgHomeProjectList\", HomeProjectListDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: working-on.controller.coffee\n###\n\nclass WorkingOnController\n    @.$inject = [\n        \"tgHomeService\"\n    ]\n\n    constructor: (@homeService) ->\n        @.assignedTo = Immutable.Map()\n        @.watching = Immutable.Map()\n\n    _setAssignedTo: (workInProgress) ->\n        userStories = workInProgress.get(\"assignedTo\").get(\"userStories\")\n        tasks = workInProgress.get(\"assignedTo\").get(\"tasks\")\n        issues = workInProgress.get(\"assignedTo\").get(\"issues\")\n\n        @.assignedTo = userStories.concat(tasks).concat(issues)\n        if @.assignedTo.size > 0\n            @.assignedTo = @.assignedTo.sortBy((elem) -> elem.get(\"modified_date\")).reverse()\n\n    _setWatching: (workInProgress) ->\n        userStories = workInProgress.get(\"watching\").get(\"userStories\")\n        tasks = workInProgress.get(\"watching\").get(\"tasks\")\n        issues = workInProgress.get(\"watching\").get(\"issues\")\n\n        @.watching = userStories.concat(tasks).concat(issues)\n        if @.watching.size > 0\n            @.watching = @.watching.sortBy((elem) -> elem.get(\"modified_date\")).reverse()\n\n    getWorkInProgress: (userId) ->\n        return @homeService.getWorkInProgress(userId).then (workInProgress) =>\n            @._setAssignedTo(workInProgress)\n            @._setWatching(workInProgress)\n\nangular.module(\"taigaHome\").controller(\"WorkingOn\", WorkingOnController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: working-on.directive.coffee\n###\n\nWorkingOnDirective = (homeService, currentUserService) ->\n    link = (scope, el, attrs, ctrl) ->\n        user = currentUserService.getUser()\n        # If we are not logged in the user will be null\n        if user\n          userId = user.get(\"id\")\n          ctrl.getWorkInProgress(userId)\n\n    return {\n        controller: \"WorkingOn\",\n        controllerAs: \"vm\",\n        templateUrl: \"home/working-on/working-on.html\",\n        scope: {},\n        link: link\n    }\n\nWorkingOnDirective.$inject = [\n    \"tgHomeService\",\n    \"tgCurrentUserService\"\n]\n\nangular.module(\"taigaHome\").directive(\"tgWorkingOn\", WorkingOnDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: dropdown-project-list.directive.coffee\n###\n\nDropdownProjectListDirective = (currentUserService, projectsService) ->\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {}\n\n        taiga.defineImmutableProperty(scope.vm, \"projects\", () -> currentUserService.projects.get(\"recents\"))\n\n        scope.vm.newProject = ->\n            projectsService.newProject()\n\n    directive = {\n        templateUrl: \"navigation-bar/dropdown-project-list/dropdown-project-list.html\"\n        scope: {}\n        link: link\n    }\n\n    return directive\n\nDropdownProjectListDirective.$inject = [\n    \"tgCurrentUserService\",\n    \"tgProjectsService\"\n]\n\nangular.module(\"taigaNavigationBar\").directive(\"tgDropdownProjectList\", DropdownProjectListDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: dropdown-user.directive.coffee\n###\n\nDropdownUserDirective = (authService, configService, locationService,\n        navUrlsService, feedbackService) ->\n\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {}\n        scope.vm.isFeedbackEnabled = configService.get(\"feedbackEnabled\")\n        taiga.defineImmutableProperty(scope.vm, \"user\", () -> authService.userData)\n\n        scope.vm.logout = ->\n            authService.logout()\n            locationService.path(navUrlsService.resolve(\"login\"))\n\n        scope.vm.sendFeedback = ->\n            feedbackService.sendFeedback()\n\n    directive = {\n        templateUrl: \"navigation-bar/dropdown-user/dropdown-user.html\"\n        scope: {}\n        link: link\n    }\n\n    return directive\n\nDropdownUserDirective.$inject = [\n    \"$tgAuth\",\n    \"$tgConfig\",\n    \"$tgLocation\",\n    \"$tgNavUrls\",\n    \"tgFeedbackService\"\n]\n\nangular.module(\"taigaNavigationBar\").directive(\"tgDropdownUser\", DropdownUserDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: navigation-bar.directive.coffee\n###\n\nNavigationBarDirective = (currentUserService, navigationBarService, $location) ->\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {}\n\n        scope.$on \"$routeChangeSuccess\", () ->\n            if $location.path() == \"/\"\n                scope.vm.active = true\n            else\n                scope.vm.active = false\n\n        taiga.defineImmutableProperty(scope.vm, \"projects\", () -> currentUserService.projects.get(\"recents\"))\n        taiga.defineImmutableProperty(scope.vm, \"isAuthenticated\", () -> currentUserService.isAuthenticated())\n        taiga.defineImmutableProperty(scope.vm, \"isEnabledHeader\", () -> navigationBarService.isEnabledHeader())\n\n\n    directive = {\n        templateUrl: \"navigation-bar/navigation-bar.html\"\n        scope: {}\n        link: link\n    }\n\n    return directive\n\nNavigationBarDirective.$inject = [\n    \"tgCurrentUserService\",\n    \"tgNavigationBarService\"\n    \"$location\"\n]\n\nangular.module(\"taigaNavigationBar\").directive(\"tgNavigationBar\", NavigationBarDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: navigation-bar.service.coffee\n###\n\nclass NavigationBarService extends taiga.Service\n\n    constructor: ->\n        @.disableHeader()\n\n    enableHeader: ->\n        @.enabledHeader = true\n\n    disableHeader:  ->\n        @.enabledHeader = false\n\n    isEnabledHeader: ->\n        return @.enabledHeader\n\nangular.module(\"taigaNavigationBar\").service(\"tgNavigationBarService\", NavigationBarService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-bar.controller.coffee\n###\n\nclass ProfileBarController\n    @.$inject = [\n        \"tgUserService\"\n    ]\n\n    constructor: (@userService) ->\n        @.loadStats()\n\n    loadStats: () ->\n        return @userService.getStats(@.user.get(\"id\")).then (stats) =>\n            @.stats = stats\n\nangular.module(\"taigaProfile\").controller(\"ProfileBar\", ProfileBarController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-bar.directive.coffee\n###\n\nProfileBarDirective = () ->\n    return {\n        templateUrl: \"profile/profile-bar/profile-bar.html\",\n        controller: \"ProfileBar\",\n        controllerAs: \"vm\",\n        scope: {\n            user: \"=user\",\n            isCurrentUser: \"=iscurrentuser\"\n        },\n        bindToController: true\n    }\n\n\nangular.module(\"taigaProfile\").directive(\"tgProfileBar\", ProfileBarDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-contacts.controller.coffee\n###\n\nclass ProfileContactsController\n    @.$inject = [\n        \"tgUserService\",\n        \"tgCurrentUserService\"\n    ]\n\n    constructor: (@userService, @currentUserService) ->\n        @.currentUser = @currentUserService.getUser()\n\n        @.isCurrentUser = false\n\n        if @.currentUser && @.currentUser.get(\"id\") == @.user.get(\"id\")\n            @.isCurrentUser = true\n\n    loadContacts: () ->\n        @userService.getContacts(@.user.get(\"id\"))\n            .then (contacts) =>\n                @.contacts = contacts\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileContacts\", ProfileContactsController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-contacts.directive.coffee\n###\n\nProfileContactsDirective = () ->\n    link = (scope, elm, attrs, ctrl) ->\n        ctrl.loadContacts()\n\n    return {\n        templateUrl: \"profile/profile-contacts/profile-contacts.html\",\n        scope: {\n            user: \"=\"\n        },\n        controllerAs: \"vm\",\n        controller: \"ProfileContacts\",\n        link: link,\n        bindToController: true\n    }\n\nangular.module(\"taigaProfile\").directive(\"tgProfileContacts\", ProfileContactsDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: items.directive.coffee\n###\n\nFavItemDirective = ->\n    link = (scope, el, attrs, ctrl) ->\n        scope.vm = {item: scope.item}\n\n    templateUrl = (el, attrs) ->\n        if attrs.itemType == \"project\"\n            return \"profile/profile-favs/items/project.html\"\n        else # if attr.itemType in [\"userstory\", \"task\", \"issue\"]\n            return \"profile/profile-favs/items/ticket.html\"\n\n    return {\n        scope: {\n            \"item\": \"=tgFavItem\"\n        }\n        link: link\n        templateUrl: templateUrl\n    }\n\n\nangular.module(\"taigaProfile\").directive(\"tgFavItem\", FavItemDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-favs.controller.coffee\n###\n\ndebounceLeading = @.taiga.debounceLeading\n\nclass FavsBaseController\n    constructor: ->\n        @._init()\n\n        #@._getItems = null # Define in inheritance classes\n        #\n    _init: ->\n        @.enableFilterByAll = true\n        @.enableFilterByProjects = true\n        @.enableFilterByUserStories = true\n        @.enableFilterByTasks = true\n        @.enableFilterByIssues = true\n        @.enableFilterByTextQuery = true\n\n        @._resetList()\n        @.q = null\n        @.type = null\n\n    _resetList: ->\n        @.items = Immutable.List()\n        @.scrollDisabled = false\n        @._page = 1\n\n    _enableLoadingSpinner: ->\n        @.isLoading = true\n\n    _disableLoadingSpinner: ->\n        @.isLoading = false\n\n    _enableScroll : ->\n        @.scrollDisabled = false\n\n    _disableScroll : ->\n        @.scrollDisabled = true\n\n    _checkIfHasMorePages: (hasNext) ->\n        if hasNext\n            @._page += 1\n            @._enableScroll()\n        else\n            @._disableScroll()\n\n    _checkIfHasNoResults: ->\n        @.hasNoResults = @.items.size == 0\n\n    loadItems:  ->\n        @._enableLoadingSpinner()\n        @._disableScroll()\n\n        @._getItems(@.user.get(\"id\"), @._page, @.type, @.q)\n            .then (response) =>\n                @.items = @.items.concat(response.get(\"data\"))\n\n                @._checkIfHasMorePages(response.get(\"next\"))\n                @._checkIfHasNoResults()\n                @._disableLoadingSpinner()\n\n                return @.items\n            .catch =>\n                @._disableLoadingSpinner()\n\n                return @.items\n\n    ################################################\n    ## Filtre actions\n    ################################################\n    filterByTextQuery: debounceLeading 500, ->\n        @._resetList()\n        @.loadItems()\n\n    showAll: ->\n        if @.type isnt null\n            @.type = null\n            @._resetList()\n            @.loadItems()\n\n    showProjectsOnly: ->\n        if @.type isnt \"project\"\n            @.type = \"project\"\n            @._resetList()\n            @.loadItems()\n\n    showUserStoriesOnly: ->\n        if @.type isnt \"userstory\"\n            @.type = \"userstory\"\n            @._resetList()\n            @.loadItems()\n\n    showTasksOnly: ->\n        if @.type isnt \"task\"\n            @.type = \"task\"\n            @._resetList()\n            @.loadItems()\n\n    showIssuesOnly: ->\n        if @.type isnt \"issue\"\n            @.type = \"issue\"\n            @._resetList()\n            @.loadItems()\n\n\n####################################################\n## Liked\n####################################################\n\nclass ProfileLikedController extends FavsBaseController\n    @.$inject = [\n        \"tgUserService\",\n    ]\n\n    constructor: (@userService) ->\n        super()\n        @.enableFilterByAll = false\n        @.enableFilterByProjects = false\n        @.enableFilterByUserStories = false\n        @.enableFilterByTasks = false\n        @.enableFilterByIssues = false\n        @.enableFilterByTextQuery = true\n        @._getItems = @userService.getLiked\n\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileLiked\", ProfileLikedController)\n\n####################################################\n## Voted\n####################################################\n\nclass ProfileVotedController extends FavsBaseController\n    @.$inject = [\n        \"tgUserService\",\n    ]\n\n    constructor: (@userService) ->\n        super()\n        @.enableFilterByAll = true\n        @.enableFilterByProjects = false\n        @.enableFilterByUserStories = true\n        @.enableFilterByTasks = true\n        @.enableFilterByIssues = true\n        @.enableFilterByTextQuery = true\n        @._getItems = @userService.getVoted\n\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileVoted\", ProfileVotedController)\n\n\n\n####################################################\n## Watched\n####################################################\n\nclass ProfileWatchedController extends FavsBaseController\n    @.$inject = [\n        \"tgUserService\",\n    ]\n\n    constructor: (@userService) ->\n        super()\n        @._getItems = @userService.getWatched\n\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileWatched\", ProfileWatchedController)\n\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-favs.directive.coffee\n###\n\nbase = {\n    scope: {},\n    bindToController: {\n        user: \"=\"\n        type: \"@\"\n        q: \"@\"\n        scrollDisabled: \"@\"\n        isLoading: \"@\"\n        hasNoResults: \"@\"\n    }\n    controller: null, # Define in directives\n    controllerAs: \"vm\",\n    templateUrl: \"profile/profile-favs/profile-favs.html\",\n}\n\n\n####################################################\n## Liked\n####################################################\n\nProfileLikedDirective = () ->\n    return _.extend({}, base, {\n        controller: \"ProfileLiked\"\n    })\n\nangular.module(\"taigaProfile\").directive(\"tgProfileLiked\", ProfileLikedDirective)\n\n\n####################################################\n## Voted\n####################################################\n\nProfileVotedDirective = () ->\n    return _.extend({}, base, {\n        controller: \"ProfileVoted\"\n    })\n\nangular.module(\"taigaProfile\").directive(\"tgProfileVoted\", ProfileVotedDirective)\n\n\n####################################################\n## Watched\n####################################################\n\nProfileWatchedDirective = () ->\n    return _.extend({}, base, {\n        controller: \"ProfileWatched\"\n    })\n\nangular.module(\"taigaProfile\").directive(\"tgProfileWatched\", ProfileWatchedDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-hints.controller.coffee\n###\n\nclass ProfileHints\n    HINTS: [\n        { #hint1\n            url: \"https://taiga.io/support/import-export-projects/\"\n        },\n        { #hint2\n            url: \"https://taiga.io/support/custom-fields/\"\n        },\n        { #hint3\n        },\n        { #hint4\n        }\n    ]\n    constructor: (@translate) ->\n        hintKey = Math.floor(Math.random() * @.HINTS.length) + 1\n\n        @.hint = @.HINTS[hintKey - 1]\n\n        @.hint.linkText = @.hint.linkText || 'HINTS.LINK'\n\n        @.hint.title = @translate.instant(\"HINTS.HINT#{hintKey}_TITLE\")\n\n        @.hint.text = @translate.instant(\"HINTS.HINT#{hintKey}_TEXT\")\n\nProfileHints.$inject = [\n    \"$translate\"\n]\n\nangular.module(\"taigaProfile\").controller(\"ProfileHints\", ProfileHints)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-hints.directive.coffee\n###\n\nProfileHints = ($translate) ->\n    return {\n        scope: {},\n        controller: \"ProfileHints\",\n        controllerAs: \"vm\",\n        templateUrl: \"profile/profile-hints/profile-hints.html\"\n    }\n\nProfileHints.$inject = [\n    \"$translate\"\n]\n\nangular.module(\"taigaProfile\").directive(\"tgProfileHints\", ProfileHints)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-projects.controller.coffee\n###\n\nclass ProfileProjectsController\n    @.$inject = [\n        \"tgProjectsService\",\n        \"tgUserService\"\n    ]\n\n    constructor: (@projectsService, @userService) ->\n\n    loadProjects: () ->\n        @projectsService.getProjectsByUserId(@.user.get(\"id\"))\n            .then (projects) =>\n                return @userService.attachUserContactsToProjects(@.user.get(\"id\"), projects)\n            .then (projects) =>\n                @.projects = projects\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileProjects\", ProfileProjectsController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-projects.directive.coffee\n###\n\nProfileProjectsDirective = () ->\n    link = (scope, elm, attr, ctrl) ->\n        ctrl.loadProjects()\n\n    return {\n        templateUrl: \"profile/profile-projects/profile-projects.html\",\n        scope: {\n            user: \"=\"\n        },\n        link: link\n        bindToController: true,\n        controllerAs: \"vm\",\n        controller: \"ProfileProjects\"\n    }\n\nangular.module(\"taigaProfile\").directive(\"tgProfileProjects\", ProfileProjectsDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-tab.directive.coffee\n###\n\nProfileTabDirective = () ->\n    link = (scope, element, attrs, ctrl, transclude) ->\n        scope.tab = {}\n\n        attrs.$observe \"tgProfileTab\", (name) ->\n            scope.tab.name = name\n\n        attrs.$observe \"tabTitle\", (title) ->\n            scope.tab.title = title\n\n        scope.tab.icon = attrs.tabIcon\n        scope.tab.active = !!attrs.tabActive\n\n        if scope.$eval(attrs.tabDisabled) != true\n            ctrl.addTab(scope.tab)\n\n    return {\n        templateUrl: \"profile/profile-tab/profile-tab.html\",\n        scope: {},\n        require: \"^tgProfileTabs\",\n        link: link,\n        transclude: true\n    }\n\nangular.module(\"taigaProfile\")\n    .directive(\"tgProfileTab\", ProfileTabDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-tabs.controller.coffee\n###\n\nclass ProfileTabsController\n    constructor: () ->\n        @tabs = []\n\n    addTab: (tab) ->\n        @tabs.push(tab)\n\n    toggleTab: (tab) ->\n        _.map @tabs, (tab) -> tab.active = false\n\n        tab.active = true\n\nangular.module(\"taigaProfile\")\n    .controller(\"ProfileTabs\", ProfileTabsController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile-tabs.directive.coffee\n###\n\nProfileTabsDirective = () ->\n    return {\n        scope: {}\n        controller: \"ProfileTabs\"\n        controllerAs: \"vm\"\n        templateUrl: \"profile/profile-tabs/profile-tabs.html\"\n        transclude: true\n    }\n\nangular.module(\"taigaProfile\")\n    .directive(\"tgProfileTabs\", ProfileTabsDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: profile.controller.coffee\n###\n\nclass ProfileController\n    @.$inject = [\n        \"tgAppMetaService\",\n        \"tgCurrentUserService\",\n        \"$routeParams\",\n        \"tgUserService\",\n        \"tgXhrErrorService\",\n        \"$translate\"\n    ]\n\n    constructor: (@appMetaService, @currentUserService, @routeParams, @userService, @xhrError, @translate) ->\n        @.isCurrentUser = false\n\n        if @routeParams.slug\n            @userService\n                .getUserByUserName(@routeParams.slug)\n                .then (user) =>\n                    if !user.get('is_active')\n                        @xhrError.notFound()\n                    else\n                        @.user = user\n                        @.isCurrentUser = false\n                        @._setMeta(@.user)\n\n                        return user\n                .catch (xhr) =>\n                    return @xhrError.response(xhr)\n\n        else\n            @.user = @currentUserService.getUser()\n            @.isCurrentUser = true\n            @._setMeta(@.user)\n\n    _setMeta: (user) ->\n        ctx = {\n            userFullName: user.get(\"full_name_display\"),\n            userUsername: user.get(\"username\")\n        }\n\n        title = @translate.instant(\"USER.PROFILE.PAGE_TITLE\", ctx)\n\n        description = user.get(\"bio\")\n        @appMetaService.setAll(title, description)\n\nangular.module(\"taigaProfile\").controller(\"Profile\", ProfileController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: like-project-button.controller.coffee\n###\n\nclass LikeProjectButtonController\n    @.$inject = [\n        \"$tgConfirm\"\n        \"tgLikeProjectButtonService\"\n    ]\n\n    constructor: (@confirm, @likeButtonService)->\n        @.isMouseOver = false\n        @.loading = false\n\n    showTextWhenMouseIsOver: ->\n        @.isMouseOver = true\n\n    showTextWhenMouseIsLeave: ->\n        @.isMouseOver = false\n\n    toggleLike: ->\n        @.loading = true\n\n        if not @.project.get(\"is_fan\")\n            promise = @._like()\n        else\n            promise = @._unlike()\n\n        promise.finally () => @.loading = false\n\n        return promise\n\n    _like: ->\n        return @likeButtonService.like(@.project.get('id'))\n            .then =>\n                @.showTextWhenMouseIsLeave()\n            .catch =>\n                @confirm.notify(\"error\")\n\n    _unlike: ->\n        return @likeButtonService.unlike(@.project.get('id')).catch =>\n            @confirm.notify(\"error\")\n\nangular.module(\"taigaProjects\").controller(\"LikeProjectButton\", LikeProjectButtonController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: like-project-button.directive.coffee\n###\n\nLikeProjectButtonDirective = ->\n    return {\n        scope: {}\n        controller: \"LikeProjectButton\",\n        bindToController: {\n            project: '='\n        }\n        controllerAs: \"vm\",\n        templateUrl: \"projects/components/like-project-button/like-project-button.html\",\n    }\n\nangular.module(\"taigaProjects\").directive(\"tgLikeProjectButton\", LikeProjectButtonDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: like-project-button.service.coffee\n###\n\ntaiga = @.taiga\n\nclass LikeProjectButtonService extends taiga.Service\n    @.$inject = [\"tgResources\", \"tgCurrentUserService\", \"tgProjectService\"]\n\n    constructor: (@rs, @currentUserService, @projectService) ->\n\n    _getProjectIndex: (projectId) ->\n        return @currentUserService.projects\n                .get('all')\n                .findIndex (project) -> project.get('id') == projectId\n\n    _updateProjects: (projectId, isFan) ->\n        projectIndex = @._getProjectIndex(projectId)\n        projects = @currentUserService.projects\n            .get('all')\n            .update projectIndex, (project) ->\n\n                totalFans = project.get(\"total_fans\")\n\n                if isFan then totalFans++ else totalFans--\n\n                return project.merge({\n                    is_fan: isFan,\n                    total_fans: totalFans\n                })\n\n        @currentUserService.setProjects(projects)\n\n    _updateCurrentProject: (isFan) ->\n        totalFans = @projectService.project.get(\"total_fans\")\n\n        if isFan then totalFans++ else totalFans--\n\n        project = @projectService.project.merge({\n            is_fan: isFan,\n            total_fans: totalFans\n        })\n\n        @projectService.setProject(project)\n\n    like: (projectId) ->\n        return @rs.projects.likeProject(projectId).then =>\n            @._updateProjects(projectId, true)\n            @._updateCurrentProject(true)\n\n    unlike: (projectId) ->\n        return @rs.projects.unlikeProject(projectId).then =>\n            @._updateProjects(projectId, false)\n            @._updateCurrentProject(false)\n\nangular.module(\"taigaProjects\").service(\"tgLikeProjectButtonService\", LikeProjectButtonService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: sort-projects.directive.coffee\n###\n\nSortProjectsDirective = (currentUserService) ->\n    link = (scope, el, attrs, ctrl) ->\n        itemEl = null\n\n        el.sortable({\n            dropOnEmpty: true\n            revert: 200\n            axis: \"y\"\n            opacity: .95\n            placeholder: 'placeholder'\n            cancel: '.project-name'\n        })\n\n        el.on \"sortstop\", (event, ui) ->\n            itemEl = ui.item\n            project = itemEl.scope().project\n            index = itemEl.index()\n\n            sorted_project_ids = _.map(scope.projects.toJS(), (p) -> p.id)\n            sorted_project_ids = _.without(sorted_project_ids, project.get(\"id\"))\n            sorted_project_ids.splice(index, 0, project.get('id'))\n\n            sortData = []\n\n            for value, index in sorted_project_ids\n                sortData.push({\"project_id\": value, \"order\":index})\n\n            currentUserService.bulkUpdateProjectsOrder(sortData)\n\n    directive = {\n        scope: {\n            projects: \"=tgSortProjects\"\n        },\n        link: link\n    }\n\n    return directive\n\nangular.module(\"taigaProjects\").directive(\"tgSortProjects\", [\"tgCurrentUserService\", SortProjectsDirective])\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: watch-project-button.controller.coffee\n###\n\nclass WatchProjectButtonController\n    @.$inject = [\n        \"$tgConfirm\"\n        \"tgWatchProjectButtonService\"\n    ]\n\n    constructor: (@confirm, @watchButtonService)->\n        @.showWatchOptions = false\n        @.loading = false\n\n    toggleWatcherOptions: () ->\n        @.showWatchOptions = !@.showWatchOptions\n\n    closeWatcherOptions: () ->\n        @.showWatchOptions = false\n\n    watch: (notifyLevel) ->\n        @.loading = true\n        @.closeWatcherOptions()\n\n        return @watchButtonService.watch(@.project.get('id'), notifyLevel)\n            .catch () => @confirm.notify(\"error\")\n            .finally () => @.loading = false\n\n    unwatch: ->\n        @.loading = true\n        @.closeWatcherOptions()\n\n        return @watchButtonService.unwatch(@.project.get('id'))\n            .catch () => @confirm.notify(\"error\")\n            .finally () => @.loading = false\n\nangular.module(\"taigaProjects\").controller(\"WatchProjectButton\", WatchProjectButtonController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: watch-project-button.directive.coffee\n###\n\nWatchProjectButtonDirective = ->\n    return {\n        scope: {}\n        controller: \"WatchProjectButton\",\n        bindToController: {\n            project: \"=\"\n        }\n        controllerAs: \"vm\",\n        templateUrl: \"projects/components/watch-project-button/watch-project-button.html\",\n    }\n\nangular.module(\"taigaProjects\").directive(\"tgWatchProjectButton\", WatchProjectButtonDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: watch-project-button.service.coffee\n###\n\ntaiga = @.taiga\n\nclass WatchProjectButtonService extends taiga.Service\n    @.$inject = [\n        \"tgResources\",\n        \"tgCurrentUserService\",\n        \"tgProjectService\"\n    ]\n\n    constructor: (@rs, @currentUserService, @projectService) ->\n\n    _getProjectIndex: (projectId) ->\n        return @currentUserService.projects\n                .get('all')\n                .findIndex (project) -> project.get('id') == projectId\n\n\n    _updateProjects: (projectId, notifyLevel, isWatcher) ->\n        projectIndex = @._getProjectIndex(projectId)\n\n        projects = @currentUserService.projects\n            .get('all')\n            .update projectIndex, (project) =>\n                totalWatchers = project.get('total_watchers')\n\n                if isWatcher then totalWatchers++ else totalWatchers--\n\n                return project.merge({\n                    is_watcher: isWatcher,\n                    total_watchers: totalWatchers\n                    notify_level: notifyLevel\n                })\n\n        @currentUserService.setProjects(projects)\n\n    _updateCurrentProject: (notifyLevel, isWatcher) ->\n        totalWatchers = @projectService.project.get(\"total_watchers\")\n\n        if isWatcher then totalWatchers++ else totalWatchers--\n\n        project = @projectService.project.merge({\n            is_watcher: isWatcher,\n            total_watchers: totalWatchers\n            notify_level: notifyLevel\n        })\n\n        @projectService.setProject(project)\n\n    watch: (projectId, notifyLevel) ->\n        return @rs.projects.watchProject(projectId, notifyLevel).then =>\n            @._updateProjects(projectId, notifyLevel, true)\n            @._updateCurrentProject(notifyLevel, true)\n\n    unwatch: (projectId) ->\n        return @rs.projects.unwatchProject(projectId).then =>\n            @._updateProjects(projectId, null, false)\n            @._updateCurrentProject(null, false)\n\nangular.module(\"taigaProjects\").service(\"tgWatchProjectButtonService\", WatchProjectButtonService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: projects-listing.controller.coffee\n###\n\nclass ProjectsListingController\n    @.$inject = [\n        \"tgCurrentUserService\",\n        \"tgProjectsService\",\n    ]\n\n    constructor: (@currentUserService, @projectsService) ->\n        taiga.defineImmutableProperty(@, \"projects\", () => @currentUserService.projects.get(\"all\"))\n\n    newProject: ->\n        @projectsService.newProject()\n\nangular.module(\"taigaProjects\").controller(\"ProjectsListing\", ProjectsListingController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: project.controller.coffee\n###\n\nclass ProjectController\n    @.$inject = [\n        \"$routeParams\",\n        \"tgAppMetaService\",\n        \"$tgAuth\",\n        \"$translate\",\n        \"tgProjectService\"\n    ]\n\n    constructor: (@routeParams, @appMetaService, @auth, @translate, @projectService) ->\n        projectSlug = @routeParams.pslug\n        @.user = @auth.userData\n\n        taiga.defineImmutableProperty @, \"project\", () => return @projectService.project\n        taiga.defineImmutableProperty @, \"members\", () => return @projectService.activeMembers\n\n        @appMetaService.setfn @._setMeta.bind(this)\n\n    _setMeta: (project)->\n        metas = {}\n\n        return metas if !@.project\n\n        ctx = {projectName: @.project.get(\"name\")}\n\n        metas.title = @translate.instant(\"PROJECT.PAGE_TITLE\", ctx)\n        metas.description = @.project.get(\"description\")\n\n        return metas\n\nangular.module(\"taigaProjects\").controller(\"Project\", ProjectController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: projects.service.coffee\n###\n\ntaiga = @.taiga\ngroupBy = @.taiga.groupBy\n\nclass ProjectsService extends taiga.Service\n    @.$inject = [\"tgResources\", \"$projectUrl\", \"tgLightboxFactory\"]\n\n    constructor: (@rs, @projectUrl, @lightboxFactory) ->\n\n    getProjectBySlug: (projectSlug) ->\n        return @rs.projects.getProjectBySlug(projectSlug)\n            .then (project) =>\n                return @._decorate(project)\n\n    getProjectStats: (projectId) ->\n        return @rs.projects.getProjectStats(projectId)\n\n    getProjectsByUserId: (userId, paginate) ->\n        return @rs.projects.getProjectsByUserId(userId, paginate)\n            .then (projects) =>\n                return projects.map @._decorate.bind(@)\n\n    _decorate: (project) ->\n        url = @projectUrl.get(project.toJS())\n\n        project = project.set(\"url\", url)\n        colorized_tags = []\n\n        if project.get(\"tags\")\n            tags = project.get(\"tags\").sort()\n\n            colorized_tags = tags.map (tag) ->\n                color = project.get(\"tags_colors\").get(tag)\n                return Immutable.fromJS({name: tag, color: color})\n\n            project = project.set(\"colorized_tags\", colorized_tags)\n\n        return project\n\n    newProject: ->\n        @lightboxFactory.create(\"tg-lb-create-project\", {\n            \"class\": \"wizard-create-project\"\n        })\n\n    bulkUpdateProjectsOrder: (sortData) ->\n        return @rs.projects.bulkUpdateOrder(sortData)\n\nangular.module(\"taigaProjects\").service(\"tgProjectsService\", ProjectsService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: external-apps-resource.service.coffee\n###\n\nResource = (urlsService, http) ->\n    service = {}\n\n    service.getApplicationToken = (applicationId, state) ->\n        url = urlsService.resolve(\"applications\")\n        url = \"#{url}/#{applicationId}/token?state=#{state}\"\n        return http.get(url).then (result) ->\n            Immutable.fromJS(result.data)\n\n    service.authorizeApplicationToken = (applicationId, state) ->\n        url = urlsService.resolve(\"application-tokens\")\n        url = \"#{url}/authorize\"\n        data = {\n            \"state\": state\n            \"application\": applicationId\n        }\n\n        return http.post(url, data).then (result) ->\n            Immutable.fromJS(result.data)\n\n    return () ->\n        return {\"externalapps\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgExternalAppsResource\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: issues-resource.service.coffee\n###\n\nResource = (urlsService, http) ->\n    service = {}\n\n    service.listInAllProjects = (params) ->\n        url = urlsService.resolve(\"issues\")\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        return http.get(url, params, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    return () ->\n        return {\"issues\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgIssuesResource\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: projects-resource.service.coffee\n###\n\npagination = () ->\n\nResource = (urlsService, http, paginateResponseService) ->\n    service = {}\n\n    service.getProjectBySlug = (projectSlug) ->\n        url = urlsService.resolve(\"projects\")\n\n        url = \"#{url}/by_slug?slug=#{projectSlug}\"\n\n        return http.get(url)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.getProjectsByUserId = (userId, paginate=false) ->\n        url = urlsService.resolve(\"projects\")\n        httpOptions = {}\n\n        if !paginate\n            httpOptions.headers = {\n                \"x-disable-pagination\": \"1\"\n            }\n\n        params = {\"member\": userId, \"order_by\": \"memberships__user_order\"}\n\n        return http.get(url, params, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.getProjectStats = (projectId) ->\n        url = urlsService.resolve(\"projects\")\n        url = \"#{url}/#{projectId}\"\n\n        return http.get(url)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.bulkUpdateOrder = (bulkData) ->\n        url = urlsService.resolve(\"bulk-update-projects-order\")\n        return http.post(url, bulkData)\n\n    service.getTimeline = (projectId, page) ->\n        params = {\n            page: page\n        }\n\n        url = urlsService.resolve(\"timeline-project\")\n        url = \"#{url}/#{projectId}\"\n\n        return http.get(url, params).then (result) ->\n            result = Immutable.fromJS(result)\n            return paginateResponseService(result)\n\n    service.likeProject = (projectId) ->\n        url = urlsService.resolve(\"project-like\", projectId)\n        return http.post(url)\n\n    service.unlikeProject = (projectId) ->\n        url = urlsService.resolve(\"project-unlike\", projectId)\n        return http.post(url)\n\n    service.watchProject = (projectId, notifyPolicy) ->\n        data = {\n            notify_policy: notifyPolicy\n        }\n        url = urlsService.resolve(\"project-watch\", projectId)\n        return http.post(url, data)\n\n    service.unwatchProject = (projectId) ->\n        url = urlsService.resolve(\"project-unwatch\", projectId)\n        return http.post(url)\n\n    return () ->\n        return {\"projects\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\", \"tgPaginateResponseService\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgProjectsResources\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: resources.coffee\n###\n\nservices = [\n    \"tgProjectsResources\",\n    \"tgUserResources\",\n    \"tgUsersResources\",\n    \"tgUserstoriesResource\",\n    \"tgTasksResource\",\n    \"tgIssuesResource\",\n    \"tgExternalAppsResource\"\n]\n\nResources = ($injector) ->\n    for serviceName in services\n        serviceFn = $injector.get(serviceName)\n\n        service = $injector.invoke(serviceFn)\n\n        for serviceProperty in Object.keys(service)\n            if @[serviceProperty]\n                console.warm(\"repeated resource \" + serviceProperty)\n\n            @[serviceProperty] = service[serviceProperty]\n\n    return @\n\n\nResources.$inject = [\"$injector\"]\n\nangular.module(\"taigaResources2\").service(\"tgResources\", Resources)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: tasks-resource.service.coffee\n###\n\nResource = (urlsService, http) ->\n    service = {}\n\n    service.listInAllProjects = (params) ->\n        url = urlsService.resolve(\"tasks\")\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        return http.get(url, params, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    return () ->\n        return {\"tasks\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgTasksResource\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-resource.service.coffee\n###\n\nResource = (urlsService, http, paginateResponseService) ->\n    service = {}\n\n    service.getUserStorage = (key) ->\n        url = urlsService.resolve(\"user-storage\")\n\n        if key\n            url += '/' + key\n\n        httpOptions = {}\n\n        return http.get(url, {}).then (response) ->\n            return response.data.value\n\n    service.setUserStorage = (key, value) ->\n        url = urlsService.resolve(\"user-storage\") + '/' + key\n\n        params = {\n            key: key,\n            value: value\n        }\n\n        return http.put(url, params)\n\n    service.createUserStorage = (key, value) ->\n        url = urlsService.resolve(\"user-storage\")\n\n        params = {\n            key: key,\n            value: value\n        }\n\n        return http.post(url, params)\n\n    return () ->\n        return {\"user\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgUserResources\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: users-resource.service.coffee\n###\n\nResource = (urlsService, http, paginateResponseService) ->\n    service = {}\n\n    service.getUserByUsername = (username) ->\n        url = urlsService.resolve(\"by_username\")\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        params = {\n            username: username\n        }\n\n        return http.get(url, params, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.getStats = (userId) ->\n        url = urlsService.resolve(\"user-stats\", userId)\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        return http.get(url, {}, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.getContacts = (userId) ->\n        url = urlsService.resolve(\"user-contacts\", userId)\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        return http.get(url, {}, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    service.getLiked = (userId, page, type, q) ->\n        url = urlsService.resolve(\"user-liked\", userId)\n\n        params = {}\n        params.page = page if page?\n        params.type = type if type?\n        params.q = q if q?\n\n        return http.get(url, params)\n            .then (result) ->\n                result = Immutable.fromJS(result)\n                return paginateResponseService(result)\n\n    service.getVoted = (userId, page, type, q) ->\n        url = urlsService.resolve(\"user-voted\", userId)\n\n        params = {}\n        params.page = page if page?\n        params.type = type if type?\n        params.q = q if q?\n\n        return http.get(url, params)\n            .then (result) ->\n                result = Immutable.fromJS(result)\n                return paginateResponseService(result)\n\n    service.getWatched = (userId, page, type, q) ->\n        url = urlsService.resolve(\"user-watched\", userId)\n\n        params = {}\n        params.page = page if page?\n        params.type = type if type?\n        params.q = q if q?\n\n        return http.get(url, params)\n            .then (result) ->\n                result = Immutable.fromJS(result)\n                return paginateResponseService(result)\n\n    service.getProfileTimeline = (userId, page) ->\n        params = {\n            page: page\n        }\n\n        url = urlsService.resolve(\"timeline-profile\")\n        url = \"#{url}/#{userId}\"\n\n        return http.get(url, params).then (result) ->\n            result = Immutable.fromJS(result)\n            return paginateResponseService(result)\n\n    service.getUserTimeline = (userId, page) ->\n        params = {\n            page: page\n        }\n\n        url = urlsService.resolve(\"timeline-user\")\n        url = \"#{url}/#{userId}\"\n\n        return http.get(url, params).then (result) ->\n            result = Immutable.fromJS(result)\n            return paginateResponseService(result)\n\n    return () ->\n        return {\"users\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\", \"tgPaginateResponseService\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgUsersResources\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: userstories-resource.service.coffee\n###\n\nResource = (urlsService, http) ->\n    service = {}\n\n    service.listInAllProjects = (params) ->\n        url = urlsService.resolve(\"userstories\")\n\n        httpOptions = {\n            headers: {\n                \"x-disable-pagination\": \"1\"\n            }\n        }\n\n        return http.get(url, params, httpOptions)\n            .then (result) ->\n                return Immutable.fromJS(result.data)\n\n    return () ->\n        return {\"userstories\": service}\n\nResource.$inject = [\"$tgUrls\", \"$tgHttp\"]\n\nmodule = angular.module(\"taigaResources2\")\nmodule.factory(\"tgUserstoriesResource\", Resource)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: app-meta.service.coffee\n###\n\ntaiga = @.taiga\n\ntruncate = taiga.truncate\n\n\nclass AppMetaService\n    @.$inject = [\n        \"$rootScope\"\n    ]\n\n    constructor: (@rootScope) ->\n\n    _set: (key, value) ->\n        return if not key\n\n        if key == \"title\"\n            meta = $(\"title\")\n\n            if meta.length == 0\n                meta = $(\"<title></title>\")\n                $(\"head\").append(meta)\n\n            meta.text(value or \"\")\n        else if key.indexOf(\"og:\") == 0\n            meta = $(\"meta[property='#{key}']\")\n\n            if meta.length == 0\n                meta = $(\"<meta property='#{key}'/>\")\n                $(\"head\").append(meta)\n\n            meta.attr(\"content\", value or \"\")\n        else\n            meta = $(\"meta[name='#{key}']\")\n\n            if meta.length == 0\n                meta = $(\"<meta name='#{key}'/>\")\n                $(\"head\").append(meta)\n\n            meta.attr(\"content\", value or \"\")\n\n    setTitle: (title) ->\n        @._set('title', title)\n\n    setDescription: (description) ->\n        @._set(\"description\", truncate(description, 250))\n\n    setTwitterMetas: (title, description) ->\n        @._set(\"twitter:card\", \"summary\")\n        @._set(\"twitter:site\", \"@taigaio\")\n        @._set(\"twitter:title\", title)\n        @._set(\"twitter:description\", truncate(description, 300))\n        @._set(\"twitter:image\", \"#{window.location.origin}/images/logo-color.png\")\n\n    setOpenGraphMetas: (title, description) ->\n        @._set(\"og:type\", \"object\")\n        @._set(\"og:site_name\", \"Taiga - Love your projects\")\n        @._set(\"og:title\", title)\n        @._set(\"og:description\", truncate(description, 300))\n        @._set(\"og:image\", \"#{window.location.origin}/images/logo-color.png\")\n        @._set(\"og:url\", window.location.href)\n\n    setAll: (title, description) ->\n        @.setTitle(title)\n        @.setDescription(description)\n        @.setTwitterMetas(title, description)\n        @.setOpenGraphMetas(title, description)\n\n    addMobileViewport: () ->\n        $(\"head\").append(\n            \"<meta name=\\\"viewport\\\"\n                   content=\\\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\\\">\"\n        )\n\n    removeMobileViewport: () ->\n        $(\"meta[name=\\\"viewport\\\"]\").remove()\n\n    setfn: (fn) ->\n        @._listener() if @.listener\n\n        @._listener = @rootScope.$watchCollection fn, (metas) =>\n            @.setAll(metas.title, metas.description)\n\n\nangular.module(\"taigaCommon\").service(\"tgAppMetaService\", AppMetaService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: check-permissions.service.coffee\n###\n\ntaiga = @.taiga\n\nclass ChekcPermissionsService\n    @.$inject = [\n        \"tgProjectService\"\n    ]\n\n    constructor: (@projectService) ->\n\n    check: (permission) ->\n        return @projectService.project.get('my_permissions').indexOf(permission) != -1\n\nangular.module(\"taigaCommon\").service(\"tgCheckPermissionsService\", ChekcPermissionsService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: current-user.service.coffee\n###\n\ntaiga = @.taiga\n\ngroupBy = @.taiga.groupBy\n\nclass CurrentUserService\n    @.$inject = [\n        \"tgProjectsService\",\n        \"$tgStorage\",\n        \"tgResources\"\n    ]\n\n    constructor: (@projectsService, @storageService, @rs) ->\n        @._user = null\n        @._projects = Immutable.Map()\n        @._projectsById = Immutable.Map()\n        @._joyride = null\n\n        taiga.defineImmutableProperty @, \"projects\", () => return @._projects\n        taiga.defineImmutableProperty @, \"projectsById\", () => return @._projectsById\n\n    isAuthenticated: ->\n        if @.getUser() != null\n            return true\n        return false\n\n    getUser: () ->\n        if !@._user\n            userData = @storageService.get(\"userInfo\")\n\n            if userData\n                userData = Immutable.fromJS(userData)\n                @.setUser(userData)\n\n        return @._user\n\n    removeUser: () ->\n        @._user = null\n        @._projects = Immutable.Map()\n        @._projectsById = Immutable.Map()\n        @._joyride = null\n\n    setUser: (user) ->\n        @._user = user\n\n        return @._loadUserInfo()\n\n    bulkUpdateProjectsOrder: (sortData) ->\n        @projectsService.bulkUpdateProjectsOrder(sortData).then () =>\n            @.loadProjects()\n\n    loadProjects: () ->\n        return @projectsService.getProjectsByUserId(@._user.get(\"id\"))\n            .then (projects) => @.setProjects(projects)\n\n    disableJoyRide: (section) ->\n        if section\n            @._joyride[section] = false\n        else\n            @._joyride = {\n                backlog: false,\n                kanban: false,\n                dashboard: false\n            }\n\n        @rs.user.setUserStorage('joyride', @._joyride)\n\n    loadJoyRideConfig: () ->\n        return new Promise (resolve) =>\n            if @._joyride != null\n                resolve(@._joyride)\n                return\n\n            @rs.user.getUserStorage('joyride')\n                .then (config) =>\n                    @._joyride = config\n                    resolve(@._joyride)\n                .catch () =>\n                    #joyride not defined\n                    @._joyride = {\n                        backlog: true,\n                        kanban: true,\n                        dashboard: true\n                    }\n\n                    @rs.user.createUserStorage('joyride', @._joyride)\n\n                    resolve(@._joyride)\n\n    _loadUserInfo: () ->\n        return Promise.all([\n            @.loadProjects()\n        ])\n\n    setProjects: (projects) ->\n        @._projects = @._projects.set(\"all\", projects)\n        @._projects = @._projects.set(\"recents\", projects.slice(0, 10))\n\n        @._projectsById = Immutable.fromJS(groupBy(projects.toJS(), (p) -> p.id))\n\n        return @.projects\n\nangular.module(\"taigaCommon\").service(\"tgCurrentUserService\", CurrentUserService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: lightbox-factory.service.coffee\n###\n\nclass LightboxFactory\n    @.$inject = [\"$rootScope\", \"$compile\"]\n    constructor: (@rootScope, @compile) ->\n\n    create: (name, attrs) ->\n        scope = @rootScope.$new()\n\n        elm = $(\"<div>\")\n            .attr(name, true)\n            .attr(\"tg-bind-scope\", true)\n\n        if attrs\n            elm.attr(attrs)\n\n        elm.addClass(\"remove-on-close\")\n\n        html = @compile(elm)(scope)\n\n        $(document.body).append(html)\n\n        return\n\nangular.module(\"taigaCommon\").service(\"tgLightboxFactory\", LightboxFactory)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: paginate-response.service.coffee\n###\n\nPaginateResponse = () ->\n    return (result) ->\n        paginateResponse = Immutable.Map({\n            \"data\": result.get(\"data\"),\n            \"next\": !!result.get(\"headers\")(\"x-pagination-next\"),\n            \"prev\": !!result.get(\"headers\")(\"x-pagination-prev\"),\n            \"current\": result.get(\"headers\")(\"x-pagination-current\"),\n            \"count\": result.get(\"headers\")(\"x-pagination-count\")\n        })\n\n        return paginateResponse\n\nangular.module(\"taigaCommon\").factory(\"tgPaginateResponseService\", PaginateResponse)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: project.service.coffee\n###\n\ntaiga = @.taiga\n\nclass ProjectService\n    @.$inject = [\n        \"tgProjectsService\",\n        \"tgXhrErrorService\"\n    ]\n\n    constructor: (@projectsService, @xhrError) ->\n        @._project = null\n        @._section = null\n        @._sectionsBreadcrumb = Immutable.List()\n        @._activeMembers = Immutable.List()\n\n        taiga.defineImmutableProperty @, \"project\", () => return @._project\n        taiga.defineImmutableProperty @, \"section\", () => return @._section\n        taiga.defineImmutableProperty @, \"sectionsBreadcrumb\", () => return @._sectionsBreadcrumb\n        taiga.defineImmutableProperty @, \"activeMembers\", () => return @._activeMembers\n\n    setSection: (section) ->\n        @._section = section\n\n        if section\n            @._sectionsBreadcrumb = @._sectionsBreadcrumb.push(@._section)\n        else\n            @._sectionsBreadcrumb = Immutable.List()\n\n    setProjectBySlug: (pslug) ->\n        return new Promise (resolve, reject) =>\n            if !@.project || @.project.get('slug') != pslug\n                @projectsService\n                    .getProjectBySlug(pslug)\n                    .then (project) =>\n                        @.setProject(project)\n                        resolve()\n                    .catch (xhr) =>\n                        @xhrError.response(xhr)\n\n            else resolve()\n\n    setProject: (project) ->\n        @._project = project\n        @._activeMembers = @._project.get('members').filter (member) -> member.get('is_active')\n\n    cleanProject: () ->\n        @._project = null\n        @._activeMembers = Immutable.List()\n        @._section = null\n        @._sectionsBreadcrumb = Immutable.List()\n\n    fetchProject: () ->\n        pslug = @.project.get('slug')\n\n        return @projectsService.getProjectBySlug(pslug).then (project) => @.setProject(project)\n\nangular.module(\"taigaCommon\").service(\"tgProjectService\", ProjectService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: scope-event.service.coffee\n###\n\nclass ScopeEvent\n    scopes: {},\n    _searchDuplicatedScopes: (id) ->\n        return _.find Object.keys(@scopes), (key) =>\n            return @scopes[key].$id == id\n\n    _create: (name, scope) ->\n        duplicatedScopeName = @._searchDuplicatedScopes(scope.$id)\n\n        if duplicatedScopeName\n            throw new Error(\"scopeEvent: this scope is already\n            register with the name \\\"\" + duplicatedScopeName + \"\\\"\")\n\n        if @scopes[name]\n            throw new Error(\"scopeEvent: \\\"\" + name + \"\\\" already in use\")\n        else\n            scope._tgEmitter = new EventEmitter2()\n\n            scope.$on \"$destroy\", () =>\n                scope._tgEmitter.removeAllListeners()\n                delete @scopes[name]\n\n            @scopes[name] = scope\n\n    emitter: (name, scope) ->\n        if scope\n            scope = @._create(name, scope)\n        else if @scopes[name]\n            scope = @scopes[name]\n        else\n            throw new Error(\"scopeEvent: \\\"\" + name + \"\\\" scope doesn't exist'\")\n\n        return scope._tgEmitter\n\nangular.module(\"taigaCommon\").service(\"tgScopeEvent\", ScopeEvent)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: theme.service.coffee\n###\n\ntaiga = @.taiga\n\n\nclass ThemeService extends taiga.Service = ->\n    use: (themeName) ->\n        stylesheetEl = $(\"link[rel='stylesheet']\")\n\n        if stylesheetEl.length == 0\n            stylesheetEl = $(\"<link rel='stylesheet' href='' type='text/css'>\")\n            $(\"head\").append(stylesheetEl)\n\n        stylesheetEl.attr(\"href\", \"/styles/theme-#{themeName}.css\")\n\n\nangular.module(\"taigaCommon\").service(\"tgThemeService\", ThemeService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user.service.coffee\n###\n\ntaiga = @.taiga\nbindMethods = taiga.bindMethods\n\n\nclass UserService extends taiga.Service\n    @.$inject = [\"tgResources\"]\n\n    constructor: (@rs) ->\n        bindMethods(@)\n\n    getUserByUserName: (username) ->\n        return @rs.users.getUserByUsername(username)\n\n    getContacts: (userId) ->\n        return @rs.users.getContacts(userId)\n\n    getLiked: (userId, pageNumber, objectType, textQuery) ->\n        return @rs.users.getLiked(userId, pageNumber, objectType, textQuery)\n\n    getVoted: (userId, pageNumber, objectType, textQuery) ->\n        return @rs.users.getVoted(userId, pageNumber, objectType, textQuery)\n\n    getWatched: (userId, pageNumber, objectType, textQuery) ->\n        return @rs.users.getWatched(userId, pageNumber, objectType, textQuery)\n\n    getStats: (userId) ->\n        return @rs.users.getStats(userId)\n\n    attachUserContactsToProjects: (userId, projects) ->\n        return @.getContacts(userId)\n            .then (contacts) ->\n                projects = projects.map (project) ->\n                    contactsFiltered = contacts.filter (contact) ->\n                        contactId = contact.get(\"id\")\n                        return project.get('members').indexOf(contactId) != -1\n\n                    project = project.set(\"contacts\", contactsFiltered)\n\n                    return project\n\n                return projects\n\nangular.module(\"taigaCommon\").service(\"tgUserService\", UserService)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: xhrError.service.coffee\n###\n\nclass xhrError extends taiga.Service\n    @.$inject = [\n        \"$q\",\n        \"$location\",\n        \"$tgNavUrls\"\n    ]\n\n    constructor: (@q, @location, @navUrls) ->\n\n    notFound: () ->\n        @location.path(@navUrls.resolve(\"not-found\"))\n        @location.replace()\n\n    permissionDenied: () ->\n        @location.path(@navUrls.resolve(\"permission-denied\"))\n        @location.replace()\n\n    response: (xhr) ->\n        if xhr\n            if xhr.status == 404\n                @.notFound()\n\n            else if xhr.status == 403\n                @.permissionDenied()\n\n        return @q.reject(xhr)\n\nangular.module(\"taigaCommon\").service(\"tgXhrErrorService\", xhrError)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline-attachment.directive.coffee\n###\n\nUserTimelineAttachmentDirective = (template, $compile) ->\n    validFileExtensions = [\".jpg\", \".jpeg\", \".bmp\", \".gif\", \".png\"]\n\n    isImage = (url) ->\n        url = url.toLowerCase()\n\n        return _.some validFileExtensions, (extension) ->\n            return url.indexOf(extension, url - extension.length) != -1\n\n    link = (scope, el) ->\n        is_image = isImage(scope.attachment.get('url'))\n\n        if is_image\n            templateHtml = template.get(\"user-timeline/user-timeline-attachment/user-timeline-attachment-image.html\")\n        else\n            templateHtml = template.get(\"user-timeline/user-timeline-attachment/user-timeline-attachment.html\")\n\n        el.html(templateHtml)\n        $compile(el.contents())(scope)\n\n        el.find(\"img\").error () -> @.remove()\n\n    return {\n        link: link\n        scope: {\n            attachment: \"=tgUserTimelineAttachment\"\n        }\n    }\n\nUserTimelineAttachmentDirective.$inject = [\n    \"$tgTemplate\",\n    \"$compile\"\n]\n\nangular.module(\"taigaUserTimeline\")\n    .directive(\"tgUserTimelineAttachment\", UserTimelineAttachmentDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline-item-title.service.coffee\n###\n\nunslugify = @.taiga.unslugify\n\nclass UserTimelineItemTitle\n    @.$inject = [\n        \"$translate\"\n    ]\n\n    _fieldTranslationKey: {\n        'status': 'COMMON.FIELDS.STATUS',\n        'subject': 'COMMON.FIELDS.SUBJECT',\n        'description_diff': 'COMMON.FIELDS.DESCRIPTION',\n        'points': 'COMMON.FIELDS.POINTS',\n        'assigned_to': 'COMMON.FIELDS.ASSIGNED_TO',\n        'severity': 'ISSUES.FIELDS.SEVERITY',\n        'priority': 'ISSUES.FIELDS.PRIORITY',\n        'type': 'ISSUES.FIELDS.TYPE',\n        'is_iocaine': 'TASK.FIELDS.IS_IOCAINE',\n        'is_blocked': 'COMMON.FIELDS.IS_BLOCKED'\n    }\n\n    _params: {\n        username: (timeline, event) ->\n            user = timeline.getIn(['data', 'user'])\n\n            if user.get('is_profile_visible')\n                title_attr = @translate.instant('COMMON.SEE_USER_PROFILE', {username: user.get('username')})\n                url = \"user-profile:username=timeline.getIn(['data', 'user', 'username'])\"\n\n                return @._getLink(url, user.get('name'), title_attr)\n            else\n                return @._getUsernameSpan(user.get('name'))\n\n        field_name: (timeline, event) ->\n            field_name = timeline.getIn(['data', 'value_diff', 'key'])\n\n            return @translate.instant(@._fieldTranslationKey[field_name])\n\n        project_name: (timeline, event) ->\n            url = \"project:project=timeline.getIn(['data', 'project', 'slug'])\"\n\n            return @._getLink(url, timeline.getIn([\"data\", \"project\", \"name\"]))\n\n        new_value: (timeline, event) ->\n            if _.isArray(timeline.getIn([\"data\", \"value_diff\", \"value\"]).toJS())\n                value = timeline.getIn([\"data\", \"value_diff\", \"value\"]).get(1)\n\n                # assigned to unasigned\n                if value == null && timeline.getIn([\"data\", \"value_diff\", \"key\"]) == 'assigned_to'\n                    value = @translate.instant('ACTIVITY.VALUES.UNASSIGNED')\n\n                return value\n            else\n                return timeline.getIn([\"data\", \"value_diff\", \"value\"]).first().get(1)\n\n        sprint_name: (timeline, event) ->\n            url = \"project-taskboard:project=timeline.getIn(['data', 'project', 'slug']),sprint=timeline.getIn(['data', 'milestone', 'slug'])\"\n\n            return @._getLink(url, timeline.getIn(['data', 'milestone', 'name']))\n\n        us_name: (timeline, event) ->\n            obj = @._getTimelineObj(timeline, event).get('userstory')\n\n            event_us = {obj: 'parent_userstory'}\n            url = @._getDetailObjUrl(event_us)\n\n            text = '#' + obj.get('ref') + ' ' + obj.get('subject')\n\n            return @._getLink(url, text)\n\n        obj_name: (timeline, event) ->\n            obj = @._getTimelineObj(timeline, event)\n            url = @._getDetailObjUrl(event)\n\n            if event.obj == 'wikipage'\n                text = unslugify(obj.get('slug'))\n            else if event.obj == 'milestone'\n                text = obj.get('name')\n            else\n                text = '#' + obj.get('ref') + ' ' + obj.get('subject')\n\n            return @._getLink(url, text)\n\n        role_name: (timeline, event) ->\n            return timeline.getIn(['data', 'value_diff', 'value']).keySeq().first()\n    }\n\n    constructor: (@translate) ->\n\n\n    _translateTitleParams: (param, timeline, event) ->\n        return @._params[param].call(this, timeline, event)\n\n    _getTimelineObj: (timeline, event) ->\n        return timeline.getIn(['data', event.obj])\n\n    _getDetailObjUrl: (event) ->\n        url = {\n            \"issue\": [\"project-issues-detail\", \":project=timeline.getIn(['data', 'project', 'slug']),ref=timeline.getIn(['obj', 'ref'])\"],\n            \"wikipage\": [\"project-wiki-page\", \":project=timeline.getIn(['data', 'project', 'slug']),slug=timeline.getIn(['obj', 'slug'])\"],\n            \"task\": [\"project-tasks-detail\", \":project=timeline.getIn(['data', 'project', 'slug']),ref=timeline.getIn(['obj', 'ref'])\"],\n            \"userstory\": [\"project-userstories-detail\", \":project=timeline.getIn(['data', 'project', 'slug']),ref=timeline.getIn(['obj', 'ref'])\"],\n            \"parent_userstory\": [\"project-userstories-detail\", \":project=timeline.getIn(['data', 'project', 'slug']),ref=timeline.getIn(['obj', 'userstory', 'ref'])\"],\n            \"milestone\": [\"project-taskboard\", \":project=timeline.getIn(['data', 'project', 'slug']),sprint=timeline.getIn(['obj', 'slug'])\"]\n        }\n\n        return url[event.obj][0] + url[event.obj][1]\n\n    _getLink: (url, text, title) ->\n        title = title || text\n\n        return $('<a>')\n            .attr('tg-nav', url)\n            .text(text)\n            .attr('title', title)\n            .prop('outerHTML')\n\n    _getUsernameSpan: (text) ->\n        title = title || text\n\n        return $('<span>')\n            .addClass('username')\n            .text(text)\n            .prop('outerHTML')\n\n    _getParams: (timeline, event, timeline_type) ->\n        params = {}\n\n        timeline_type.translate_params.forEach (param) =>\n            params[param] = @._translateTitleParams(param, timeline, event)\n\n        return params\n\n    getTitle: (timeline, event, type) ->\n        return @translate.instant(type.key, @._getParams(timeline, event, type))\n\nangular.module(\"taigaUserTimeline\")\n    .service(\"tgUserTimelineItemTitle\", UserTimelineItemTitle)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline-item-type.service.coffee\n###\n\ntimelineType = (timeline, event) ->\n    types = [\n        { # NewMember\n            check: (timeline, event) ->\n                return event.obj == 'membership'\n            key: 'TIMELINE.NEW_MEMBER',\n            translate_params: ['project_name']\n            member: (timeline) ->\n                return Immutable.Map({\n                    user: timeline.getIn(['data', 'user']),\n                    role: timeline.getIn(['data', 'role'])\n                })\n        },\n        { # NewProject\n            check: (timeline, event) ->\n                return event.obj == 'project' && event.type == 'create'\n            key: 'TIMELINE.NEW_PROJECT',\n            translate_params: ['username', 'project_name'],\n            description: (timeline) ->\n                return timeline.getIn(['data', 'project', 'description'])\n        },\n        { # NewAttachment\n            check: (timeline, event) ->\n                return event.type == 'change' &&\n                     timeline.hasIn(['data', 'value_diff']) &&\n                     timeline.getIn(['data', 'value_diff', 'key']) == 'attachments'\n            key: 'TIMELINE.UPLOAD_ATTACHMENT',\n            translate_params: ['username', 'obj_name']\n        },\n        { # NewUs\n            check: (timeline, event) ->\n                return event.obj == 'userstory' && event.type == 'create'\n            key: 'TIMELINE.US_CREATED',\n            translate_params: ['username', 'project_name', 'obj_name']\n        },\n        { # NewIssue\n            check: (timeline, event) ->\n                return event.obj == 'issue' && event.type == 'create'\n            key: 'TIMELINE.ISSUE_CREATED',\n            translate_params: ['username', 'project_name', 'obj_name']\n        },\n        { # NewWiki\n            check: (timeline, event) ->\n                return event.obj == 'wikipage' && event.type == 'create'\n            key: 'TIMELINE.WIKI_CREATED',\n            translate_params: ['username', 'project_name', 'obj_name']\n        },\n        { # NewTask\n            check: (timeline, event) ->\n                return event.obj == 'task' && event.type == 'create' && !timeline.getIn(['data', 'task', 'userstory'])\n            key: 'TIMELINE.TASK_CREATED',\n            translate_params: ['username', 'project_name', 'obj_name']\n        },\n        { # NewTask with US\n            check: (timeline, event) ->\n                return event.obj == 'task' && event.type == 'create' && timeline.getIn(['data', 'task', 'userstory'])\n            key: 'TIMELINE.TASK_CREATED_WITH_US',\n            translate_params: ['username', 'project_name', 'obj_name', 'us_name']\n        },\n        { # NewMilestone\n            check: (timeline, event) ->\n                return event.obj == 'milestone' && event.type == 'create'\n            key: 'TIMELINE.MILESTONE_CREATED',\n            translate_params: ['username', 'project_name', 'obj_name']\n        },\n        { # NewUsComment\n            check: (timeline, event) ->\n                return timeline.getIn(['data', 'comment']) && event.obj == 'userstory'\n            key: 'TIMELINE.NEW_COMMENT_US',\n            translate_params: ['username', 'obj_name'],\n            description: (timeline) ->\n                return $(timeline.getIn(['data', 'comment_html'])).text()\n        },\n        { # NewIssueComment\n            check: (timeline, event) ->\n                return timeline.getIn(['data', 'comment']) && event.obj == 'issue'\n            key: 'TIMELINE.NEW_COMMENT_ISSUE',\n            translate_params: ['username', 'obj_name'],\n            description: (timeline) ->\n                return $(timeline.getIn(['data', 'comment_html'])).text()\n        },\n        { # NewTaskComment\n            check: (timeline, event) ->\n                return timeline.getIn(['data', 'comment']) && event.obj == 'task'\n            key: 'TIMELINE.NEW_COMMENT_TASK'\n            translate_params: ['username', 'obj_name'],\n            description: (timeline) ->\n                return $(timeline.getIn(['data', 'comment_html'])).text()\n        },\n        { # UsMove\n            check: (timeline, event) ->\n                return timeline.hasIn(['data', 'value_diff']) &&\n                      timeline.getIn(['data', 'value_diff', 'key']) == 'moveInBacklog' &&\n                      timeline.hasIn(['data', 'value_diff', 'value', 'backlog_order']) &&\n                      event.type == 'change'\n            key: 'TIMELINE.US_MOVED',\n            translate_params: ['username', 'obj_name']\n        },\n        { # UsToBacklog\n            check: (timeline, event) ->\n                if timeline.hasIn(['data', 'value_diff']) &&\n                      timeline.getIn(['data', 'value_diff', 'key']) == 'moveInBacklog' &&\n                      event.type == 'change'\n\n                    return timeline.getIn(['data', 'value_diff', 'value', 'milestone']).get(1) == null\n\n                return false\n            key: 'TIMELINE.US_REMOVED_FROM_MILESTONE',\n            translate_params: ['username', 'obj_name']\n        },\n        { # UsToMilestone\n            check: (timeline, event) ->\n                return timeline.hasIn(['data', 'value_diff']) &&\n                      timeline.getIn(['data', 'value_diff', 'key']) == 'moveInBacklog' &&\n                      event.type == 'change'\n            key: 'TIMELINE.US_ADDED_MILESTONE',\n            translate_params: ['username', 'obj_name', 'sprint_name']\n        },\n        { # Blocked\n            check: (timeline, event) ->\n                if timeline.hasIn(['data', 'value_diff']) &&\n                      timeline.getIn(['data', 'value_diff', 'key']) == 'blocked' &&\n                      event.type == 'change'\n                    return timeline.getIn(['data', 'value_diff', 'value', 'is_blocked']).get(1) == true\n\n                return false\n            key: 'TIMELINE.BLOCKED',\n            translate_params: ['username', 'obj_name'],\n            description: (timeline) ->\n                if timeline.hasIn(['data', 'value_diff', 'value', 'blocked_note_html'])\n                    return $(timeline.getIn(['data', 'value_diff', 'value', 'blocked_note_html']).get(1)).text()\n                else\n                    return false\n        },\n        { # UnBlocked\n            check: (timeline, event) ->\n                if timeline.hasIn(['data', 'value_diff']) &&\n                      timeline.getIn(['data', 'value_diff', 'key']) == 'blocked' &&\n                      event.type == 'change'\n                    return timeline.getIn(['data', 'value_diff', 'value', 'is_blocked']).get(1) == false\n\n                return false\n            key: 'TIMELINE.UNBLOCKED',\n            translate_params: ['username', 'obj_name']\n        },\n        { # MilestoneUpdated\n            check: (timeline, event) ->\n                return event.obj == 'milestone' && event.type == 'change'\n            key: 'TIMELINE.MILESTONE_UPDATED',\n            translate_params: ['username', 'obj_name']\n        },\n        { # WikiUpdated\n            check: (timeline, event) ->\n                return event.obj == 'wikipage' && event.type == 'change'\n            key: 'TIMELINE.WIKI_UPDATED',\n            translate_params: ['username', 'obj_name']\n        },\n        { # UsUpdated points\n            check: (timeline, event) ->\n                return event.obj == 'userstory' &&\n                    event.type == 'change' &&\n                    timeline.hasIn(['data', 'value_diff']) &&\n                    timeline.getIn(['data', 'value_diff', 'key']) == 'points'\n            key: 'TIMELINE.US_UPDATED_POINTS',\n            translate_params: ['username', 'field_name', 'obj_name', 'new_value', 'role_name']\n        },\n        { # UsUpdated description\n            check: (timeline, event) ->\n                return event.obj == 'userstory' &&\n                    event.type == 'change' &&\n                    timeline.hasIn(['data', 'value_diff']) &&\n                    timeline.getIn(['data', 'value_diff', 'key']) == 'description_diff'\n            key: 'TIMELINE.US_UPDATED',\n            translate_params: ['username', 'field_name', 'obj_name']\n        },\n        { # UsUpdated general\n            check: (timeline, event) ->\n                return event.obj == 'userstory' &&\n                    event.type == 'change'\n            key: 'TIMELINE.US_UPDATED_WITH_NEW_VALUE',\n            translate_params: ['username', 'field_name', 'obj_name', 'new_value']\n        },\n        { # IssueUpdated description\n            check: (timeline, event) ->\n                return event.obj == 'issue' &&\n                    event.type == 'change' &&\n                    timeline.hasIn(['data', 'value_diff']) &&\n                    timeline.getIn(['data', 'value_diff', 'key']) == 'description_diff'\n            key: 'TIMELINE.ISSUE_UPDATED',\n            translate_params: ['username', 'field_name', 'obj_name']\n        },\n        { # IssueUpdated general\n            check: (timeline, event) ->\n                return event.obj == 'issue' &&\n                    event.type == 'change'\n            key: 'TIMELINE.ISSUE_UPDATED_WITH_NEW_VALUE',\n            translate_params: ['username', 'field_name', 'obj_name', 'new_value']\n        },\n        { # TaskUpdated description\n            check: (timeline, event) ->\n                return event.obj == 'task' &&\n                    event.type == 'change' &&\n                    !timeline.getIn('data', 'task', 'userstory') &&\n                    timeline.hasIn(['data', 'value_diff']) &&\n                    timeline.getIn(['data', 'value_diff', 'key']) == 'description_diff'\n            key: 'TIMELINE.TASK_UPDATED',\n            translate_params: ['username', 'field_name', 'obj_name']\n        },\n        { # TaskUpdated with US description\n            check: (timeline, event) ->\n                return event.obj == 'task' &&\n                    event.type == 'change' &&\n                    timeline.getIn('data', 'task', 'userstory') &&\n                    timeline.hasIn(['data', 'value_diff']) &&\n                    timeline.getIn(['data', 'value_diff', 'key']) == 'description_diff'\n            key: 'TIMELINE.TASK_UPDATED_WITH_US',\n            translate_params: ['username', 'field_name', 'obj_name', 'us_name']\n        },\n        { # TaskUpdated general\n            check: (timeline, event) ->\n                return event.obj == 'task' &&\n                    event.type == 'change' &&\n                    !timeline.getIn(['data', 'task', 'userstory'])\n            key: 'TIMELINE.TASK_UPDATED_WITH_NEW_VALUE',\n            translate_params: ['username', 'field_name', 'obj_name', 'new_value']\n        },\n        { # TaskUpdated with US\n            check: (timeline, event) ->\n                return event.obj == 'task' &&\n                    event.type == 'change' &&\n                    timeline.getIn(['data', 'task', 'userstory'])\n            key: 'TIMELINE.TASK_UPDATED_WITH_US_NEW_VALUE',\n            translate_params: ['username', 'field_name', 'obj_name', 'us_name', 'new_value']\n        },\n        { # New User\n            check: (timeline, event) ->\n                return event.obj == 'user' && event.type == 'create'\n            key: 'TIMELINE.NEW_USER',\n            translate_params: ['username']\n        }\n    ]\n\n    return _.find types, (obj) ->\n        return obj.check(timeline, event)\n\nclass UserTimelineType\n    getType: (timeline, event) -> timelineType(timeline, event)\n\nangular.module(\"taigaUserTimeline\")\n    .service(\"tgUserTimelineItemType\", UserTimelineType)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline-item.directive.coffee\n###\n\nUserTimelineItemDirective = () ->\n    return {\n        templateUrl: \"user-timeline/user-timeline-item/user-timeline-item.html\"\n        scope: {\n            timeline: \"=tgUserTimelineItem\"\n        }\n    }\n\nangular.module(\"taigaUserTimeline\")\n    .directive(\"tgUserTimelineItem\", UserTimelineItemDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline-pagination-sequence.service.coffee\n###\n\nUserTimelinePaginationSequence = () ->\n    obj = {}\n\n    obj.generate = (config) ->\n        page = 1\n        items = Immutable.List()\n\n        config.minItems = config.minItems || 20\n\n        next = () ->\n            items = Immutable.List()\n            return getContent()\n\n        getContent = () ->\n            config.fetch(page).then (response) ->\n                page++\n\n                data = response.get(\"data\")\n\n                if config.filter\n                    data = config.filter(data)\n\n                if config.map\n                    data = data.map(config.map)\n\n                items = items.concat(data)\n\n                if items.size < config.minItems && response.get(\"next\")\n                    return getContent()\n\n                return Immutable.Map({\n                    items: items,\n                    next: response.get(\"next\")\n                })\n\n        return {\n            next: () -> next()\n        }\n\n    return obj\n\nangular.module(\"taigaUserTimeline\").factory(\"tgUserTimelinePaginationSequenceService\", UserTimelinePaginationSequence)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/profile/profile-timeline/profile-timeline.controller.coffee\n###\n\ntaiga = @.taiga\n\nmixOf = @.taiga.mixOf\n\nclass UserTimelineController extends mixOf(taiga.Controller, taiga.PageMixin, taiga.FiltersMixin)\n    @.$inject = [\n        \"tgUserTimelineService\"\n    ]\n\n    constructor: (@userTimelineService) ->\n        @.timelineList = Immutable.List()\n        @.scrollDisabled = false\n\n        @.timeline = null\n\n        if @.projectId\n            @.timeline = @userTimelineService.getProjectTimeline(@.projectId)\n        else if @.currentUser\n            @.timeline = @userTimelineService.getProfileTimeline(@.user.get(\"id\"))\n        else\n            @.timeline = @userTimelineService.getUserTimeline(@.user.get(\"id\"))\n\n    loadTimeline: () ->\n        @.scrollDisabled = true\n\n        return @.timeline\n            .next()\n            .then (response) =>\n                @.timelineList = @.timelineList.concat(response.get(\"items\"))\n\n                if response.get(\"next\")\n                    @.scrollDisabled = false\n\n                return @.timelineList\n\nangular.module(\"taigaUserTimeline\")\n    .controller(\"UserTimeline\", UserTimelineController)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline.directive.coffee\n###\n\nUserTimelineDirective = ->\n    return {\n        templateUrl: \"user-timeline/user-timeline/user-timeline.html\",\n        controller: \"UserTimeline\",\n        controllerAs: \"vm\",\n        scope: {\n            projectId: \"=projectid\",\n            user: \"=\",\n            currentUser: \"=\"\n        },\n        bindToController: true\n    }\n\nangular.module(\"taigaProfile\").directive(\"tgUserTimeline\", UserTimelineDirective)\n","###\n# Copyright (C) 2014-2015 Taiga Agile LLC <taiga@taiga.io>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: user-timeline.service.coffee\n###\n\ntaiga = @.taiga\n\nclass UserTimelineService extends taiga.Service\n    @.$inject = [\n        \"tgResources\",\n        \"tgUserTimelinePaginationSequenceService\",\n        \"tgUserTimelineItemType\",\n        \"tgUserTimelineItemTitle\"\n    ]\n\n    constructor: (@rs, @userTimelinePaginationSequenceService, @userTimelineItemType, @userTimelineItemTitle) ->\n\n    _valid_fields: [\n        'status',\n        'subject',\n        'description_diff',\n        'assigned_to',\n        'points',\n        'severity',\n        'priority',\n        'type',\n        'attachments',\n        'is_iocaine',\n        'content_diff',\n        'name',\n        'estimated_finish',\n        'estimated_start',\n        # customs\n        'blocked',\n        'moveInBacklog',\n        'milestone'\n    ]\n\n    _invalid: [\n        {# Items with only invalid fields\n            check: (timeline) ->\n                value_diff = timeline.get(\"data\").get(\"value_diff\")\n\n                if value_diff\n                    fieldKey = value_diff.get('key')\n\n                    if @._valid_fields.indexOf(fieldKey) == -1\n                        return true\n                    else if fieldKey == 'attachments' &&\n                         value_diff.get('value').get('new').size == 0\n                        return true\n\n                return false\n        },\n        {# Deleted\n            check: (timeline) ->\n                event = timeline.get('event_type').split(\".\")\n                return event[2] == 'delete'\n        },\n        {# Project change\n            check: (timeline) ->\n                event = timeline.get('event_type').split(\".\")\n                return event[1] == 'project' && event[2] == 'change'\n        },\n        {# Comment deleted\n            check: (timeline) ->\n                return !!timeline.get(\"data\").get(\"comment_deleted\")\n        },\n        {# Task milestone\n            check: (timeline) ->\n                event = timeline.get('event_type').split(\".\")\n                value_diff = timeline.get(\"data\").get(\"value_diff\")\n\n                if value_diff &&\n                     event[1] == \"task\" &&\n                     event[2] == \"change\" &&\n                     value_diff.get(\"key\") == \"milestone\"\n                    return timeline.get(\"data\").get(\"value_diff\").get(\"value\")\n\n                return false\n        }\n    ]\n\n    _isInValidTimeline: (timeline) ->\n        return _.some @._invalid, (invalid) =>\n            return invalid.check.call(this, timeline)\n\n    _parseEventType: (event_type) ->\n        event_type = event_type.split(\".\")\n\n        return {\n            section: event_type[0],\n            obj: event_type[1],\n            type: event_type[2]\n        }\n\n    _getTimelineObject: (timeline, event) ->\n        if timeline.get('data').get(event.obj)\n            return timeline.get('data').get(event.obj)\n\n    _attachExtraInfoToTimelineEntry: (timeline, event, type) ->\n        title = @userTimelineItemTitle.getTitle(timeline, event, type)\n\n        timeline = timeline.set('title_html', title)\n\n        timeline =  timeline.set('obj', @._getTimelineObject(timeline, event))\n\n        if type.description\n            timeline = timeline.set('description', type.description(timeline))\n\n        if type.member\n            timeline = timeline.set('member', type.member(timeline))\n\n        if timeline.getIn(['data', 'value_diff', 'key']) == 'attachments' &&\n          timeline.hasIn(['data', 'value_diff', 'value', 'new'])\n            timeline = timeline.set('attachments', timeline.getIn(['data', 'value_diff', 'value', 'new']))\n\n        return timeline\n\n    # - create a entry per every item in the values_diff\n    _parseTimeline: (response) ->\n        newdata = Immutable.List()\n\n        response.get('data').forEach (item) =>\n            event = @._parseEventType(item.get('event_type'))\n\n            data = item.get('data')\n            values_diff = data.get('values_diff')\n\n            if values_diff && values_diff.count()\n                # blocked/unblocked change must be a single change\n                if values_diff.has('is_blocked')\n                    values_diff = Immutable.Map({'blocked': values_diff})\n\n                if values_diff.has('milestone')\n                    values_diff = Immutable.Map({'moveInBacklog': values_diff})\n                else if event.obj == 'milestone'\n                     values_diff = Immutable.Map({'milestone': values_diff})\n\n                values_diff.forEach (value, key) =>\n                    obj = Immutable.Map({\n                        key: key,\n                        value: value\n                    })\n\n                    newItem = item.setIn(['data', 'value_diff'], obj)\n                    newItem = newItem.deleteIn(['data', 'values_diff'])\n                    newdata = newdata.push(newItem)\n            else\n                newItem = item.deleteIn(['data', 'values_diff'])\n                newdata = newdata.push(newItem)\n\n        return response.set('data', newdata)\n\n    _addEntyAttributes: (item) ->\n        event = @._parseEventType(item.get('event_type'))\n        type = @userTimelineItemType.getType(item, event)\n\n        return @._attachExtraInfoToTimelineEntry(item, event, type)\n\n    getProfileTimeline: (userId) ->\n        config = {}\n\n        config.fetch = (page) =>\n            return @rs.users.getProfileTimeline(userId, page)\n                .then (response) =>\n                    return @._parseTimeline(response)\n\n        config.map = (obj) => @._addEntyAttributes(obj)\n\n        config.filter = (items) =>\n            return items.filterNot (item) => @._isInValidTimeline(item)\n\n        return @userTimelinePaginationSequenceService.generate(config)\n\n    getUserTimeline: (userId) ->\n        config = {}\n\n        config.fetch = (page) =>\n            return @rs.users.getUserTimeline(userId, page)\n                .then (response) =>\n                    return @._parseTimeline(response)\n\n        config.map = (obj) => @._addEntyAttributes(obj)\n\n        config.filter = (items) =>\n            return items.filterNot (item) => @._isInValidTimeline(item)\n\n        return @userTimelinePaginationSequenceService.generate(config)\n\n    getProjectTimeline: (projectId) ->\n        config = {}\n\n        config.fetch = (page) =>\n            return @rs.projects.getTimeline(projectId, page)\n                .then (response) => return @._parseTimeline(response)\n\n        config.map = (obj) => @._addEntyAttributes(obj)\n\n        config.filter = (items) =>\n            return items.filterNot (item) => @._isInValidTimeline(item)\n\n        return @userTimelinePaginationSequenceService.generate(config)\n\nangular.module(\"taigaUserTimeline\").service(\"tgUserTimelineService\", UserTimelineService)\n","###\n# Copyright (C) 2014-2015 Andrey Antukh <niwi@niwi.be>\n# Copyright (C) 2014-2015 Jess Espino Garcia <jespinog@gmail.com>\n# Copyright (C) 2014-2015 David Barragn Merino <bameda@dbarragan.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU Affero General Public License as\n# published by the Free Software Foundation, either version 3 of the\n# License, or (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n# GNU Affero General Public License for more details.\n#\n# You should have received a copy of the GNU Affero General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#\n# File: modules/backlog.coffee\n###\n\nmodule = angular.module(\"taigaPlugins\", [\"ngRoute\"])\n"],"sourceRoot":"/source/"}